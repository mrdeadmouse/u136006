(function(e){if(e.BVotedUser)return true;e.FormToArray=function(e,t){t=!!t?t:new Array;if(!!e){var s,a=new Array,r=e.elements.length;for(s=0;s<r;s++){var n=e.elements[s];if(n.disabled)continue;switch(n.type.toLowerCase()){case"text":case"textarea":case"password":case"hidden":case"select-one":a.push({name:n.name,value:n.value});break;case"radio":case"checkbox":if(n.checked)a.push({name:n.name,value:n.value});break;case"select-multiple":for(var o=0;o<n.options.length;o++){if(n.options[o].selected)a.push({name:n.name,value:n.options[o].value})}break;default:break}}var i=t,s=0;while(s<a.length){var l=a[s].name.indexOf("[");if(l==-1){i[a[s].name]=a[s].value;i=t;s++}else{var c=a[s].name.substring(0,l);var u=a[s].name.substring(l+1);if(!i[c])i[c]=new Array;var f=u.indexOf("]");if(f==-1){i=t;s++}else if(f==0){i=i[c];a[s].name=""+i.length}else{i=i[c];a[s].name=u.substring(0,f)+u.substring(f+1)}}}}return t};e.voteGetID=function(){return"vote"+(new Date).getTime()};e.VCLinkCloseWait=function(e){return app.hidePopupLoader()};e.VCLinkShowWait=function(e){return app.showPopupLoader()};e.voteSendForm=function(t,s,a){if(!!s){e.voteAJAX(t,a,s.action,e.FormToArray(s,{AJAX_POST:"Y"}))}};e.voteGetForm=function(t,s,a){var r=t.getAttribute("href").replace(/.AJAX_RESULT=Y/g,"").replace(/.AJAX_POST=Y/g,"").replace(/.sessid=[^&]*/g,"").replace(/.VOTE_ID=([\d]+)/,"").replace(/.view_form=Y/g,"").replace(/.view_result=Y/g,""),n={view_form:"Y",VOTE_ID:s,AJAX_POST:"Y",sessid:BX.bitrix_sessid()};e.voteAJAX(t,a,r,n);return false};e.__VConVoteEntityWasChanged=function(t,s,a){var t=!!t&&!!t.id?BX(t.id):t,r=BX.processHTML(s,false),n=BX.findParent(t,{className:"bx-vote-block"});n.innerHTML="";n.innerHTML=r.HTML;BX.removeClass(n,"bx-vote-block-result");BX.removeClass(n,"bx-vote-block-result-view");if(r.HTML.indexOf("<form")<0){BX.addClass(n,"bx-vote-block-result")}BX.ajax.processScripts(r.SCRIPT);e["BVote"+a]=null};BX.addCustomEvent("onVoteEntityWasChanged",function(e){__VConVoteEntityWasChanged(e.link,e.result,e.CID)});e.voteAJAX=function(e,t,s,a){VCLinkShowWait(e);var r=new MobileAjaxWrapper;r.Wrap({type:"html",method:"POST",url:s,data:a,callback:function(r){if(a&&(a=='{"status":"failed"}'||a.status=="failed")){app.BasicAuth({success:function(r){voteAJAX(e,t,s,a)},failure:function(){}});return false}VCLinkCloseWait(e);__VConVoteEntityWasChanged(e,r,t);app.onCustomEvent("onVoteEntityWasChanged",{link:{id:e.id},result:r,CID:t})},callback_failure:function(t){VCLinkCloseWait(e)}})};e.voteGetResult=function(t,s,a){VCLinkShowWait(a);BX.addCustomEvent(t,"OnBeforeChangeData",function(){var e=BX.findParent(t,{className:"bx-vote-block"});BX.addClass(e,"bx-vote-block-result");BX.addClass(e,"bx-vote-block-result-view");VCLinkCloseWait(a)});BX.addCustomEvent(t,"OnAfterChangeData",function(){BX.hide(a)});e["BVote"+s].checker.lastVote=0;e["BVote"+s].checker.check(true);return false};e.BVoteChecker=function(e){if(!e["url"]||!e["CID"]||!e["controller"])return false;this.CID=e["CID"];this.voteId=e["voteId"];this.url=e["url"];this.controller=e["controller"];this.period=[2,5,10,30];this.form=!!e["form"]?BX(e["form"]):false;this.lastVote=!!e["startCheck"]?parseInt(e["startCheck"]/60):false;if(!!this.lastVote)this.check();return this};e.BVoteChecker.prototype.check=function(e){var t=e===true?0:false;if(e!==true){for(var s in this.period){if(this.lastVote<=this.period[s]){t=this.period[s];break}}}if(t!==false)setTimeout(BX.proxy(function(){this.send()},this),t*60*1e3)};e.BVoteChecker.prototype.send=function(){BX.ajax({url:this.url.replace(/.AJAX_RESULT=Y/g,"").replace(/.AJAX_POST=Y/g,"").replace(/.sessid=[^&]*/g,"").replace(/.VOTE_ID=([\d]+)/,"").replace(/.view_form=Y/g,"").replace(/.view_result=Y/g,""),method:"POST",dataType:"json",data:{VOTE_ID:this.voteId,AJAX_RESULT:"Y",view_result:"Y",sessid:BX.bitrix_sessid()},onsuccess:BX.proxy(function(e){this.start(e)},this),onfailure:function(e){}})};e.BVoteChecker.prototype.start=function(e){this.lastVote=parseInt(e["LAST_VOTE"]/60);this.changeData(e);this.check()};e.BVoteChecker.prototype.changeData=function(e){e=e["QUESTIONS"];BX.onCustomEvent(this.controller,"OnBeforeChangeData");for(var t in e){var s=BX.findChild(this.controller,{attr:{id:"question"+t}},true);if(!!s){for(var a in e[t]){var r=BX.findChild(s,{attr:{id:"answer"+a}},true);if(!!r){BX.adjust(r,{attrs:{"bx-voters-count":e[t][a]["COUNTER"]}});if(!this.form)BX.bind(r,"click",voteGetUsersL);else BX.unbind(r,"click",voteGetUsersL);BX.adjust(BX.findChild(r,{tagName:"DIV",className:"bx-vote-data-percent"},true),{html:"<span>"+parseInt(e[t][a]["PERCENT"])+'</span><span class="post-vote-color">%</span>'});BX.adjust(BX.findChild(r,{tagName:"DIV",className:"bx-vote-answer-bar"},true),{style:{width:parseInt(e[t][a]["PERCENT"])+"%"}})}}}}BX.adjust(BX.findChild(this.controller,{tagName:"SPAN",className:"bx-vote-events-count"},true),{html:"<span>"+parseInt(e["COUNTER"])+'</span><span class="post-vote-color">%</span>'});BX.onCustomEvent(this.controller,"OnAfterChangeData")};e.BVotedUser=function(e){this.checker=new BVoteChecker(e);this.form=!!e["form"]?BX(e["form"]):false;var t=BX.findChildren(e.controller,{tagName:"TR",className:"bx-vote-answer-item"},true);if(!this.form&&!!t&&t.length>0){for(var s=0;s<t.length;s++){BX.bind(t[s],"click",voteGetUsersL)}}};e.voteGetUsers=function(e,t){if(!t||!t.hasAttribute("bx-voters-count")||parseInt(t.getAttribute("bx-voters-count"))<=0)return false;BX.PreventDefault(e);var s=t.getAttribute("id").replace("answer",""),a="/bitrix/templates/mobile_app/components/bitrix/voting.current/.userfield/users.php?answer_id="+s+"&URL_TEMPLATE=/mobile/users/?user_id=%23user_id%23&sessid="+BX.bitrix_sessid();app.openBXTable({url:a,TABLE_SETTINGS:{markmode:false,cache:false}})};e.voteGetUsersL=function(e){voteGetUsers(e,this)}})(window);
//# sourceMappingURL=script.map.js