; /* /bitrix/js/main/core/core_uploader/common.min.js?14522774308204*/
; /* /bitrix/js/main/core/core_uploader/uploader.min.js?145227743035959*/
; /* /bitrix/js/main/core/core_uploader/file.min.js?145227743017963*/
; /* /bitrix/js/main/core/core_uploader/queue.min.js?145227743010121*/

; /* Start:"a:4:{s:4:"full";s:63:"/bitrix/js/main/core/core_uploader/common.min.js?14522774308204";s:6:"source";s:44:"/bitrix/js/main/core/core_uploader/common.js";s:3:"min";s:48:"/bitrix/js/main/core/core_uploader/common.min.js";s:3:"map";s:48:"/bitrix/js/main/core/core_uploader/common.map.js";}"*/
(function(window){if(window.BX["UploaderUtils"])return false;var BX=window.BX;BX.UploaderLog=[];BX.UploaderDebug=false;var statuses={"new":0,ready:1,preparing:2,inprogress:3,done:4,failed:5,stopped:6,changed:7,uploaded:8};BX.UploaderUtils={statuses:statuses,getId:function(){return(new Date).valueOf()+Math.round(Math.random()*1e6)},log:function(){if(BX.UploaderDebug===true){console.log(arguments)}else{BX.UploaderLog.push(arguments)}},Hash:function(){this.length=0;this.items={};this.order=[];var e;if(arguments.length==1&&BX.type.isArray(arguments[0])&&arguments[0].length>0){var t=arguments[0];for(e=0;e<t.length;e++){if(t[e]&&typeof t[e]=="object"&&t[e]["id"]){this.setItem(t[e]["id"],t[e])}}}else{for(e=0;e<arguments.length;e+=2)this.setItem(arguments[e],arguments[e+1])}},getFileNameOnly:function(e){var t="\\",i=e.lastIndexOf(t),n=e.length;if(i==-1){t="/";i=e.lastIndexOf(t)}if(i+1==e.length){n=i;i=e.substring(0,n).lastIndexOf(t)}e=e.substring(i+1,n);if(t=="/"&&e.indexOf("?")>0){e=e.substring(0,e.indexOf("?"))}if(e=="")e="noname";return e},isImageExt:function(e){return BX.message("bxImageExtensions")&&BX.type.isNotEmptyString(e)?new RegExp("(?:^|\\W)("+e+")(?:\\W|$)").test(BX.message("bxImageExtensions")):false},isImage:function(e,t,i){i=BX.type.isNumber(i)?i:BX.type.isNotEmptyString(i)&&!/[\D]+/gi.test(i)?parseInt(i):null;return(t===null||(t||"").indexOf("image/")===0)&&(i===null||i<20*1024*1024)&&BX.UploaderUtils.isImageExt((e||"").lastIndexOf(".")>0?e.substr(e.lastIndexOf(".")+1).toLowerCase():"")},scaleImage:function(e,t,i){var n=parseInt(e["width"]),r=parseInt(e["height"]);i=!i&&!!t["type"]?t["type"]:i;t=!!t?t:{};t.width=parseInt(!!t.width?t.width:0);t.height=parseInt(!!t.height?t.height:0);var s={bNeedCreatePicture:false,source:{x:0,y:0,width:0,height:0},destin:{x:0,y:0,width:0,height:0}},o,a;if(!(n>0||r>0)){BX.DoNothing()}else{if(!BX.type.isNotEmptyString(i)){i="inscribed"}var l,u;if(i.indexOf("proportional")>=0){o=Math.max(n,r);a=Math.min(n,r)}else{o=n;a=r}if(i=="circumscribed"){l={width:o>0?t["width"]/o:1,height:a>0?t["height"]/a:1};u=Math.max(l["width"],l["height"],1)}else{l={width:o>0?t["width"]/o:1,height:a>0?t["height"]/a:1};u=Math.min(l["width"],l["height"],1);u=0<u?u:1}s.bNeedCreatePicture=u!=1;s.coeff=u;s.destin["width"]=Math.max(1,parseInt(u*n));s.destin["height"]=Math.max(1,parseInt(u*r));s.source["x"]=0;s.source["y"]=0;s.source["width"]=n;s.source["height"]=r}return s},dataURLToBlob:function(e){var t=";base64,",i,n,r,s;if(e.indexOf(t)==-1){i=e.split(",");n=i[0].split(":")[1];r=i[1];return new Blob([r],{type:n})}i=e.split(t);n=i[0].split(":")[1];r=window.atob(i[1]);s=r.length;var o=new Uint8Array(s);for(var a=0;a<s;++a){o[a]=r.charCodeAt(a)}return new Blob([o],{type:n})},sizeof:function(e){var t=0,i;for(i in e){if(e.hasOwnProperty(i)){t+=i.length;if(typeof e[i]=="object"){if(e[i]===null)BX.DoNothing();else if(e[i]["size"]>0)t+=e[i].size;else t+=BX.UploaderUtils.sizeof(e[i])}else if(typeof e[i]=="number"){t+=e[i].toString().length}else if(!!e[i]&&e[i].length>0){t+=e[i].length}}}return t},FormToArray:function(e,t){return BX.ajax.prepareForm(e,t)},getFormattedSize:function(e,t){var i=["b","Kb","Mb","Gb","Tb"],n=0;while(e>=1024&&n<4){e/=1024;n++}return Math.round(e*(t>0?t*10:1))/(t>0?t*10:1)+" "+BX.message("FILE_SIZE_"+i[n])},bindEvents:function(obj,event,func){var funcs=[],ii;if(typeof func=="string"){eval("funcs.push("+func+");")}else if(!!func["length"]&&func["length"]>0){for(ii=0;ii<func.length;ii++){if(typeof func[ii]=="string")eval("funcs.push("+func[ii]+");");else funcs.push(func[ii])}}else funcs.push(func);if(funcs.length>0){for(ii=0;ii<funcs.length;ii++){BX.addCustomEvent(obj,event,funcs[ii])}}},applyFilePart:function(e,t){if(BX.type.isDomNode(e)){e.uploadStatus=statuses.done}else if(e==t){e.uploadStatus=statuses.done}else if(e.blobed===true){e.uploadStatus=e.package+1>=e.packages?statuses.done:statuses.inprogress;if(e.uploadStatus==statuses.inprogress)e.package++}return true},getFilePart:function(e,t,i){var n,r=i,s,o,a=null;if(BX.type.isDomNode(e)){n=e}else if(!(i>0&&e.size>i)){n=e}else if(window.Blob||window.MozBlobBuilder||window.WebKitBlobBuilder||window.BlobBuilder){e.blobed=true;if(e.uploadStatus==statuses.inprogress){s=e.firstChunk+(e.package-1)*r;o=s+r}else{t=0<t&&t<r?t:r;e.firstChunk=t;e.packages=1+Math.ceil((e.size-e.firstChunk)/r);e.package=0;s=0;o=e.firstChunk}if("mozSlice"in e)n=e.mozSlice(s,o);else if("webkitSlice"in e)n=e.webkitSlice(s,o);else if("slice"in e)n=e.slice(s,o);else n=e.Slice(s,o,e.type);for(var l in e){if(e.hasOwnProperty(l)){n[l]=e[l]}}n["name"]=e["name"];n["start"]=s}return n},makeAnArray:function(e,t){e=!!e?e:{files:[],props:{}};var i;for(var n in t){if(t.hasOwnProperty(n)){if(typeof t[n]=="object"&&t[n].length>0){e[n]=!!e[n]?e[n]:[];for(i=0;i<t[n].length;i++){e[n].push(t[n][i])}}else{for(i in t[n]){if(t[n].hasOwnProperty(i)){e[n]=!!e[n]?e[n]:{};e[n][i]=t[n][i]}}}}}return e},appendToForm:function(e,t,i){if(!!i&&typeof i=="object"){for(var n in i){if(i.hasOwnProperty(n)){BX.UploaderUtils.appendToForm(e,t+"["+n+"]",i[n])}}}else{e.append(t,!!i?i:"")}},FormData:function(){return new(BX.Uploader.getInstanceName()=="BX.UploaderSimple"?FormDataLocal:window.FormData)},prepareData:function(e){var t={};if(null!=e){if(typeof e=="object"){for(var i in e){if(e.hasOwnProperty(i)){var n=BX.util.urlencode(i);if(typeof e[i]=="object")t[n]=BX.UploaderUtils.prepareData(e[i]);else t[n]=BX.util.urlencode(e[i])}}}else t=BX.util.urlencode(e)}return t}};var FormDataLocal=function(){var e;do{e=Math.floor(Math.random()*99999)}while(BX("form-"+e));this.local=true;this.form=BX.create("FORM",{props:{id:"form-"+e,method:"POST",enctype:"multipart/form-data",encoding:"multipart/form-data"},style:{display:"none"}});document.body.appendChild(this.form)};FormDataLocal.prototype={append:function(e,t){if(BX.type.isDomNode(t)){this.form.appendChild(t)}else{this.form.appendChild(BX.create("INPUT",{props:{type:"hidden",name:e,value:t}}))}}};BX.UploaderUtils.slice=function(e,t,i){var n=null;if("mozSlice"in e)n=e.mozSlice(t,i);else if("webkitSlice"in e)n=e.webkitSlice(t,i);else if("slice"in e)n=e.slice(t,i);else n=e.Slice(t,i,e.type);return n};BX.UploaderUtils.readFile=function(e,t,i){if(window["FileReader"]){var n=new FileReader;n.onload=n.onerror=t;i=i||"readAsDataURL";if(n[i]){n[i](e);return n}}return false};BX.UploaderUtils.Hash.prototype={getIds:function(){return this.order},getQueue:function(e){e+="";return BX.util.array_search(e,this.order)},removeItem:function(e){e+="";var t,i;if(typeof this.items[e]!="undefined"){t=this.items[e];i=this.getQueue(e);this.pointer-=this.pointer>=i?1:0;delete this.items[e];this.order=BX.util.deleteFromArray(this.order,i);this.length=this.order.length}return t},getItem:function(e){e+="";return this.items[e]},unshiftItem:function(e,t){e+="";if(typeof t!="undefined"){if(typeof this.items[e]=="undefined"){this.order.unshift(e);this.length=this.order.length}this.items[e]=t}return t},setItem:function(e,t){e+="";if(typeof t!="undefined"){if(typeof this.items[e]=="undefined"){this.order.push(e);this.length=this.order.length}this.items[e]=t}return t},hasItem:function(e){e+="";return typeof this.items[e]!="undefined"},insertBeforeItem:function(e,t,i){e+="";if(typeof t!="undefined"){if(typeof this.items[e]=="undefined"){this.order.splice(this.getQueue(i),0,e);this.length=this.order.length}this.items[e]=t}return t},getFirst:function(){var e,t=null;for(var i=0;i<this.order.length;i++){e=this.order[i];if(!!e&&this.hasItem(e)){t=this.getItem(e);break}}return t},getNext:function(){this.pointer=0<=this.pointer&&this.pointer<this.order.length?this.pointer:-1;var e=this.getItem(this.order[this.pointer+1]);if(!!e)this.pointer++;else this.pointer=-1;return e},getPrev:function(){this.pointer=0<=this.pointer&&this.pointer<this.order.length?this.pointer:0;var e=this.getItem(this.order[this.pointer-1]);if(!!e)this.pointer--;return e},reset:function(){this.pointer=-1},setPointer:function(e){this.pointer=this.getQueue(e);return this.pointer},getLast:function(){var e,t=null;for(var i=this.order.length;i>=0;i--){e=this.order[i];if(!!e&&this.hasItem(e)){t=this.getItem(e);break}}return t}}})(window);
/* End */
;
; /* Start:"a:4:{s:4:"full";s:66:"/bitrix/js/main/core/core_uploader/uploader.min.js?145227743035959";s:6:"source";s:46:"/bitrix/js/main/core/core_uploader/uploader.js";s:3:"min";s:50:"/bitrix/js/main/core/core_uploader/uploader.min.js";s:3:"map";s:50:"/bitrix/js/main/core/core_uploader/uploader.map.js";}"*/
(function(window){if(window.BX["Uploader"])return;var BX=window.BX,statuses={"new":0,ready:1,preparing:2,inprogress:3,done:4,failed:5,error:5.2,stopped:6,changed:7,uploaded:8},repo={},settings={phpPostMinSize:1.5*1024*1024,phpUploadMaxFilesize:1024*1024,phpPostMaxSize:10*1024*1024,estimatedTimeForUploadFile:10*60,maxTimeForUploadFile:15*60};BX.Uploader=function(e){var t;if(!(typeof e=="object"&&e&&(BX(e["input"])||e["input"]===null))){BX.debug(BX.message("UPLOADER_INPUT_IS_NOT_DEFINED"))}else{this.fileInput=e["input"]===null?null:BX(e["input"]);this.controlID=this.controlId=e["controlId"]||"bitrixUploader";this.dialogName="BX.Uploader";this.id=!!e["id"]?e["id"]:Math.random();this.CID=!!e["CID"]?!!e["CID"]:"CID"+BX.UploaderUtils.getId();this.streams=new BX.UploaderStreams(e["streams"],this);this.limits={phpMaxFileUploads:parseInt(BX.message("phpMaxFileUploads")),phpPostMaxSize:Math.min(parseInt(BX.message("phpPostMaxSize")),settings.phpPostMaxSize),phpUploadMaxFilesize:Math.min(parseInt(BX.message("phpUploadMaxFilesize")),settings.phpUploadMaxFilesize),uploadMaxFilesize:e["uploadMaxFilesize"]>0?e["uploadMaxFilesize"]:0,uploadFileWidth:e["uploadFileWidth"]>0?e["uploadFileWidth"]:0,uploadFileHeight:e["uploadFileHeight"]>0?e["uploadFileHeight"]:0,allowUpload:e["allowUpload"]=="A"||e["allowUpload"]=="I"||e["allowUpload"]=="F"?e["allowUpload"]:"A",allowUploadExt:typeof e["allowUploadExt"]==="string"?e["allowUploadExt"]:""};var s=["phpMaxFileUploads","phpPostMaxSize","phpUploadMaxFilesize"];for(t=0;t<s.length;t++){this.limits[s[t]]=typeof e[s[t]]=="number"&&e[s[t]]<this.limits[s[t]]?e[s[t]]:this.limits[s[t]]}this.limits["phpPostSize"]=Math.min(this.limits["phpPostMaxSize"],settings.phpPostMinSize);this.CEF=!!window["BXDesktopSystem"];if(this.CEF){this.limits["phpUploadMaxFilesize"]=Math.min(200*1024*1024,parseInt(BX.message("phpUploadMaxFilesize")),parseInt(e["phpUploadMaxFilesize"]?e["phpUploadMaxFilesize"]:BX.message("phpUploadMaxFilesize")));this.limits["phpPostMaxSize"]=Math.min(210*1024*1024,parseInt(BX.message("phpPostMaxSize")),parseInt(e["phpPostMaxSize"]?e["phpPostMaxSize"]:BX.message("phpPostMaxSize")));this.limits["uploadMaxFilesize"]=this.limits["phpUploadMaxFilesize"];this.limits["phpPostSize"]=this.limits["phpPostMaxSize"]}this.limits["uploadFile"]=e["allowUpload"]=="I"?"image/*":"";this.limits["uploadFileExt"]=this.limits["allowUploadExt"];if(this.limits["uploadFileExt"].length>0){var i=this.limits["uploadFileExt"].split(this.limits["uploadFileExt"].indexOf(",")>=0?",":" ");for(t=0;t<i.length;t++)i[t]=i[t].charAt(0)=="."?i[t].substr(1):i[t];this.limits["uploadFileExt"]=i.join(",")}this.params=e;this.params["filesInputName"]=this.fileInput&&this.fileInput["name"]?this.fileInput["name"]:"FILES";this.params["filesInputMultiple"]=this.fileInput&&this.fileInput["multiple"]||this.params["filesInputMultiple"]?"multiple":false;this.params["uploadFormData"]=this.params["uploadFormData"]=="N"?"N":"Y";this.params["uploadMethod"]=this.params["uploadMethod"]=="immediate"?"immediate":"deferred";this.params["uploadFilesForPackage"]=parseInt(this.params["uploadFilesForPackage"]>0?this.params["uploadFilesForPackage"]:0);this.params["imageExt"]="jpg,bmp,jpeg,jpe,gif,png";this.params["uploadInputName"]=!!this.params["uploadInputName"]?this.params["uploadInputName"]:"bxu_files";this.params["uploadInputInfoName"]=!!this.params["uploadInputInfoName"]?this.params["uploadInputInfoName"]:"bxu_info";this.params["deleteFileOnServer"]=!(this.params["deleteFileOnServer"]===false||this.params["deleteFileOnServer"]==="N");this.params["pasteFileHashInForm"]=!(this.params["pasteFileHashInForm"]===false||this.params["pasteFileHashInForm"]==="N");repo[this.id]=this;if(this.init(this.fileInput)){if(!!e["dropZone"])this.initDropZone(BX(e["dropZone"]));if(!!e["events"]){for(t in e["events"]){if(e["events"].hasOwnProperty(t)){BX.UploaderUtils.bindEvents(this,t,e["events"][t])}}}this.uploadFileUrl=!!e["uploadFileUrl"]?e["uploadFileUrl"]:this.form?this.form.getAttribute("action"):"";if(!this.uploadFileUrl||this.uploadFileUrl.length<=0){BX.debug(BX.message("UPLOADER_ACTION_URL_NOT_DEFINED"))}this.status=statuses.ready;this.fileFields=e["fields"];this.fileCopies=e["copies"];var a=!!e["queueFields"]?e["queueFields"]:{};a["placeHolder"]=BX(a["placeHolder"]||e["placeHolder"]);a["showImage"]=a["showImage"]||e["showImage"];a["sortItems"]=a["sortItems"]||e["sortItems"];a["thumb"]=a["thumb"]||e["thumb"];this.queue=new BX.UploaderQueue(a,this.limits,this);this.params["doWeHaveStorage"]=true;BX.addCustomEvent(this,"onDone",BX.delegate(function(){this.init(this.fileInput)},this));if(!!this.params["filesInputName"]&&this.params["pasteFileHashInForm"]){BX.addCustomEvent(this,"onFileIsUploaded",BX.delegate(function(t,s){var i=BX.create("INPUT",{props:{type:"hidden",name:this.params["filesInputName"]+"[]",value:s.hash}});if(BX(e["placeHolder"])&&BX(t+"Item"))BX(t+"Item").appendChild(i);else if(this.fileInput!==null)this.fileInput.parentNode.insertBefore(i,this.fileInput)},this))}if(this.params["deleteFileOnServer"]){BX.addCustomEvent(this,"onFileIsDeleted",BX.delegate(function(e,t){if(!!t&&!!t.hash){var s=this.preparePost({mode:"delete",hash:t.hash},false);BX.ajax.get(this.uploadFileUrl,s.data)}},this))}BX.onCustomEvent(window,"onUploaderIsInited",[this.id,this]);this.uploads=new BX.UploaderUtils.Hash;this.upload=null}}};BX.Uploader.prototype={init:function(e){this.log("input is initialized");if(!this.__beforeunload){this.__beforeunload=BX.delegate(function(){this.terminate()},this);BX.bind(window,"beforeunload",this.__beforeunload)}if(BX(e)){if(e==this.fileInput&&!this.form)this.form=this.fileInput.form;if(e==this.fileInput)e=this.fileInput=this.mkFileInput(e);else e=this.mkFileInput(e);BX.onCustomEvent(this,"onFileinputIsReinited",[e,this]);if(e){BX.bind(e,"change",BX.delegate(this.onChange,this));return true}}else if(e===null&&this.fileInput===null){this.log("Initialized && null");return true}return false},log:function(e){BX.UploaderUtils.log("uploader",e)},initDropZone:function(e){var t=null;if(!!BX.DD&&BX.type.isDomNode(e)&&e.parentNode){t=new BX.DD.dropFiles(e);if(t&&t.supported()&&BX.ajax.FormData.isSupported()){t.f={dropFiles:BX.delegate(this.onChange,this),dragEnter:function(){BX.addClass(t.DIV,"bxu-file-input-over")},dragLeave:function(){BX.removeClass(t.DIV,"bxu-file-input-over")}};BX.addCustomEvent(t,"dropFiles",t.f.dropFiles);BX.addCustomEvent(t,"dragEnter",t.f.dragEnter);BX.addCustomEvent(t,"dragLeave",t.f.dragLeave)}if(this.params["dropZone"]==e){this.dropZone=t}}return t},onAttach:function(e,t){if(typeof e!=="undefined"&&e.length>0){if(!this.params["doWeHaveStorage"])this.queue.clear();if(!BX.type.isArray(e)){var s=[];for(var i=0;i<e.length;i++){s.push(e[i])}e=s}BX.onCustomEvent(this,"onAttachFiles",[e,t,this]);var a=false,o,r;t=typeof t=="object"&&!!t&&t.length>0?t:[];for(var l=0,n;l<e.length;l++){n=e[l];if(BX(n)&&n.value){o=(n.value.name||"").split(".").pop()}else{o=(n.name||"").split(".").pop()}o=(BX.type.isNotEmptyString(o)?o:"").toLowerCase();r=(BX.type.isNotEmptyString(n["type"])?n["type"]:"").toLowerCase();if(this.limits["uploadFile"]=="image/*"&&(BX.type.isNotEmptyString(r)&&r.indexOf("image/")!==0||!BX.type.isNotEmptyString(r)&&this.params["imageExt"].indexOf(o)<0)||this.limits["uploadFileExt"].length>0&&this.limits["uploadFileExt"].indexOf(o)<0){continue}BX.onCustomEvent(this,"onItemIsAdded",[n,t[l]||null,this]);a=true}if(a){BX.onCustomEvent(this,"onItemsAreAdded",[this]);if(this.params["uploadMethod"]=="immediate")this.submit()}}return false},onChange:function(e){BX.PreventDefault(e);var t=e;if(e&&e.target)t=e.target.files;else if(!e&&BX(this.fileInput))t=this.fileInput.files;if(BX(this.fileInput)&&this.fileInput.disabled){BX.DoNothing()}else{this.init(e);this.onAttach(t)}return false},mkFileInput:function(e){if(!BX(e))return false;BX.unbindAll(e);var t=e.cloneNode(true);BX.adjust(t,{props:{value:""},attrs:{name:this.params["uploadInputName"]+"[]",multiple:this.params["filesInputMultiple"],accept:this.limits["uploadFile"],value:""}});e.parentNode.insertBefore(t,e);e.parentNode.removeChild(e);return t},preparePost:function(e,t){if(t===true&&this.params["uploadFormData"]=="Y"&&!this.post){var s={AJAX_POST:"Y",data:{}};s=this.form?BX.UploaderUtils.FormToArray(this.form,s):s;if(!!s.data[this.params["filesInputName"]]){s.data[this.params["filesInputName"]]=null;delete s.data[this.params["filesInputName"]]}if(!!s.data[this.params["uploadInputInfoName"]]){s.data[this.params["uploadInputInfoName"]]=null;delete s.data[this.params["uploadInputInfoName"]]}if(!!s.data[this.params["uploadInputName"]]){s.filesCount-=s.data[this.params["uploadInputName"]].length;s.data[this.params["uploadInputName"]]=null;delete s.data[this.params["uploadInputName"]]}if(this.limits["phpMaxFileUploads"]<=s.filesCount){BX.debug("You can not upload any file from your list.");return false}s.size=BX.UploaderUtils.sizeof(s.data);this.post=s}var i=t===true&&this.params["uploadFormData"]=="Y"?this.post:{data:{AJAX_POST:"Y"},filesCount:0,size:10},a=0;i.data["sessid"]=BX.bitrix_sessid();i.size+=6+BX.bitrix_sessid().length;if(e){i.data[this.params["uploadInputInfoName"]]={controlId:this.controlId,CID:this.CID,inputName:this.params["uploadInputName"]};for(var o in e){if(e.hasOwnProperty(o)){i.data[this.params["uploadInputInfoName"]][o]=e[o]}}a=BX.UploaderUtils.sizeof(this.params["uploadInputInfoName"])+BX.UploaderUtils.sizeof(i.data[this.params["uploadInputInfoName"]])}i.length=i.size+a;return i},submit:function(){this.start()},stop:function(){this.terminate()},adjustProcess:function(e,t,s,i,a){var o="",r=0;if(this.queue.itFailed.hasItem(t.id)){o="response [we do not work with errors]"}else if(s==statuses.error){delete t.progress;this.queue.itFailed.setItem(t.id,t);this.queue.itForUpload.removeItem(t.id);BX.onCustomEvent(this,"onFileIsUploadedWithError",[t.id,t,i,this,a]);BX.onCustomEvent(t,"onUploadError",[t,i,this,a]);o="response [error]"}else if(s==statuses.uploaded){delete t.progress;this.queue.itUploaded.setItem(t.id,t);this.queue.itForUpload.removeItem(t.id);BX.onCustomEvent(this,"onFileIsUploaded",[t.id,t,i,this,a]);BX.onCustomEvent(t,"onUploadDone",[t,i,this,a]);o="response [uploaded]"}else if(s==statuses.inprogress){if(typeof i=="number"){if(i==0&&t.progress.status==statuses["new"]){BX.onCustomEvent(t,"onUploadStart",[t,0,this,a]);t.progress.status=statuses.inprogress}r=t.progress.uploaded+t.progress.streams[e]*i/100}else{t.progress.uploaded+=t.progress.streams[e];t.progress.streams[e]=0;r=t.progress.uploaded}o="response [uploading]. Uploaded: "+r;BX.onCustomEvent(t,"onUploadProgress",[t,r,this,a])}else if(s==statuses.failed){if(t.progress.streams[e]==t.progress.percentPerChunk){t.progress=null;delete t.progress}else{t.progress.streams[e]-=t.progress.percentPerChunk/i.packages;t.progress.streams[e]=t.progress.streams[e]>0?t.progress.streams[e]:0}}else{if(s==statuses["new"]){var l=(t.getThumbs("getCount")>0?t.getThumbs("getCount"):0)+2;t.progress={percentPerChunk:100/l,streams:{},uploaded:0,status:statuses["new"]};t.progress.streams[e]=t.progress.percentPerChunk;o="request preparing [start]. Prepared: "+t.progress.streams[e]}else if(s==statuses.preparing){t.progress.streams[e]=t.progress.streams[e]>0?t.progress.streams[e]:0;t.progress.streams[e]+=t.progress.percentPerChunk/i.packages;o+="request preparing [cont]. Prepared: "+t.progress.streams[e]}else{o="request preparing [finish]. "}BX.onCustomEvent(t,"onUploadPrepared",[t,i,this,a])}this.log(t.name+": "+o)},terminate:function(e){var t,s;if(!e||e=="beforeunload"){s=this.uploads;this.uploads=new BX.UploaderUtils.Hash;this.upload=null;while((t=s.getFirst())&&t){s.removeItem(t.id);this.terminate(t)}return}else if(BX.type.isNotEmptyString(e)){t=this.uploads.removeItem(e)}else if(typeof e=="object"){t=e}if(t&&t["stop"]){t.stop();this.log(t.id+" Uploading is canceled");BX.onCustomEvent(this,"onTerminated",[t.id,t])}},start:function(){if(this.queue.itForUpload.length<=0){BX.onCustomEvent(this,"onStart",[null,{filesCount:0},this]);BX.onCustomEvent(this,"onDone",[null,null,{filesCount:0}]);BX.onCustomEvent(this,"onFinish",[null,null,{filesCount:0}]);return}var e="pIndex"+BX.UploaderUtils.getId(),t=this.queue.itForUpload;this.queue.itForUpload=new BX.UploaderUtils.Hash;this.post=false;this.log("create new package "+e);var s=new BX.UploaderPackage({id:e,data:t,post:this.preparePost({},true),uploadFileUrl:this.uploadFileUrl,limits:this.limits,params:this.params},this);BX.addCustomEvent(s,"adjustProcess",BX.proxy(this.adjustProcess,this));BX.addCustomEvent(s,"startStream",BX.proxy(function(e,t,s){BX.onCustomEvent(this,"startPackage",[e,t.id,s])},this));BX.addCustomEvent(s,"progressStream",BX.proxy(function(e,t,s){BX.onCustomEvent(this,"processPackage",[e,t.id,s])},this));BX.addCustomEvent(s,"doneStream",BX.proxy(function(e,t,s){BX.onCustomEvent(this,"donePackage",[e,t.id,s])},this));BX.addCustomEvent(s,"stopPackage",BX.proxy(function(e){this.log("restore files: "+e.data.length);this.queue.restoreFiles(e.data)},this));BX.addCustomEvent(s,"donePackage",BX.proxy(function(e,t,s){BX.onCustomEvent(this,"onDone",[e,t.id,t,s]);var i=this.checkUploads(t.id);if(!i)BX.onCustomEvent(this,"onFinish",[e,t.id,t,s])},this));BX.addCustomEvent(s,"errorPackage",BX.proxy(function(t,s,i){BX.onCustomEvent(this,"error",[t,e,i]);BX.onCustomEvent(this,"onError",[t,e,i]);this.checkUploads(s.id)},this));BX.addCustomEvent(s,"processPackage",BX.proxy(function(e,t,s){BX.onCustomEvent(this,"processPackage",[e,t,s])},this));BX.onCustomEvent(this,"onStart",[e,s,this]);this.uploads.setItem(e,s);this.checkUploads()},checkUploads:function(e){if(e)this.uploads.removeItem(e);this.upload=this.uploads.getFirst();if(this.upload)this.upload.start(this.streams);return this.upload},getItem:function(e){return this.queue.getItem(e)},getItems:function(){return this.queue.items},restoreItems:function(){this.queue.restoreFiles.apply(this.queue,arguments)},clear:function(){var e;while((e=this.queue.items.getFirst())&&e){e.deleteFile()}}};BX.UploaderSimple=function(e){BX.UploaderSimple.superclass.constructor.apply(this,arguments);this.dialogName="BX.UploaderSimple";this.previews=new BX.UploaderUtils.Hash;if(this.params["uploadMethod"]!="immediate"){BX.addCustomEvent(this,"onFileNeedsPreview",BX.delegate(function(e,t){this.previews.setItem(t.id,t);this.log("onFileNeedsPreview: "+t.id);setTimeout(BX.delegate(this.onFileNeedsPreview,this),500)},this));BX.addCustomEvent(this,"onStart",BX.delegate(function(e,t){if(t&&t.filesCount>0){var s=t.raw.getIds(),i;for(i=0;i<s.length;i++){this.previews.removeItem(s[i])}}},this))}else{BX.addCustomEvent(this,"onFileIsUploaded",BX.delegate(function(e,t,s){this.dealWithFile(t,s)},this))}this.streams=new BX.UploaderStreams(1,this);return this};BX.extend(BX.UploaderSimple,BX.Uploader);BX.UploaderSimple.prototype.preparePost=function(){var e=BX.UploaderSimple.superclass.preparePost.apply(this,arguments);if(e&&e.data&&e.data[this.params["uploadInputInfoName"]]&&!e.data[this.params["uploadInputInfoName"]]["simpleUploader"]){e.data[this.params["uploadInputInfoName"]]["simpleUploader"]="Y";e.size+=15}return e};BX.UploaderSimple.prototype.init=function(e,t){this.log("input is initialized: "+(t!==false?"drop":" does not drop"));if(BX(e)){if(e==this.fileInput&&!this.form)this.form=this.fileInput.form;if(e==this.fileInput)e=this.fileInput=this.mkFileInput(e,t);else e=this.mkFileInput(e,t);BX.onCustomEvent(this,"onFileinputIsReinited",[e,this]);if(e){BX.bind(e,"change",BX.delegate(this.onChange,this));return true}}else if(e===null&&this.fileInput===null){this.log("Initialized && null");return true}return false};BX.UploaderSimple.prototype.log=function(e){BX.UploaderUtils.log("simpleup",e)};BX.UploaderSimple.prototype.mkFileInput=function(e,t){if(!BX(e))return false;BX.unbindAll(e);var s=e.cloneNode(true);BX.adjust(s,{attrs:{id:"",name:this.params["uploadInputName"]+"[file"+BX.UploaderUtils.getId()+"][default]",multiple:false,accept:this.limits["uploadFile"]}});e.parentNode.insertBefore(s,e);if(t!==false)e.parentNode.removeChild(e);return s};BX.UploaderSimple.prototype.onChange=function(e){BX.PreventDefault(e);e=e.target||e.srcElement||this.fileInput;if(BX(this.fileInput)&&this.fileInput.disabled){BX.DoNothing()}else{this.init(e,false);this.onAttach([e])}return false};BX.UploaderSimple.prototype.dealWithFile=function(e,t){var s;if(t&&t["status"]=="uploaded"&&t["hash"]&&t["file"]&&t["file"]["files"]&&t["file"]["files"]["default"]){s=t["file"]["files"]["default"]}if(s){e.file={name:s["name"],"~name":s["~name"],size:parseInt(s["size"]),type:s["type"],id:e.id,hash:t["hash"],copy:"default",url:s["url"],uploadStatus:statuses.done};e.nonProcessRun=true;BX.onCustomEvent(e,"onFileHasGotPreview",[e.id,e])}else{BX.onCustomEvent(e,"onFileHasNotGotPreview",[e.id,e])}};BX.UploaderSimple.prototype.onFileNeedsPreviewCallback=function(e,t){if(!(t&&t["files"])){this.log("onFileNeedsPreviewCallback is failed.");return}this.log("onFileNeedsPreviewCallback");this.onFileNeedsPreview();var s;while((s=e.result.getFirst())&&!!s){e.result.removeItem(s.id);this.dealWithFile(s,t["files"][s.id])}};BX.UploaderSimple.prototype.onFileNeedsPreview=function(){this.log("onFileNeedsPreview");var e=new BX.UploaderUtils.Hash,t;while(e.length<this.limits["phpMaxFileUploads"]&&(t=this.previews.getFirst())&&t&&t!==null){this.previews.removeItem(t.id);e.setItem(t.id,t)}if(e.length>0){this.post=false;var s="pIndex"+BX.UploaderUtils.getId();this.log("create new package for preview "+s);var i=new BX.UploaderPackage({id:s,data:e,post:this.preparePost({type:"brief"},true),uploadFileUrl:this.uploadFileUrl,limits:this.limits,params:this.params});i["SimpleUploaderUploadsPreview"]="Y";BX.addCustomEvent(i,"adjustProcess",BX.proxy(function(e,t,s,i,a){if(s==statuses.error){this.adjustProcess(e,t,s,i,a)}},this));BX.addCustomEvent(i,"startStream",BX.proxy(function(e,t,s){BX.onCustomEvent(this,"startPackagePreview",[e,t.id,s])},this));BX.addCustomEvent(i,"progressStream",BX.proxy(function(e,t,s){BX.onCustomEvent(this,"processPackagePreview",[e,t.id,s])},this));BX.addCustomEvent(i,"doneStream",BX.proxy(function(e,t,s){BX.onCustomEvent(this,"donePackagePreview",[e,t.id,s])},this));BX.addCustomEvent(i,"stopPackage",BX.proxy(function(e){},this));BX.addCustomEvent(i,"donePackage",BX.proxy(function(e,t,s){this.checkUploads(t.id);this.onFileNeedsPreviewCallback(t,s)},this));BX.addCustomEvent(i,"errorPackage",BX.proxy(function(e,t,i){BX.onCustomEvent(this,"error",[e,s,i]);BX.onCustomEvent(this,"onError",[e,s,i]);this.checkUploads(t.id)},this));BX.addCustomEvent(i,"processPackage",BX.proxy(function(e,t,s){BX.onCustomEvent(this,"processPackagePreview",[e,t,s])},this));BX.onCustomEvent(this,"onStartPreview",[s,i,this]);this.uploads.setItem(s,i);this.checkUploads()}};BX.Uploader.isSupported=function(){return window.Blob||window["MozBlobBuilder"]||window["WebKitBlobBuilder"]||window["BlobBuilder"]};var objName="BX.UploaderSimple";if(BX.Uploader.isSupported())objName="BX.Uploader";BX.Uploader.getInstanceName=function(){return objName};BX.Uploader.getInstance=function(params){BX.onCustomEvent(window,"onUploaderIsAlmostInited",[objName,params]);return eval("new "+objName+"(params);")};BX.UploaderPackage=function(e,t){this.filesCount=0;this.length=0;e=e||{};this["pIndex"]=this.id=e["id"];this.limits=e["limits"];this.params=e["params"];this.status=statuses.ready;if(e["data"]&&e.data.length>0){this.length=e.data.length;this.filesCount=e.data.length;this.uploadFileUrl=e["uploadFileUrl"];this.raw=e.data;this.repo=new BX.UploaderUtils.Hash;this.data=new BX.UploaderUtils.Hash;this.result=new BX.UploaderUtils.Hash;this.init();this.post=e["post"];if(!this.post){var s;while((s=this.raw.getFirst())&&s){this.adjustProcess(null,s,statuses.error,{error:BX.message("UPLOADER_UPLOADING_ERROR2")});this.raw.removeItem(s.id)}BX.onCustomEvent(this,"errorPackage",[null,this,null])}else{var i,a={packageIndex:this.id,filesCount:this.filesCount,mode:"upload"};for(i in a){if(a.hasOwnProperty(i)){this.post.data[this.params["uploadInputInfoName"]][i]=a[i];this.post.size+=BX.UploaderUtils.sizeof(i)+BX.UploaderUtils.sizeof(a[i])}}this.post.startSize=this.post.size;BX.onCustomEvent(this,"initializePackage",[this,this.raw]);if(t)BX.onCustomEvent(t,"onPackageIsInitialized",[this,this.raw]);this.log("initialize")}}this._exec=BX.delegate(this.exec,this)};BX.UploaderPackage.prototype={checkFile:function(e){var t="";if(this.limits["uploadMaxFilesize"]>0&&e.file&&e.file.size>this.limits["uploadMaxFilesize"]){t=BX.message("FILE_BAD_SIZE")+" ("+BX.UploaderUtils.getFormattedSize(this.limits["uploadMaxFilesize"],2)+")"}return t},packStream:function(e){if(e.filesSize<=0)return null;var t=new BX.UploaderUtils.FormData,s,i=this.post.data,a=e.files,o;for(s in i){if(i.hasOwnProperty(s)){BX.UploaderUtils.appendToForm(t,s,i[s])}}for(var r in a){if(a.hasOwnProperty(r)){i=a[r];if(!!i.props){o=BX.UploaderUtils.prepareData(i.props);for(s in o){if(o.hasOwnProperty(s)){BX.UploaderUtils.appendToForm(t,this.params["uploadInputName"]+"["+r+"]["+s+"]",o[s])}}}if(!!i.files){for(var l=0;l<i.files.length;l++){s=i.files[l];s.copy=s.postName=s.thumb?s.thumb:"default";if(s.packages>0){s.postName+=".ch"+s.package+"."+(s.start>0?s.start:"0")+".chs"+s.packages}t.append(this.params["uploadInputName"]+"["+r+"]["+BX.UploaderUtils.prepareData(s.postName)+"]",s,BX.UploaderUtils.prepareData(s.postName))}}}}t.action=this.uploadFileUrl;return t},packFiles:function(e,t){if(!e)return statuses.error;else if(e["uploadStatus"]==statuses.done||e["uploadStatus"]==statuses.error)return e["uploadStatus"];var s=this.limits["phpMaxFileUploads"]-this.post.filesCount,i=this.limits["phpPostMaxSize"]-t.filesSize-t.postSize,a=this.limits["phpPostSize"]-t.filesSize,o,r,l={files:[]},n,p,u,h;while(i>0&&s>0&&a>0){r=null;o=null;p="";u=[];if(e.uploadStatus!=statuses.preparing){p=this.checkFile(e);if(p===""){l.props=e.getProps();if(e["restored"]){l.props["restored"]=e["restored"];delete e["restored"]}u.push(BX.proxy(function(){e.uploadStatus=statuses.preparing;this.adjustProcess(t.id,e,statuses["new"],{})},this))}else{l.props={name:e.name,error:true};this.adjustProcess(t.id,e,statuses.error,{error:p});e.uploadStatus=statuses.error}}if(e.uploadStatus==statuses.error){}else if(e.nonProcessRun===true){e.uploadStatus=statuses.done}else{if(!e["file"]){r=null}else if(e.file.uploadStatus!=statuses.done){r=e.file}else if(e["thumb"]&&e.thumb!==null){r=e.thumb}else{e.thumb=r=e.getThumbs(null)}var d=Object.prototype.toString.call(r);if(r===null){e.uploadStatus=statuses.done;this.adjustProcess(t.id,e,statuses.done,{});e.file.uploadStatus=statuses.done;e.thumb=null}else if(BX.type.isDomNode(r)){l.props=l.props||{name:e.name};l.files.push(r);u.push(BX.proxy(function(s){s.uploadStatus=statuses.done;if(e.file==s){this.adjustProcess(t.id,e,statuses.preparing,{canvas:"default","package":1,packages:1})}else{this.adjustProcess(t.id,e,statuses.preparing,{canvas:e.thumb.thumb,"package":1,packages:1});e.thumb=null}},this))}else if(!(d=="[object File]"||d=="[object Blob]")){l.props=l.props||{name:e.name};l.props["files"]=l.props["files"]||{};l.props["files"][r["thumb"]||"default"]=r;u.push(BX.proxy(function(s){s.uploadStatus=statuses.done;if(e.file==s){this.adjustProcess(t.id,e,statuses.preparing,{canvas:"default","package":1,packages:1})}else{this.adjustProcess(t.id,e,statuses.preparing,{canvas:e.thumb.thumb,"package":1,packages:1});e.thumb=null}},this))}else{o=BX.UploaderUtils.getFilePart(r,i-BX.UploaderUtils.sizeof({name:e.name}),this.limits["phpUploadMaxFilesize"]);if(!o){l.props="error";this.adjustProcess(t.id,e,statuses.error,{error:BX.message("FILE_BAD_SIZE")});e.uploadStatus=statuses.error}else{l.files.push(o);l.props=l.props||{name:e.name};u.push(BX.proxy(function(s,i){BX.UploaderUtils.applyFilePart(s,i);if(e.file==s&&i==s){this.adjustProcess(t.id,e,statuses.preparing,{canvas:"default","package":1,packages:1})}else if(e.file==s){this.adjustProcess(t.id,e,statuses.preparing,{canvas:"default","package":i.package+1,packages:i.packages,blob:i})}else if(i==s){this.adjustProcess(t.id,e,statuses.preparing,{canvas:e.thumb.thumb,"package":1,packages:1,blob:i});e.thumb=null}else{this.adjustProcess(t.id,e,statuses.preparing,{canvas:e.thumb.thumb,"package":i.package+1,packages:i.packages,blob:i});if(e.thumb.uploadStatus==statuses.done)e.thumb=null}},this))}}}if(l.files.length>0||l["props"]){n=BX.UploaderUtils.sizeof(l.files)+(l["props"]?BX.UploaderUtils.sizeof(l.props):0);i-=n;a-=n;if(i>=0&&a>0){while((h=u.shift())&&h)h(r,o,p);t.filesSize+=n;t.files[e.id]=BX.UploaderUtils.makeAnArray(t.files[e.id],l);if(l.files.length){s--;t.filesCount++}}else if(t.filesCount<=0){this.adjustProcess(t.id,e,statuses.error,{error:BX.message("UPLOADER_UPLOADING_ERROR4")});e.uploadStatus=statuses.error}l={files:[]}}if(e.uploadStatus!==statuses.preparing){break}}return e.uploadStatus},start:function(e){this.streams=e;if(this.status!=statuses.ready)return;this.status=statuses.inprogress;this.__onAllStreamsAreKilled=BX.delegate(function(e,t){this.stop();BX.onCustomEvent(this,"donePackage",[t,this,this["lastResponse"]])},this);BX.addCustomEvent(this.streams,"onrelease",this.__onAllStreamsAreKilled);BX.onCustomEvent(this,"startPackage",[this,e]);this.log("start");e.init(this,this._exec)},stop:function(){this.status=statuses.stopped;this.streams.stop();BX.onCustomEvent(this,"stopPackage",[this,this.repo]);BX.removeCustomEvent(this.streams,"onrelease",this.__onAllStreamsAreKilled);this.log("stop")},log:function(){BX.UploaderUtils.log("package",this.id,arguments)},init:function(){var e,t=BX.proxy(function(e,t){if(this.raw.removeItem(e)){this.data.setItem(e,t);this.repo.setItem(e,t);BX.onCustomEvent(t,"onFileHasToBePrepared",[t.id,t]);this.init()}},this);while((e=this.raw.getFirst())&&e){BX.addCustomEvent(e,"onFileIsDeleted",BX.delegate(function(e){this.length--;this.filesCount--;if(this.data.removeItem(e.id))this.post.data[this.params["uploadInputInfoName"]]["filesCount"]=this.filesCount;this.result.removeItem(e.id);this.repo.removeItem(e.id)},this));if(e.status===statuses["new"]){BX.addCustomEvent(e,"onFileIsInited",t);break}else{t(e.id,e)}}},exec:function(e,t){if(this.status!==statuses.inprogress)return;this.log("exec");var s,i=false;if(e.pack!=this){this.log("stream is bound: "+e.id);BX.addCustomEvent(e,"onsuccess",BX.delegate(this.doneStream,this));BX.addCustomEvent(e,"onfailure",BX.delegate(this.errorStream,this));BX.addCustomEvent(e,"onprogress",BX.delegate(this.progressStream,this))}if(t!==false){this.log("stream is reinited: "+e.id);e.init(this)}var a,o=e.filesCount;if(this.filesCount>0){while((s=this.data.getFirst())&&s){if(s.uploadStatus==statuses.done){}else if(s.preparationStatus!=statuses.done){i=true;break}a=this.packFiles(s,e);if(typeof a=="undefined"){break}else if(a!=statuses.error){o++;if(a==statuses.preparing){break}}this.data.removeItem(s.id);if(this["SimpleUploaderUploadsPreview"]=="Y"){delete s.uploadStatus}}if(i===true||!s&&this.raw.length>0){setTimeout(BX.proxy(function(){this.exec(e,false)},this),100);return}}var r=o>0?this.packStream(e):null;if(r!==null){this.log("stream is packed: "+e.id);this.startStreaming(e);e.send(r);this.sended=true}else{this.log("stream is killed: "+e.id);e.kill()}},adjustProcess:function(e,t,s,i){if(t&&this.repo.hasItem(t.id)){if(s==statuses.error||s==statuses.uploaded){this.data.removeItem(t.id);this.result.setItem(t.id,t)}BX.onCustomEvent(this,"adjustProcess",[e,t,s,i,this.id,this])}},adjustPostSize:function(e,t){var s=false,i=null;if(this.CEF)return s;var a=e.xhr.finishTime-e.xhr.startTime;if(t!==false){i=Math.ceil(a>0?(e.postSize+e.filesSize)*1e3/a*settings.estimatedTimeForUploadFile:0);if(i>this.limits["phpPostSize"]){i=Math.min(this.limits["phpPostSize"]*2,i,this.limits["phpPostMaxSize"])}}else if(this.limits["phpPostSize"]>settings.phpPostMinSize){i=Math.max(Math.ceil(this.limits["phpPostSize"]/2),settings.phpPostMinSize)}if(i>0&&i!==this.limits["phpPostSize"]){this.limits["phpPostSize"]=i;s=true}return s},startStreaming:function(e){this.log("start streaming");for(var t in e.files){if(e.files.hasOwnProperty(t)){this.adjustProcess(e.id,this.repo.getItem(t),statuses.inprogress,0)}}BX.onCustomEvent(this,"startStream",[e,this.id,e.files])},doneStream:function(e,t){this.adjustPostSize(e,true);var s=function(e,t){for(var i in t){if(t.hasOwnProperty(i)&&!e[i]){e[i]=t[i]}else if(typeof t[i]==typeof e[i]=="object"&&t[i]!==null&&e[i]!==null){e[i]=s(e[i],t[i])}}return e};this.response=s(this.response||{},t||{});var i,a,o,r,l,n,p;for(a in e.files){if(e.files.hasOwnProperty(a)){i=this.repo.getItem(a);if(i&&(o=t.files[a])){if(!o){this.queue.restoreFiles(new BX.UploaderUtils.Hash([i]))}else if(!o["status"]){if(BX.type.isArray(e.files[a]["files"])){p={};for(n=0;n<e.files[a]["files"].length;n++){o=e.files[a]["files"][n];if(p[o["copy"]])continue;p[o["copy"]]="Y";if(o["copy"]=="default"&&o["package"]<=0){this.queue.restoreFiles(new BX.UploaderUtils.Hash([i]));break}if(o["copy"]=="default"){i.uploadStatus=statuses.preparing;i.file["uploadStatus"]=statuses.preparing;i.file["package"]=o["package"]}if(i.file["copies"]){i.file["copies"].reset();var u;while((u=i.file["copies"].getNext())&&u){delete u["uploadStatus"];delete u["firstChunk"];delete u["package"];delete u["packages"]}i.file["copies"].reset()}}}}else if(o.status=="error"){this.adjustProcess(e.id,i,statuses.error,o)}else if((i.hash=o.hash)&&o.status=="uploaded"){this.adjustProcess(e.id,i,statuses.uploaded,o)}else{this.adjustProcess(e.id,i,statuses.inprogress,o);r=false;l=o["file"]&&o["file"]["files"]?o["file"]["files"]:false;if(typeof l=="object"){for(n in l){if(l.hasOwnProperty(n)){if(l[n]["chunksInfo"]&&l[n]["chunksInfo"]["count"]==l[n]["chunksInfo"]["uploaded"]&&l[n]["chunksInfo"]["count"]>l[n]["chunksInfo"]["written"]){r=true;break}}}i.nonProcessRun=r;if(r==true){if(!i["nonProcessRunLastTimeWritten"]||i["nonProcessRunLastTimeWritten"]!=l[n]["chunksInfo"]["written"]){i["nonProcessRunLastTimeWritten"]=l[n]["chunksInfo"]["written"];i["nonProcessRunLastTimeWrittenCount"]=0}else{i["nonProcessRunLastTimeWrittenCount"]++}if(i["nonProcessRunLastTimeWrittenCount"]<=10){delete i.uploadStatus;this.data.setItem(i.id,i)}else{this.adjustProcess(e.id,i,statuses.error,{error:BX.message("UPLOADER_UPLOADING_ERROR3")})}}}}}}}this.log("stream is done: "+e.id,t["status"],this.response);this["lastResponse"]=t;if(t["status"]=="inprogress"){BX.onCustomEvent(this,"continuePackage",[e,this,t])}else{if(t["status"]=="error")this.errorStream(e,t);else{this.stop();BX.onCustomEvent(this,"donePackage",[e,this,t])}}},errorStream:function(e,t){var s,i,a,o;this.log("error stream: "+e.id,"status: ",e.xhr.status,t);if(e&&t=="timeout"&&this.adjustPostSize(e,false)&&e["files"]){for(a in e["files"]){if(e["files"].hasOwnProperty(a)){if(this.repo.hasItem(a)&&BX.type.isArray(e["files"][a]["files"])&&e["files"][a]["files"].length>0){s=this.repo.getItem(a);if(e["files"][a]["files"][0]["package"]<=0||s["uploadStatus"]!==statuses.inprogress){delete s["uploadStatus"];delete s.file["uploadStatus"];delete s.file["firstChunk"];delete s.file["package"];delete s.file["packages"]}else{s.file["package"]=Math.min(e["files"][a]["files"][0]["package"],s.file["package"])}if(s.file["copies"]){s.file["copies"].reset();while((o=s.file["copies"].getNext())&&o){delete o["uploadStatus"];delete o["firstChunk"];delete o["package"];delete o["packages"]}s.file["copies"].reset()}if(!this.data.hasItem(a)){this.result.removeItem(a);this.data.unshiftItem(a,s)}}}}BX.onCustomEvent(this,"resendPackage",[e,this,t])}else{this.stop();var r=t=="timeout"?BX.message("UPLOADER_UPLOADING_ERROR5"):BX.message("UPLOADER_UPLOADING_ERROR1");t=t||{};t["files"]=t["files"]?t["files"]:{};if((s=this.repo.getFirst())&&s){do{if(!this.result.hasItem(s.id)){if(t.files&&t.files[s.id])i=t.files[s.id];else if(BX.type.isNotEmptyString(t["error"]))i=t;else i={error:r};this.adjustProcess(e.id,s,statuses.error,i)}}while((s=this.repo.getNext())&&s)}BX.onCustomEvent(this,"errorPackage",[e,this,t]);

}},progressStream:function(e,t){var s;e.files=e.files||{};for(s in e.files){if(e.files.hasOwnProperty(s)){this.adjustProcess(e.id,this.repo.getItem(s),statuses.inprogress,t)}}BX.onCustomEvent(this,"processPackage",[e,this,t])}};BX.UploaderStream=function(e,t){this.id="stream"+e;this._id=e;this.manager=t;this._onsuccess=BX.delegate(this.onsuccess,this);this._onfailure=BX.delegate(this.onfailure,this);this._onerror=BX.delegate(this.onerror,this);this._onprogress=BX.delegate(this.onprogress,this)};BX.UploaderStream.prototype={xhr:{},init:function(e){this["pIndex"]=e.id;this.pack=e;this.files={};this.filesCount=0;this.filesSize=0;this.postSize=e.post.size},send:function(e){if(e&&e.local===true){BX.adjust(e.form,{attrs:{action:e.action}});BX.ajax.submit(e.form,BX.proxy(function(e){e=BX.util.htmlspecialcharsback(e);while(/^<(.*?)>(.*?)<(.*?)>$/gi.test(e))e=e.replace(/^<(.*?)>(.*?)<(.*?)>$/gi,"$2");while(/^<([^<>]+)>(.*?)/gi.test(e))e=e.replace(/^<(.*?)>(.*?)/gi,"$2");while(/(.+?)<([^<>]+)>$/gi.test(e))e=e.replace(/(.+?)<([^<>]+)>$/gi,"$1");var t=BX.parseJSON(e,{});if(!!t){this.onsuccess(t)}else{this.onfailure(e)}},this));this.onprogress(90)}else if(e){this.xhr=BX.ajax({method:"POST",dataType:"json",data:e,url:e.action,onsuccess:this._onsuccess,onfailure:this._onfailure,onerror:this._onerror,start:false,preparePost:false,processData:true,timeout:settings.maxTimeForUploadFile});this.xhr.upload.addEventListener("progress",this._onprogress,false);var t=new Date;this.xhr.startTime=t.getTime();this.xhr.send(e)}else{this.onfailure(null)}},onsuccess:function(e){var t=new Date;this.xhr.finishTime=t.getTime();try{if(typeof e=="object"&&e&&e["files"]&&e["status"]!=="error")BX.onCustomEvent(this,"onsuccess",[this,e]);else BX.onCustomEvent(this,"onfailure",[this,e])}catch(s){BX.debug(s)}BX.onCustomEvent(this,"onrelease",[this])},onfailure:function(e){var t=new Date;this.xhr.finishTime=t.getTime();BX.onCustomEvent(this,"onfailure",[this,e]);BX.onCustomEvent(this,"onrelease",[this])},onerror:function(){this.xhr.finishTime=d.getTime();this.onfailure.apply(arguments)},onprogress:function(e){var t=15;if(typeof e=="object"&&e.lengthComputable){t=e.loaded*100/(e["total"]||e["totalSize"])}else if(e>t)t=e;t=t>5?t:5;BX.onCustomEvent(this,"onprogress",[this,t]);return t},kill:function(){BX.DoNothing();BX.onCustomEvent(this,"onkill",[this])},restore:function(){this.manager.restore(this)}};BX.UploaderStreams=function(e,t){this.streams=new BX.UploaderUtils.Hash;this.killedStreams=new BX.UploaderUtils.Hash;this.packages=new BX.UploaderUtils.Hash;this.uploaded=t;this.timeout=3e3;this._exec=BX.delegate(this.exec,this);this._restore=BX.delegate(this.restore,this);this._kill=BX.delegate(this.kill,this);this.count=Math.min(5,e>1?e:1);this.status=statuses.ready};BX.UploaderStreams.prototype={init:function(e,t){if(this.package!==e){this.package=e;this.package.log("streams are occupied",t);this.packages.setItem(e.id,e.post);this.handler=t;var s=this.count,i;while((i=this.streams.getFirst())&&i){this.streams.removeItem(i.id);i=null}this.streams=new BX.UploaderUtils.Hash;while(s-->0){i=new BX.UploaderStream(s,this);BX.addCustomEvent(i,"onrelease",this._restore);BX.addCustomEvent(i,"onkill",this._kill);this.streams.setItem(i.id,i)}}this.start()},exec:function(){if(this.status==statuses.ready){this.package.log("streams are in executing");var e=this.streams.getFirst();if(e){this.streams.removeItem(e.id);if(this.streams.length>0){setTimeout(this._exec,this.timeout)}this.handler(e)}}else{this.package.log("streams are locked")}},restore:function(e){this.streams.setItem(e.id,e);BX.defer_proxy(this.exec,this)()},kill:function(e){this.killedStreams.setItem(e.id,e);if(this.killedStreams.length==this.count){BX.onCustomEvent(this,"onrelease",[this,e])}},start:function(){this.status=statuses.ready;this.exec()},stop:function(){this.status=statuses.stopped}}})(window);
/* End */
;
; /* Start:"a:4:{s:4:"full";s:62:"/bitrix/js/main/core/core_uploader/file.min.js?145227743017963";s:6:"source";s:42:"/bitrix/js/main/core/core_uploader/file.js";s:3:"min";s:46:"/bitrix/js/main/core/core_uploader/file.min.js";s:3:"map";s:46:"/bitrix/js/main/core/core_uploader/file.map.js";}"*/
(function(e){if(e.BX["UploaderFile"])return false;var t=e.BX,i={"new":0,ready:1,preparing:2,inprogress:3,done:4,failed:5,stopped:6,changed:7,uploaded:8},s=function(e){this.timeLimit=typeof e=="number"&&e>0?e:50;this.status=i.ready;this.queue=new t.UploaderUtils.Hash};s.prototype={image:null,getImage:function(){if(!this.image)this.image=new Image;return this.image},canvas:null,getCanvas:function(){if(!this.canvas)this.canvas=t.create("CANVAS");return this.canvas},context:null,getContext:function(){if(!this.context&&this.getCanvas()["getContext"])this.context=this.getCanvas().getContext("2d");return this.context},reader:null,getReader:function(){if(!this.reader&&e["FileReader"])this.reader=new FileReader;return this.reader},load:function(i,s,a,h){var n=this.getImage();t.unbindAll(n);this.onload=null;delete this.onload;this.onerror=null;delete this.onerror;n.src="/bitrix/images/1.gif";this.onload=t.delegate(function(){if(!!s){try{s(t.proxy_context,this.getCanvas(),this.getContext())}catch(e){t.debug(e)}}if(!!a){this.queue.removeItem(a);setTimeout(t.proxy(this.exec,this),this.timeLimit)}},this);this.onerror=t.delegate(function(){if(!!h){try{h(t.proxy_context)}catch(e){t.debug(e)}}if(!!a){this.queue.removeItem(a);setTimeout(t.proxy(this.exec,this),this.timeLimit)}},this);n.name=i.name;t.bind(n,"load",this.onload);t.bind(n,"error",this.onerror);var r=Object.prototype.toString.call(i);if(i["tmp_url"]){n.src=i["tmp_url"]}else if(r!=="[object File]"&&r!=="[object Blob]"){this.onerror(null)}else if(!!e["URL"]){n.src=e["URL"]["createObjectURL"](i)}else if(this.getReader()!==null){this.__readerOnLoad=t.delegate(function(e){n.src=e.target.result;this.__readerOnLoad=null;delete this.__readerOnLoad},this);this.getReader().onload=this.__readerOnLoad;this.getReader().readAsDataURL(i)}},push:function(e,i,s){var a=t.UploaderUtils.getId();this.queue.setItem(a,[a,e,i,s]);this.exec()},exec:function(){var e=this.queue.getFirst();if(!!e)this.load(e[1],e[2],e[0],e[3])}};t.UploaderFileCnvConstr=s;var a=function(e){this.timeLimit=typeof e=="number"&&e>0?e:50;this.status=i.ready;this.queue=new t.UploaderUtils.Hash;this._exec=t.delegate(this.exec,this)};a.prototype={xhr:null,goToNext:function(e){delete this.xhr;this.xhr=null;this.queue.removeItem(e);this.status=i.ready;setTimeout(this._exec,this.timeLimit)},load:function(e,s,a,h){if(this.status!=i.ready)return;this.status=i.inprogress;var n=this;this.xhr=t.ajax({method:"GET",data:"",url:s,onsuccess:function(t){if(t===null){h(t)}else{a(t)}n.goToNext(e)},onfailure:function(t){h(t);n.goToNext(e)},start:false,preparePost:false,processData:false});this.xhr.withCredentials=true;this.xhr.responseType="blob";this.xhr.send()},push:function(e,i,s){var a=t.UploaderUtils.getId();this.queue.setItem(a,[a,e,i,s]);this.exec()},exec:function(){var e=this.queue.getFirst();if(!!e)this.load(e[0],e[1],e[2],e[3])}};t.UploaderFileFileLoader=a();var h=new s,n=new s,r=new s,l=t.create("CANVAS"),o;t.UploaderFile=function(e,s,a,h){this.dialogName="BX.UploaderFile";this.file=e;this.id=e["id"]||"file"+t.UploaderUtils.getId();this.name=e.name;this.isNode=false;if(t.type.isDomNode(e)){this.isNode=true;this.name=t.UploaderUtils.getFileNameOnly(e.value);if(/\[(.+?)\]/.test(e.name)){var n=/\[(.+?)\]/.exec(e.name);this.id=n[1]}this.file.bxuHandler=this}else if(e["tmp_url"]&&!e["name"]){this.name=t.UploaderUtils.getFileNameOnly(e["tmp_url"])}this.preview='<span id="'+this.id+'Canvas" class="bx-bxu-canvas"></span>';this.nameWithoutExt=this.name.lastIndexOf(".")>0?this.name.substr(0,this.name.lastIndexOf(".")):this.name;this.ext=this.name.substr(this.nameWithoutExt.length+1);this.size="";if(e.size)this.size=t.UploaderUtils.getFormattedSize(e.size,0);this.type=e.type;this.status=i["new"];this.limits=a;this.caller=h;this.fields={thumb:{tagName:"SPAN",template:'<div class="someclass">#preview#<div>#name#</div>',editorTemplate:'<div class="someeditorclass"><div>#name#</div>',className:"bx-bxu-thumb-thumb",placeHolder:null},preview:{params:{width:400,height:400},template:"#preview#",editorParams:{width:1024,height:860},editorTemplate:"<span>#preview#</span>",className:"bx-bxu-thumb-preview",placeHolder:null,events:{click:t.delegate(this.clickFile,this)}},name:{template:"#name#",editorTemplate:'<span><input type="text" name="name" value="#name#" /></span>',className:"bx-bxu-thumb-name",placeHolder:null},type:{template:"#type#",editorTemplate:"#type#",className:"bx-bxu-thumb-type",placeHolder:null}};if(!!s["fields"]){var r,l;for(var o in s["fields"]){if(s["fields"].hasOwnProperty(o)){if(!!this.fields[o]){for(r in s["fields"][o]){if(s["fields"][o].hasOwnProperty(r)){this.fields[o][r]=s["fields"][o][r]}}}else this.fields[o]=s["fields"][o];l=o+"";if(l.toLowerCase()!="thumb"&&l.toLowerCase()!="preview"){this[l.toLowerCase()]=!!s["fields"][o]["value"]?s["fields"][o]["value"]:"";this.log(l.toLowerCase()+": "+this[l.toLowerCase()])}}}}t.onCustomEvent(this,"onFileIsCreated",[this.id,this,this.caller]);t.onCustomEvent(this.caller,"onFileIsCreated",[this.id,this,this.caller]);this.makePreview();this.preparationStatus=i.done;return this};t.UploaderFile.prototype={log:function(e){t.UploaderUtils.log("file "+this.name,e)},makeThumb:function(){var e=this.fields.thumb.template,i,s,a={},h,n;for(s in this.fields){if(this.fields.hasOwnProperty(s)){if(this.fields[s].template&&this.fields[s].template.indexOf("#"+s+"#")>=0){i=this.id+s.toUpperCase().substr(0,1)+s.substr(1);h=this.setProps(s,this[s],true);e=e.replace("#"+s+"#",'<span id="'+i+'" class="'+this.fields[s]["className"]+'">'+h.html+"</span>");for(n in h.events){if(h.events.hasOwnProperty(n)){a[n]=h.events[n]}}if(!!this.fields[s].events)a[i]=this.fields[s].events}}}var r,l=[],o=[],d;while((r=/#(.+?)#/gi.exec(e))&&!!r){if(this[r[1]]!==undefined)e=e.replace(r[0],this[r[1]]);else{d="<"+l.length+">";l.push(d);o.push(r[0]);e=e.replace(r[0],d)}}while((r=l.shift())&&r){d=o.shift();e=e.replace(r,d)}if(!!this.fields.thumb.tagName){r=t.create(this.fields.thumb.tagName,{attrs:{id:this.id+"Thumb",className:this.fields.thumb.className},events:this.fields.thumb.events,html:e})}else{r=e}this.__makeThumbEventsObj=a;this.__makeThumbEvents=t.delegate(function(){var e,i;for(e in a){if(a.hasOwnProperty(e)&&t(e)){for(i in a[e]){if(a[e].hasOwnProperty(i)){t.bind(t(e),i,a[e][i])}}}}this.__makeThumbEvents=null;delete this.__makeThumbEvents},this);t.addCustomEvent(this,"onFileIsAppended",this.__makeThumbEvents);if(t.type.isDomNode(this.file)){if(t.type.isString(e)){this.__bindFileNode=t.delegate(function(e){var i=t(e+"Item");if(i.tagName=="TR")i.cells[0].appendChild(this.file);else if(i.tagName=="TABLE")i.rows[0].cells[0].appendChild(this.file);else t(e+"Item").appendChild(this.file);this.__bindFileNode=null;delete this.__bindFileNode},this);t.addCustomEvent(this,"onFileIsAppended",this.__bindFileNode)}else{r.appendChild(this.file)}}return r},checkProps:function(){var e=t.UploaderUtils.FormToArray({elements:[t.proxy_context]}),i;for(i in e.data){if(e.data.hasOwnProperty(i))this[i]=e.data[i]}},setProps:function(e,i,s){if(typeof e=="string"){if(e=="size")i=t.UploaderUtils.getFormattedSize(this.file.size,0);if(typeof this[e]!="undefined"&&typeof this.fields[e]!="undefined"){this[e]=i;var a=this.fields[e].template.replace("#"+e+"#",!!i?i:"").replace(/#id#/gi,this.id),h,n,r,l={html:a,events:{}};this.hiddenForm=!!this.hiddenForm?this.hiddenForm:t.create("FORM",{style:{display:"none"}});this._checkProps=!!this._checkProps?this._checkProps:t.delegate(this.checkProps,this);this.hiddenForm.innerHTML=a;if(this.hiddenForm.elements.length>0){for(h=0;h<this.hiddenForm.elements.length;h++){r=this.hiddenForm.elements[h];if(typeof this[r.name]!="undefined"){if(!r.hasAttribute("id"))r.setAttribute("id",this.id+e+t.UploaderUtils.getId());l.events[r.id]={blur:this._checkProps}}}l.html=this.hiddenForm.innerHTML}if(t(this.hiddenForm))t.remove(this.hiddenForm);this.hiddenForm=null;delete this.hiddenForm;if(s)return l;var o=this.getPH(e);if(!!o){o.innerHTML=l.html;for(h in l.events){if(l.events.hasOwnProperty(h)){for(n in l.events[h]){if(l.events[h].hasOwnProperty(n)){t.bind(t(h),n,l.events[h][n])}}}}}}}else if(!!e){for(var d in e){if(e.hasOwnProperty(d)){if(this.fields.hasOwnProperty(d)&&d!=="preview")this.setProps(d,e[d])}}}return true},getProps:function(e){if(e=="canvas"){return t(this.id+"ProperCanvas")}else if(typeof e=="string"){return this[e]}var i={};for(var s in this.fields){if(this.fields.hasOwnProperty(s)&&(s!=="preview"&&s!=="thumb")){i[s]=this[s]}}if(!!this.copies){var a;i["canvases"]={};while((a=this.copies.getNext())&&!!a){i["canvases"][a.id]={width:a.width,height:a.height,name:a.name}}}return i},getThumbs:function(){return null},getPH:function(e){e=typeof e==="string"?e:"";e=e.toLowerCase();if(this.fields.hasOwnProperty(e)){var i=e.substr(0,1).toUpperCase()+e.substr(1);this.fields[e]["placeHolder"]=t(this.id+i);return this.fields[e]["placeHolder"]}return null},clickFile:function(){return false},makePreview:function(){this.status=i.ready;t.onCustomEvent(this,"onFileIsInited",[this.id,this,this.caller]);t.onCustomEvent(this.caller,"onFileIsInited",[this.id,this,this.caller]);this.log("is initialized as a file")},preparationStatus:i.ready,deleteFile:function(){var e,i=this.__makeThumbEventsObj;for(e in this.fields){if(this.fields.hasOwnProperty(e)){if(!!this.fields[e]["placeHolder"]){this.fields[e]["placeHolder"]=null;t.unbindAll(this.fields[e]["placeHolder"]);delete this.fields[e]["placeHolder"]}}}for(e in i){if(i.hasOwnProperty(e)&&t(e)){t.unbindAll(t(e))}}this.file=null;delete this.file;t.remove(this.canvas);this.canvas=null;delete this.canvas;t.onCustomEvent(this.caller,"onFileIsDeleted",[this.id,this,this.caller]);t.onCustomEvent(this,"onFileIsDeleted",[this,this.caller])}};t.UploaderImage=function(e,s,a,h){t.UploaderImage.superclass.constructor.apply(this,arguments);this.dialogName="BX.UploaderImage";this.isImage=true;this.copies=new t.UploaderUtils.Hash;this.caller=h;if(!this.isNode&&t.Uploader.getInstanceName()=="BX.Uploader"){if(!!s["copies"]){var r=s["copies"],l;for(var o in r){if(r.hasOwnProperty(o)&&!!r[o]){l={width:parseInt(r[o]["width"]),height:parseInt(r[o]["height"]),id:o};if(l["width"]>0&&l["height"]>0){this.copies.setItem(o,l)}}}}this.preparationStatus=i["new"];t.addCustomEvent(this,"onFileHasToBePrepared",t.delegate(function(){this.preparationStatus=i.inprogress;if(this.status!=i["new"]){n.push(this.file,t.delegate(this.makeCopies,this))}},this));t.addCustomEvent(this,"onUploadDone",t.delegate(function(){var e;while((e=this.copies.getNext())&&!!e){e.file=null;delete e.file}this.preparationStatus=i["new"]},this));this.canvas=t.create("CANVAS",{attrs:{id:this.id+"ProperCanvas"}})}else{this.preparationStatus=i.done;this.canvas=null}return this};t.extend(t.UploaderImage,t.UploaderFile);t.UploaderImage.prototype.makePreviewImageWork=function(e){var i=null;if(this.file){this.file.width=e.width;this.file.height=e.height}if(!!this.canvas){t.adjust(h.getCanvas(),{props:{width:e.width,height:e.height}});h.getContext().drawImage(e,0,0);this.applyFile(h.getCanvas(),false);i=this.canvas}else if(t(this.id+"Canvas")){var s=t.UploaderUtils.scaleImage(e,this.fields.preview.params),a={props:{width:s.destin.width,height:s.destin.height,src:e.src},attrs:{className:this.file.width>this.file.height?"landscape":"portrait"}};i=t.create("IMG",a)}t.onCustomEvent(this,"onFileCanvasIsLoaded",[this.id,this,this.caller,e]);t.onCustomEvent(this.caller,"onFileCanvasIsLoaded",[this.id,this,this.caller,e]);if(t(this.id+"Canvas"))t(this.id+"Canvas").appendChild(i);return i};t.UploaderImage.prototype.makePreviewImageLoadHandler=function(e,s,a){this.makePreviewImageWork(e);this.status=i.ready;t.onCustomEvent(this,"onFileIsInited",[this.id,this,this.caller]);t.onCustomEvent(this.caller,"onFileIsInited",[this.id,this,this.caller]);this.log("is initialized as an image with preview");if(this.preparationStatus==i.inprogress)this.makeCopies(e,s,a);if(this["_makePreviewImageLoadHandler"]){this._makePreviewImageLoadHandler=null;delete this._makePreviewImageLoadHandler}if(this["_makePreviewImageFailedHandler"]){this._makePreviewImageFailedHandler=null;delete this._makePreviewImageFailedHandler}};t.UploaderImage.prototype.makePreviewImageFailedHandler=function(){this.status=i.ready;this.preparationStatus=i.done;t.onCustomEvent(this,"onFileIsInited",[this.id,this,this.caller]);t.onCustomEvent(this.caller,"onFileIsInited",[this.id,this,this.caller]);this.log("is initialized without canvas");if(this["_makePreviewImageLoadHandler"]){this._makePreviewImageLoadHandler=null;delete this._makePreviewImageLoadHandler}if(this["_makePreviewImageFailedHandler"]){this._makePreviewImageFailedHandler=null;delete this._makePreviewImageFailedHandler}};t.UploaderImage.prototype.makePreview=function(){if(!this.isNode){this._makePreviewImageLoadHandler=t.delegate(this.makePreviewImageLoadHandler,this);this._makePreviewImageFailedHandler=t.delegate(this.makePreviewImageFailedHandler,this);h.push(this.file,this._makePreviewImageLoadHandler,this._makePreviewImageFailedHandler)}else{this.status=i.ready;t.onCustomEvent(this,"onFileIsInited",[this.id,this,this.caller]);t.onCustomEvent(this.caller,"onFileIsInited",[this.id,this,this.caller]);this.log("is initialized as an image without preview");if(this.caller.queue.placeHolder){this._onFileHasGotPreview=t.delegate(function(e,i){t.removeCustomEvent(this,"onFileHasGotPreview",this._onFileHasGotPreview);t.removeCustomEvent(this,"onFileHasNotGotPreview",this._onFileHasNotGotPreview);this._makePreviewImageLoadHandler=t.delegate(function(e){e=this.makePreviewImageWork(e);t.onCustomEvent(this,"onFileHasPreview",[i.id,i,e]);delete this._makePreviewImageLoadHandler;delete this._makePreviewImageFailedHandler},this);this._makePreviewImageFailedHandler=t.delegate(function(e){delete this._makePreviewImageLoadHandler;delete this._makePreviewImageFailedHandler},this);h.push({tmp_url:i.file.url},this._makePreviewImageLoadHandler,this._makePreviewImageFailedHandler)},this);this._onFileHasNotGotPreview=t.delegate(function(e){if(e==this.id){t.removeCustomEvent(this,"onFileHasGotPreview",this._onFileHasGotPreview);t.removeCustomEvent(this,"onFileHasNotGotPreview",this._onFileHasNotGotPreview)}},this);t.addCustomEvent(this,"onFileHasGotPreview",this._onFileHasGotPreview);t.addCustomEvent(this,"onFileHasNotGotPreview",this._onFileHasNotGotPreview);t.onCustomEvent(this.caller,"onFileNeedsPreview",[this.id,this,this.caller])}}return true};t.UploaderImage.prototype.checkPreview=function(){};t.UploaderImage.prototype.applyFile=function(e,s){this.checkPreview();if(!!s&&s.data)this.setProps(s.data);var a=t.UploaderUtils.scaleImage(e,{width:this.limits["uploadFileWidth"],height:this.limits["uploadFileHeight"]}),h=t.UploaderUtils.scaleImage(e,this.fields.preview.params),n={props:{width:h.destin.width,height:h.destin.height},attrs:{className:"bx-bxu-proper-canvas"+(h.destin.width>h.destin.height?" landscape":" portrait")}};if(a.bNeedCreatePicture||!!s){t.adjust(l,{props:{width:a.destin.width,height:a.destin.height}});o=l.getContext("2d");o.drawImage(e,a.source.x,a.source.y,a.source.width,a.source.height,a.destin.x,a.destin.y,a.destin.width,a.destin.height);var r=l.toDataURL(this.file.type);this.file=t.UploaderUtils.dataURLToBlob(r)}this.file.name=this.name;this.file.width=a.destin.width;this.file.height=a.destin.height;t.adjust(this.canvas,n);o=this.canvas.getContext("2d");o.drawImage(e,h.source.x,h.source.y,h.source.width,h.source.height,h.destin.x,h.destin.y,h.destin.width,h.destin.height);o=null;e=null;this.setProps("size");this.status=i.changed};t.UploaderImage.prototype.clickFile=function(){if(!this.canvas||!t["CanvasEditor"]||this.status==i["new"])return false;if(!this.__showEditor){this.__showEditor=t.delegate(this.showEditor,this);this.eFunc={apply:t.delegate(this.applyFile,this),"delete":t.delegate(this.deleteFile,this),clear:t.delegate(function(){t.removeCustomEvent(h,"onApplyCanvas",this.eFunc["apply"]);t.removeCustomEvent(h,"onDeleteCanvas",this.eFunc["delete"]);t.removeCustomEvent(h,"onClose",this.eFunc["clear"])},this)}}var e=this.fields.thumb.editorTemplate,s;for(var a in this.fields){if(this.fields.hasOwnProperty(a)){s=a.substr(0,1).toUpperCase()+a.substr(1);e=e.replace("#"+a+"#",a==="preview"?"":'<span id="'+this.id+s+'Editor" class="'+this.fields[a]["className"]+'">'+this.fields[a]["editorTemplate"].replace("#"+a+"#",!!this[a]?this[a]:"")+"</span>")}}t.adjust(r.getCanvas(),{props:{width:this.file.width,height:this.file.height}});r.getContext().drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,0,0,r.getCanvas().width,r.getCanvas().height);var h=t.CanvasEditor.show(r.getCanvas(),{title:this.name,template:e});t.addCustomEvent(h,"onApplyCanvas",this.eFunc["apply"]);t.addCustomEvent(h,"onDeleteCanvas",this.eFunc["delete"]);t.addCustomEvent(h,"onClose",this.eFunc["clear"]);t.onCustomEvent(this,"onCanvasEditorIsCreated",[h,this]);r.push(this.file,this.__showEditor);this.editor=h;return false};t.UploaderImage.prototype.showEditor=function(e,i,s){t.adjust(i,{props:{width:this.file.width,height:this.file.height}});s.drawImage(e,0,0);this.editor.copyCanvas(i)};t.UploaderImage.prototype.makeCopies=function(e,s,a){var h,n,r,l;while((h=this.copies.getNext())&&!!h){n=t.UploaderUtils.scaleImage(e,h);t.adjust(s,{props:{width:n.destin.width,height:n.destin.height}});a.drawImage(e,n.source.x,n.source.y,n.source.width,n.source.height,n.destin.x,n.destin.y,n.destin.width,n.destin.height);r=s.toDataURL(this.file.type);l=t.UploaderUtils.dataURLToBlob(r);l.width=s.width;l.height=s.height;l.name=this.name;l.thumb=h.id;l.canvases=this.copies.length;l.canvas=this.copies.pointer-1;h.file=l}this.preparationStatus=i.done};t.UploaderImage.prototype.getThumbs=function(e){if(e=="getCount")return this.copies.length;var t=typeof e=="string"?this.copies.getItem(e):this.copies.getNext();if(!!t)return t.file;return null};return true})(window);
/* End */
;
; /* Start:"a:4:{s:4:"full";s:63:"/bitrix/js/main/core/core_uploader/queue.min.js?145227743010121";s:6:"source";s:43:"/bitrix/js/main/core/core_uploader/queue.js";s:3:"min";s:47:"/bitrix/js/main/core/core_uploader/queue.min.js";s:3:"map";s:47:"/bitrix/js/main/core/core_uploader/queue.map.js";}"*/
(function(e){if(e.BX["UploaderQueue"])return false;var t=e.BX,i={"new":0,ready:1,preparing:2,inprogress:3,done:4,failed:5,stopped:6,changed:7,uploaded:8};t.UploaderQueue=function(e,i,s){this.dialogName="BX.UploaderQueue";i=!!i?i:{};this.limits={phpPostMaxSize:i["phpPostMaxSize"],phpUploadMaxFilesize:i["phpUploadMaxFilesize"],uploadMaxFilesize:i["uploadMaxFilesize"]>0?i["uploadMaxFilesize"]:0,uploadFileWidth:i["uploadFileWidth"]>0?i["uploadFileWidth"]:0,uploadFileHeight:i["uploadFileHeight"]>0?i["uploadFileHeight"]:0};this.placeHolder=t(e["placeHolder"]);this.showImage=e["showImage"]!==false;this.sortItems=e["sortItems"]!==false;this.uploader=s;this.itForUpload=new t.UploaderUtils.Hash;this.items=new t.UploaderUtils.Hash;this.itUploaded=new t.UploaderUtils.Hash;this.itFailed=new t.UploaderUtils.Hash;this.thumb={tagName:"LI",className:"bx-bxu-thumb-thumb"};if(!!e["thumb"]){for(var r in e["thumb"]){if(e["thumb"].hasOwnProperty(r)&&this.thumb.hasOwnProperty(r)){this.thumb[r]=e["thumb"][r]}}}t.addCustomEvent(s,"onItemIsAdded",t.delegate(this.addItem,this));t.addCustomEvent(s,"onItemsAreAdded",t.delegate(this.finishQueue,this));t.addCustomEvent(s,"onFileIsDeleted",t.delegate(this.deleteItem,this));t.addCustomEvent(s,"onFileIsReinited",t.delegate(this.reinitItem,this));this.log("Initialized");return this};t.UploaderQueue.prototype={showError:function(e){this.log("Error! "+e)},log:function(e){t.UploaderUtils.log("queue",e)},addItem:function(s,r){var a;if(!this.showImage)a=false;else if(t.type.isDomNode(s))a=t.UploaderUtils.isImage(s.value,null,null);else a=t.UploaderUtils.isImage(s["name"],s["type"],s["size"]);t.onCustomEvent(this.uploader,"onFileIsBeforeCreated",[s,r,a,this.uploader]);var d={copies:this.uploader.fileCopies,fields:this.uploader.fileFields},o=a?new t.UploaderImage(s,d,this.limits,this.uploader):new t.UploaderFile(s,d,this.limits,this.uploader),l,n,h={status:i.ready};t.onCustomEvent(o,"onFileIsAfterCreated",[o,r,h,this.uploader]);t.onCustomEvent(this.uploader,"onFileIsAfterCreated",[o,r,h,this.uploader]);this.items.setItem(o.id,o);if(r||h["status"]!==i.ready){this.itUploaded.setItem(o.id,o)}else{this.itForUpload.setItem(o.id,o)}if(!!this.placeHolder){if(t(r)){o.thumbNode=n=t(r)}else{l=o.makeThumb();n=t.create(this.thumb.tagName,{attrs:{id:o.id+"Item","bx-bxu-item-id":o.id,className:this.thumb.className}});if(t.type.isNotEmptyString(l)){if(this.thumb.tagName=="TR"){l=l.replace(/[\n\t]/gi,"").replace(/^(\s+)(.*?)/gi,"$2").replace(/(.*?)(\s+)$/gi,"$1");if(!!l["trim"])l=l.trim();var u=function(e,t,i){var s=n.insertCell(-1),r={colspan:true,headers:true,accesskey:true,"class":true,contenteditable:true,contextmenu:true,dir:true,hidden:true,id:true,lang:true,spellcheck:true,style:true,tabindex:true,title:true,translate:true},a;s.innerHTML=i;t=t.split(" ");while((a=t.pop())&&a){a=a.split("=");if(a.length==2){a[0]=a[0].replace(/^(\s+)(.*?)/gi,"$2").replace(/(.*?)(\s+)$/gi,"$1").replace(/^["'](.*?)["']$/gi,"$1");a[1]=a[1].replace(/^(\s+)(.*?)/gi,"$2").replace(/(.*?)(\s+)$/gi,"$1").replace(/^["'](.*?)["']$/gi,"$1");if(r[a[0]]===true)s.setAttribute(a[0],a[1]);else s[a[0]]=a[1]}}return""},p=/^<td(.*?)>(.*?)<\/td>/i;e.data1=l;while(p.test(l))l=l.replace(p,u)}else{n.innerHTML=l}}else if(t.type.isDomNode(l)){t.adjust(n,{children:[l]})}}if(!!e["jsDD"]&&this.sortItems){if(!this._onbxdragstart){this._onbxdragstart=t.delegate(this.onbxdragstart,this);this._onbxdragstop=t.delegate(this.onbxdragstop,this);this._onbxdrag=t.delegate(this.onbxdrag,this);this._onbxdraghout=t.delegate(this.onbxdraghout,this);this._onbxdestdraghover=t.delegate(this.onbxdestdraghover,this);this._onbxdestdraghout=t.delegate(this.onbxdestdraghout,this);this._onbxdestdragfinish=t.delegate(this.onbxdestdragfinish,this)}t.addClass(n,"bx-drag-draggable");n.onbxdragstart=this._onbxdragstart;n.onbxdragstop=this._onbxdragstop;n.onbxdrag=this._onbxdrag;n.onbxdraghout=this._onbxdraghout;e.jsDD.registerObject(n);n.onbxdestdraghover=this._onbxdestdraghover;n.onbxdestdraghout=this._onbxdestdraghout;n.onbxdestdragfinish=this._onbxdestdragfinish;e.jsDD.registerDest(n)}n.setAttribute("bx-item-id",o.id);if(t(r)){t.onCustomEvent(this.uploader,"onFileIsBound",[o.id,o,this.caller,r]);t.onCustomEvent(o,"onFileIsBound",[o.id,o,this.caller,r])}else if(!!r){this.placeHolder.appendChild(n);t.onCustomEvent(this.uploader,"onFileIsAttached",[o.id,o,this.caller,r]);t.onCustomEvent(o,"onFileIsAttached",[o.id,o,this.caller,r])}else{this.placeHolder.appendChild(n);t.onCustomEvent(this.uploader,"onFileIsAppended",[o.id,o,this.caller]);t.onCustomEvent(o,"onFileIsAppended",[o.id,o,this.caller])}}t.onCustomEvent(this.uploader,"onQueueIsChanged",[this,"add",o.id,o])},getItem:function(e){var i=this.items.getItem(e);if(i)return{item:i,node:i.thumbNode||t(e+"Item")};return null},onbxdragstart:function(){var e=t.proxy_context,i=e&&e.getAttribute("bx-item-id");if(i){var s=e.innerHTML.replace(new RegExp(i,"gi"),"DragCopy");e.__dragCopyDiv=t.create("DIV",{attrs:{className:"bx-drag-object "+e.className},style:{position:"absolute",zIndex:10,width:e.clientWidth+"px"},html:s});e.__dragCopyPos=t.pos(e);t.onCustomEvent(this.uploader,"onBxDragStart",[e,e.__dragCopyDiv]);document.body.appendChild(e.__dragCopyDiv);t.addClass(e,"bx-drag-source");var r=t("DragCopyProperCanvas"),a,d=this.items.getItem(i);if(r&&(d&&t(d.canvas))){a=d.canvas.cloneNode(true);r.parentNode.replaceChild(a,r);a.getContext("2d").drawImage(d.canvas,0,0)}}return true},onbxdragstop:function(){var e=t.proxy_context;if(e.__dragCopyDiv){t.removeClass(e,"bx-drag-source");e.__dragCopyDiv.parentNode.removeChild(e.__dragCopyDiv);e.__dragCopyDiv=null;delete e["__dragCopyDiv"];delete e["__dragCopyPos"]}return true},onbxdrag:function(e,i){var s=t.proxy_context,r=s.__dragCopyDiv;if(r){if(s.__dragCopyPos){if(!s.__dragCopyPos.deltaX)s.__dragCopyPos.deltaX=s.__dragCopyPos.left-e;if(!s.__dragCopyPos.deltaY)s.__dragCopyPos.deltaY=s.__dragCopyPos.top-i;e+=s.__dragCopyPos.deltaX;i+=s.__dragCopyPos.deltaY}r.style.left=e+"px";r.style.top=i+"px"}},onbxdraghout:function(e,t,i){},onbxdestdraghover:function(){var e=t.proxy_context;t.addClass(e,"bx-drag-over");return true},onbxdestdraghout:function(){var e=t.proxy_context;t.removeClass(e,"bx-drag-over");return true},onbxdestdragfinish:function(e){var i=t.proxy_context;t.removeClass(i,"bx-drag-over");if(i==e||!t.hasClass(e,"bx-drag-draggable"))return true;else{var s=i.parentNode,r=s.childNodes.length;for(var a=0;a<r;a++){if(s.childNodes[a]==i)i.number=a;else if(s.childNodes[a]==e)e.number=a;if(e.number>0&&i.number>0)break}if(this.itForUpload.hasItem(e.getAttribute("bx-bxu-item-id"))){var d=i.number<=e.number?"beforeItem":i.nextSibling?"afterItem":"inTheEnd",o=null;if(d!="inTheEnd"){for(a=i.number+(d=="beforeItem"?0:1);a<r;a++){if(this.itForUpload.hasItem(s.childNodes[a].getAttribute("bx-bxu-item-id"))){o=s.childNodes[a].getAttribute("bx-bxu-item-id");break}}if(o===null)d="inTheEnd"}var l=this.itForUpload.removeItem(e.getAttribute("bx-bxu-item-id"));if(d!="inTheEnd")this.itForUpload.insertBeforeItem(l.id,l,o);else this.itForUpload.setItem(l.id,l)}e.parentNode.removeChild(e);if(i.number<=e.number){i.parentNode.insertBefore(e,i)}else if(i.nextSibling){i.parentNode.insertBefore(e,i.nextSibling)}else{i.parentNode.appendChild(e)}}return true},deleteItem:function(i,s){var r=this.getItem(i),a;if(r&&(!this.placeHolder||(a=r.node)&&a)){if(!!a){if(!!e["jsDD"]){a.onmousedown=null;a.onbxdragstart=null;a.onbxdragstop=null;a.onbxdrag=null;a.onbxdraghout=null;a.onbxdestdraghover=null;a.onbxdestdraghout=null;a.onbxdestdragfinish=null;a.__bxpos=null;e.jsDD.arObjects[a.__bxddid]=null;delete e.jsDD.arObjects[a.__bxddid];e.jsDD.arDestinations[a.__bxddeid]=null;delete e.jsDD.arDestinations[a.__bxddeid]}t.unbindAll(a);a.parentNode.removeChild(a)}this.items.removeItem(i);this.itUploaded.removeItem(i);this.itFailed.removeItem(i);this.itForUpload.removeItem(i);t.onCustomEvent(this.uploader,"onQueueIsChanged",[this,"add",i,s]);return true}return false},reinitItem:function(i,s){var r,a;if(!!this.placeHolder&&this.items.hasItem(i)&&(r=t(i+"Item"))&&r){a=s.makeThumb();if(t.type.isNotEmptyString(a)){if(this.thumb.tagName=="TR"){a=a.replace(/[\n\t]/gi,"").replace(/^(\s+)(.*?)/gi,"$2").replace(/(.*?)(\s+)$/gi,"$1");if(!!a["trim"])a=a.trim();var d=function(e,t,i){var s=r.insertCell(-1),a={colspan:true,headers:true,accesskey:true,"class":true,contenteditable:true,contextmenu:true,dir:true,hidden:true,id:true,lang:true,spellcheck:true,style:true,tabindex:true,title:true,translate:true},d;s.innerHTML=i;t=t.split(" ");while((d=t.pop())&&d){d=d.split("=");if(d.length==2){d[0]=d[0].replace(/^(\s+)(.*?)/gi,"$2").replace(/(.*?)(\s+)$/gi,"$1").replace(/^["'](.*?)["']$/gi,"$1");d[1]=d[1].replace(/^(\s+)(.*?)/gi,"$2").replace(/(.*?)(\s+)$/gi,"$1").replace(/^["'](.*?)["']$/gi,"$1");if(a[d[0]]===true)s.setAttribute(d[0],d[1]);else s[d[0]]=d[1]}}return""},o=/^<td(.*?)>(.*?)<\/td>/i;e.data1=a;while(o.test(a))a=a.replace(o,d)}else{r.innerHTML=a}}else if(t.type.isDomNode(a)){while(t(r.firstChild)){t.remove(r.firstChild)}t.adjust(r,{children:[a]})}t.onCustomEvent(this.uploader,"onFileIsAppended",[s.id,s,this.caller]);t.onCustomEvent(s,"onFileIsAppended",[s.id,s,this.caller])}},finishQueue:function(){},clear:function(){var e;while((e=this.items.getFirst())&&!!e)this.deleteItem(e.id,e)},restoreFiles:function(e,i,s){i=i===true;var r=e.getFirst();while(r){if(this.items.hasItem(r.id)&&(s===true||!this.itUploaded.hasItem(r.id))&&(i||!this.itFailed.hasItem(r.id))){if(this.itFailed.hasItem(r.id)||s===true){delete r["uploadStatus"];delete r.file["uploadStatus"];delete r.file["firstChunk"];delete r.file["package"];delete r.file["packages"];if(r.file["copies"]){r.file["copies"].reset();var a;while((a=r.file["copies"].getNext())&&a){delete a["uploadStatus"];delete a["firstChunk"];delete a["package"];delete a["packages"]}r.file["copies"].reset()}r["restored"]="Y"}else{r["restored"]="C"}this.itFailed.removeItem(r.id);this.itUploaded.removeItem(r.id);this.itForUpload.setItem(r.id,r);t.onCustomEvent(r,"onUploadRestore",[r])}r=e.getNext()}}};return i})(window);
/* End */
;
//# sourceMappingURL=kernel_coreuploader.map.js