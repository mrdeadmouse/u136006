(function(VoxImplant,undefined){var VI_WEBRTC_STATE_IDLE="VI_WEBRTC_STATE_IDLE";var VI_WEBRTC_STATE_WS_CONNECTING="VI_WEBRTC_STATE_WS_CONNECTING";var VI_WEBRTC_STATE_WS_CONNECTED="VI_WEBRTC_STATE_WS_CONNECTED";var VI_WEBRTC_STATE_CONNECTED="VI_WEBRTC_STATE_WS_CONNECTED";var VI_CALL_STATE_ALERTING=VoxImplant.VI_CALL_STATE_ALERTING="ALERTING";var VI_CALL_STATE_PROGRESSING=VoxImplant.VI_CALL_STATE_PROGRESSING="PROGRESSING";var VI_CALL_STATE_CONNECTED=VoxImplant.VI_CALL_STATE_CONNECTED="CONNECTED";var VI_CALL_STATE_ENDED=VoxImplant.VI_CALL_STATE_ENDED="ENDED";VoxImplant.ZingayaAPI=function(videoEnabled,micRequired){var PING_DELAY=5e3;var audioElements=[];var videoElements=[];var needMic=!(false===micRequired);var getAudioElement=function(){if(audioElements.length){return audioElements.pop()}return document.createElement("audio")};var releaseAudioElement=function(el){attachMediaStream(el,null);audioElements.push(el)};var getVideoElement=function(){if(videoElements.length){return videoElements.pop()}return document.createElement("video")};var releaseVideoElement=function(el){attachMediaStream(el,null);videoElements.push(el)};var getAudioTracks=function(stream){if(stream){if(stream.audioTracks)return stream.audioTracks;if(stream.getAudioTracks)return stream.getAudioTracks()}return null};var getVideoTracks=function(stream){if(stream){if(stream.videoTracks)return stream.videoTracks;if(stream.getVideoTracks)return stream.getVideoTracks()}return null};var enableTracks=function(tracks,b){if(tracks){for(var i in tracks){tracks[i].enabled=b}}};var videoSupport=videoEnabled===true?true:false;var mediaConstraints={mandatory:{OfferToReceiveAudio:true,OfferToReceiveVideo:videoSupport}};var connectionProtocol="wss";var getUserMedia;var attachMediaStream;var RTCPeerConnection;var myRTCIceCandidate;var sock=null;var state=VI_WEBRTC_STATE_IDLE;var isChrome;var isFirefox;var deviceEnumAPI;var audioSourceId;var videoSourceId;var videoConstraints;var microphoneMuted=false;var speakerMuted=false;var videoSent=true;var renegotiationInProgress=false;var pingTimer=null;var pongTimer=null;var playbackVolume=1;var initPCMethods=function(){isChrome=typeof webkitRTCPeerConnection!="undefined";isFirefox=typeof mozRTCPeerConnection!="undefined";deviceEnumAPI=typeof MediaStreamTrack!="undefined"&&typeof MediaStreamTrack.getSources!="undefined";audioSourceId=null;videoSourceId=null;videoConstraints=null;if(isFirefox){myRTCIceCandidate=mozRTCIceCandidate;RTCPeerConnection=mozRTCPeerConnection;getUserMedia=navigator.mozGetUserMedia.bind(navigator);attachMediaStream=function(element,stream){if(stream){element.mozSrcObject=stream;element.load();element.play()}else{element.mozSrcObject=null;element.load()}}}if(isChrome){RTCPeerConnection=webkitRTCPeerConnection;myRTCIceCandidate=RTCIceCandidate;getUserMedia=navigator.webkitGetUserMedia.bind(navigator);attachMediaStream=function(element,stream){if(stream){element.src=webkitURL.createObjectURL(stream);element.load();element.play()}else{element.pause()}}}};var localStream=null;var calls={};var peerConnections={};var numCalls=0;var log=function(message){if(typeof this.writeLog=="function"){this.writeLog(message)}}.bind(this);var trace=function(message){if(typeof this.writeTrace=="function"){this.writeTrace(message)}}.bind(this);var localVideoSink;var remoteSinksContainerId;var dateTimeOptions={year:"numeric",month:"numeric",day:"numeric"};this.writeLog=function(message){BXIM.webrtc.phoneLog("VI WebRTC: "+(new Date).toLocaleTimeString("en-US",dateTimeOptions)+" "+message)};this.writeTrace=function(message){BXIM.webrtc.phoneLog("VI WebRTC: "+(new Date).toLocaleTimeString("en-US",dateTimeOptions)+" "+message)};this.onConnectionEstablished=null;this.onConnectionFailed=null;this.onConnectionClosed=null;this.onLoginSuccessful=null;this.onLoginFailed=null;this.onIncomingCall=null;this.onCallRinging=null;this.onCallMediaStarted=null;this.onCallConnected=null;this.onCallEnded=null;this.onCallFailed=null;this.onSIPInfoReceived=null;this.onInstantMessageReceived=null;this.onTransferComplete=null;this.onTransferFailed=null;this.onNetStatsReceived=null;this.onStatusNotify=null;var cleanHeaders=function(headers){var res={};for(var i in headers){if(i.substring(0,2)=="X-"||i=="VI-CallData"){res[i]=headers[i]}}return res};var isDirectCall=function(headers){for(var i in headers)if(i=="X-DirectCall")return headers[i]=="true"?true:false;return false};var recalculateNumCalls=function(){numCalls=0;for(var i in calls){numCalls++}};var addCall=function(call){calls[call.id()]=call;recalculateNumCalls()};var deleteCall=function(callId){delete calls[callId];recalculateNumCalls()}.bind(this);initPCMethods();var makeid=function(len){var text="";var possible="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var i=0;i<len;i++)text+=possible.charAt(Math.floor(Math.random()*possible.length));return text};var traceState=function(){};this.muteMicrophone=function(doMute){microphoneMuted=doMute;if(localStream){enableTracks(getAudioTracks(localStream),!doMute)}};this.sendVideo=function(doSend){videoSent=doSend;if(localStream){enableTracks(getVideoTracks(localStream),doSend)}};this.mutePlayback=function(doMute){speakerMuted=doMute;for(var i in peerConnections){peerConnections[i].updateSpeakerMuteState()}};this.setPlaybackVolume=function(volume){playbackVolume=volume;for(var i in peerConnections){peerConnections[i].setPlaybackVolume(volume)}};this.getCalls=function(){var res=[];for(var i in calls){res.push(i)}return res};this.setLocalVideoSink=function(element){localVideoSink=element;if(localStream){attachMediaStream(element,localStream)}};this.setRemoteSinksContainerId=function(id){remoteSinksContainerId=id};this.stopLocalStream=function(){if(localStream){localStream.stop();localStream=null}}.bind(this);this.destroy=function(){this.disconnect();this.stopLocalStream()}.bind(this);this.disconnect=function(){if(sock){onWSClosed();sock.onclose=null;sock.close();cleanup()}};this.useAudioSource=function(id,successCallback,failedCallback,video){if(deviceEnumAPI){audioSourceId=id;this.requestMedia(video,successCallback,failedCallback,videoSupport)}}.bind(this);this.useVideoSource=function(id,successCallback,failedCallback){if(deviceEnumAPI){videoSourceId=id;this.requestMedia(true,successCallback,failedCallback,true)}}.bind(this);this.setConstraints=function(constraints,successCallback,failedCallback){videoConstraints=constraints;this.requestMedia(videoSupport,successCallback,failedCallback,videoSupport)}.bind(this);this.requestMedia=function(video,onMediaAccessGranted,onMediaAccessRejected,stopStream){if(audioSourceId==null&&videoSourceId==null){var constraints={audio:true,video:video===true?true:false}}else{if(audioSourceId!=null&&videoSourceId!=null){var constraints={audio:{optional:[{sourceId:audioSourceId}]},video:{optional:[{sourceId:videoSourceId}]}}}else if(audioSourceId!=null){var constraints={audio:{optional:[{sourceId:audioSourceId}]},video:video===true?true:false}}else if(videoSourceId!=null){var constraints={audio:true,video:{optional:[{sourceId:videoSourceId}]}}}}if(videoConstraints!=null){constraints.video=new Object;if(typeof videoConstraints.mandatory!="undefined")constraints.video.mandatory=videoConstraints.mandatory;if(typeof videoConstraints.optional!="undefined"){constraints.video.optional=videoConstraints.optional;if(videoSourceId!=null)constraints.video.optional.push({sourceId:videoSourceId})}else{if(videoSourceId!=null)constraints.video.optional=[{sourceId:videoSourceId}]}}if(localStream&&stopStream){localStream.stop();localStream=null}getUserMedia(constraints,function(_localStream){if(localStream){localStream.stop();for(var i in peerConnections){peerConnections[i].setLocalStream(null)}}log("Media access granted");localStream=_localStream;enableTracks(getAudioTracks(localStream),!microphoneMuted);if(localVideoSink){attachMediaStream(localVideoSink,_localStream)}for(var i in peerConnections){peerConnections[i].setLocalStream(localStream)}if(typeof onMediaAccessGranted=="function"){onMediaAccessGranted()}for(var i in pcsWaitingForLocalStream){doCreatePC(i,pcsWaitingForLocalStream[i])}pcsWaitingForLocalStream={}}.bind(this),function(err){log("Media access rejected: "+err.name);if(typeof onMediaAccessRejected=="function"){onMediaAccessRejected(err.name)}})}.bind(this);this.getRemoteParty=function(callId){if(calls[callId]){return calls[callId].getRemoteParty()}return null};this.getCallState=function(callId){if(calls[callId]){return calls[callId].getState()}return null};this.setCallActive=function(callId,active){if(calls[callId]){if(active){this.unholdCall(callId)}else{this.holdCall(callId)}return calls[callId].setStreamsActive(active)}};this.isCallActive=function(callId){if(calls[callId]){return calls[callId].streamsAreActive()}return false};this.connectTo=function(serverAddress,referrer,extra){if(state==VI_WEBRTC_STATE_IDLE){sock=new WebSocket(connectionProtocol+"://"+serverAddress+"/platform?version=2&client="+(isFirefox?"firefox":"chrome")+"&referrer="+encodeURIComponent(referrer)+"&extra="+encodeURIComponent(extra)+"&video="+(videoSupport===true?"true":"false")+"&q="+makeid(12));state=VI_WEBRTC_STATE_WS_CONNECTING;sock.onopen=onWSConnected;sock.onclose=onWSClosed;sock.onerror=onWSError;sock.onmessage=onWSDataReceived}else{log("Error: called connectTo while in state "+state)}}.bind(this);this.login=function(username,password,options){if(state!=VI_WEBRTC_STATE_CONNECTED){log("login called while in state "+state);return}callRemoteFunction("login",[username,password,options?options:null])};this.loginStage2=function(username,code,options){if(state!=VI_WEBRTC_STATE_CONNECTED){log("loginStage2 called while in state "+state);return}callRemoteFunction("loginStage2",[username,code,options?options:null])};this.loginGenerateOneTimeKey=function(username){if(state!=VI_WEBRTC_STATE_CONNECTED){log("loginGenerateOneTimeKey called while in state "+state);return}callRemoteFunction("loginGenerateOneTimeKey",[username])};this.loginUsingOneTimeKey=function(username,hash,options){if(state!=VI_WEBRTC_STATE_CONNECTED){log("loginUsingOneTimeKey called while in state "+state);return}callRemoteFunction("loginUsingOneTimeKey",[username,hash,options?options:null])};this.setOperatorACDStatus=function(s){if(state!=VI_WEBRTC_STATE_CONNECTED){log("setOperatorACDStatus called while in state "+s);return}callRemoteFunction("setOperatorACDStatus",[s])};this.trackPresence=function(arr){if(state!=VI_WEBRTC_STATE_CONNECTED){log("trackPresence called while in state "+state);return}callRemoteFunction("subscribeStatus",[arr])};this.setPresenceStatus=function(status){if(state!=VI_WEBRTC_STATE_CONNECTED){log("setPresenceStatus called while in state "+state);return}callRemoteFunction("setStatus",[status])};this.callTo=function(destination,useVideo,headers,extraParams){var id=makeid(36);headers=cleanHeaders(typeof headers=="undefined"?{}:headers);var call=new Call(id,VI_CALL_STATE_PROGRESSING,destination,"");call.setHeaders(headers);addCall(call);if(isDirectCall(headers)){var pcw=createPeerConnection2(id,true);pcw.outgoingCall()}else{callRemoteFunction("createCall",[-1,destination,useVideo,id,null,null,headers,extraParams])}return id};this.transferCall=function(call1,call2){var x=[call1,call2];for(var i in x){var call=calls[x[i]];if(call){if(call.getState()!=VI_CALL_STATE_CONNECTED){log("ERROR: trying to transfer call "+call.id()+" in state "+call.getState());return}}else{log("ERROR: trying to transfer unknown call "+call.id());return}}callRemoteFunction("transferCall",[call1,call2])};this.hangupCall=function(callId,headers){var call=calls[callId];if(call){if(call.getState()==VI_CALL_STATE_ALERTING){callRemoteFunction("rejectCall",[callId,true,cleanHeaders(headers)])}else{callRemoteFunction("disconnectCall",[callId,cleanHeaders(headers)])}}else{log("ERROR: trying to hangup unknown call "+callId)}};this.rejectCall=function(callId,code,headers){var call=calls[callId];if(call){if(call.getState()==VI_CALL_STATE_ALERTING){callRemoteFunction("rejectCall",[callId,true,cleanHeaders(headers)])}else{log("ERROR: trying to reject call "+callId+" in state "+call.getState())}}else{log("ERROR: trying to reject unknown call "+callId)}};this.answerCall=function(callId,headers){var call=calls[callId];if(call){if(call.getState()==VI_CALL_STATE_ALERTING){if(isDirectCall(call.getHeaders())){var pc=call.getPeerConnection();pc.createAnswer()}else{callRemoteFunction("acceptCall",[callId,cleanHeaders(headers)])}}else{log("ERROR: trying to answer call "+callId+" in state "+call.getState())}}else{log("ERROR: trying to answer unknown call "+callId)}};this.sendDigit=function(callId,digit){var call=calls[callId];if(call){if(call.getState()==VI_CALL_STATE_CONNECTED){callRemoteFunction("sendDTMF",[callId,digit])}else{log("ERROR: trying to send digit to call "+callId+" in state "+call.getState())}}else{log("ERROR: trying to send digit to unknown call "+callId)}};this.holdCall=function(callId){var call=calls[callId];if(call){if(call.getState()==VI_CALL_STATE_CONNECTED){callRemoteFunction("hold",[callId])}else{log("ERROR: trying to hold call "+callId+" in state "+call.getState())}}else{log("ERROR: trying to hold unknown call "+callId)}};this.unholdCall=function(callId){var call=calls[callId];if(call){if(call.getState()==VI_CALL_STATE_CONNECTED){callRemoteFunction("unhold",[callId])}else{log("ERROR: trying to unhold call "+callId+" in state "+call.getState())}}else{log("ERROR: trying to unhold unknown call "+callId)}};this.sendSIPInfo=function(callId,type,subtype,body,headers){var call=calls[callId];if(call){if(call.getState()==VI_CALL_STATE_CONNECTED||call.getState()==VI_CALL_STATE_ALERTING||call.getState()==VI_CALL_STATE_PROGRESSING){callRemoteFunction("sendSIPInfo",[callId,type,subtype,body,cleanHeaders(headers)])}else{log("ERROR: trying to send SIP Info to call "+callId+" in state "+call.getState())}}else{log("ERROR: trying to send SIP Info to unknown call "+callId)}};var __sendSIPInfo=this.sendSIPInfo.bind(this);this.sendInstantMessage=function(callId,text){this.sendSIPInfo(callId,"application","zingaya-im",text,{})};this.getVideoElementId=function(callId){var call=calls[callId];if(call){return call.getVideoElementId()}else{log("ERROR: No such call "+callId)}};this.getStats=function(callId,callback){var pc=peerConnections[callId];if(pc){pc.getStats(callback)}};var cleanup=function(){for(var i in peerConnections){peerConnections[i].close()}peerConnections={};calls={};numCalls=0;if(pingTimer){clearTimeout(pingTimer)}if(pongTimer){clearTimeout(pongTimer)}};var onWSError=function(e){sock.oncloe=null;log("WS error: "+e);state=VI_WEBRTC_STATE_IDLE;cleanup();if(typeof this.onConnectionFailed=="function"){this.onConnectionFailed(e)}}.bind(this);var onWSConnected=function(){state=VI_WEBRTC_STATE_WS_CONNECTED;log("WS connected")}.bind(this);var onWSClosed=function(){log("WS closed");var closed=state==VI_WEBRTC_STATE_CONNECTED;var cb=closed?this.onConnectionClosed:this.onConnectionFailed;state=VI_WEBRTC_STATE_IDLE;cleanup();if(typeof cb=="function"){cb("Connection closed")}}.bind(this);var doPing=function(){pingTimer=null;callRemoteFunction("__ping",[]);pongTimer=setTimeout(function(){pongTimer=null;log("WS closed");var closed=state==VI_WEBRTC_STATE_CONNECTED;var cb=closed?this.onConnectionClosed:this.onConnectionFailed;state=VI_WEBRTC_STATE_IDLE;cleanup();if(typeof cb=="function"){cb("Connection closed")}}.bind(this),PING_DELAY)}.bind(this);var pcsWaitingForLocalStream={};var doCreatePC=function(id,sdp){var pcw=createPeerConnection2(id,false);pcw.start(sdp)};var createPeerConnection2=function(id,direct){BXIM.webrtc.phoneLog("createPeerConnection2 invoked");if(peerConnections[id]){peerConnections[id].close()}var pcw=new PeerConnectionWrapper2(id,direct);if(calls[id]){pcw.setStreamsActive(calls[id].streamsAreActive())}peerConnections[id]=pcw;pcw.setLocalStream(localStream);var call=calls[id];if(call){calls[id].setPeerConnection(pcw);pcw.setCall(call)}return peerConnections[id]};var ice_config=null;var rpcHandlers;rpcHandlers={__createPC:function(id,sdpOffer){if(!needMic||localStream||id=="__default"){doCreatePC(id,sdpOffer)}else{pcsWaitingForLocalStream[id]=sdpOffer}},__destroyPC:function(id){if(peerConnections[id]){peerConnections[id].close();delete peerConnections[id]}delete pcsWaitingForLocalStream[id]},__onPCStats:function(id,stats){if(peerConnections[id]){if(typeof this.onNetStatsReceived=="function"){this.onNetStatsReceived(stats)}}},__pong:function(){if(pongTimer){clearTimeout(pongTimer);pongTimer=null;pingTimer=setTimeout(doPing,PING_DELAY)}},__connectionSuccessful:function(){if(state==VI_WEBRTC_STATE_WS_CONNECTED){state=VI_WEBRTC_STATE_CONNECTED;if(typeof this.onConnectionEstablished=="function"){this.onConnectionEstablished()}pingTimer=setTimeout(doPing,PING_DELAY)}},loginSuccessful:function(displayName,params){if(params)ice_config=params["iceConfig"];if(typeof this.onLoginSuccessful=="function"){this.onLoginSuccessful(displayName,params)}},loginFailed:function(code,oneTimeKey){if(typeof this.onLoginFailed=="function"){this.onLoginFailed({errorCode:code,oneTimeKey:oneTimeKey})}},handleConnectionConnected:function(callId,headers,sdp){var call=calls[callId];if(call){call.canStartSendingCandidates();if(call.getState()==VI_CALL_STATE_PROGRESSING||call.getState()==VI_CALL_STATE_ALERTING){call.setState(VI_CALL_STATE_CONNECTED);if(sdp==undefined){}else{var pc=call.getPeerConnection();pc.onConnectionConnected(sdp)}if(typeof this.onCallConnected=="function"){this.onCallConnected(callId,headers)}}else{log("WARNING: received handleConnectionConnected for call: "+callId+" in invalid state: "+call.getState())}}else{log("WARNING: received handleConnectionConnected for unknown call: "+callId)}},stopRinging:function(callId){var call=calls[callId];if(call){call.canStartSendingCandidates();if(typeof this.onCallMediaStarted=="function"){this.onCallMediaStarted(callId)}}else{log("WARNING: received stopRinging for unknown call: "+callId)}},handleConnectionDisconnected:function(callId,headers){var call=calls[callId];if(call){call.setState(VI_CALL_STATE_ENDED);if(typeof this.onCallEnded=="function"){this.onCallEnded(callId,headers)}deleteCall(callId)}else{log("WARNING: received handleConnectionDisconnected for unknown call: "+callId)}},handleConnectionFailed:function(callId,code,reason,headers){var call=calls[callId];if(call){if(call.getState()==VI_CALL_STATE_PROGRESSING){call.setState(VI_CALL_STATE_ENDED);if(typeof this.onCallFailed=="function"){this.onCallFailed(callId,code,reason,headers)}deleteCall(callId)}else{log("WARNING: received handleConnectionFailed for call: "+callId+" in invalid state: "+call.getState())}}else{log("WARNING: received handleConnectionFailed for unknown call: "+callId)}},handleRingOut:function(callId){var call=calls[callId];if(call){call.canStartSendingCandidates();if(call.getState()==VI_CALL_STATE_PROGRESSING){if(typeof this.onCallRinging=="function"){this.onCallRinging(callId)}}else{log("WARNING: received handleRingOut for call: "+callId+" in invalid state: "+call.getState())}}else{log("WARNING: received handleRingOut for unknown call: "+callId)}},handleIncomingConnection:function(id,callerid,displayName,headers,sdp){var call=new Call(id,VI_CALL_STATE_ALERTING,callerid,displayName);call.setHeaders(headers);addCall(call);if(isDirectCall(headers)){var pc=createPeerConnection2(id,true);pc.onIncomingCall(sdp)}else{if(peerConnections[id])call.setPeerConnection(peerConnections[id])}if(typeof this.onIncomingCall=="function"){this.onIncomingCall(id,callerid,displayName,headers)}else{this.rejectCall(id,486);log("WARNING: Received incoming call while no handler was specified")}},handleSIPInfo:function(callId,type,subType,body,headers){var call=calls[callId];if(call){if(call.getState()==VI_CALL_STATE_CONNECTED||call.getState()==VI_CALL_STATE_PROGRESSING||call.getState()==VI_CALL_STATE_ALERTING){if(type=="application"&&subType=="zingaya-im"){if(typeof this.onInstantMessageReceived=="function"){this.onInstantMessageReceived(callId,body)}}else if(type=="voximplant"&&subType=="sdpfrag"){cands=JSON.parse(body);for(i in cands){var pc=call.getPeerConnection();pc.addRemoteCandidate(cands[i][0],cands[i][1])}}else{if(typeof this.onSIPInfoReceived=="function"){this.onSIPInfoReceived(callId,type+"/"+subType,body,headers)}}}else{log("WARNING: received handleSIPInfo for call: "+callId+" in invalid state: "+call.getState())}}else{log("WARNING: received handleSIPInfo for unknown call: "+callId)}},handleSipEvent:function(){},handleTransferStarted:function(){},handleTransferComplete:function(callId){var call=calls[callId];if(call){if(this.onTransferComplete){this.onTransferComplete(callId)}}else{log("WARNING: received handleTransferComplete for unknown call: "+callId)}},handleTransferFailed:function(callId){var call=calls[callId];if(call){if(this.onTransferFailed){this.onTransferFailed(callId)}}else{log("WARNING: received handleTransferFailed for unknown call: "+callId)}},handleStatus:function(presence,user){trace("Presence update for "+user+". Data "+presence);if(typeof this.onPresenceUpdate=="function"){this.onPresenceUpdate(presence,user)}}};var onWSDataReceived=function(data){var receivedObject=JSON.parse(data.data);var functionName=receivedObject["name"];var params=receivedObject["params"];if(functionName!="__pong"){trace("Called local function "+functionName+" with params "+JSON.stringify(params))}if(typeof rpcHandlers[functionName]=="function"){rpcHandlers[functionName].apply(this,params)}else{log("Unknown function called: "+functionName)}traceState()}.bind(this);var createSDP=function(type,sdpString){if(typeof mozRTCSessionDescription=="function")return new mozRTCSessionDescription({type:type,sdp:sdpString});else return new RTCSessionDescription({type:type,sdp:sdpString})};var Call=function(id,state,remoteParty,displayName){var _id=id;var _state=state;var _remoteParty=remoteParty;var _displayName=displayName;var _pc;var _headers;var streamsActive=true;this.id=function(){return _id};this.getRemoteParty=function(){return _remoteParty};this.getState=function(){return _state};this.setState=function(state){_state=state};this.getDisplayName=function(){return _displayName};this.setPeerConnection=function(pc){BXIM.webrtc.phoneLog("Set peer connection: "+pc);_pc=pc};this.getPeerConnection=function(){BXIM.webrtc.phoneLog("Get peer connection: "+_pc);return _pc};this.setHeaders=function(headers){_headers=headers};this.getHeaders=function(){return _headers};this.streamsAreActive=function(){return streamsActive};this.setStreamsActive=function(b){streamsActive=b;if(peerConnections[_id]){peerConnections[_id].setStreamsActive(b)}};this.getVideoElementId=function(){return _pc.getVideoElementId()};this.canStartSendingCandidates=function(){_pc.canStartSendingCandidates()}};var PeerConnectionWrapper2=function(id,direct){var cfg=null;if(direct)cfg=ice_config;var pc=new RTCPeerConnection(cfg,{optional:[{DtlsSrtpKeyAgreement:"true"}]});var _id=id;var _direct=direct;var pcLog=function(message){log("PC ["+_id+"]: "+message)};var pcTrace=function(message){trace("PC ["+_id+"]: "+message)};var pcError=function(message){log("PC ["+_id+"] ERROR: "+message)};var _call;this.setCall=function(__call){_call=__call};this.getCall=function(){return _call};var audioElement;var videoElement;audioElement=getAudioElement();audioElement.id="vi_audio_"+_id;audioElement.volume=playbackVolume;document.body.appendChild(audioElement);if(videoSupport){videoElement=getVideoElement();videoElement.id="vi_video_"+_id;videoElement.width=400;videoElement.height=300;videoElement.volume=playbackVolume;var container=remoteSinksContainerId?document.getElementById(remoteSinksContainerId):document.body;container.appendChild(videoElement)}var activeRemoteSD=null;var activeLocalSD=null;var localRTCPMux=false;var answerSent=false;var remoteAudioStream=null;var remoteVideoStream=null;var localStream=null;var iceComplete=false;var closed=false;var streamsActive=true;this.getStats=function(callback){var localStreamLocalStats;var localStreamRemoteStats;var remoteStreamLocalStats;var remoteStreamRemoteStats;if(!!localStream&&!!remoteAudioStream){pc.getStats(function(statsReport){var x=statsReport.result();for(var i in x){if(x[i].type=="ssrc"){if(x[i].local==x[i]||!x[i].remote){}if(x[i].remote==x[i]||!x[i].local){}}}})}};this.getRemoteAudioStream=function(){return remoteAudioStream};this.getRemoteVideoStream=function(){return remoteVideoStream};this.getVideoElementId=function(){return videoElement?videoElement.id:null};this.setLocalStream=function(newLocalStream){if(closed)return;if(localStream){pc.removeStream(localStream);localStream=null}if(newLocalStream){localStream=newLocalStream;var audioTracks=typeof newLocalStream.getAudioTracks=="undefined"?newLocalStream.audioTracks:newLocalStream.getAudioTracks();var videoTracks=typeof newLocalStream.getVideoTracks=="undefined"?newLocalStream.videoTracks:newLocalStream.getVideoTracks();localStream=newLocalStream;pc.addStream(localStream);enableTracks(localStream.getAudioTracks(),!microphoneMuted);enableTracks(localStream.getVideoTracks(),videoSent)}};this.onIncomingCall=function(sdp){if(closed)return;activeRemoteSD=createSDP("offer",sdp);pc.setRemoteDescription(activeRemoteSD,function(){},pcError)};this.onConnectionConnected=function(sdp){if(closed)return;if(!_direct)return;activeRemoteSD=createSDP("answer",sdp);pc.setRemoteDescription(activeRemoteSD,function(){},pcError)};this.outgoingCall=function(){if(closed)return;pc.createOffer(function(sdpOffer){activeLocalSD=sdpOffer;pc.setLocalDescription(createSDP("offer",sdpOffer.sdp),function(){sendOffer()},pcError)},pcError)};var sendOffer=function(){if(closed)return;callRemoteFunction("createCall",[-1,_call.getRemoteParty(),false,id,null,null,_call.getHeaders(),"",activeLocalSD.sdp])};this.createAnswer=function(){if(closed)return;pcTrace("Calling createAnswer");pc.createAnswer(onAnswerCreated,pcError)};var onAnswerCreated=function(sdp){if(closed){return}localRTCPMux=sdp.sdp.indexOf("a=rtcp-mux")!=-1;pc.setLocalDescription(sdp,function(){activeLocalSD=sdp;answerSent=true;sendAnswer()},pcError)}.bind(this);var sendAnswer=function(){if(closed){return}pcLog("Sending local answer");pcTrace("Local answer: "+activeLocalSD.sdp);if(_direct)callRemoteFunction("acceptCall",[_id,cleanHeaders(_call.getHeaders()),activeLocalSD.sdp]);else callRemoteFunction("__confirmPC",[_id,activeLocalSD.sdp])};var candidatesEnded=false;var onCandidatesEnded=function(){if(candidatesEnded)return;candidatesEnded=true};var rtpCandidateGenerated=false;var rtpVideoCandidateGenerated=false;var rtcpCandidateGenerated=false;var rtcpVideoCandidateGenerated=false;var canSendCandidates=false;var candidateSendTimer=null;var pendingCandidates=[];function startCandidateSendTimer(){if(candidateSendTimer==null)candidateSendTimer=setTimeout(function(){candidateSendTimer=null;if(pendingCandidates.length>0){__sendSIPInfo(_id,"voximplant","sdpfrag",JSON.stringify(pendingCandidates),{})}pendingCandidates=[]},100)}function addCandidateToSend(attrString,mLineIndex){pendingCandidates.push([mLineIndex,attrString]);if(canSendCandidates)startCandidateSendTimer()}this.canStartSendingCandidates=function(){canSendCandidates=true;startCandidateSendTimer()};this.addRemoteCandidate=function(mediaId,attrString){pc.addIceCandidate(new myRTCIceCandidate({candidate:attrString.substring(2),sdpMLineIndex:mediaId}),function(){BXIM.webrtc.phoneLog("Added ice candidate")},function(err){pcTrace("error adding ice candidate "+err)})};var onIceCandidate=function(event){if(closed)return;if(event.candidate){pcTrace("ICE candidate: "+event.candidate.candidate);var cand=event.candidate.candidate;var candidateAttr=cand;if(candidateAttr.indexOf("a=")==-1)candidateAttr="a="+candidateAttr;if(isChrome&&activeLocalSD){activeLocalSD.sdp+=candidateAttr;activeLocalSD.sdp+="\r\n"}if(!_direct)callRemoteFunction("__addCandidate",[_id,candidateAttr,event.candidate.sdpMLineIndex]);else addCandidateToSend(candidateAttr,event.candidate.sdpMLineIndex);if(!_direct){}}else{pcLog("End of candidates.");onCandidatesEnded()}};var onRenegotiate=function(){if(closed){pcLog("Renegotiation requested on closed PeerConnection");return}if(activeLocalSD==null){pcLog("Renegotiation needed, but no local SD, skipping");return}if(pc.iceConnectionState!="connected"&&pc.iceConnectionState!="completed"){pcLog("Renegotiation requested while ice state is "+pc.iceConnectionState+". Postponing");setTimeout(onRenegotiate,100);return}if(renegotiationInProgress){pcLog("Renegotiation in progress. Queueing")}else{pcLog("Renegotiation started")}renegotiationInProgress=true;pc.setRemoteDescription(activeRemoteSD,function(){if(closed){renegotiationInProgress=false;return}pc.createAnswer(function(sdpOffer){if(closed){renegotiationInProgress=false;return}activeLocalSD=sdpOffer;pc.setLocalDescription(activeLocalSD,function(){renegotiationInProgress=false;pcLog("Renegotiation successful")},function(e){renegotiationInProgress=false;pcLog("ERROR: "+e)})},function(e){renegotiationInProgress=false;pcLog("ERROR: "+e)})},function(e){renegotiationInProgress=false;pcLog("ERROR: "+e)})};var remoteStreamAdded=function(e){var isVideoStream=getVideoTracks(e.stream).length>0;pcLog("Remote stream added "+e.stream.id+" "+(isVideoStream?"video":"audio"));if(isVideoStream){remoteVideoStream=e.stream}else{remoteAudioStream=e.stream}if(isVideoStream){if(videoElement){attachMediaStream(videoElement,e.stream)}}else{attachMediaStream(audioElement,e.stream)}this.setStreamsActive(streamsActive)};this.setPlaybackVolume=function(vol){if(audioElement){audioElement.volume=vol}if(videoElement){videoElement.volume=vol}};this.streamsAreActive=function(){return streamsActive};this.setStreamsActive=function(b){streamsActive=b;enableTracks(getAudioTracks(remoteAudioStream),b&&!speakerMuted);enableTracks(getAudioTracks(remoteVideoStream),b&&!speakerMuted);enableTracks(getVideoTracks(remoteVideoStream),b);callRemoteFunction("__muteLocal",[_id,!b])}.bind(this);this.updateMicrophoneMuteState=function(){};this.updateSpeakerMuteState=function(){if(remoteAudioStream){enableTracks(getAudioTracks(remoteAudioStream),streamsActive&&!speakerMuted)}};this.activateStreams=function(){if(closed){return}this.setStreamsActive(true)};this.deactivateStreams=function(){if(closed){return}this.setStreamsActive(false)};pc.onicecandidate=onIceCandidate.bind(this);pc.onaddstream=remoteStreamAdded.bind(this);pc.onnegotiationneeded=onRenegotiate.bind(this);this.close=function(){closed=true;pc.close();if(audioElement){audioElement.parentNode.removeChild(audioElement);releaseAudioElement(audioElement)}if(videoElement){videoElement.parentNode.removeChild(videoElement);releaseVideoElement(videoElement)}};this.start=function(sdpOffer){if(closed)return;activeRemoteSD=createSDP("offer",sdpOffer);pc.setRemoteDescription(activeRemoteSD,function(){pc.createAnswer(function(sdp){BXIM.webrtc.phoneLog("Local answer created: "+sdp.sdp);localRTCPMux=sdp.sdp.indexOf("a=rtcp-mux")!=-1;pc.setLocalDescription(sdp,function(){activeLocalSD=sdp;answerSent=true;sendAnswer()},pcError)},pcError)},pcError)}};var callRemoteFunction=function(name,params){if(name!="__ping"){trace("Called remote function "+name+" with params "+JSON.stringify(params))}if(sock){if(typeof Array.prototype.toJSON!="undefined"||typeof String.prototype.toJSON!="undefined"){sock.send(VoxImplantJSON.stringify({name:name,params:params}))}else sock.send(JSON.stringify({name:name,params:params}))}else{log("ERROR: can't call remote function when not connected")}traceState()}}})(window.VoxImplant=window.VoxImplant||{});if(!Function.prototype.bind){Function.prototype.bind=function(oThis){if(typeof this!=="function"){throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable")}var aArgs=Array.prototype.slice.call(arguments,1),fToBind=this,fNOP=function(){},fBound=function(){return fToBind.apply(this instanceof fNOP&&oThis?this:oThis,aArgs.concat(Array.prototype.slice.call(arguments)))};fNOP.prototype=this.prototype;fBound.prototype=new fNOP;
return fBound}}window.VoxImplantJSON={parse:function(sJSON){return eval("("+sJSON+")")},stringify:function(vContent){if(vContent instanceof Object){var sOutput="";if(vContent.constructor===Array){for(var nId=0;nId<vContent.length;sOutput+=this.stringify(vContent[nId])+",",nId++);return"["+sOutput.substr(0,sOutput.length-1)+"]"}if(vContent.toString!==Object.prototype.toString){return'"'+vContent.toString().replace(/"/g,"\\$&")+'"'}for(var sProp in vContent){sOutput+='"'+sProp.replace(/"/g,"\\$&")+'":'+this.stringify(vContent[sProp])+","}return"{"+sOutput.substr(0,sOutput.length-1)+"}"}else if(typeof vContent==="undefined"||vContent===NaN||vContent===Infinity||vContent===-Infinity){return null}else if(typeof vContent==="number"||vContent===true||vContent===false){return vContent}else if(typeof vContent==="string"){return'"'+vContent.replace(/"/g,"\\$&")+'"'}else return null}};if(!window.JSON){window.JSON=window.VoxImplantJSON}(function(VoxImplant,undefined){VoxImplant.Utils={source:null,swfMovie:function(movieName){if(navigator.appName.indexOf("Microsoft")!=-1)return window[movieName];else return document[movieName]},stringifyExtraHeaders:function(headersObj){if(Object.prototype.toString.call(headersObj)=="[object Object]")headersObj=JSON.stringify(headersObj);else headersObj=null;return headersObj},cadScript:function(script){var cads=script.split(";");return cads.map(function(cad){if(cad.length===0){return}var matchParens=cad.match(/\([0-9\/\.,\*\+]*\)$/),ringLength=cad.substring(0,matchParens.index),segments=matchParens.pop();if(matchParens.length){throw new Error("cadence script should be of the form `%f(%f/%f[,%f/%f])`")}ringLength=ringLength==="*"?Infinity:parseFloat(ringLength);if(isNaN(ringLength)){throw new Error("cadence length should be of the form `%f`")}segments=segments.slice(1,segments.length-1).split(",").map(function(segment){try{var onOff=segment.split("/");if(onOff.length>3){throw new Error}onOff=onOff.map(function(string,i){if(i===2){var freqs=string.split("+").map(function(f){var integer=parseInt(f,10);if(isNaN(integer)){throw new Error}return integer-1});return freqs}var flt;if(string=="*"){flt=Infinity}flt=flt?flt:parseFloat(string,10);if(isNaN(flt)){throw new Error}return flt});return{on:onOff[0],off:onOff[1],frequencies:onOff[2]}}catch(err){throw new Error("cadence segments should be of the form `%f/%f[%d[+%d]]`")}});return{duration:ringLength,sections:segments}})},freqScript:function(script){var freqs=script.split(",");return freqs.map(function(freq){try{var tonePair=freq.split("@"),frequency=parseInt(tonePair.shift()),dB=parseFloat(tonePair.shift());if(tonePair.length){throw Error()}return{frequency:frequency,decibels:dB}}catch(err){throw new Error("freqScript pairs are expected to be of the form `%d@%f[,%d@%f]`")}})},toneScript:function(script){var sections=script.split(";"),frequencies=VoxImplant.Utils.freqScript(sections.shift()),cadences=VoxImplant.Utils.cadScript(sections.join(";"));return{frequencies:frequencies,cadences:cadences}},playToneScript:function(script,loop){if(typeof window.AudioContext!="undefined"||typeof window.webkitAudioContext!="undefined"){window.AudioContext=window.AudioContext||window.webkitAudioContext;var context=new AudioContext,parsedToneScript=VoxImplant.Utils.toneScript(script),samples=[],fullDuration=0;function processCadence(cadence){if(cadence.duration!=Infinity)fullDuration+=cadence.duration;else fullDuration+=20;for(var i=0;i<cadence.sections.length;i++){processSection(cadence.sections[i],cadence.duration)}}function processSection(section,duration){if(duration!=Infinity)t=duration;else t=duration=20;if(section.off!=0&&section.off!=Infinity){while(t>0){addSound(section.frequencies,section.on);t-=section.on;addSilence(section.off);t-=section.off;t=parseInt(t*10)/10}}else{addSound(section.frequencies,duration)}}function addSilence(sec){for(var t=0;t<context.sampleRate*sec;t++)samples.push(0)}function addSound(freq,sec){for(var t=0;t<context.sampleRate*sec;t++){var sample=0;for(var f=0;f<freq.length;f++){sample+=Math.pow(10,parsedToneScript.frequencies[freq[f]].decibels/20)*Math.sin((samples.length+t)*(3.14159265359/context.sampleRate)*parsedToneScript.frequencies[freq[f]].frequency);if(t<10)sample*=t/10;if(t>context.sampleRate*sec-10)sample*=(context.sampleRate*sec-t)/10}samples.push(sample)}}this.source=context.createBufferSource();for(var k=0;k<parsedToneScript.cadences.length;k++){if(parsedToneScript.cadences[k].duration==Infinity)this.source.loop=true;processCadence(parsedToneScript.cadences[k])}this.source.connect(context.destination);sndBuffer=context.createBuffer(1,fullDuration*context.sampleRate,context.sampleRate);bufferData=sndBuffer.getChannelData(0);for(var i=0;i<fullDuration*context.sampleRate;i++){bufferData[i]=samples[i]}samples=null;this.source.buffer=sndBuffer;if(loop===true)this.source.loop=true;this.source.start(0)}},stopPlayback:function(){if(this.source!=null){this.source.stop(0);this.source=null;return true}return false},sendRequest:function(url,callback,error,postData){var xdr=false;var createXMLHTTPObject=function(){var XMLHttpFactories=[function(){return new XDomainRequest},function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}];var xmlhttp=false;for(var i=0;i<XMLHttpFactories.length;i++){try{xmlhttp=XMLHttpFactories[i]();if(i==0)xdr=true}catch(e){continue}break}return xmlhttp};var req=createXMLHTTPObject();if(!req)return;var method=postData?"POST":"GET";if(!xdr){req.open(method,url,true);if(postData)req.setRequestHeader("Content-type","application/x-www-form-urlencoded");req.onreadystatechange=function(){if(req.readyState!=4)return;if(req.status!=200&&req.status!=304){error(req);return}callback(req)};if(req.readyState==4)return;req.send(postData)}else{req.onerror=function(){error(req)};req.ontimeout=function(){error(req)};req.onload=function(){callback(req)};req.open(method,url);req.timeout=5e3;req.send()}},getServers:function(callback,reservedBalancer,vi){var protocol="https:"==document.location.protocol?"https://":"http://";if(reservedBalancer===true)balancer_url=protocol+"balancer2.voximplant.com/getNearestHost?result_mode=JSONP&jsonp_callback=balancerComplete";else balancer_url=protocol+"balancer.voximplant.com/getNearestHost?result_mode=JSONP&jsonp_callback=balancerComplete";VoxImplant.Utils.sendRequest(balancer_url,function(XHR){eval(XHR.responseText)},function(XHR){balancerComplete(null)});function balancerComplete(data){if(data!=null)callback(data);else if(reservedBalancer!==true)VoxImplant.Utils.getServers(callback,true,vi);else vi.dispatchEvent({name:"ConnectionFailed",message:"VoxImplant Cloud is unavailable"})}}};VoxImplant.Call=function(c,n,dn,headers,RTC,api){var _RTC=RTC;var _call=c;var _num=n;var _displayName=dn;var _headers=headers;var _zingayaAPI=api;this.eventListeners={};this.call=function(pid){if(typeof pid=="undefined")return _call;else _call=pid};this.__number=function(pnum){if(typeof pnum=="undefined")return _num;else _num=pnum};this.__displayName=function(){return _displayName};this.__headers=function(){return _headers};this.RTC=function(){return _RTC};this.zingayaAPI=function(){return _zingayaAPI}};VoxImplant.Call.prototype={id:function(){return this.call()},number:function(){return this.__number()},displayName:function(){return this.__displayName()},headers:function(){return this.__headers()},active:function(){return this.RTC()?this.zingayaAPI().isCallActive(this.call()):VoxImplant.Utils.swfMovie("voximplantSWF").isCallActive(this.call())},state:function(){if(this.RTC())return this.zingayaAPI().getCallState(this.call());else{var state=VoxImplant.Utils.swfMovie("voximplantSWF").getCallState(this.call()).toUpperCase();switch(state){case"CONNECTING":state=VoxImplant.VI_CALL_STATE_ALERTING;break;case"CONNECTED_ON_HOLD":state=VoxImplant.VI_CALL_STATE_CONNECTED;break;case"DISCONNECTED":case"FAILED":state=VoxImplant.VI_CALL_STATE_ENDED;break}return state}},answer:function(customData,extraHeaders){if(typeof customData!="undefined"){if(typeof extraHeaders=="undefined")extraHeaders=new Object;extraHeaders["VI-CallData"]=customData}if(this.RTC()){if(this.zingayaAPI().getCallState(this.call())!=VoxImplant.VI_CALL_STATE_ALERTING)throw new Error("NO_INCOMING_CALL");this.zingayaAPI().answerCall(this.call(),extraHeaders)}else{extraHeaders=JSON.stringify(extraHeaders);VoxImplant.Utils.swfMovie("voximplantSWF").accept(this.call(),extraHeaders)}},decline:function(extraHeaders){if(this.RTC()){if(this.zingayaAPI().getCallState(this.call())!=VoxImplant.VI_CALL_STATE_ALERTING)throw new Error("NO_INCOMING_CALL");this.zingayaAPI().rejectCall(this.call(),486,extraHeaders)}else{extraHeaders=VoxImplant.Utils.stringifyExtraHeaders(extraHeaders);VoxImplant.Utils.swfMovie("voximplantSWF").reject(this.call(),extraHeaders)}},reject:function(extraHeaders){this.decline(extraHeaders)},hangup:function(extraHeaders){if(this.RTC()){if(this.zingayaAPI().getCallState(this.call())==VoxImplant.VI_CALL_STATE_CONNECTED||this.zingayaAPI().getCallState(this.call())==VoxImplant.VI_CALL_STATE_PROGRESSING)this.zingayaAPI().hangupCall(this.call(),extraHeaders);else throw new Error("WRONG_CALL_STATE")}else{extraHeaders=VoxImplant.Utils.stringifyExtraHeaders(extraHeaders);VoxImplant.Utils.swfMovie("voximplantSWF").disconnectCall(this.call(),extraHeaders)}},sendTone:function(key){if(key=="*")key=10;else if(key=="#")key=11;else{key=parseInt(key);if(key<0||key>9)throw new Error("WRONG_TONE_INPUT")}if(this.RTC()){if(this.zingayaAPI().getCallState(this.call())!=VoxImplant.VI_CALL_STATE_CONNECTED)throw new Error("CALL_NOT_CONNECTED");this.zingayaAPI().sendDigit(this.call(),key)}else{VoxImplant.Utils.swfMovie("voximplantSWF").sendDTMF(key,this.call())}},mutePlayback:function(){if(this.RTC()){this.zingayaAPI().mutePlayback(true)}else{VoxImplant.Utils.swfMovie("voximplantSWF").muteIncomingAudio(this.call())}},muteMicrophone:function(){if(this.RTC()){this.zingayaAPI().muteMicrophone(true)}else{VoxImplant.Utils.swfMovie("voximplantSWF").muteOutgoingAudio(this.call())}},unmutePlayback:function(){if(this.RTC()){this.zingayaAPI().mutePlayback(false)}else{VoxImplant.Utils.swfMovie("voximplantSWF").unmuteIncomingAudio(this.call())}},unmuteMicrophone:function(){if(this.RTC()){this.zingayaAPI().muteMicrophone(false)}else{VoxImplant.Utils.swfMovie("voximplantSWF").unmuteOutgoingAudio(this.call())}},showRemoteVideo:function(flag){if(typeof flag=="undefined")flag=true;if(this.RTC()){document.getElementById(this.zingayaAPI().getVideoElementId(this.call())).style.display=flag?"block":"none"}else{VoxImplant.Utils.swfMovie("voximplantSWF").showRemoteVideo(this.call(),flag)}},setRemoteVideoPosition:function(x,y){if(this.RTC()){throw new Error("Please use CSS to position '#voximplantcontainer' element")}else{VoxImplant.Utils.swfMovie("voximplantSWF").setRemoteViewPosition(this.call(),x,y)}},setRemoteVideoSize:function(width,height){if(this.RTC()){throw new Error("Please use CSS to set size of '#voximplantcontainer' element")}else{VoxImplant.Utils.swfMovie("voximplantSWF").setRemoteViewSize(this.call(),width,height)}},sendInfo:function(mimeType,body,extraHeaders){var type,subtype,i=mimeType.indexOf("/");if(i==-1){type="application";subtype=mimeType}else{type=mimeType.substring(0,i);subtype=mimeType.substring(i+1)}if(this.RTC()){if(this.zingayaAPI().getCallState(this.call())!=VoxImplant.VI_CALL_STATE_CONNECTED)throw new Error("CALL_NOT_CONNECTED");this.zingayaAPI().sendSIPInfo(this.call(),type,subtype,body,extraHeaders)}else{extraHeaders=VoxImplant.Utils.stringifyExtraHeaders(extraHeaders);VoxImplant.Utils.swfMovie("voximplantSWF").sendSIPInfo(this.call(),type,subtype,body,extraHeaders)}},sendMessage:function(msg){if(this.RTC()){if(this.zingayaAPI().getCallState(this.call())!=VoxImplant.VI_CALL_STATE_CONNECTED)throw new Error("CALL_NOT_CONNECTED");this.zingayaAPI().sendInstantMessage(this.call(),msg)}else{VoxImplant.Utils.swfMovie("voximplantSWF").sendMessage(this.call(),msg)}},setVideoSettings:function(settings,successCallback,failedCallback){if(this.RTC()){this.zingayaAPI().setConstraints(settings,successCallback,failedCallback)}else if(!this.useRTCOnly){if(Object.prototype.toString.call(settings)=="[object Object]")settings=JSON.stringify(settings);VoxImplant.Utils.swfMovie("voximplantSWF").setVideoSettings(settings,this.call())}},getIncomingStreamInfo:function(){if(this.RTC()){}else if(!this.useRTCOnly){return JSON.parse(VoxImplant.Utils.swfMovie("voximplantSWF").getIncomingStreamInfo(this.call()))}},getOutgoingStreamInfo:function(){if(this.RTC()){}else if(!this.useRTCOnly){return JSON.parse(VoxImplant.Utils.swfMovie("voximplantSWF").getOutgoingStreamInfo(this.call()))}},getVideoElementId:function(){if(this.RTC()){return this.zingayaAPI().getVideoElementId(this.call())}}};VoxImplant.Client=function(){this.config=null;this.calls=new Array;var Call=VoxImplant.Call;delete VoxImplant.Call;var _connected=false;this.eventListeners={};this.progressToneScript={US:"440@-19,480@-19;*(2/4/1+2)",RU:"425@-19;*(1/3/1)"};this.playingNow=false;this.serversList=new Array;var _vol=100;this.audioSourcesList=new Array;this.videoSourcesList=new Array;this.deviceEnumAPI=typeof MediaStreamTrack!="undefined"&&typeof MediaStreamTrack.getSources!="undefined";this.gotSources=function(sourceInfos){if(this.audioSourcesList.length!=0)this.audioSourcesList=new Array;if(this.videoSourcesList.length!=0)this.videoSourcesList=new Array;var v=0,a=0;for(var i=0;i!=sourceInfos.length;++i){var sourceInfo=sourceInfos[i];if(sourceInfo.kind==="audio"){a++;this.audioSourcesList.push({id:sourceInfo.id,name:sourceInfo.label||"Audio recording device "+a})}else if(sourceInfo.kind==="video"){v++;this.videoSourcesList.push({id:sourceInfo.id,name:sourceInfo.label||"Video recording device "+v})}}this.dispatchEvent({name:"SourcesInfoUpdated"})}.bind(this),this.__init=function(config){if(this.config!=null)throw"VoxImplant.Client has been already initialized";this.config=typeof config!=="undefined"?config:{};if(this.config.useFlashOnly===true)this.useFlashOnly=true;else this.useFlashOnly=false;if(this.config.useRTCOnly===true)this.useRTCOnly=true;else this.useRTCOnly=false;this.RTCsupported=false;if(this.config.micRequired!==false)this.micRequired=true;else this.micRequired=false;if(this.config.videoSupport!==true)this.videoSupport=false;else this.videoSupport=true;if(typeof this.config.swfContainer!="undefined")this.swfContainer=this.config.swfContainer;else this.swfContainer=null;if(typeof this.config.progressToneCountry!="undefined")this.progressToneCountry=this.config.progressToneCountry;else this.progressToneCountry="US";if(this.config.progressTone!==true)this.progressTone=false;else this.progressTone=true;if(this.config.showFlashSettings===true)this.showFlashSettings=true;else this.showFlashSettings=false;if(typeof this.config.serverIp!="undefined")this.serverIp=this.config.serverIp;if(typeof this.config.swfURL!="undefined")this.swfURL=this.config.swfURL;if(typeof this.config.showDebugInfo!="undefined")this.showDebugInfo=this.config.showDebugInfo;else this.showDebugInfo=true;if(typeof webkitRTCPeerConnection!="undefined"||typeof mozRTCPeerConnection!="undefined"){if(typeof mozRTCPeerConnection!="undefined"){try{var testPC=new mozRTCPeerConnection({iceServers:[]});this.RTCsupported=true}catch(e){}}else this.RTCsupported=true}if(this.RTCsupported&&!this.useFlashOnly){this.zingayaAPI=new VoxImplant.ZingayaAPI(this.videoSupport,this.micRequired);delete VoxImplant.ZingayaAPI;this.zingayaAPI.onConnectionEstablished=function(){this.connectionState(true);this.dispatchEvent({name:"ConnectionEstablished"})}.bind(this);this.zingayaAPI.onConnectionFailed=function(msg){if(this.serversList.length>1&&typeof this.serverIp=="undefined"){this.serversList.splice(0,1);this.connectTo(this.serversList[0],true)}else this.dispatchEvent({name:"ConnectionFailed",message:msg})}.bind(this);this.zingayaAPI.onConnectionClosed=function(){this.connectionState(false);this.__cleanup();this.dispatchEvent({name:"ConnectionClosed"});if(this.progressTone)this.stopProgressTone()}.bind(this);this.zingayaAPI.onLoginSuccessful=function(displayName,options){this.dispatchEvent({name:"AuthResult",result:true,displayName:displayName,options:options})}.bind(this);this.zingayaAPI.onLoginFailed=function(obj){this.dispatchEvent({name:"AuthResult",result:false,code:obj.errorCode,key:obj.oneTimeKey})}.bind(this);this.zingayaAPI.onCallConnected=function(call_id,headers){this.getCall(call_id).dispatchEvent({name:"Connected",call:this.getCall(call_id),headers:headers});if(this.progressTone)this.stopProgressTone()}.bind(this);this.zingayaAPI.onCallEnded=function(call_id,headers){this.getCall(call_id).dispatchEvent({name:"Disconnected",call:this.getCall(call_id),headers:headers});this.removeCall(call_id);if(this.progressTone)this.stopProgressTone()}.bind(this);this.zingayaAPI.onCallFailed=function(call_id,code,reason,headers){this.getCall(call_id).dispatchEvent({name:"Failed",call:this.getCall(call_id),code:code,reason:reason,headers:headers});this.removeCall(call_id);if(this.progressTone)this.stopProgressTone()}.bind(this);this.zingayaAPI.onMediaAccessGranted=function(){if(this.deviceEnumAPI)MediaStreamTrack.getSources(this.gotSources);if(this.micRequired)this.zingayaAPI.connectTo(this.host,"platform");this.dispatchEvent({name:"MicAccessResult",result:true})}.bind(this);this.zingayaAPI.onMediaAccessRejected=function(){this.dispatchEvent({name:"MicAccessResult",result:false})}.bind(this);this.zingayaAPI.onIncomingCall=function(call_id,remoteUserName,remoteDisplayName,headers){var newCall=new Call(call_id,remoteUserName,remoteDisplayName,headers,true,this.zingayaAPI);if(this.calls.length>0)this.zingayaAPI.setCallActive(call_id,false);this.calls.push(newCall);this.dispatchEvent({name:"IncomingCall",call:newCall,headers:headers})}.bind(this);this.zingayaAPI.onCallRinging=function(call_id){this.getCall(call_id).dispatchEvent({name:"ProgressToneStart",call:this.getCall(call_id)});if(this.progressTone)this.playProgressTone()}.bind(this);this.zingayaAPI.onCallMediaStarted=function(call_id){this.getCall(call_id).dispatchEvent({name:"ProgressToneStop",call:this.getCall(call_id)});if(this.progressTone)this.stopProgressTone()}.bind(this);this.zingayaAPI.onInstantMessageReceived=function(call_id,body){this.getCall(call_id).dispatchEvent({name:"MessageReceived",call:this.getCall(call_id),text:body})}.bind(this);this.zingayaAPI.onSIPInfoReceived=function(call_id,mime,body,headers){this.getCall(call_id).dispatchEvent({name:"InfoReceived",call:this.getCall(call_id),mimeType:mime,body:body,headers:headers})}.bind(this);this.zingayaAPI.onTransferComplete=function(call_id){this.getCall(call_id).dispatchEvent({name:"TransferComplete",call:this.getCall(call_id)})}.bind(this);this.zingayaAPI.onTransferFailed=function(call_id){this.getCall(call_id).dispatchEvent({name:"TransferFailed",call:this.getCall(call_id)})}.bind(this);this.zingayaAPI.onNetStatsReceived=function(stats){this.dispatchEvent({name:"NetStatsReceived",stats:stats})}.bind(this);this.zingayaAPI.onPresenceUpdate=function(presence,user){this.dispatchEvent({name:"PresenceUpdate",presence:presence,user:user})}.bind(this);this.zingayaAPI.writeLog=function(message){if(typeof this.writeLog=="function")this.writeLog(message);else{var dateTimeOptions={year:"numeric",month:"numeric",day:"numeric"};if(this.showDebugInfo)BXIM.webrtc.phoneLog("VI WebRTC: "+(new Date).toLocaleTimeString("en-US",dateTimeOptions)+" "+message)}}.bind(this);this.zingayaAPI.writeTrace=function(message){if(typeof this.writeTrace=="function")this.writeTrace(message);else{var dateTimeOptions={year:"numeric",month:"numeric",day:"numeric"};if(this.showDebugInfo)BXIM.webrtc.phoneLog("VI WebRTC: "+(new Date).toLocaleTimeString("en-US",dateTimeOptions)+" "+message)}}.bind(this);function checkDOMReady(){if(typeof document!="undefined"){clearInterval(ts);this.dispatchEvent({name:"SDKReady",version:VoxImplant.version});if(this.deviceEnumAPI)MediaStreamTrack.getSources(this.gotSources)}}var ts=setInterval(checkDOMReady.bind(this),100)}else if(!this.useRTCOnly){var swfobject=function(){var D="undefined",r="object",S="Shockwave Flash",W="ShockwaveFlash.ShockwaveFlash",q="application/x-shockwave-flash",R="SWFObjectExprInst",x="onreadystatechange",O=window,j=document,t=navigator,T=false,U=[h],o=[],N=[],I=[],l,Q,E,B,J=false,a=false,n,G,m=true,M=function(){var aa=typeof j.getElementById!=D&&typeof j.getElementsByTagName!=D&&typeof j.createElement!=D,ah=t.userAgent.toLowerCase(),Y=t.platform.toLowerCase(),ae=Y?/win/.test(Y):/win/.test(ah),ac=Y?/mac/.test(Y):/mac/.test(ah),af=/webkit/.test(ah)?parseFloat(ah.replace(/^.*webkit\/(\d+(\.\d+)?).*$/,"$1")):false,X=!+"1",ag=[0,0,0],ab=null;if(typeof t.plugins!=D&&typeof t.plugins[S]==r){ab=t.plugins[S].description;if(ab&&!(typeof t.mimeTypes!=D&&t.mimeTypes[q]&&!t.mimeTypes[q].enabledPlugin)){T=true;X=false;ab=ab.replace(/^.*\s+(\S+\s+\S+$)/,"$1");ag[0]=parseInt(ab.replace(/^(.*)\..*$/,"$1"),10);ag[1]=parseInt(ab.replace(/^.*\.(.*)\s.*$/,"$1"),10);ag[2]=/[a-zA-Z]/.test(ab)?parseInt(ab.replace(/^.*[a-zA-Z]+(.*)$/,"$1"),10):0}}else{if(typeof O.ActiveXObject!=D){try{var ad=new ActiveXObject(W);if(ad){ab=ad.GetVariable("$version");if(ab){X=true;ab=ab.split(" ")[1].split(",");ag=[parseInt(ab[0],10),parseInt(ab[1],10),parseInt(ab[2],10)]}}}catch(Z){}}}return{w3:aa,pv:ag,wk:af,ie:X,win:ae,mac:ac}}(),k=function(){if(!M.w3){return}if(typeof j.readyState!=D&&j.readyState=="complete"||typeof j.readyState==D&&(j.getElementsByTagName("body")[0]||j.body)){f()}if(!J){if(typeof j.addEventListener!=D){j.addEventListener("DOMContentLoaded",f,false)}if(M.ie&&M.win){j.attachEvent(x,function(){if(j.readyState=="complete"){j.detachEvent(x,arguments.callee);f()}});if(O==top){(function(){if(J){return}try{j.documentElement.doScroll("left")}catch(X){setTimeout(arguments.callee,0);return}f()})()}}if(M.wk){(function(){if(J){return}if(!/loaded|complete/.test(j.readyState)){setTimeout(arguments.callee,0);return}f()})()}s(f)}}();function f(){if(J){return}try{var Z=j.getElementsByTagName("body")[0].appendChild(C("span"));Z.parentNode.removeChild(Z)}catch(aa){return}J=true;var X=U.length;for(var Y=0;Y<X;Y++){U[Y]()}}function K(X){if(J){X()}else{U[U.length]=X}}function s(Y){if(typeof O.addEventListener!=D){O.addEventListener("load",Y,false)}else{if(typeof j.addEventListener!=D){j.addEventListener("load",Y,false)}else{if(typeof O.attachEvent!=D){i(O,"onload",Y)}else{if(typeof O.onload=="function"){var X=O.onload;O.onload=function(){X();Y()}}else{O.onload=Y}}}}}function h(){if(T){V()}else{H()}}function V(){var X=j.getElementsByTagName("body")[0];var aa=C(r);aa.setAttribute("type",q);var Z=X.appendChild(aa);if(Z){var Y=0;(function(){if(typeof Z.GetVariable!=D){var ab=Z.GetVariable("$version");if(ab){ab=ab.split(" ")[1].split(",");M.pv=[parseInt(ab[0],10),parseInt(ab[1],10),parseInt(ab[2],10)]}}else{if(Y<10){Y++;setTimeout(arguments.callee,10);return}}X.removeChild(aa);Z=null;H()})()}else{H()}}function H(){var ag=o.length;if(ag>0){for(var af=0;af<ag;af++){var Y=o[af].id;var ab=o[af].callbackFn;var aa={success:false,id:Y};if(M.pv[0]>0){var ae=c(Y);if(ae){if(F(o[af].swfVersion)&&!(M.wk&&M.wk<312)){w(Y,true);if(ab){aa.success=true;aa.ref=z(Y);ab(aa)}}else{if(o[af].expressInstall&&A()){var ai={};ai.data=o[af].expressInstall;ai.width=ae.getAttribute("width")||"0";ai.height=ae.getAttribute("height")||"0";if(ae.getAttribute("class")){ai.styleclass=ae.getAttribute("class")}if(ae.getAttribute("align")){ai.align=ae.getAttribute("align")}var ah={};var X=ae.getElementsByTagName("param");var ac=X.length;for(var ad=0;ad<ac;ad++){if(X[ad].getAttribute("name").toLowerCase()!="movie"){ah[X[ad].getAttribute("name")]=X[ad].getAttribute("value")}}P(ai,ah,Y,ab)}else{p(ae);if(ab){ab(aa)}}}}}else{w(Y,true);if(ab){var Z=z(Y);if(Z&&typeof Z.SetVariable!=D){aa.success=true;aa.ref=Z}ab(aa)}}}}}function z(aa){var X=null;var Y=c(aa);if(Y&&Y.nodeName=="OBJECT"){if(typeof Y.SetVariable!=D){X=Y}else{var Z=Y.getElementsByTagName(r)[0];if(Z){X=Z}}}return X}function A(){return!a&&F("6.0.65")&&(M.win||M.mac)&&!(M.wk&&M.wk<312)}function P(aa,ab,X,Z){a=true;E=Z||null;B={success:false,id:X};var ae=c(X);if(ae){if(ae.nodeName=="OBJECT"){l=g(ae);Q=null}else{l=ae;Q=X}aa.id=R;if(typeof aa.width==D||!/%$/.test(aa.width)&&parseInt(aa.width,10)<310){aa.width="310"}if(typeof aa.height==D||!/%$/.test(aa.height)&&parseInt(aa.height,10)<137){aa.height="137"}j.title=j.title.slice(0,47)+" - Flash Player Installation";var ad=M.ie&&M.win?"ActiveX":"PlugIn",ac="MMredirectURL="+O.location.toString().replace(/&/g,"%26")+"&MMplayerType="+ad+"&MMdoctitle="+j.title;if(typeof ab.flashvars!=D){ab.flashvars+="&"+ac}else{ab.flashvars=ac}if(M.ie&&M.win&&ae.readyState!=4){var Y=C("div");X+="SWFObjectNew";Y.setAttribute("id",X);ae.parentNode.insertBefore(Y,ae);ae.style.display="none";(function(){if(ae.readyState==4){ae.parentNode.removeChild(ae)}else{setTimeout(arguments.callee,10)}})()}u(aa,ab,X)}}function p(Y){if(M.ie&&M.win&&Y.readyState!=4){var X=C("div");Y.parentNode.insertBefore(X,Y);X.parentNode.replaceChild(g(Y),X);Y.style.display="none";(function(){if(Y.readyState==4){Y.parentNode.removeChild(Y)}else{setTimeout(arguments.callee,10)}})()}else{Y.parentNode.replaceChild(g(Y),Y)}}function g(ab){var aa=C("div");if(M.win&&M.ie){aa.innerHTML=ab.innerHTML}else{var Y=ab.getElementsByTagName(r)[0];if(Y){var ad=Y.childNodes;if(ad){var X=ad.length;for(var Z=0;Z<X;Z++){if(!(ad[Z].nodeType==1&&ad[Z].nodeName=="PARAM")&&!(ad[Z].nodeType==8)){aa.appendChild(ad[Z].cloneNode(true))}}}}}return aa}function u(ai,ag,Y){var X,aa=c(Y);if(M.wk&&M.wk<312){return X}if(aa){if(typeof ai.id==D){ai.id=Y}if(M.ie&&M.win){var ah="";for(var ae in ai){if(ai[ae]!=Object.prototype[ae]){if(ae.toLowerCase()=="data"){ag.movie=ai[ae]}else{if(ae.toLowerCase()=="styleclass"){ah+=' class="'+ai[ae]+'"'}else{if(ae.toLowerCase()!="classid"){ah+=" "+ae+'="'+ai[ae]+'"'}}}}}var af="";for(var ad in ag){if(ag[ad]!=Object.prototype[ad]){af+='<param name="'+ad+'" value="'+ag[ad]+'" />'}}aa.outerHTML='<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"'+ah+">"+af+"</object>";N[N.length]=ai.id;X=c(ai.id)}else{var Z=C(r);Z.setAttribute("type",q);for(var ac in ai){if(ai[ac]!=Object.prototype[ac]){if(ac.toLowerCase()=="styleclass"){Z.setAttribute("class",ai[ac])}else{if(ac.toLowerCase()!="classid"){Z.setAttribute(ac,ai[ac])}}}}for(var ab in ag){if(ag[ab]!=Object.prototype[ab]&&ab.toLowerCase()!="movie"){e(Z,ab,ag[ab])}}aa.parentNode.replaceChild(Z,aa);X=Z}}return X}function e(Z,X,Y){var aa=C("param");aa.setAttribute("name",X);aa.setAttribute("value",Y);Z.appendChild(aa)}function y(Y){var X=c(Y);if(X&&X.nodeName=="OBJECT"){if(M.ie&&M.win){X.style.display="none";(function(){if(X.readyState==4){b(Y)}else{setTimeout(arguments.callee,10)}})()}else{X.parentNode.removeChild(X)}}}function b(Z){var Y=c(Z);if(Y){for(var X in Y){if(typeof Y[X]=="function"){Y[X]=null}}Y.parentNode.removeChild(Y)}}function c(Z){var X=null;try{X=j.getElementById(Z)}catch(Y){}return X}function C(X){return j.createElement(X)}function i(Z,X,Y){Z.attachEvent(X,Y);I[I.length]=[Z,X,Y]}function F(Z){var Y=M.pv,X=Z.split(".");X[0]=parseInt(X[0],10);X[1]=parseInt(X[1],10)||0;X[2]=parseInt(X[2],10)||0;return Y[0]>X[0]||Y[0]==X[0]&&Y[1]>X[1]||Y[0]==X[0]&&Y[1]==X[1]&&Y[2]>=X[2]?true:false}function v(ac,Y,ad,ab){if(M.ie&&M.mac){return}var aa=j.getElementsByTagName("head")[0];if(!aa){return}var X=ad&&typeof ad=="string"?ad:"screen";if(ab){n=null;G=null}if(!n||G!=X){var Z=C("style");Z.setAttribute("type","text/css");Z.setAttribute("media",X);n=aa.appendChild(Z);if(M.ie&&M.win&&typeof j.styleSheets!=D&&j.styleSheets.length>0){n=j.styleSheets[j.styleSheets.length-1]}G=X}if(M.ie&&M.win){if(n&&typeof n.addRule==r){n.addRule(ac,Y)}}else{if(n&&typeof j.createTextNode!=D){n.appendChild(j.createTextNode(ac+" {"+Y+"}"))}}}function w(Z,X){if(!m){return}var Y=X?"visible":"hidden";if(J&&c(Z)){c(Z).style.visibility=Y}else{v("#"+Z,"visibility:"+Y)}}function L(Y){var Z=/[\\\"<>\.;]/;var X=Z.exec(Y)!=null;return X&&typeof encodeURIComponent!=D?encodeURIComponent(Y):Y}var d=function(){if(M.ie&&M.win){window.attachEvent("onunload",function(){var ac=I.length;for(var ab=0;ab<ac;ab++){I[ab][0].detachEvent(I[ab][1],I[ab][2])}var Z=N.length;for(var aa=0;aa<Z;aa++){y(N[aa])}for(var Y in M){M[Y]=null}M=null;for(var X in swfobject){swfobject[X]=null}swfobject=null})}}();return{registerObject:function(ab,X,aa,Z){if(M.w3&&ab&&X){var Y={};Y.id=ab;Y.swfVersion=X;Y.expressInstall=aa;Y.callbackFn=Z;o[o.length]=Y;w(ab,false)}else{if(Z){Z({success:false,id:ab})}}},getObjectById:function(X){if(M.w3){return z(X)}},embedSWF:function(ab,ah,ae,ag,Y,aa,Z,ad,af,ac){var X={success:false,id:ah};if(M.w3&&!(M.wk&&M.wk<312)&&ab&&ah&&ae&&ag&&Y){w(ah,false);K(function(){ae+="";ag+="";var aj={};if(af&&typeof af===r){for(var al in af){aj[al]=af[al]}}aj.data=ab;aj.width=ae;aj.height=ag;var am={};if(ad&&typeof ad===r){for(var ak in ad){am[ak]=ad[ak]}}if(Z&&typeof Z===r){for(var ai in Z){if(typeof am.flashvars!=D){am.flashvars+="&"+ai+"="+Z[ai]}else{am.flashvars=ai+"="+Z[ai]}}}if(F(Y)){var an=u(aj,am,ah);if(aj.id==ah){w(ah,true)}X.success=true;X.ref=an}else{if(aa&&A()){aj.data=aa;P(aj,am,ah,ac);return}else{w(ah,true)}}if(ac){ac(X)}})}else{if(ac){ac(X)}}},switchOffAutoHideShow:function(){m=false},ua:M,getFlashPlayerVersion:function(){return{major:M.pv[0],minor:M.pv[1],release:M.pv[2]}},hasFlashPlayerVersion:F,createSWF:function(Z,Y,X){if(M.w3){return u(Z,Y,X)}else{return undefined}},showExpressInstall:function(Z,aa,X,Y){if(M.w3&&A()){P(Z,aa,X,Y)}},removeSWF:function(X){if(M.w3){y(X)}},createCSS:function(aa,Z,Y,X){if(M.w3){v(aa,Z,Y,X)}},addDomLoadEvent:K,addLoadEvent:s,getQueryParamValue:function(aa){var Z=j.location.search||j.location.hash;if(Z){if(/\?/.test(Z)){Z=Z.split("?")[1]}if(aa==null){return L(Z)}var Y=Z.split("&");for(var X=0;X<Y.length;X++){if(Y[X].substring(0,Y[X].indexOf("="))==aa){return L(Y[X].substring(Y[X].indexOf("=")+1))}}}return""},expressInstallCallback:function(){if(a){var X=c(R);if(X&&l){X.parentNode.replaceChild(l,X);if(Q){w(Q,true);if(M.ie&&M.win){l.style.display="block"}}if(E){E(B)}}a=false}}}}();function createContainer(){if(typeof document!="undefined"){clearInterval(ts);if(this.swfContainer!=null){var div=document.getElementById(this.swfContainer);if(div==null)throw new Error("NO_SWF_CONTAINER");if(div.offsetWidth<215)div.style.minWidth=div.style.width=215+"px";if(div.offsetHeight<138)div.style.minHeight=div.style.height=138+"px"}else{div=document.createElement("div");this.swfContainer=div.id="voximplantcontainer";div.style.minWidth=div.style.width=215+"px";div.style.minHeight=div.style.height=138+"px";if(document.body.firstChild)document.body.insertBefore(div,document.body.firstChild);else document.body.appendChild(div)}if(navigator.userAgent.indexOf("Safari")!=-1)div.style.minWidth=div.style.width=310+"px";var div2=document.createElement("div");div2.id="voximplantcontainerSWF";div.appendChild(div2);var attributes={id:"voximplantSWF",name:"voximplantSWF"};var flashvars=false;var params={allowScriptAccess:"always",wmode:"window",allowFullScreen:"true"};window.voxImplantFlashAPIReady=swfLoaded.bind(this);var swfPath=("https:"==document.location.protocol?"https://":"http://")+"cdn.voximplant.com/VoxImplant-2.9.swf?ver=300115";if(typeof this.swfURL!="undefined")swfPath=this.swfURL;swfobject.embedSWF(swfPath,"voximplantcontainerSWF","100%","100%","11.3","http://cdn.voximplant.com/expressInstall.swf",flashvars,params,attributes)}}if(!swfobject.hasFlashPlayerVersion("11.3"))throw new Error("OLD_FLASH_VERSION");var ts=setInterval(createContainer.bind(this),100)}else{throw new Error("NO_WEBRTC_SUPPORT")}function swfLoaded(){this.dispatchEvent({name:"SDKReady",version:VoxImplant.version});if(navigator.userAgent.indexOf("Safari")!=-1){var div=document.getElementById(this.swfContainer);if(div!=null)div.style.minWidth=div.style.width=215+"px"
}var aSources=JSON.parse(VoxImplant.Utils.swfMovie("voximplantSWF").audioSources());var vSources=JSON.parse(VoxImplant.Utils.swfMovie("voximplantSWF").videoSources());for(var i=0;i<aSources.length;i++)this.audioSourcesList.push({id:i,name:aSources[i]});for(i=0;i<vSources.length;i++)this.videoSourcesList.push({id:i,name:vSources[i]});this.dispatchEvent({name:"SourcesInfoUpdated"})}window.VILog=function(message){if(typeof this.writeLog=="function")this.writeLog(message);else{var dateTimeOptions={year:"numeric",month:"numeric",day:"numeric"};if(this.showDebugInfo&&typeof console!="undefined")BXIM.webrtc.phoneLog("VI FLASH: "+(new Date).toLocaleTimeString("en-US",dateTimeOptions)+" "+message)}}.bind(this);window.VIConnectionEstablished=function(){this.connectionState(true);this.dispatchEvent({name:"ConnectionEstablished"})}.bind(this);window.VIConnectionFailed=function(){if(this.serversList.length>1&&typeof this.serverIp=="undefined"){this.serversList.splice(0,1);this.connectTo(this.serversList[0],true)}else{this.dispatchEvent({name:"ConnectionFailed"})}}.bind(this);window.VIConnectionClosed=function(){this.connectionState(false);this.__cleanup();this.dispatchEvent({name:"ConnectionClosed"});if(this.progressTone)this.stopProgressTone()}.bind(this);window.VIAuthFailed=function(code,key){this.dispatchEvent({name:"AuthResult",result:false,code:code,key:key})}.bind(this);window.VIAuthSuccessful=function(displayName,options){if(typeof options=="string")options=JSON.parse(options);this.dispatchEvent({name:"AuthResult",result:true,displayName:displayName,options:options})}.bind(this);window.VICallConnected=function(id,headers){this.getCall(id).dispatchEvent({name:"Connected",call:this.getCall(id),headers:headers!=null?JSON.parse(headers):{}});if(this.progressTone)this.stopProgressTone()}.bind(this);window.VICallDisconnected=function(id,headers){this.getCall(id).dispatchEvent({name:"Disconnected",call:this.getCall(id),headers:headers!=null?JSON.parse(headers):{}});this.removeCall(id);if(this.progressTone)this.stopProgressTone()}.bind(this);window.VICallFailed=function(id,code,reason,headers){this.getCall(id).dispatchEvent({name:"Failed",call:this.getCall(id),code:code,reason:reason,headers:headers!=null?JSON.parse(headers):{}});this.removeCall(id);if(this.progressTone)this.stopProgressTone()}.bind(this);window.VIMicAccessResult=function(res){this.dispatchEvent({name:"MicAccessResult",result:res})}.bind(this);window.VIProgressToneStart=function(id){this.getCall(id).dispatchEvent({name:"ProgressToneStart",call:this.getCall(id)});if(this.progressTone)this.playProgressTone()}.bind(this);window.VIProgressToneStop=function(id){this.getCall(id).dispatchEvent({name:"ProgressToneStop",call:this.getCall(id)});if(this.progressTone)this.stopProgressTone()}.bind(this);window.VIIncomingCall=function(id,num,displayName,headers){var newCall=new Call(id,num,displayName,headers!=null?JSON.parse(headers):{},false);if(this.calls.length>0)this.zingayaAPI.setCallActive(id,false);this.calls.push(newCall);this.dispatchEvent({name:"IncomingCall",call:newCall,headers:headers!=null?JSON.parse(headers):{}})}.bind(this);window.VISIPInfoReceived=function(id,type,subtype,body,headers){if(type=="application"&&subtype=="zingaya-im"){this.getCall(id).dispatchEvent({name:"MessageReceived",call:this.getCall(id),text:body})}else{if(headers!=null)headers=JSON.parse(headers);this.getCall(id).dispatchEvent({name:"InfoReceived",call:this.getCall(id),mimeType:type+"/"+subtype,body:body,headers:headers})}}.bind(this);window.VIToneScriptPlaybackStop=function(){this.dispatchEvent({name:"PlaybackFinished"})}.bind(this);window.VITransferComplete=function(id){this.getCall(id).dispatchEvent({name:"TransferComplete",call:this.getCall(id)})}.bind(this);window.VITransferFailed=function(id){this.getCall(id).dispatchEvent({name:"TransferFailed",call:this.getCall(id)})}.bind(this);window.VIPacketLossInfo=function(val){this.dispatchEvent({name:"NetStatsReceived",stats:{packetLoss:val}})}.bind(this);window.VIPresenceUpdate=function(presence,user){this.dispatchEvent({name:"PresenceUpdate",presence:presence,user:user})}.bind(this)},this.connectionState=function(b){if(typeof b=="undefined")return _connected;else _connected=b};this.getCall=function(call_id){for(var i=0;i<this.calls.length;i++){if(this.calls[i].call()==call_id)return this.calls[i]}return null};this.removeCall=function(call_id){var newCallsArray=new Array;for(var i=0;i<this.calls.length;i++){if(this.calls[i].call()!=call_id)newCallsArray.push(this.calls[i]);else delete this.calls[i]}this.calls=newCallsArray};this.playProgressTone=function(){if(this.progressToneScript[this.progressToneCountry]!=null){if(!this.playingNow)this.playToneScript(this.progressToneScript[this.progressToneCountry]);this.playingNow=true}};this.stopProgressTone=function(){if(this.playingNow){this.stopPlayback();this.playingNow=false}};this.__call=function(num,useVideo,customData,extraHeaders){if(typeof customData!="undefined"){if(typeof extraHeaders=="undefined")extraHeaders=new Object;extraHeaders["VI-CallData"]=customData}if(!this.connectionState())throw new Error("NOT_CONNECTED_TO_VOXIMPLANT");if(this.RTCsupported&&!this.useFlashOnly){var call_id=this.zingayaAPI.callTo(num,useVideo,extraHeaders);var newCall=new Call(call_id,num,"",extraHeaders,true,this.zingayaAPI);if(this.calls.length>0)this.zingayaAPI.setCallActive(call_id,false)}else if(!this.useRTCOnly){extraHeaders=JSON.stringify(extraHeaders);call_id=VoxImplant.Utils.swfMovie("voximplantSWF").call(num,useVideo,null,extraHeaders);newCall=new Call(call_id,num,"",extraHeaders,false);if(this.calls.length>0)VoxImplant.Utils.swfMovie("voximplantSWF").setCallActive(call_id,false)}this.calls.push(newCall);return newCall};this.__volume=function(vol){if(typeof vol=="undefined")return _vol;else _vol=vol};this.__cleanup=function(){if(this.calls.length>0){var callIds=new Array;for(var i in this.calls){callIds.push(this.calls[i].id());if(this.connectionState())this.calls[i].hangup()}for(var i in callIds)this.removeCall(callIds[i])}}};VoxImplant.Client.prototype={call:function(num,useVideo,customData,extraHeaders){return this.__call(num,useVideo,customData,extraHeaders)},config:function(){return this.config},connect:function(){if(typeof this.serverIp!="undefined"){host=this.serverIp;this.connectTo(host)}else{function balancerResult(data){var ind=String(data).indexOf(";");if(ind==-1){host=data}else{this.serversList=data.split(";");host=this.serversList[0]}this.connectTo(host)}VoxImplant.Utils.getServers(balancerResult.bind(this),false,this)}},connectTo:function(host,omitMicDetection){if(this.connectionState()){throw new Error("ALREADY_CONNECTED_TO_VOXIMPLANT");return}this.host=host;if(this.RTCsupported&&!this.useFlashOnly){if(!this.micRequired||omitMicDetection===true)this.zingayaAPI.connectTo(host,"platform");else this.zingayaAPI.requestMedia(this.videoSupport,this.zingayaAPI.onMediaAccessGranted,this.zingayaAPI.onMediaAccessRejected)}else if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").connect(host,omitMicDetection===true?false:this.micRequired,this.micRequired&&this.showFlashSettings)}},disconnect:function(){if(!this.connectionState())throw new Error("NOT_CONNECTED_TO_VOXIMPLANT");this.__cleanup();if(this.RTCsupported&&!this.useFlashOnly){this.zingayaAPI.destroy()}else if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").disconnect()}},init:function(config){this.__init(config)},setOperatorACDStatus:function(status){if(!this.connectionState())throw new Error("NOT_CONNECTED_TO_VOXIMPLANT");if(this.RTCsupported&&!this.useFlashOnly){this.zingayaAPI.setOperatorACDStatus(status)}else if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").setOperatorACDStatus(status)}},subscribeStatus:function(arr){if(!this.connectionState())throw new Error("NOT_CONNECTED_TO_VOXIMPLANT");if(this.RTCsupported&&!this.useFlashOnly){this.zingayaAPI.subscribeStatus(status)}else if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").subscribeStatus(status)}},login:function(username,password,options){options=typeof options!=="undefined"?options:null;if(!this.connectionState())throw new Error("NOT_CONNECTED_TO_VOXIMPLANT");if(this.RTCsupported&&!this.useFlashOnly){this.zingayaAPI.login(username,password,options)}else if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").login(username,password,JSON.stringify(options))}},loginWithCode:function(username,code,options){options=typeof options!=="undefined"?options:null;if(!this.connectionState())throw new Error("NOT_CONNECTED_TO_VOXIMPLANT");if(this.RTCsupported&&!this.useFlashOnly){this.zingayaAPI.loginStage2(username,code,options)}else if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").loginStage2(username,code,JSON.stringify(options))}},requestOneTimeLoginKey:function(username){if(!this.connectionState())throw new Error("NOT_CONNECTED_TO_VOXIMPLANT");if(this.RTCsupported&&!this.useFlashOnly){this.zingayaAPI.loginGenerateOneTimeKey(username)}else if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").requestOneTimeLoginKey(username)}},loginWithOneTimeKey:function(username,hash,options){options=typeof options!=="undefined"?options:null;if(!this.connectionState())throw new Error("NOT_CONNECTED_TO_VOXIMPLANT");if(this.RTCsupported&&!this.useFlashOnly){this.zingayaAPI.loginUsingOneTimeKey(username,hash,options)}else if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").loginUsingOneTimeKey(username,hash,JSON.stringify(options))}},setPresenceStatus:function(status){if(!this.connectionState())throw new Error("NOT_CONNECTED_TO_VOXIMPLANT");if(this.RTCsupported&&!this.useFlashOnly){this.zingayaAPI.setPresenceStatus(status)}else if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").setPresenceStatus(status)}},connected:function(){return this.connectionState()},showLocalVideo:function(flag){if(typeof flag=="undefined")flag=true;if(this.RTCsupported&&!this.useFlashOnly){if(flag){if(document.getElementById("voximplantlocalvideo")==null){var element=document.createElement("video");element.id="voximplantlocalvideo";element.autoplay="autoplay";element.muted="true";if(document.body.firstChild)document.body.insertBefore(element,document.body.firstChild);else document.body.appendChild(element);this.zingayaAPI.setLocalVideoSink(element)}else document.getElementById("voximplantlocalvideo").style.display="block"}else{document.getElementById("voximplantlocalvideo").style.display="none"}}else if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").showLocalVideo(flag)}},setLocalVideoPosition:function(x,y){if(this.RTCsupported&&!this.useFlashOnly){throw new Error("Please use CSS to position '#voximplantlocalvideo' element")}else if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").setSelfViewPosition(x,y)}},setLocalVideoSize:function(width,height){if(this.RTCsupported&&!this.useFlashOnly){throw new Error("Please use CSS to set size of '#voximplantlocalvideo' element")}else if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").setSelfViewSize(width,height)}},setVideoSettings:function(settings){if(this.RTCsupported&&!this.useFlashOnly){this.zingayaAPI.setConstraints(settings,function(){if(document.getElementById("voximplantlocalvideo")!=null)this.zingayaAPI.setLocalVideoSink(document.getElementById("voximplantlocalvideo"))}.bind(this))}else if(!this.useRTCOnly){if(Object.prototype.toString.call(settings)=="[object Object]")settings=JSON.stringify(settings);VoxImplant.Utils.swfMovie("voximplantSWF").setVideoSettings(settings)}},playToneScript:function(script,loop){if(this.RTCsupported&&!this.useFlashOnly){VoxImplant.Utils.playToneScript(script,loop)}else if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").playToneScript(script,loop)}},stopPlayback:function(){if(this.RTCsupported&&!this.useFlashOnly){if(VoxImplant.Utils.stopPlayback())this.dispatchEvent({name:"PlaybackFinished"})}else if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").stopPlayback()}},volume:function(vol){if(typeof vol=="undefined"){return this.__volume()}else{if(vol>100)vol=100;if(vol<0)vol=0;if(this.RTCsupported&&!this.useFlashOnly){this.zingayaAPI.setPlaybackVolume(vol/100)}else if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").changeIncomingAudioVolume(vol)}this.__volume(vol)}},audioSources:function(){if(this.RTCsupported&&!this.useFlashOnly){if(!this.deviceEnumAPI)throw new Error("NOT_SUPPORTED [MediaStreamTrack.getSources]")}return this.audioSourcesList},videoSources:function(){if(this.RTCsupported&&!this.useFlashOnly){if(!this.deviceEnumAPI)throw new Error("NOT_SUPPORTED [MediaStreamTrack.getSources]")}return this.videoSourcesList},useAudioSource:function(id,successCallback,failedCallback){if(this.RTCsupported&&!this.useFlashOnly){this.zingayaAPI.useAudioSource(id,successCallback,failedCallback)}else if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").setAudioSource(id)}},useVideoSource:function(id,successCallback,failedCallback){if(this.RTCsupported&&!this.useFlashOnly){this.zingayaAPI.useVideoSource(id,function(){if(document.getElementById("voximplantlocalvideo")!=null)this.zingayaAPI.attachLocalVideoToSink(document.getElementById("voximplantlocalvideo"));if(typeof successCallback=="function")successCallback()}.bind(this),failedCallback)}else if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").setVideoSource(id)}},attachRecordingDevice:function(successCallback,failedCallback){if(this.RTCsupported&&!this.useFlashOnly&&!this.micRequired){this.zingayaAPI.requestMedia(this.videoSupport,successCallback,failedCallback)}},detachRecordingDevice:function(){if(this.RTCsupported&&!this.useFlashOnly&&!this.micRequired){this.zingayaAPI.stopLocalStream()}},showFlashSettingsPanel:function(panel){if(typeof panel=="undefined")panel="default";if(this.RTCsupported&&!this.useFlashOnly){}else if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").showFlashSettings(panel)}},setCallActive:function(call,active){if(this.RTCsupported&&!this.useFlashOnly){this.zingayaAPI.setCallActive(call.call(),active)}else if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").setCallActive(call.call(),active)}},sendVideo:function(flag){if(typeof flag=="undefined")flag=true;if(this.RTCsupported&&!this.useFlashOnly){this.zingayaAPI.sendVideo(flag)}else if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").sendVideo(flag)}},isRTCsupported:function(){return this.RTCsupported},transferCall:function(call1,call2){if(this.RTCsupported&&!this.useFlashOnly){this.zingayaAPI.transferCall(call1.call(),call2.call())}else if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").transferCall(call1.call(),call2.call())}},setSwfColor:function(color){if(this.RTCsupported&&!this.useFlashOnly){}else if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").setStageColor(color)}},setCodecPayload:function(payload){if(this.RTCsupported&&!this.useFlashOnly){}else if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").setCodecPayload(payload)}},trackPresence:function(users){if(this.RTCsupported&&!this.useFlashOnly){this.zingayaAPI.trackPresence(users)}else if(!this.useRTCOnly){VoxImplant.Utils.swfMovie("voximplantSWF").trackPresence(JSON.stringify(users))}}};VoxImplant.Client.prototype.addEventListener=function(event,handler){if(typeof this.eventListeners[event]=="undefined")this.eventListeners[event]=[];this.eventListeners[event].push(handler)};VoxImplant.Call.prototype.addEventListener=function(event,handler){if(typeof this.eventListeners[event]=="undefined")this.eventListeners[event]=[];this.eventListeners[event].push(handler)};VoxImplant.Client.prototype.removeEventListener=function(event,handler){if(typeof this.eventListeners[event]=="undefined")return;for(var i=0;i<this.eventListeners[event].length;i++){if(this.eventListeners[event][i]==handler){this.eventListeners[event].splice(i,1);break}}};VoxImplant.Call.prototype.removeEventListener=function(event,handler){if(typeof this.eventListeners[event]=="undefined")return;for(var i=0;i<this.eventListeners[event].length;i++){if(this.eventListeners[event][i]==handler){this.eventListeners[event].splice(i,1);break}}};VoxImplant.Client.prototype.dispatchEvent=VoxImplant.Call.prototype.dispatchEvent=function(e){var event=e.name;if(typeof this.eventListeners[event]!="undefined"){for(var i=0;i<this.eventListeners[event].length;i++){if(typeof this.eventListeners[event][i]=="function"){this.eventListeners[event][i](e)}}}};VoxImplant.getInstance=function(){return VoxImplant._clientInstance};VoxImplant.Config={};VoxImplant.FlashVideoSettings={};VoxImplant.VideoSettings={};VoxImplant.AudioSourceInfo={};VoxImplant.VideoSourceInfo={};VoxImplant.NetworkInfo={};VoxImplant.Events={SDKReady:"SDKReady",ConnectionEstablished:"ConnectionEstablished",ConnectionFailed:"ConnectionFailed",ConnectionClosed:"ConnectionClosed",AuthResult:"AuthResult",PlaybackFinished:"PlaybackFinished",MicAccessResult:"MicAccessResult",IncomingCall:"IncomingCall",SourcesInfoUpdated:"SourcesInfoUpdated",NetStatsReceived:"NetStatsReceived",PresenceUpdate:"PresenceUpdate"};VoxImplant.CallEvents={Connected:"Connected",Disconnected:"Disconnected",Failed:"Failed",ProgressToneStart:"ProgressToneStart",ProgressToneStop:"ProgressToneStop",MessageReceived:"MessageReceived",InfoReceived:"InfoReceived",TransferComplete:"TransferComplete",TransferFailed:"TransferFailed"};VoxImplant.UserStatuses={Online:1,Offline:0};VoxImplant.OperatorACDStatuses={Offline:"OFFLINE",Online:"ONLINE",Ready:"READY",InService:"IN_SERVICE",AfterService:"AFTER_SERVICE",Timeout:"TIMEOUT",DND:"DND"};VoxImplant.version=VoxImplant.Client.prototype.version="2.9.13866";if(!VoxImplant._clientInstance){VoxImplant._clientInstance=new VoxImplant.Client;delete VoxImplant.Client}})(window.VoxImplant=window.VoxImplant||{});