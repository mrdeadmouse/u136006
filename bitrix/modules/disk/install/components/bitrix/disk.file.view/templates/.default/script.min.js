BX.namespace("BX.Disk");BX.Disk.FileViewClass=function(){var e=function(){this.xpi_path_en="/bitrix/webdav/ff_bx_integration@bitrixsoft.com.xpi";this.xpi_path_ru="/bitrix/webdav/ff_bx_integration@1c-bitrix.ru.xpi";this.xpi_version="0.7";try{if(window.phpVars.LANGUAGE_ID=="ru"){this.xpi_path=this.xpi_path_ru}else{this.xpi_path=this.xpi_path_en}}catch(e){this.xpi_path=this.xpi_path_en}this.CheckVersion=function(){var e=false;if("undefined"!=typeof ff_bx_integration){var t=2;e=this.CompareVersions(ff_bx_integration,this.xpi_version);if(e)t=1;return t}return 0};this.GetOfficeType=function(){if("undefined"!=typeof ff_bx_integration_office)return ff_bx_integration_office;else return false};this.Bind=function(e,t){var n="BXPluginDataElement";if(BX(n))BX.remove(BX(n));var i=document.createElement(n);i.setAttribute("id",n);i.setAttribute("data",t);document.documentElement.appendChild(i);var s=document.createEvent("Events");s.initEvent(e,true,false);i.dispatchEvent(s);return true};this.OpenConfig=function(){return this.Bind("BitrixWebdavConfig","")};this.OpenDoc=function(e){var t=e.split(".");var n=t.pop().toLowerCase();t.push(n);e=t.join(".");this.Bind("BitrixWebdavOpenFile",e)};this.CompareVersions=function(e,t){var n=e.split(".");var i=t.split(".");for(var s=0;s<n.length;s++){x1=parseInt(n[s])||0;x2=parseInt(i[s])||0;if(x2>x1)return true}return false};this.ShowDialog=function(e,t){if(e==null||e==false){var n=this.CheckVersion();if(n==2)return this.OpenConfig();else if(n==1)e="update";else e="install"}var i=this.xpi_path;BX.CDialog.prototype.btnWdInstall=BX.CDialog.btnWdInstall=BX.create("a",{text:e=="update"?BX.message("DISK_FILE_VIEW_BTN_UPDATE"):BX.message("DISK_FILE_VIEW_BTN_INSTALL"),props:{className:"bx-disk-btn bx-disk-btn-big bx-disk-btn-green"},events:{click:function(e){window.location=i;BX.PopupWindowManager.getCurrentPopup().destroy();BX.PreventDefault(e);return false}}});BX.CDialog.prototype.btnWdOpen=BX.CDialog.btnWdOpen=BX.create("a",{text:BX.message("DISK_FILE_VIEW_BTN_OPEN"),props:{className:"bx-disk-btn bx-disk-btn-big bx-disk-btn-transparent"},events:{click:function(e){var t=BX.findChild(BX.PopupWindowManager.getCurrentPopup().contentContainer,{attribute:{name:"ff_extension_disable"}},true);if(t.checked){window.suggest_ff_extension=false;if(null!=jsUserOptions){if(!jsUserOptions.options)jsUserOptions.options=new Object;jsUserOptions.options["webdav.suggest.ff_extension"]=["webdav","suggest","ff_extension",false,false];jsUserOptions.SendData(null)}}BX.PopupWindowManager.getCurrentPopup().destroy();BX.PreventDefault(e);return false}}});BX.CDialog.prototype.btnWdInstallCancell=BX.CDialog.btnWdInstallCancell=BX.create("a",{text:BX.message("DISK_FILE_VIEW_BTN_INSTALL_CANCEL"),props:{className:"bx-disk-btn bx-disk-btn-big bx-disk-btn-transparent"},events:{click:function(e){var t=BX.findChild(BX.PopupWindowManager.getCurrentPopup().contentContainer,{attribute:{name:"ff_extension_disable"}},true);if(t&&t.checked){window.suggest_ff_extension=false;if(null!=jsUserOptions){jsUserOptions.SaveOption("webdav","suggest","ff_extension",false)}}BX.PopupWindowManager.getCurrentPopup().destroy();BX.PreventDefault(e);return false}}});var s=e=="update"?"DISK_FILE_VIEW_FF_EXTENSION_UPDATE":"DISK_FILE_VIEW_FF_EXTENSION_INSTALL";s="<p>"+BX.message(s).replace("#LINK#",this.xpi_path)+"</p>";var a=BX.message("DISK_FILE_VIEW_FF_EXTENSION_TITLE");var o="<p>"+BX.message("DISK_FILE_VIEW_FF_EXTENSION_HELP")+"</p>";var r="";if(t!=null)r='<p style="margin-top:20px;">'+BX.message("DISK_FILE_VIEW_FF_EXTENSION_DISABLE")+"</p>";var d={title:a,content:s+o+r,width:"530",height:"200"};if(t!=null){d["file"]=t;d["buttons"]=[BX.CDialog.btnWdInstall,BX.CDialog.btnWdOpen]}else{d["buttons"]=[BX.CDialog.btnWdInstall,BX.CDialog.btnWdInstallCancell]}BX.Disk.modalWindow({modalId:"bx-ff-ext-webdav",title:a,contentStyle:{width:"600px",paddingTop:"70px",paddingBottom:"70px"},content:[d["content"]],buttons:d["buttons"]})}};var t=false;var n=false;var i=function(e){this.webdavEditPath=e.webdavEditPath;this.object=e.object||{};this.tabs=new BX.Disk.TabsClass(e.tabs);this.ajaxUrl="/bitrix/components/bitrix/disk.file.view/ajax.php";if(!e.withoutEventBinding)this.setEvents();if(!this.checkWebdavEditButton()){BX.remove(BX("bx-disk-file-edit-btn-webdav"))}else{BX.style(BX("bx-disk-file-edit-btn-webdav"),"display","")}};i.prototype.setEvents=function(){BX.bind(BX("bx-disk-sidebar-shared-outlink"),"click",BX.proxy(this.onClickExternalSwitcher,this));BX.bind(BX("bx-disk-sidebar-shared-outlink-input"),"click",BX.proxy(this.onClickExternalInput));BX.bind(BX("bx-disk-file-edit-btn"),"click",BX.proxy(this.onClickEditButton));BX.bind(BX("bx-disk-file-edit-btn-webdav"),"click",BX.proxy(this.onClickWebdavEditButton,this));if(!!this.tabs){BX.addCustomEvent(this.tabs,"onChangeTab",BX.delegate(function(e){if(e=="bp"&&n||e=="history"&&t){return}if(e=="history"){var i=BX.create("div",{props:{className:"disk-loading-circle"}});BX("bx-disk-version-grid").appendChild(i);BX.addClass(i,"disk-anim");BX.ajax({url:BX.Disk.addToLinkParam(document.location.href.replace(document.location.hash,""),"action","showVersion"),method:"POST",dataType:"html",scriptsRunFirst:true,data:{sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(e){BX.remove(i);t=true;BX.adjust(BX("bx-disk-version-grid"),{html:e})},this)})}else if(e=="bp"){var i=BX.create("div",{props:{className:"disk-loading-circle"}});BX("bx-disk-bp-content").appendChild(i);BX.addClass(i,"disk-anim");BX.ajax({url:BX.Disk.addToLinkParam(document.location.href.replace(document.location.hash,""),"action","showBp"),method:"POST",dataType:"html",scriptsRunFirst:true,data:{sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(e){BX.remove(i);n=true;BX.adjust(BX("bx-disk-bp-content"),{html:e})},this)})}},this))}};i.prototype.onClickExternalInput=function(e){BX.focus(this);this.setSelectionRange(0,this.value.length)};i.prototype.onClickEditButton=function(e){BX.PreventDefault(e);BX.fireEvent(BX.firstChild(BX("bx-disk-filepage-filename")),"click");if(top.BX.CViewer.objNowInShow){top.BX.CViewer.objNowInShow.runActionByCurrentElement("forceEdit",{obElementViewer:top.BX.CViewer.objNowInShow})}};i.prototype.checkWebdavEditButton=function(){if(BX.browser.IsIE()||BX.browser.IsIE11()){try{if(new ActiveXObject("SharePoint.OpenDocuments.2")){return true}}catch(t){}return false}else if(navigator.userAgent.indexOf("Firefox")!=-1){var n=new e;var i=n.CheckVersion();if(i==2){return true}else if(typeof window.suggest_ff_extension!="undefined"&&window.suggest_ff_extension==true){return true}}return false};i.prototype.onClickWebdavEditButton=function(t){BX.PreventDefault(t);function n(t){var n=location.protocol+"//"+location.host;var i=t;if(i.indexOf(n)<0)i=n+i;if(BX.browser.IsIE()||BX.browser.IsIE11()){try{var s=new ActiveXObject("SharePoint.OpenDocuments.2");if(s){if(s.EditDocument2(window,i))return false}}catch(a){}return true}else if(navigator.userAgent.indexOf("Firefox")!=-1){var o=new e;var r=o.CheckVersion();if(r==2){if(navigator.userAgent.indexOf("Mac OS X")!=-1&&i.indexOf(".xl")!=-1)i=i.replace(/ /g,"%20");o.OpenDoc(i);return false}else if(typeof window.suggest_ff_extension!="undefined"&&window.suggest_ff_extension==true){o.ShowDialog(null,i);return false}else{return true}}return true}if(n(this.webdavEditPath)){return false}};i.prototype.openConfirmRestore=function(e){var t=e.object.name;var n=e.object.id;var i=e.version.id;var s=BX.message("DISK_FILE_VIEW_VERSION_RESTORE_CONFIRM");var a=[BX.create("a",{text:BX.message("DISK_FILE_VIEW_VERSION_RESTORE_BUTTON"),props:{className:"bx-disk-btn bx-disk-btn-big bx-disk-btn-green"},events:{click:BX.delegate(function(e){BX.PopupWindowManager.getCurrentPopup().destroy();BX.PreventDefault(e);BX.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam(this.ajaxUrl,"action","restoreFromVersion"),data:{objectId:n,versionId:i,sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(e){if(!e){return}BX.Disk.showModalWithStatusAction(e)},this)});return false},this)}}),BX.create("a",{text:BX.message("DISK_FILE_VIEW_VERSION_CANCEL_BUTTON"),props:{className:"bx-disk-btn bx-disk-btn-big bx-disk-btn-transparent"},events:{click:function(e){BX.PopupWindowManager.getCurrentPopup().destroy();BX.PreventDefault(e);return false}}})];BX.Disk.modalWindow({modalId:"bx-link-unlink-confirm",title:BX.message("DISK_FILE_VIEW_VERSION_RESTORE_TITLE"),contentClassName:"tac",contentStyle:{paddingTop:"70px",paddingBottom:"70px"},content:s.replace("#NAME#",t),buttons:a})};i.prototype.openConfirmDeleteVersion=function(e){var t=e.object.name;var n=e.object.id;var i=e.version.id;var s=BX.message("DISK_FILE_VIEW_VERSION_DELETE_VERSION_CONFIRM");var a=[BX.create("a",{text:BX.message("DISK_FILE_VIEW_VERSION_DELETE_VERSION_BUTTON"),props:{className:"bx-disk-btn bx-disk-btn-big bx-disk-btn-green"},events:{click:BX.delegate(function(e){BX.PopupWindowManager.getCurrentPopup().destroy();BX.PreventDefault(e);BX.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam(this.ajaxUrl,"action","deleteVersion"),data:{objectId:n,versionId:i,sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(e){if(!e){return}BX.Disk.showModalWithStatusAction(e)},this)});return false},this)}}),BX.create("a",{text:BX.message("DISK_FILE_VIEW_VERSION_CANCEL_BUTTON"),props:{className:"bx-disk-btn bx-disk-btn-big bx-disk-btn-transparent"},events:{click:function(e){BX.PopupWindowManager.getCurrentPopup().destroy();BX.PreventDefault(e);return false}}})];BX.Disk.modalWindow({modalId:"bx-link-unlink-confirm",title:BX.message("DISK_FILE_VIEW_VERSION_DELETE_VERSION_TITLE"),contentClassName:"tac",contentStyle:{paddingTop:"70px",paddingBottom:"70px"},content:s.replace("#NAME#",t),buttons:a})};i.prototype.deleteBizProc=function(e){BX.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam(this.ajaxUrl,"action","deleteBizProc"),data:{idBizProc:e,fileId:this.object.id,sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(t){if(t){BX.remove(BX(e))}},this)})};i.prototype.stopBizProc=function(e){BX.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam(this.ajaxUrl,"action","stopBizProc"),data:{idBizProc:e,fileId:this.object.id,sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(e){if(e.status=="success"){var t=document.location.href.replace("#tab-bp","");t+="#tab-bp";document.location.href=t;location.reload()}else{e.errors=e.errors||[{}];BX.Disk.showModalWithStatusAction({status:"error",message:e.errors.pop().message})}},this)})};i.prototype.sortBizProcLog=function(){var e=BX.findChildByClassName(BX("workarea-content"),"bx-sortable").getAttribute("onclick").replace("log_sort=1&","");e=e.replace("?log_workflow","?log_sort=1&log_workflow");e=e.replace("&action=showBp","");BX.findChildByClassName(BX("workarea-content"),"bx-sortable").setAttribute("onclick",e)};i.prototype.fixUrlForSort=function(){var e=document.location.href.replace("&log_sort=1","");e+="#tab-bp";document.location.href=e};i.prototype.onClickExternalSwitcher=function(e){var t=e.target||e.srcElement;if(BX.hasClass(t.parentNode,"on")){BX.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam(this.ajaxUrl,"action","disableExternalLink"),data:{objectId:this.object.id,sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(e){},this)});this.switchOffExtLinkInPanel();BX.PreventDefault(e)}else{BX.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam(this.ajaxUrl,"action","generateExternalLink"),data:{objectId:this.object.id,sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(t){if(!t||t.status!="success"){return}this.switchOnExtLinkInPanel(t);BX.PreventDefault(e)},this)})}};i.prototype.switchOffExtLinkInPanel=function(e){var t=BX("bx-disk-sidebar-shared-outlink-input");var n=BX("bx-disk-sidebar-shared-outlink-label");t.value="";BX.adjust(n,{text:BX.message("DISK_FILE_VIEW_EXT_LINK_OFF")});BX.removeClass(n.parentNode,"on");BX.addClass(n.parentNode,"off")};i.prototype.switchOnExtLinkInPanel=function(e){var t=BX("bx-disk-sidebar-shared-outlink-input");var n=BX("bx-disk-sidebar-shared-outlink-label");t.value=e.link||"";BX.adjust(n,{text:BX.message("DISK_FILE_VIEW_EXT_LINK_ON")});BX.removeClass(n.parentNode,"off");BX.addClass(n.parentNode,"on")};i.prototype.getInternalLink=function(){BX.Disk.modalWindow({modalId:"bx-disk-internal-link",title:BX.message("DISK_FILE_VIEW_COPY_INTERNAL_LINK"),contentClassName:"tac",contentStyle:{},events:{onAfterPopupShow:function(){var e=BX("disk-get-internal-link");BX.focus(e);e.setSelectionRange(0,e.value.length)},onPopupClose:function(){this.destroy()}},content:[BX.create("label",{props:{className:"bx-disk-popup-label","for":"disk-get-internal-link"}}),BX.create("input",{style:{marginTop:"10px"},props:{id:"disk-get-internal-link",className:"bx-disk-popup-input",type:"text",value:document.location.href}})],buttons:[BX.create("a",{text:BX.message("DISK_FILE_VIEW_BTN_CLOSE"),props:{className:"bx-disk-btn bx-disk-btn-big bx-disk-btn-transparent"},events:{click:function(){BX.PopupWindowManager.getCurrentPopup().close()}}})]})};i.prototype.openConfirmDeleteGroupVersion=function(e){var t=BX.message("DISK_FILE_VIEW_VERSION_DELETE_GROUP_CONFIRM");var n=[BX.create("a",{text:BX.message("DISK_FILE_VIEW_VERSION_DELETE_VERSION_BUTTON"),props:{className:"bx-disk-btn bx-disk-btn-big bx-disk-btn-green"},events:{click:BX.delegate(function(e){BX.PopupWindowManager.getCurrentPopup().destroy();BX.PreventDefault(e);this.grid.ActionDelete();return false},this)}}),BX.create("a",{text:BX.message("DISK_FILE_VIEW_VERSION_CANCEL_BUTTON"),props:{className:"bx-disk-btn bx-disk-btn-big bx-disk-btn-transparent"},events:{click:function(e){BX.PopupWindowManager.getCurrentPopup().destroy();BX.PreventDefault(e);return false}}})];BX.Disk.modalWindow({modalId:"bx-link-unlink-confirm",title:BX.message("DISK_FILE_VIEW_VERSION_DELETE_TITLE"),contentClassName:"tac",contentStyle:{paddingTop:"70px",paddingBottom:"70px"},content:t,buttons:n})};return i}();
//# sourceMappingURL=script.map.js