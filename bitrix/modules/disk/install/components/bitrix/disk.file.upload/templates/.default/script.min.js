(function(){if(BX.DiskUpload)return;var e=[];BX.DiskUpload=function(e){this.bp=e["bp"];this.bpParameters=e["bpParameters"];this.bpParametersRequired=e["bpParametersRequired"];this.storageId=e["storageId"];this.ajaxUrl="/bitrix/components/bitrix/disk.folder.list/ajax.php";this.CID=e["CID"];this.nodeContent=BX.create("DIV",{style:{display:"none"},attrs:{id:e["CID"]+"ContentNode"},html:BX.message("DFU_TEMPLATE").replace(/#id#/gi,this.CID)+'<div class="wduf-uploader area">'+BX.message("DFU_DND_TEMPLATE")+"</div>"});document.body.appendChild(this.nodeContent);this.counter={all:[],uploaded:[],uploading:[]};this.init(e);return this};BX.DiskUpload.prototype={_camelToSNAKE:function(e){var t={},i,s;for(i in e){if(e.hasOwnProperty(i)){s=i.replace(/(.)([A-Z])/g,"$1_$2").toUpperCase();t[s]=e[i];t[i]=e[i]}}return t},initAttempt:0,init:function(e){this.initAttempt++;if(this.initAttempt>10||this.agent)return;this.placeHolder=BX(this.CID+"PlaceHolder");if(this.placeHolder){this.templates={"new":BX.message("DFU_NODE_TEMPLATE"),done:BX.message("DFU_NODE_TEMPLATE_DONE"),canceled:BX.message("DFU_NODE_TEMPLATE_CANCELED"),error:BX.message("DFU_NODE_TEMPLATE_ERROR"),error_double:BX.message("DFU_NODE_TEMPLATE_ERROR_DOUBLE")};var t,i,s,r,o,a;for(t in this.templates){r={};if(this.templates.hasOwnProperty(t)){i=this.templates[t];if(/^<tr(.*?)>/gi.test(i)){s=/^<tr(.*?)>/gi.exec(i);s=s[1].split(" ");if(s&&s.length>0){for(o=0;o<s.length;o++){a=s[o].split("=");if(a&&a.length==2){a[0]=a[0].replace(/['"]/gi,"");a[1]=a[1].replace(/['"]/gi,"");r[a[0]]=a[1]}}}}this.templates[t]={node:"TR",attrs:r,text:i.replace(/^<tr(.*?)>/i,"").replace(/<\/tr>$/i,"")}}}var n;if(this.bp){if(this.bpParameters){n="deferred"}else{if(BX("formPostAjax").getElementsByTagName("div").length){BX("formPostAjax").removeChild(BX("divStartBizProc"))}var d=BX("divStartBizProc").cloneNode(true);BX("formPostAjax").appendChild(d);n="immediate"}this.agent=BX.Uploader.getInstance({id:this.CID,streams:1,allowUpload:"A",uploadFormData:"Y",uploadMethod:n,uploadFileUrl:e["urlUpload"],showImage:false,input:e["input"],dropZone:e["dropZone"],placeHolder:this.placeHolder,phpMaxFileUploads:1,queueFields:{thumb:{tagName:"TR",className:"bxu-item"}},fields:{thumb:{tagName:"",template:this.templates["new"].text}}})}else{this.agent=BX.Uploader.getInstance({id:this.CID,streams:1,allowUpload:"A",uploadFormData:"Y",uploadMethod:"immediate",uploadFileUrl:e["urlUpload"],showImage:false,input:e["input"],dropZone:e["dropZone"],placeHolder:this.placeHolder,phpMaxFileUploads:1,queueFields:{thumb:{tagName:"TR",className:"bxu-item"}},fields:{thumb:{tagName:"",template:this.templates["new"].text}}})}this._onItemIsAdded=BX.delegate(this.onItemIsAdded,this);this._onFileIsInited=BX.delegate(this.onFileIsInited,this);this._onError=BX.delegate(this.onError,this);if(BX(this.agent.fileInput)&&!this.agent.fileInput.hasAttribute("id"))this.agent.fileInput.setAttribute("id","diskUbloadFileInput"+this.CID);BX.addCustomEvent(this.agent,"onItemIsAdded",this._onItemIsAdded);BX.addCustomEvent(this.agent,"onFileIsInited",this._onFileIsInited);BX.addCustomEvent(this.agent,"onError",this._onError);this._onFileIsAppended=BX.delegate(this.onFileIsAppended,this);this._onUploadStart=BX.delegate(this.onUploadStart,this);this._onUploadProgress=BX.delegate(this.onUploadProgress,this);this._onUploadDone=BX.delegate(this.onUploadDone,this);this._onUploadError=BX.delegate(this.onUploadError,this);this._onUploadWindowClose=BX.delegate(this.onUploadWindowClose,this);this._onUploadWindowFirstShow=BX.delegate(this.onUploadWindowFirstShow,this);this._onStartBizproc=BX.delegate(this.onStartBizproc,this);if(BX(e["dropZone"])){var l=BX.create("DIV",{attrs:{className:"wduf-uploader area"},html:BX.message("DFU_DND_TEMPLATE")}),p=BX.pos(e["dropZone"]);BX.adjust(e["dropZone"],{style:{position:"relative"},children:[l]});BX.addCustomEvent(this.agent.dropZone,"dragEnter",function(){var e=BX.GetWindowInnerSize(),t=BX.GetWindowScrollPos();p["height"]=e["innerHeight"]-(p["top"]-t["scrollTop"]);l.style.height=p["height"]+"px"})}}else{setTimeout(BX.delegate(function(){this.init(e)},this),500)}},onItemIsAdded:function(){if(this.popup)this.popup.show();else if(this.bp&&this.bpParameters){var e=BX.findChildren(this.nodeContent);e.unshift(BX("parametersFormBp"));this.popup=BX.Disk.modalWindow({modalId:"bx-dfu-upload-"+this.CID,title:BX.message("DFU_UPLOAD_TITLE1"),contentClassName:" tac bx-disk-upload-file",content:e,events:{onPopupFirstShow:this._onUploadWindowFirstShow,onPopupClose:function(){BX.reload()}},zIndex:-200,buttons:[BX.create("A",{text:BX.message("DFU_SAVE_BP"),props:{className:"bx-disk-btn bx-disk-btn-big bx-disk-btn-green mb0"},events:{click:this._onStartBizproc},attrs:{id:"bx-disk-savebp-button"}}),BX.create("LABEL",{text:BX.message("DFU_UPLOAD"),props:{className:"bx-disk-btn bx-disk-btn-big bx-disk-btn-green mb0 bx-hide-button"},attrs:{id:"bx-disk-upload-button","for":this.agent.fileInput.getAttribute("id")}}),BX.create("A",{text:BX.message("DFU_CLOSE"),props:{className:"bx-disk-btn bx-disk-btn-big bx-disk-btn-gray mb0"},attrs:{id:this.CID+"ButtonClose",disabled:true},events:{click:this._onUploadWindowClose}})]})}else{this.popup=BX.Disk.modalWindow({modalId:"bx-dfu-upload-"+this.CID,title:BX.message("DFU_UPLOAD_TITLE1"),contentClassName:" tac bx-disk-upload-file",content:BX.findChildren(this.nodeContent),events:{onPopupFirstShow:this._onUploadWindowFirstShow,onPopupClose:BX.delegate(function(){BX.addCustomEvent(this.agent,"onItemIsAdded",this._onItemIsAdded)},this)},buttons:[BX.create("LABEL",{text:BX.message("DFU_UPLOAD"),props:{className:"bx-disk-btn bx-disk-btn-big bx-disk-btn-green mb0"},attrs:{"for":this.agent.fileInput.getAttribute("id")}}),BX.create("A",{text:BX.message("DFU_CLOSE"),props:{className:"bx-disk-btn bx-disk-btn-big bx-disk-btn-gray mb0"},attrs:{id:this.CID+"ButtonClose",disabled:true},events:{click:this._onUploadWindowClose}})]})}this.popup.destroy=BX.DoNothing;BX.removeCustomEvent(this.agent,"onItemIsAdded",this._onItemIsAdded)},onStartBizproc:function(){if(BX("formPostAjax").getElementsByTagName("div").length){BX("formPostAjax").removeChild(BX("divStartBizProc"))}var e=BX("divStartBizProc").cloneNode(true),t=BX("parametersFormBp").querySelectorAll("textarea"),i=BX("parametersFormBp").querySelectorAll("select"),s=e.querySelectorAll("textarea"),r=e.querySelectorAll("select"),o;if(t.length){for(o in t){if(t.hasOwnProperty(o)){s[o].value=t[o].value}}}if(i.length){for(o in i){if(i.hasOwnProperty(o)){r[o].value=i[o].value}}}BX("formPostAjax").appendChild(e);var a=BX.ajax.prepareForm(BX("formPostAjax")),n=this.agent;BX.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam(this.ajaxUrl,"action","validateParameterAutoloadBizProc"),data:{required:this.bpParametersRequired,data:a,storageId:this.storageId,sessid:BX.bitrix_sessid()},onsuccess:function(e){if(e.status=="success"){n.submit();BX("formPostAjax").removeChild(BX("divStartBizProc"));BX("errorTd").innerHTML="";if(!BX.hasClass(BX("bx-disk-savebp-button"),"bx-hide-button")){BX.toggleClass(BX("bx-disk-upload-button"),"bx-hide-button");BX.toggleClass(BX("bx-disk-savebp-button"),"bx-hide-button")}}else{if(BX("formPostAjax").getElementsByTagName("div").length){BX("formPostAjax").removeChild(BX("divStartBizProc"))}for(o in e["errors"]){if(e["errors"].hasOwnProperty(o)){BX("errorTd").innerHTML=e["errors"][o].message}}if(BX.hasClass(BX("bx-disk-savebp-button"),"bx-hide-button")){BX.toggleClass(BX("bx-disk-upload-button"),"bx-hide-button");BX.toggleClass(BX("bx-disk-savebp-button"),"bx-hide-button")}}}})},onFileIsInited:function(e,t){this.counter.all.push(e);BX.addCustomEvent(t,"onFileIsAppended",this._onFileIsAppended);BX.addCustomEvent(t,"onUploadStart",this._onUploadStart);BX.addCustomEvent(t,"onUploadProgress",this._onUploadProgress);BX.addCustomEvent(t,"onUploadDone",this._onUploadDone);BX.addCustomEvent(t,"onUploadError",this._onUploadError);this.__checkButton();if(this.bp&&this.bpParameters&&this.popup){this.onStartBizproc()}},onFileIsAppended:function(e,t){var i=this.agent.getItem(e);this.__bindEventsToNode(i.node,t)},onUploadStart:function(e){this.counter.uploading.push(e.id);e.__progressBar=BX(e.id+"Progress");e.__progressBarWidth=5;if(e.__progressBar)e.__progressBar.style.width=e.__progressBarWidth+"%"},onUploadProgress:function(e,t){t=Math.min(t,96);if(t>e.__progressBarWidth){e.__progressBarWidth=Math.ceil(t);e.__progressBarWidth=e.__progressBarWidth>100?100:e.__progressBarWidth;if(e.__progressBar)e.__progressBar.style.width=e.__progressBarWidth+"%"}},onUploadDone:function(e,t){if(e.__progressBar)e.__progressBar.style.width="100%";this.counter.uploading=BX.util.deleteFromArray(this.counter.uploading,BX.util.array_search(e.id,this.counter.uploading));this.counter.uploaded.push(e.id);var i=this.agent.getItem(e.id).node,s=this._camelToSNAKE(t["file"]);if(BX(i)){var r=this.templates.done.text;for(var o in s){if(s.hasOwnProperty(o)){r=r.replace(new RegExp("#"+o.toLowerCase()+"#","gi"),s[o]).replace(new RegExp("#"+o.toUpperCase()+"#","gi"),s[o])}}var a;if(true||BX.browser.IsIE8()){a=i;while(a.cells.length>0){a.deleteCell(0)}var n=0;r.replace(/<\/td>/gi,"").replace(/<td([^>]+)>([^\002]+)\002/gi,function(e,t,i){var s=a.insertCell(n);s.innerHTML=i;t.replace(/class=["']([a-z\-\s]+)['"]/,function(e,t){s.className=t});n++;return""})}else{a=BX.create("TR",{attrs:this.templates.done.attrs,html:r});a.setAttribute("id",i.getAttribute("id"));i.parentNode.replaceChild(a,i)}}else{this.onUploadError(e,t)}this.__bindEventsToNode(i,e);this.__checkButton()},onUploadError:function(e,t,i){this.counter.uploading=BX.util.deleteFromArray(this.counter.uploading,BX.util.array_search(e.id,this.counter.uploading));t=typeof t=="object"&&t?t:{};var s=this.agent.getItem(e.id).node,r=this._camelToSNAKE(t);if(BX(s)&&(i==true||!BX(s).hasAttribute("bx-disk-error"))){r=!!r&&typeof r=="object"?r:{};var o=r["file"]&&r["file"]["isNotUnique"]?this.templates.error_double:this.templates.error,a=o.text,n;for(n in e){if(e.hasOwnProperty(n)&&typeof e[n]=="string"){a=a.replace(new RegExp("#"+n.toLowerCase()+"#","gi"),e[n]).replace(new RegExp("#"+n.toUpperCase()+"#","gi"),e[n])}}if(r){for(n in r){if(r.hasOwnProperty(n)){a=a.replace(new RegExp("#"+n.toLowerCase()+"#","gi"),r[n]).replace(new RegExp("#"+n.toUpperCase()+"#","gi"),r[n])}}if(r["file"]){for(n in r["file"]){if(r["file"].hasOwnProperty(n)){a=a.replace(new RegExp("#"+n.toLowerCase()+"#","gi"),r["file"][n]).replace(new RegExp("#"+n.toUpperCase()+"#","gi"),r["file"][n])}}}}var d=BX.create("TR",{attrs:o.attrs,html:a});d.setAttribute("id",s.getAttribute("id"));d.setAttribute("bx-disk-error","Y");s.parentNode.replaceChild(d,s);this.__bindEventsToNode(d,e);this.__checkButton()}else{BX.debug("BX.Disk.Upload: node for error does not exist.")}},onError:function(e,t,i){var s="Uploading error.",r=s,o,a;if(i){if(i["error"]&&typeof i["error"]=="string")r=i["error"];else if(BX.type.isArray(i["errors"])&&i["errors"].length>0){r=[];for(var n=0;n<i["errors"].length;n++){if(typeof i["errors"][n]=="object"&&i["errors"][n]["message"])r.push(i["errors"][n]["message"])}if(r.length<=0)r.push(s);r=r.join(" ")}}e["files"]=e.files||{};for(a in e["files"]){if(e["files"].hasOwnProperty(a)){o=this.agent.queue.items.getItem(a);this.onUploadError(o,{error:r},r!=s)}}},deleteFile:function(e,t){BX.addClass(e,"bx-disk-popup-upload-file-delete-event");var i=BX.findChild(e,{className:"file-delete"},true),s=BX.util.array_search(t.id,this.counter.uploaded);if(s>=0)this.counter.uploaded=BX.util.deleteFromArray(this.counter.uploaded,s);s=BX.util.array_search(t.id,this.counter.uploading);if(s>=0)this.counter.uploading=BX.util.deleteFromArray(this.counter.uploading,s);this.counter.all=BX.util.deleteFromArray(this.counter.all,BX.util.array_search(t.id,this.counter.all));delete t.hash;setTimeout(function(){t.deleteFile("deleteFile")},400);if(!!i&&i.getAttribute("href").length>0)BX.ajax.post(i.href,{sessid:BX.bitrix_sessid()});this.__checkButton()},replaceFile:function(e,t){if(BX(e)){var i=this.templates["new"].text;for(var s in t){if(t.hasOwnProperty(s)){i=i.replace(new RegExp("#"+s.toLowerCase()+"#","gi"),t[s]).replace(new RegExp("#"+s.toUpperCase()+"#","gi"),t[s])}}var r=BX.create("TR",{attrs:this.templates["new"].attrs,html:i});r.setAttribute("id",e.getAttribute("id"));e.parentNode.replaceChild(r,e);this.__bindEventsToNode(e,t);this.__checkButton();var o=t.file.uploadStatus;this.agent.queue.restoreFiles(new BX.UploaderUtils.Hash(t.id,t),true);t.file.uploadStatus=o;if(this.agent.post){this.agent.post.data["REPLACE_FILE"]=this.agent.post.data["REPLACE_FILE"]||[];this.agent.post.data["REPLACE_FILE"].push(t.id)}var a;if(this.agent.form){a=BX.create("INPUT",{attrs:{id:"input"+t.id},props:{name:"REPLACE_FILE[]",value:t.id}});this.agent.form.appendChild(a)}this.agent.submit();if(this.agent.post){this.agent.post.data["REPLACE_FILE"].pop()}if(this.agent.form){BX.remove(a)}}},__checkButton:function(){var e=BX(this.CID+"ButtonClose"),t=BX(this.CID+"Number"),i=BX(this.CID+"Count");if(this.popup){i.innerHTML=this.counter.all.length;t.innerHTML=this.counter.uploaded.length;BX.adjust(e,{props:{disabled:this.counter.uploading.length>0}})}},__bindEventsToNode:function(e,t){var i=BX.delegate(function(){this.deleteFile(e,t)},this),s=BX.delegate(function(){this.replaceFile(e,t)},this),r=BX.findChild(e,{attribute:{id:t.id+"Cancel"}},true),o=BX.findChild(e,{attribute:{id:t.id+"Replace"}},true);if(r&&!r.hasAttribute("bx-bound")){r.setAttribute("bx-bound","Y");BX.bind(r,"click",i)}if(o&&!o.hasAttribute("bx-bound")){o.setAttribute("bx-bound","Y");BX.bind(o,"click",s)}},onUploadWindowFirstShow:function(e){this.agent.initDropZone(e.contentContainer);if(this.bp&&this.bpParameters){var t=BX.findChildrenByClassName(BX("parametersFormBp"),"bx-html-editor"),i;for(var s in t){if(t.hasOwnProperty(s)){i=t[s].getAttribute("id").replace("bx-html-editor-","");window["BXHtmlEditor"].editors[i].CheckAndReInit()}}}},onUploadWindowClose:function(){if(this.popup&&this.counter.uploading.length<=0){this.popup.close();if(this.counter.uploaded.length>0)BX.reload()}}};BX.DiskUpload.initialize=function(t){if(!BX(t["inputContainer"])){BX.debug("BX.Disk.Uploader: inputContainer is not found.")}else{t["CID"]=t["CID"]?t["CID"]:"DiskUpload";var i=BX(t["inputContainer"]),s=BX.create("INPUT",{attrs:{id:"inputContainer"+t["CID"]},props:{type:"file",multiple:true,title:BX.message("DFU_UPLOAD_TITLE1")}}),r=BX.create("FORM",{attrs:{id:"formPostAjax"},children:[s,t["targetFileId"]?BX.create("INPUT",{props:{type:"hidden",name:"targetFileId",value:t["targetFileId"]}}):BX.create("INPUT",{props:{type:"hidden",name:"targetFolderId",value:t["targetFolderId"]}})]}),o=BX.create("LABEL",{attrs:{className:i.className,id:i.id,title:BX.message("DFU_UPLOAD_TITLE1"),"for":"inputContainer"+t["CID"]},html:i.innerHTML});i.parentNode.replaceChild(o,i);o.appendChild(r);t["input"]=s;if(!e[t["CID"]]){e[t["CID"]]=new BX.DiskUpload(t)}}return e[t["CID"]]};BX.DiskUpload.getObj=function(t){return e[t]}})();
//# sourceMappingURL=script.map.js