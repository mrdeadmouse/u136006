if(typeof BX.CrmContactEditor==="undefined"){BX.CrmContactEditor=function(){this._id="";this._settings={};this._prefix="";this._typeId=this._typeName=null;this._assignedById=this._assignedByName=null;this._companyId=this._companyName=null;this._addPhoneBtn=this._addEmailBtn=null;this._photo=this._photoId=null;this._dispatcher=null;this._isDirty=false;this._contextMenuId=""};BX.CrmContactEditor.prototype={initialize:function(e,t){this._id=e;this._settings=t?t:{};this._prefix=this.getSetting("prefix");this._dispatcher=this.getSetting("dispatcher",null);this._photo=this.resolveElement("photo");if(this._photo){BX.bind(this._photo,"click",BX.delegate(this._onPhotoAdd,this))}this._typeId=this.resolveElement("type_id");if(this._typeId){BX.bind(BX.findParent(this._typeId,{className:"crm_block_container"}),"click",BX.delegate(this._onTypeSelect,this))}this._typeName=this.resolveElement("type_name");this._assignedById=this.resolveElement("assigned_by_id");if(this._assignedById){BX.bind(BX.findParent(this._assignedById,{className:"crm_block_container"}),"click",BX.delegate(this._onResponsibleSelect,this))}this._assignedByName=this.resolveElement("assigned_by_name");this._companyId=this.resolveElement("company_id");if(this._companyId){BX.bind(BX.findParent(this._companyId,{className:"crm_block_container"}),"click",BX.delegate(this._onCompanySelect,this))}this._companyName=this.resolveElement("company_name");this._photoId=this.resolveElement("photo_id");this._addPhoneBtn=this.resolveElement("phone_add_btn");if(this._addPhoneBtn){BX.bind(this._addPhoneBtn,"click",BX.delegate(this._onPhoneAdd,this))}this._addEmailBtn=this.resolveElement("email_add_btn");if(this._addEmailBtn){BX.bind(this._addEmailBtn,"click",BX.delegate(this._onEmailAdd,this))}BX.addCustomEvent(window,"onCrmEntityUpdate",BX.delegate(this._onExternalUpdate,this));BX.addCustomEvent(window,"onCrmEntityDelete",BX.delegate(this._onExternalDelete,this));BX.addCustomEvent(window,"onCrmStatusSelect",BX.delegate(this._onExternalStatusSelect,this));BX.addCustomEvent(window,"onCrmClientSelect",BX.delegate(this._onExternalClientSelect,this));BX.addCustomEvent(window,"onOpenPageBefore",BX.delegate(this._onBeforePageOpen,this))},getId:function(){return this._id},getSettings:function(){return this._settings},getSetting:function(e,t){return this._settings.hasOwnProperty(e)?this._settings[e]:t},setSetting:function(e,t){this._settings[e]=t},getEntityId:function(){return parseInt(this.getSetting("entityId",0))},prepareElementId:function(e){e=e.toLowerCase();return this._prefix!==""?this._prefix+"_"+e:e},resolveElement:function(e){return BX(this.prepareElementId(e))},getFieldValue:function(e){var t=this.resolveElement(e);return t?t.value:""},createSaveHandler:function(){return BX.delegate(this._onSave,this)},getMessage:function(e){var t=BX.CrmContactEditor.messages;return BX.type.isNotEmptyString(t[e])?t[e]:""},_onPhoneAdd:function(e){this._createMultiField("PHONE",BX.findPreviousSibling(this._addPhoneBtn,{tagName:"DIV",className:"clb"}));return BX.PreventDefault(e)},_onEmailAdd:function(e){this._createMultiField("EMAIL",BX.findPreviousSibling(this._addEmailBtn,{tagName:"DIV",className:"clb"}));return BX.PreventDefault(e)},_onPhotoAdd:function(e){var t=BX.CrmMobileContext.getCurrent();if(this._contextMenuId!=="IMAGE_SOURCE"){t.createMenu([{name:this.getMessage("openPhotoAlbumMenuItem"),action:BX.delegate(this._addPhotoFromLibrary,this)},{name:this.getMessage("takePhotoMenuItem"),action:BX.delegate(this._addPhotoFromCamera,this)}]);this._contextMenuId="IMAGE_SOURCE"}t.showMenu()},_addPhotoFromLibrary:function(){BX.CrmMobileContext.getCurrent().hideMenu();this._addPhoto(0)},_addPhotoFromCamera:function(){BX.CrmMobileContext.getCurrent().hideMenu();this._addPhoto(1)},_addPhoto:function(sourceId){var self=this;app.takePhoto({source:sourceId,correctOrientation:true,callback:function(fileURI){var uploadUrl=self.getSetting("uploadUrl","");if(!BX.type.isNotEmptyString(uploadUrl)){return}function onSuccess(result){var response=decodeURIComponent(result.response);var info=eval("("+response+")");if(typeof info["fileId"]!=="undefined"){self._setupPhoto(info)}}function onError(e){}var options=new FileUploadOptions;options.fileKey="file";var fileName=fileURI.substr(fileURI.lastIndexOf("/")+1);if(fileName.indexOf(".")<0){fileName+=".jpg"}options.fileName=fileName;options.mimeType="image/jpeg";options.params={fullpath:fileURI,name:options.fileName,sessid:BX.bitrix_sessid()};options.chunkedMode=false;options.headers={Connection:"close"};var ft=new FileTransfer;ft.upload(fileURI,uploadUrl,onSuccess,onError,options,true)}})},_setupPhoto:function(e){var t=typeof e["fileId"]!=="undefined"?parseInt(e["fileId"]):0;if(this._photoId){this._photoId.value=t}var i=typeof e["showUrl"]!=="undefined"?e["showUrl"]:"";if(this._photo){if(!BX.CrmMobileContext.getCurrent().isAndroid()){this._photo.src=i}else{var n=this._photo.parentNode;n.removeChild(this._photo);this._photo.src=i;n.appendChild(this._photo)}}},_onTypeSelect:function(){var e=this.getSetting("contactTypeSelectorUrl","");if(e!==""){BX.CrmMobileContext.getCurrent().open({url:e})}},_onCompanySelect:function(){var e=this.getSetting("companySelectorUrl","");if(e!==""){BX.CrmMobileContext.getCurrent().open({url:e,cache:this.getEntityId()>0})}},_onResponsibleSelect:function(){BX.CrmMobileContext.getCurrent().openUserSelector({callback:BX.delegate(this._onResponsibleChange,this),multiple:false,okButtonTitle:this.getMessage("userSelectorOkButton"),cancelButtonTitle:this.getMessage("userSelectorCancelButton")})},_onResponsibleChange:function(e){var t=0;var i="";if(e&&e["a_users"]){var n=e["a_users"];for(var s in n){if(!n.hasOwnProperty(s)){continue}var o=n[s];t=parseInt(o["ID"]);i=o["NAME"];break}}if(this._assignedById){this._assignedById.value=t}if(this._assignedByName){this._assignedByName.innerHTML=BX.util.htmlspecialchars(i)}},_createMultiField:function(e,t){var i=0;var n="";var s=e+"_";do{i++;n="n"+i.toString()}while(BX.type.isDomNode(this.resolveElement(s+n+"_VALUE")));var o=this.getSetting("multiFields",{});if(typeof o[e]==="undefined"){o[e]={}}o[e][n]={};var a=BX.create("INPUT",{props:{id:this.prepareElementId(s+n+"_VALUE"),type:"text",className:"crm_input_text fll"},style:{width:"70%"}});t.parentNode.insertBefore(a,t);var r=BX.create("SELECT",{props:{id:this.prepareElementId(s+n+"_VALUE_TYPE"),className:"crm_input_select flr"}});var l=this.getSetting("multiFieldInfos",{});var d=typeof l[e]!=="undefined"?l[e]:{};for(var h in d){if(!d.hasOwnProperty(h)){continue}var u=d[h];var _=BX.create("OPTION",{value:h,text:u});if(!BX.browser.isIE){r.add(_,null)}else{try{r.add(_,r.options[null])}catch(c){r.add(_,null)}}}t.parentNode.insertBefore(r,t)},_saveMultiFields:function(e,t){var i=this.getSetting("multiFields",{});if(typeof i[e]==="undefined"){return}if(typeof t["FM"]==="undefined"){t["FM"]={}}if(typeof t["FM"][e]==="undefined"){t["FM"][e]={}}var n=i[e];for(var s in n){if(!n.hasOwnProperty(s)){continue}var o=e+"_"+s;var a=this.getFieldValue(o+"_value");if(a===""){continue}t["FM"][e][s]={VALUE:a,VALUE_TYPE:this.getFieldValue(o+"_value_type")}}},_onSave:function(){if(!this._dispatcher){return}var e=this.getEntityId();var t={ID:this.getEntityId(),PHOTO:this.getFieldValue("PHOTO_ID"),NAME:this.getFieldValue("NAME"),SECOND_NAME:this.getFieldValue("SECOND_NAME"),LAST_NAME:this.getFieldValue("LAST_NAME"),ADDRESS:this.getFieldValue("ADDRESS"),ADDRESS_2:this.getFieldValue("ADDRESS_2"),ADDRESS_CITY:this.getFieldValue("ADDRESS_CITY"),ADDRESS_REGION:this.getFieldValue("ADDRESS_REGION"),ADDRESS_PROVINCE:this.getFieldValue("ADDRESS_PROVINCE"),ADDRESS_POSTAL_CODE:this.getFieldValue("ADDRESS_POSTAL_CODE"),ADDRESS_COUNTRY:this.getFieldValue("ADDRESS_COUNTRY"),COMMENTS:this.getFieldValue("COMMENTS"),TYPE_ID:this.getFieldValue("TYPE_ID"),ASSIGNED_BY_ID:this.getFieldValue("ASSIGNED_BY_ID")};var i=this.getFieldValue("COMPANY_ID");if(i!==""){t["COMPANY_ID"]=i}this._saveMultiFields("PHONE",t);this._saveMultiFields("EMAIL",t);if(e<=0){this._dispatcher.createEntity(t,BX.CrmMobileContext.getCurrent().createCloseHandler(),{contextId:this.getSetting("contextId",""),title:this.getSetting("title","")})}else{this._dispatcher.updateEntity(t,BX.CrmMobileContext.getCurrent().createCloseHandler(),{contextId:this.getSetting("contextId",""),title:this.getSetting("title","")})}},_onExternalUpdate:function(e){var t=typeof e["typeName"]!=="undefined"?e["typeName"]:"";var i=typeof e["id"]!=="undefined"?parseInt(e["id"]):0;var n=typeof e["senderId"]!=="undefined"?e["senderId"]:"";if(t==="CONTACT"&&i===this.getEntityId()&&n!==this._dispatcher.getId()){this._isDirty=true}},_onExternalDelete:function(e){var t=typeof e["typeName"]!=="undefined"?e["typeName"]:"";var i=typeof e["id"]!=="undefined"?parseInt(e["id"]):0;if(t==="CONTACT"&&i===this.getEntityId()){BX.CrmMobileContext.getCurrent().close()}},_onExternalStatusSelect:function(e){var t=typeof e["contextId"]?e["contextId"]:"";if(t!==this.getSetting("contextId","")){return}var i=typeof e["typeId"]?e["typeId"]:"";var n=typeof e["statusId"]?e["statusId"]:"";var s=typeof e["name"]?e["name"]:"";if(i==="CONTACT_TYPE"){if(this._typeId){this._typeId.value=n}if(this._typeName){this._typeName.innerHTML=BX.util.htmlspecialchars(s!==""?s:n)}}},_onExternalClientSelect:function(e){var t=typeof e["contextId"]?e["contextId"]:"";if(t!==this.getSetting("contextId","")){return}var i=typeof e["typeName"]?e["typeName"]:"";if(i!=="COMPANY"){return}var n=typeof e["id"]?parseInt(e["id"]):0;var s=typeof e["caption"]?e["caption"]:"";if(this._companyId){this._companyId.value=n}if(this._companyName){this._companyName.innerHTML=BX.util.htmlspecialchars(s!==""?s:n)}},_onBeforePageOpen:function(){if(this._isDirty){this._isDirty=false;BX.CrmMobileContext.getCurrent().reload()}}};if(typeof BX.CrmContactEditor.messages==="undefined"){BX.CrmContactEditor.messages={}}BX.CrmContactEditor.items={};BX.CrmContactEditor.create=function(e,t){var i=new BX.CrmContactEditor;i.initialize(e,t);this.items[e]=i;return i}}
//# sourceMappingURL=script.map.js