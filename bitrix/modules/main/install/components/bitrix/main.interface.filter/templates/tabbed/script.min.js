if(typeof BX.CrmParamBag==="undefined"){BX.CrmParamBag=function(){this._params={}};BX.CrmParamBag.prototype={initialize:function(e){this._params=e?e:{}},getParam:function(e,t){var i=this._params;return typeof i[e]!="undefined"?i[e]:t},setParam:function(e,t){this._params[e]=t},clear:function(){this._params={}}};BX.CrmParamBag.create=function(e){var t=new BX.CrmParamBag;t.initialize(e);return t}}if(typeof BX.CrmInterfaceGridManager=="undefined"){BX.CrmInterfaceGridManager=function(){this._id="";this._settings={}};BX.CrmInterfaceGridManager.prototype={initialize:function(e,t){this._id=e;this._settings=t?t:{};var i=this.getForm();if(i){BX.bind(i["apply"],"click",BX.delegate(this._handleFormApplyButtonClick,this))}BX.ready(BX.delegate(this._bindOnSetFilterFields,this))},getId:function(){return this._id},_bindOnSetFilterFields:function(){BX.addCustomEvent(this.getGridJsObject(),"AFTER_SET_FILTER_FIELDS",BX.delegate(this._onSetFilterFields,this));BX.addCustomEvent(this.getGridJsObject(),"AFTER_GET_FILTER_FIELDS",BX.delegate(this._onGetFilterFields,this))},registerFilter:function(e){BX.addCustomEvent(e,"AFTER_SET_FILTER_FIELDS",BX.delegate(this._onSetFilterFields,this));BX.addCustomEvent(e,"AFTER_GET_FILTER_FIELDS",BX.delegate(this._onGetFilterFields,this))},_onSetFilterFields:function(e,t,i){var n=this.getSetting("filterFields",null);if(!BX.type.isArray(n)){return}var s=t.name.indexOf("flt_settings")===0;var r=n.length;var a=null;var l="";for(var o=0;o<r;o++){var d=n[o];var h=BX.type.isNotEmptyString(d["id"])?d["id"]:"";var f=BX.type.isNotEmptyString(d["typeName"])?d["typeName"].toUpperCase():"";var u=d["params"]?d["params"]:{};if(f==="USER"){var c=u["data"]?u["data"]:{};this._setElementByFilter(c[s?"settingsElementId":"elementId"],c["paramName"],i);var g=u["search"]?u["search"]:{};this._setElementByFilter(g[s?"settingsElementId":"elementId"],g["paramName"],i)}}},_setElementByFilter:function(e,t,i){var n=BX.type.isNotEmptyString(e)?BX(e):null;if(BX.type.isElementNode(n)){n.value=BX.type.isNotEmptyString(t)&&i[t]?i[t]:""}},_onGetFilterFields:function(e,t,i){var n=this.getSetting("filterFields",null);if(!BX.type.isArray(n)){return}var s=t.name.indexOf("flt_settings")===0;var r=n.length;for(var a=0;a<r;a++){var l=n[a];var o=BX.type.isNotEmptyString(l["id"])?l["id"]:"";var d=BX.type.isNotEmptyString(l["typeName"])?l["typeName"].toUpperCase():"";var h=l["params"]?l["params"]:{};if(d==="USER"){var f=h["data"]?h["data"]:{};this._setFilterByElement(f[s?"settingsElementId":"elementId"],f["paramName"],i);var u=h["search"]?h["search"]:{};this._setFilterByElement(u[s?"settingsElementId":"elementId"],u["paramName"],i)}}},_setFilterByElement:function(e,t,i){var n=BX.type.isNotEmptyString(e)?BX(e):null;if(BX.type.isElementNode(n)&&BX.type.isNotEmptyString(t)){i[t]=n.value}},getSetting:function(e,t){return typeof this._settings[e]!="undefined"?this._settings[e]:t},getOwnerType:function(){return this.getSetting("ownerType","")},getForm:function(){return document.forms[this.getSetting("formName","")]},getGrid:function(){return BX(this.getSetting("gridId",""))},getGridJsObject:function(){var e=this.getSetting("gridId","");return BX.type.isNotEmptyString(e)?window["bxGrid_"+e]:null},getAllRowsCheckBox:function(){return BX(this.getSetting("allRowsCheckBoxId",""))},getEditor:function(){var e=this.getSetting("activityEditorId","");return BX.CrmActivityEditor.items[e]?BX.CrmActivityEditor.items[e]:null},getServiceUrl:function(){return this.getSetting("serviceUrl","/bitrix/components/bitrix/crm.activity.editor/ajax.php")},_loadCommunications:function(e,t,i){BX.ajax({url:this.getServiceUrl(),method:"POST",dataType:"json",data:{ACTION:"GET_ENTITIES_DEFAULT_COMMUNICATIONS",COMMUNICATION_TYPE:e,ENTITY_TYPE:this.getOwnerType(),ENTITY_IDS:t,GRID_ID:this.getSetting("gridId","")},onsuccess:function(e){if(e&&e["DATA"]&&i){i(e["DATA"])}},onfailure:function(e){}})},_onEmailDataLoaded:function(e){var t={};if(e){var i=BX.type.isArray(e["ITEMS"])?e["ITEMS"]:[];if(i.length>0){var n=e["ENTITY_TYPE"]?e["ENTITY_TYPE"]:"";var s=t["communications"]=[];for(var r=0;r<i.length;r++){var a=i[r];s.push({type:"EMAIL",entityTitle:"",entityType:n,entityId:a["entityId"],value:a["value"]})}}}this.addEmail(t)},_onCallDataLoaded:function(e){var t={};if(e){var i=BX.type.isArray(e["ITEMS"])?e["ITEMS"]:[];if(i.length>0){var n=e["ENTITY_TYPE"]?e["ENTITY_TYPE"]:"";var s=t["communications"]=[];var r=i[0];s.push({type:"PHONE",entityTitle:"",entityType:n,entityId:r["entityId"],value:r["value"]});t["ownerType"]=n;t["ownerID"]=r["entityId"]}}this.addCall(t)},_onMeetingDataLoaded:function(e){var t={};if(e){var i=BX.type.isArray(e["ITEMS"])?e["ITEMS"]:[];if(i.length>0){var n=e["ENTITY_TYPE"]?e["ENTITY_TYPE"]:"";var s=t["communications"]=[];var r=i[0];s.push({type:"",entityTitle:"",entityType:n,entityId:r["entityId"],value:r["value"]});t["ownerType"]=n;t["ownerID"]=r["entityId"]}}this.addMeeting(t)},_handleFormApplyButtonClick:function(e){var t=this.getForm();if(!t){return true}var i=t.elements["action_button_"+this.getSetting("gridId","")];if(!i){return}var n=i.value;if(n==="subscribe"){var s=this.getAllRowsCheckBox();var r=[];if(!(s&&s.checked)){var a=BX.findChildren(this.getGrid(),{tagName:"INPUT",attribute:{type:"checkbox"}},true);if(a){for(var l=0;l<a.length;l++){var o=a[l];if(o.id.indexOf("ID")==0&&o.checked){r.push(o.value)}}}}this._loadCommunications("EMAIL",r,BX.delegate(this._onEmailDataLoaded,this));return BX.PreventDefault(e)}return true},addEmail:function(e){var t=this.getEditor();if(!t){return}e=e?e:{};if(typeof e["ownerID"]!=="undefined"){e["ownerType"]=this.getOwnerType()}t.addEmail(e)},addCall:function(e){var t=this.getEditor();if(!t){return}e=e?e:{};if(typeof e["ownerID"]!=="undefined"){e["ownerType"]=this.getOwnerType()}t.addCall(e)},addMeeting:function(e){var t=this.getEditor();if(!t){return}e=e?e:{};if(typeof e["ownerID"]!=="undefined"){e["ownerType"]=this.getOwnerType()}t.addMeeting(e)},addTask:function(e){var t=this.getEditor();if(!t){return}e=e?e:{};if(typeof e["ownerID"]!=="undefined"){e["ownerType"]=this.getOwnerType()}t.addTask(e)},viewActivity:function(e,t){var i=this.getEditor();if(i){i.viewActivity(e,t)}}};BX.CrmInterfaceGridManager.items={};BX.CrmInterfaceGridManager.create=function(e,t){var i=new BX.CrmInterfaceGridManager;i.initialize(e,t);this.items[e]=i;BX.onCustomEvent(this,"CREATED",[i]);return i};BX.CrmInterfaceGridManager.addEmail=function(e,t){if(typeof this.items[e]!=="undefined"){this.items[e].addEmail(t)}};BX.CrmInterfaceGridManager.addCall=function(e,t){if(typeof this.items[e]!=="undefined"){this.items[e].addCall(t)}};BX.CrmInterfaceGridManager.addMeeting=function(e,t){if(typeof this.items[e]!=="undefined"){this.items[e].addMeeting(t)}};BX.CrmInterfaceGridManager.addTask=function(e,t){if(typeof this.items[e]!=="undefined"){this.items[e].addTask(t)}};BX.CrmInterfaceGridManager.viewActivity=function(e,t,i){if(typeof this.items[e]!=="undefined"){this.items[e].viewActivity(t,i)}};BX.CrmInterfaceGridManager.showPopup=function(e,t,i){BX.PopupMenu.show(e,t,i,{offsetTop:0,offsetLeft:-30})};BX.CrmInterfaceGridManager.reloadGrid=function(e){var t=window["bxGrid_"+e];if(!t||!BX.type.isFunction(t.Reload)){return false}t.Reload();return true};BX.CrmInterfaceGridManager.applyFilter=function(e,t){var i=window["bxGrid_"+e];if(!i||!BX.type.isFunction(i.Reload)){return false}i.ApplyFilter(t);return true};BX.CrmInterfaceGridManager.clearFilter=function(e){var t=window["bxGrid_"+e];if(!t||!BX.type.isFunction(t.ClearFilter)){return false}t.ClearFilter();return true};BX.CrmInterfaceGridManager.menus={};BX.CrmInterfaceGridManager.createMenu=function(e,t,i){i=parseInt(i);var n=new PopupMenu(e,!isNaN(i)?i:1010);if(BX.type.isArray(t)){n.settingsMenu=t}this.menus[e]=n};BX.CrmInterfaceGridManager.showMenu=function(e,t){var i=this.menus[e];if(typeof i!=="undefined"){i.ShowMenu(t,i.settingsMenu,false,false)}};BX.CrmInterfaceGridManager.expandEllipsis=function(e){if(!BX.type.isDomNode(e)){return false}var t=BX.findNextSibling(e,{"class":"bx-crm-text-cut-on"});if(t){BX.removeClass(t,"bx-crm-text-cut-on");BX.addClass(t,"bx-crm-text-cut-off");t.style.display=""}e.style.display="none";return true}}if(typeof BX.InterfaceGridFilter==="undefined"){BX.InterfaceGridFilter=function(){this._defaultItemId="";this._id="";this._settings=null;this._itemInfos={};this._fieldInfos={};this._visibleFieldCount=0;this._items={};this._fields={};this._addFieldOpener=null;this._settingsOpener=null;this._ignoreFieldVisibilityChange=false;this._isApplied=false;this._currentItemId="";this._activeItemId="";this._saveAsDlg=null;this._manager=null;this._isFolded=false;this._presetsDeleted=[];this._saveVisibleFieldsTimeoutId=null};BX.InterfaceGridFilter.prototype={initialize:function(e,t){this._id=BX.type.isNotEmptyString(e)?e:"";this._settings=t?t:BX.CrmParamBag.create(null);this._isApplied=this._settings.getParam("isApplied",false);this._isFolded=this._settings.getParam("isFolded",true);this._presetsDeleted=this._settings.getParam("presetsDeleted",[]);this._defaultItemId=this._settings.getParam("defaultItemId","filter_default");this._currentItemId=this._settings.getParam("currentItemId","");this._activeItemId=this._currentItemId;if(this._activeItemId===""){this._activeItemId=this._defaultItemId}this._itemInfos=this._settings.getParam("itemInfos",{});var i=this._settings.getParam("currentValues",{});if(BX.type.isArray(i)){i={}}var n=this._activeItemId===this._defaultItemId;this._items[this._defaultItemId]=BX.InterfaceGridFilterItem.create(this._defaultItemId,BX.CrmParamBag.create({filter:this,info:{name:"",fields:n?i:{},filter_rows:this._settings.getParam("defaultVisibleRows","")},isActive:n}));for(var s in this._itemInfos){if(!this._itemInfos.hasOwnProperty(s)){continue}if(this.isDeleletedPreset(s)){continue}this._items[s]=BX.InterfaceGridFilterItem.create(s,BX.CrmParamBag.create({filter:this,info:this._itemInfos[s],isActive:this._activeItemId===s}))}this._fieldInfos=this._settings.getParam("fieldInfos",{});for(var r in this._fieldInfos){if(!this._fieldInfos.hasOwnProperty(r)){continue}var a=BX.InterfaceGridFilterField.create(r,BX.CrmParamBag.create({filter:this,info:this._fieldInfos[r]}));this._fields[r]=a;if(a.isVisible()){this._visibleFieldCount++}}BX.bind(this.getAddFieldButton(),"click",BX.delegate(this._handleAddFieldButtonClick,this));BX.bind(this.getSettingsButton(),"click",BX.delegate(this._handleSettingsButtonClick,this));BX.bind(this.getApplyButton(),"click",BX.delegate(this._handleApplyButtonClick,this));BX.bind(this.getCancelButton(),"click",BX.delegate(this._handleCancelButtonClick,this));BX.bind(this.getAddFilterButton(),"click",BX.delegate(this._handleSaveAsMenuItemClick,this));var l=this.getSwitchViewButton();if(l){l.title=this.getMessage(this._isFolded?"buttonMaximize":"buttonMinimize");BX.bind(l,"click",BX.delegate(this._handleSwitchViewButtonClick,this))}this._manager=BX.CrmInterfaceGridManager.items[this.getGridId()+"_MANAGER"];if(this._manager){this._initializeFieldControllers()}else{this._manager=null;BX.addCustomEvent(BX.CrmInterfaceGridManager,"CREATED",BX.delegate(this._onManagerCreated,this))}},_onManagerCreated:function(e){if(e.getId()===this.getGridId()+"_MANAGER"){this._manager=e}this._initializeFieldControllers()},_initializeFieldControllers:function(){for(var e in this._fields){if(this._fields.hasOwnProperty(e)){this._fields[e].initializeController()}}},getMessage:function(e){return BX.InterfaceGridFilter.getMessage(e)},getId:function(){return this._id},isApplied:function(){return this._isApplied},isFolded:function(){return this._isFolded},getCurrentItemId:function(){return this._currentItemId},getGridId:function(){return this._settings.getParam("gridId","")},getFormName:function(){return this._settings.getParam("formName","")},getForm:function(){return document.forms[this.getFormName()]},getCurrentTime:function(){return this._settings.getParam("currentTime","")},getServiceUrl:function(){return this._settings.getParam("serviceUrl","")},getContainerId:function(){return this._settings.getParam("containerId","flt_wrapper")},getItemContainerId:function(e){return this._settings.getParam("itemContainerPrefix","flt_tab_")+e.toString()},getFieldContainerId:function(e){return this._settings.getParam("fieldContainerPrefix","flt_field_")+e.toString()},getFieldDelimiterContainerId:function(e){return this._settings.getParam("fieldDelimiterContainerPrefix","flt_field_delim_")+e.toString()},getVisibleFieldCount:function(){return this._visibleFieldCount},getVisibleFieldIds:function(){var e=[];var t=this._fields;for(var i in t){if(t.hasOwnProperty(i)&&t[i].isVisible()){e.push(i)}}return e},getFieldInfo:function(e){if(!this._manager){return null}var t=this._manager.getSetting("filterFields",null);if(!t){return null}for(var i=0;i<t.length;i++){if(t[i]["id"]===e){return t[i]}}return null},saveVisibleFields:function(){if(this._saveVisibleFieldsTimeoutId!==null){window.clearTimeout(this._saveVisibleFieldsTimeoutId);this._saveVisibleFieldsTimeoutId=null}var e=this;this._saveVisibleFieldsTimeoutId=window.setTimeout(function(){e._doSaveVisibleFields()},100)},_doSaveVisibleFields:function(){this._saveVisibleFieldsTimeoutId=null;BX.ajax.get(this.getServiceUrl(),{GRID_ID:this.getGridId(),action:"filterrows",filter_id:this._activeItemId!==this._defaultItemId?this._activeItemId:"",rows:this.getVisibleFieldIds().join(",")})},saveActiveItem:function(e){var t=this._items[this._activeItemId];if(!t){return}BX.ajax.post(this.getServiceUrl(),{GRID_ID:this.getGridId(),filter_id:t.getId(),action:"savefilter",name:t.getName(),fields:this.getFieldParams(),rows:this.getVisibleFieldIds().join(",")},e)},isDeleletedPreset:function(e){for(var t=0;t<this._presetsDeleted.length;t++){if(this._presetsDeleted[t]===e){return true}}return false},deleteActiveItem:function(){var e=this._items[this._activeItemId];if(!e){return}var t=e.getId();BX.ajax.post(this.getServiceUrl(),{GRID_ID:this.getGridId(),filter_id:t,action:"delfilter"});if(/^filter_[0-9]+$/i.test(t)||this.isDeleletedPreset(t)){return}this._presetsDeleted.push(t);var i=BX.userOptions.delay;BX.userOptions.delay=100;BX.userOptions.save("crm.interface.grid.filter",this.getId().toLowerCase(),"presetsDeleted",this._presetsDeleted.join(","));BX.userOptions.delay=i},requireFieldVisibilityChange:function(e){if(this._ignoreFieldVisibilityChange){return true}return!e.isVisible()||this.getVisibleFieldCount()>1},handleFieldVisibilityChange:function(e){if(this._ignoreFieldVisibilityChange){return}if(e.isVisible()){this._visibleFieldCount++}else{this._visibleFieldCount--}this._adjustStyle();this._showDeleteButtons(this._visibleFieldCount>1);this.saveVisibleFields()},requireItemActivityChange:function(e){return true},handleItemActivityChange:function(e){if(!e.isActive()){return}this._setActiveItem(e)},handleSaveAsDialogClose:function(e){if(e.getButtonId()!=="save"){return}var t=e.getValues();var i="filter_"+Math.random().toString().substring(2).toString();var n={name:t["name"]?t["name"]:BX.InterfaceGridFilter.getMessage("defaultFilterName"),fields:this.getFieldParams()};this._itemInfos[i]=n;var s=this._items[i]=BX.InterfaceGridFilterItem.create(i,BX.CrmParamBag.create({filter:this,info:n,isActive:false}));s.setActive(true);this.saveActiveItem()},getFieldParams:function(){var e={};for(var t in this._fields){if(this._fields.hasOwnProperty(t)){this._fields[t].getParams(e)}}return e},setFieldParams:function(e){for(var t in this._fields){if(this._fields.hasOwnProperty(t)){this._fields[t].setParams(e)}}},_setActiveItem:function(e){var t=null;if(this._activeItemId!==""){t=this._items[this._activeItemId]}if(t){t.setFieldParams(this.getFieldParams());t.setVisibleFieldIds(this.getVisibleFieldIds());t.setActive(false)}this._activeItemId=e.getId();t=this._items[this._activeItemId];if(t.isCurrent()){BX.addClass(this._getWrapper(),"bx-current-filter")}else{BX.removeClass(this._getWrapper(),"bx-current-filter")}this.setFieldParams(t.getFieldParams());this._ignoreFieldVisibilityChange=true;this._visibleFieldCount=0;var i=t.getVisibleFieldIds();if(i.length>0){for(var n in this._fields){if(!this._fields.hasOwnProperty(n)){continue}var s=false;for(var r=0;r<i.length;r++){if(i[r]===n){s=true;break}}this._fields[n].setVisible(s);if(s){this._visibleFieldCount++}}}else{for(var n in this._fieldInfos){if(!this._fieldInfos.hasOwnProperty(n)){continue}var s=this._fieldInfos[n]["isVisible"];this._fields[n].setVisible(s);if(s){this._visibleFieldCount++}}}this._adjustStyle();this._showDeleteButtons(this._visibleFieldCount>1);this._ignoreFieldVisibilityChange=false},apply:function(e){var t=this._items[e];if(t){this._setActiveItem(t);this.applyActive()}},applyActive:function(){var e=this._currentItemId;this._currentItemId=this._activeItemId;if(e!==""){this._items[e].handleCurrentItemChange(this)}this._items[this._currentItemId].handleCurrentItemChange(this);var t=this.getForm();if(!t){return}var i=BX.findChild(t,{tag:"INPUT",property:{type:"hidden",name:"grid_filter_id"}},true,false);if(i){i.value=this._activeItemId!==this._defaultItemId?this._activeItemId:""}var n=BX.findChild(t,{tag:"INPUT",property:{type:"hidden",name:"apply_filter"}},true,false);if(n){n.value="Y"}BX.submit(t)},clear:function(){var e=this.getForm();if(!e){return}var t=BX.findChild(e,{tag:"INPUT",property:{type:"hidden",name:"clear_filter"}},true,false);if(t){t.value="Y"}this.setFieldParams({});BX.submit(e)},_adjustStyle:function(){var e=BX(this.getContainerId());if(!e){return}var t=BX.findChild(e,{"class":"bx-filter-bottom-separate"},true,false);var i=BX.findChild(e,{"class":"bx-filter-content"},true,false);if(this.getVisibleFieldCount()>1){BX.removeClass(i,"bx-filter-content-first");t.style.display=""}else{BX.addClass(i,"bx-filter-content-first");t.style.display="none"}},_getWrapper:function(){return BX.findChild(BX(this.getContainerId()),{tag:"DIV","class":"bx-filter-wrap"},true)},getAddFieldButton:function(){return BX.findChild(BX(this.getContainerId()),{tag:"SPAN","class":"bx-filter-add-button"},true,false)},getAddFilterButton:function(){return BX.findChild(BX(this.getContainerId()),{tag:"SPAN","class":"bx-filter-add-tab"},true,false)},getSettingsButton:function(){return BX.findChild(BX(this.getContainerId()),{tag:"SPAN","class":"bx-filter-setting"},true,false)},getApplyButton:function(){return BX.findChild(BX(this.getContainerId()),{tag:"INPUT",property:{type:"button",name:"set_filter"}},true,false)},getCancelButton:function(){return BX.findChild(BX(this.getContainerId()),{tag:"INPUT",property:{type:"button",name:"reset_filter"}},true,false)},getSwitchViewButton:function(){return BX.findChild(BX(this.getContainerId()),{tag:"SPAN","class":"bx-filter-switcher-tab"},true,false)},setFieldsVisible:function(e,t){this._ignoreFieldVisibilityChange=true;this._visibleFieldCount=0;e=!!e;t=t?t:{};var i=typeof t["skipTop"]!=="undefined"?parseInt(t["skipTop"]):0;var n=this._fields;for(var s in n){if(!n.hasOwnProperty(s)){continue}var r=n[s];if(r.isVisible()!==e){if(i>0){i--}else{r.setVisible(e)}}if(r.isVisible()){this._visibleFieldCount++}}this._adjustStyle();this._showDeleteButtons(this._visibleFieldCount>1);this.saveVisibleFields();this._ignoreFieldVisibilityChange=false},setFolded:function(e){e=!!e;if(e===this._isFolded){return}this._isFolded=e;if(e){BX.addClass(this._getWrapper(),"bx-filter-folded")}else{BX.removeClass(this._getWrapper(),"bx-filter-folded")}if(this._activeItemId!==""){var t=this._items[this._activeItemId];if(t){t.handleFilderFoldingChange(this)}}var i=this.getSwitchViewButton();if(i){i.title=this.getMessage(e?"buttonMaximize":"buttonMinimize")}var n=BX.userOptions.delay;BX.userOptions.delay=100;BX.userOptions.save("crm.interface.grid.filter",this.getId().toLowerCase(),"isFolded",e?"Y":"N");BX.userOptions.delay=n},_showDeleteButtons:function(e){e=!!e;var t=this._fields;for(var i in t){if(t.hasOwnProperty(i)){t[i].showDeleteButton(e)}}},_handleAddFieldButtonClick:function(e){var t=[];var i=this._fields;for(var n in i){if(!i.hasOwnProperty(n)){continue}var s=i[n];t.push({id:s.getId(),text:s.getName(),onchange:s.getToggleHandler(),checked:s.isVisible()})}t.push({id:"__showAll",text:this.getMessage("showAll"),onclick:BX.delegate(this._handleShowAllButtonClick,this),checked:false,allowToggle:false,separatorBefore:true});t.push({id:"__hideAll",text:this.getMessage("hideAll"),onclick:BX.delegate(this._handleHideAllButtonClick,this),checked:false,allowToggle:false});var r=this.getAddFieldButton();var a=BX.pos(r);this._addFieldOpener=BX.InterfaceGridFilterCheckListMenu.create(this.getId()+"_ADD_FIELDS",BX.CrmParamBag.create({allowToggle:true,items:t,anchor:r,offsetTop:Math.round(a.height/4),offsetLeft:Math.round(a.width/2),angle:{position:"top",offset:0}}));this._addFieldOpener.open()},_handleSettingsButtonClick:function(e){var t=[];if(this._activeItemId==this._defaultItemId){t.push({id:"saveAs",text:this.getMessage("saveAs"),onclick:BX.delegate(this._handleSaveAsMenuItemClick,this),checked:false})}else{t.push({id:"save",text:this.getMessage("save"),onclick:BX.delegate(this._handleSaveMenuItemClick,this),checked:false});t.push({id:"saveAs",text:this.getMessage("saveAs"),onclick:BX.delegate(this._handleSaveAsMenuItemClick,this),checked:false});t.push({id:"delete",text:this.getMessage("delete"),onclick:BX.delegate(this._handleDeleteMenuItemClick,this),checked:false})}var i=this.getSettingsButton();var n=BX.pos(i);this._settingsOpener=BX.InterfaceGridFilterCheckListMenu.create(this.getId()+"_SETTINGS_"+this._activeItemId.toUpperCase(),BX.CrmParamBag.create({allowToggle:false,items:t,anchor:i,closeOnClick:true,offsetTop:Math.round(n.height/4),offsetLeft:Math.round(n.width/2),angle:{position:"top",offset:0}}));this._settingsOpener.open()},_handleApplyButtonClick:function(e){if(this._activeItemId===this._defaultItemId){this.applyActive();return}var t=this;this.saveActiveItem(function(){t.applyActive()})},_handleCancelButtonClick:function(e){this.clear()},_handleShowAllButtonClick:function(e){this.setFieldsVisible(true,{})},_handleHideAllButtonClick:function(e){this.setFieldsVisible(false,{skipTop:1})},_handleSaveMenuItemClick:function(e){this.saveActiveItem()},_handleSaveAsMenuItemClick:function(e){if(!this._saveAsDlg){this._saveAsDlg=BX.InterfaceGridFilterSaveAsDialog.create(this.getId()+"_SAVE_AS",BX.CrmParamBag.create({filter:this}))}this._saveAsDlg.openDialog()},_handleDeleteMenuItemClick:function(e){var t=this._activeItemId;var i=this._items[t];if(t===this._defaultItemId||!i){return}this.deleteActiveItem();if(i.isCurrent()){this.clear()}i.clearLayout();this._items[this._defaultItemId].setActive(true);delete this._items[t]},_handleSwitchViewButtonClick:function(e){this.setFolded(!this.isFolded())}};BX.InterfaceGridFilter.isEmptyObject=function(e){if(e===null||e===undefined){return true}var t=Object.prototype.hasOwnProperty;if(typeof e.length!=="undefined"){return e.length===0}if(typeof e==="object"){for(var i in e){if(t.call(e,i)){return false}}}return true};if(typeof BX.InterfaceGridFilter.messages==="undefined"){BX.InterfaceGridFilter.messages={}}BX.InterfaceGridFilter.getMessage=function(e){return typeof BX.InterfaceGridFilter.messages[e]!=="undefined"?BX.InterfaceGridFilter.messages[e]:""};BX.InterfaceGridFilter.items={};BX.InterfaceGridFilter.create=function(e,t){var i=new BX.InterfaceGridFilter;i.initialize(e,t);this.items[e]=i;return i}}if(typeof BX.InterfaceGridFilterItem==="undefined"){BX.InterfaceGridFilterItem=function(){this._id="";this._settings=null;this._filter=null;this._container=null;this._isActive=false;this._info={};this._fieldParams={};this._visibleFieldIds=[]};BX.InterfaceGridFilterItem.prototype={initialize:function(e,t){this._id=BX.type.isNotEmptyString(e)?e:"";this._settings=t?t:BX.CrmParamBag.create(null);this._filter=t.getParam("filter",null);this._info=t.getParam("info",{});this._fieldParams=typeof this._info["fields"]!=="undefined"?this._info["fields"]:{};var i=typeof this._info["filter_rows"]!=="undefined"?this._info["filter_rows"]:null;if(BX.type.isString(i)){i=i.split(",")}if(BX.type.isArray(i)){this._visibleFieldIds=i}else{for(var n in this._fieldParams){if(this._fieldParams.hasOwnProperty(n)){this._visibleFieldIds.push(BX.InterfaceGridFilterField.convertParamToFieldId(n))}}}this._isActive=t.getParam("isActive",false);var s=this._filter.getItemContainerId(e);this._container=BX(s);if(!this._container){this.layout()}BX.bind(this._container,"click",BX.delegate(this._onClick,this))},getId:function(){return this._id},getName:function(){return this._info["name"]},getInfo:function(){return this._info},isActive:function(){return this._isActive},isCurrent:function(){return this._filter.getCurrentItemId()===this.getId()},setActive:function(e){e=!!e;if(this._isActive===e){return}if(!this._filter.requireItemActivityChange(this)){return}this._isActive=e;this._filter.handleItemActivityChange(this);this._adjustStyle()},getFieldParams:function(){return this._fieldParams},setFieldParams:function(e){this._fieldParams=e},getVisibleFieldIds:function(){return this._visibleFieldIds},setVisibleFieldIds:function(e){this._visibleFieldIds=e},layout:function(){var e=BX.findChild(BX(this._filter.getContainerId()),{tag:"DIV","class":"bx-filter-tabs-block"},true);if(!e){return}this._container=BX.create("SPAN",{props:{id:this._filter.getItemContainerId(this.getId())},attrs:{"class":"bx-filter-tab"},text:this.getName()});e.insertBefore(this._container,this._filter.getAddFilterButton())},clearLayout:function(){if(!this._container){return}BX.remove(this._container)},_adjustStyle:function(){if(this._filter.isFolded()){if(this.isCurrent()){BX.addClass(this._container,"bx-filter-tab-active")}else{BX.removeClass(this._container,"bx-filter-tab-active")}}else{if(this._isActive){BX.addClass(this._container,"bx-filter-tab-active")}else{BX.removeClass(this._container,"bx-filter-tab-active")}}},handleFilderFoldingChange:function(e){this._adjustStyle()},handleCurrentItemChange:function(e){this._adjustStyle()},_onClick:function(e){if(!this.isActive()){this.setActive(true)}if(this._filter.isFolded()){this._filter.applyActive()}}};BX.InterfaceGridFilterItem.create=function(e,t){var i=new BX.InterfaceGridFilterItem;i.initialize(e,t);return i}}if(typeof BX.InterfaceGridFilterField==="undefined"){BX.InterfaceGridFilterField=function(){this._id="";this._settings=null;this._filter=null;this._info={};this._container=null;this._delimiterContainer=null;this._isVisible=true;this._deleteButton=null;this._controller=null};BX.InterfaceGridFilterField.prototype={initialize:function(e,t){this._id=BX.type.isNotEmptyString(e)?e:"";this._settings=t?t:BX.CrmParamBag.create(null);this._filter=t.getParam("filter",null);this._container=BX(this._filter.getFieldContainerId(e));this._delimiterContainer=BX(this._filter.getFieldDelimiterContainerId(e));this._info=t.getParam("info",{});this._isVisible=this._info["isVisible"];this._deleteButton=BX.findChild(this._container,{tag:"SPAN","class":"bx-filter-item-delete"},true,false);if(this._deleteButton){this._deleteButton.title=BX.InterfaceGridFilter.getMessage("buttonDeleteField");BX.bind(this._deleteButton,"click",BX.delegate(this._handleDeleteButtonClick,this))}if(this.getType()==="date"){this._controller=BX.InterfaceGridFilterDate.create(BX.CrmParamBag.create({containerId:this._filter.getFieldContainerId(e),formName:this._filter.getFormName(),currentTime:this._filter.getCurrentTime()}))}if(this._controller){this._controller.layout()}this._handleVisibilityChange()},initializeController:function(){if(this.getType()!=="custom"){return}var e=this._filter.getFieldInfo(this._id);if(e&&e["typeName"]==="USER"){this._controller=BX.InterfaceGridFilterUser.create(BX.CrmParamBag.create({containerId:this._filter.getFieldContainerId(this._id),info:e}));if(this._controller){this._controller.layout()}}},getId:function(){return this._id},getName:function(){return this._info["name"]},getType:function(){return this._info["type"]},isVisible:function(){return this._isVisible},getToggleHandler:function(){return BX.delegate(this._handleToggleButtonClick,this)},_handleToggleButtonClick:function(e){this.toggle()},_handleDeleteButtonClick:function(e){this.setVisible(false)},_handleVisibilityChange:function(){var e=BX.findChildren(this._container,{tag:/^INPUT|SELECT|TEXTAREA/i},true);if(!BX.type.isArray(e)){return}var t=!this._isVisible;for(var i=0;i<e.length;i++){var n=e[i];var s=n.name;if(s===""){continue}n.disabled=t}},setVisible:function(e){e=!!e;if(this._isVisible===e){return}if(!this._filter.requireFieldVisibilityChange(this)){return}this._container.style.display=e?"":"none";if(this._delimiterContainer){this._delimiterContainer.style.display=e?"":"none"}this._isVisible=e;this._handleVisibilityChange();this._filter.handleFieldVisibilityChange(this)},toggle:function(){this.setVisible(!this._isVisible)},showDeleteButton:function(e){if(this._deleteButton){this._deleteButton.style.display=!!e?"":"none"}},getParams:function(e){if(!this.isVisible()){return}if(this._controller&&this._controller.tryGetParams(e)){return}var t=BX.findChildren(this._container,{tag:/^INPUT|SELECT|TEXTAREA/i},true);for(var i=0;i<t.length;i++){var n=t[i];var s=n.name;if(s===""){continue}switch(n.type.toLowerCase()){case"select-one":case"text":case"textarea":case"hidden":{e[s]=n.value;break}case"radio":{if(n.checked){e[s]=n.value}break}case"checkbox":{e[s]=n.checked?n.value:false;break}case"select-multiple":{s=s.substr(0,s.length-2);e[s]={};for(var r=0;r<n.options.length;r++){if(n.options[r].selected&&n.options[r].value){e[s]["sel"+n.options[r].value]=n.options[r].value}}break}}}},setParams:function(e){if(this._controller&&this._controller.trySetParams(e)){return}var t=BX.findChildren(this._container,{tag:/^INPUT|SELECT|TEXTAREA/i},true);for(var i=0;i<t.length;i++){var n=t[i];var s=n.name;if(s===""){continue}var r=false;var a=typeof e[s]!=="undefined"?e[s]:null;switch(n.type.toLowerCase()){case"select-one":case"text":case"textarea":case"hidden":n.value=a!==null?a:"";r=true;break;case"select-multiple":{s=s.substr(0,s.length-2);a=typeof e[s]==="object"&&e[s]?e[s]:{};if(a===null){for(var l=0;l<n.options.length;l++){n.options[l].selected=false}}else{var o=false;for(var d=0;d<n.options.length;d++){var h=n.options[d];var f="sel"+h.value;var u=a[f]?a[f]:null;h.selected=h.value==u;if(h.value==u){o=true}}if(!o&&n.options.length>0&&n.options[0].value==""){n.options[0].selected=true}}r=true;break}case"radio":case"checkbox":{n.checked=a!==null?a:false}r=true;break}if(r&&BX.type.isFunction(n.onchange)){try{n.onchange()}catch(c){}}}}};BX.InterfaceGridFilterField.convertParamToFieldId=function(e){return e.replace(/_[a-z]+$/,"")};BX.InterfaceGridFilterField.create=function(e,t){var i=new BX.InterfaceGridFilterField;i.initialize(e,t);return i}}if(typeof BX.InterfaceGridFilterDate==="undefined"){BX.InterfaceGridFilterDate=function(){this._settings=null;this._container=null};BX.InterfaceGridFilterDate.prototype={initialize:function(e){this._settings=e?e:BX.CrmParamBag.create(null);this._container=BX(e.getParam("containerId"));var t=BX.findChild(this._container,{tag:"SELECT","class":"bx-filter-date-interval-select"},true,false);if(t){BX.bind(t,"change",BX.delegate(this._onIntervalChange,this))}BX.bind(BX.findChild(BX.findChild(this._container,{tag:"DIV","class":"bx-filter-date-from"},true,false),{tag:"SPAN","class":"bx-calendar-icon"},true,false),"click",BX.delegate(this._onDataFromClick,this));BX.bind(BX.findChild(BX.findChild(this._container,{tag:"DIV","class":"bx-filter-date-to"},true,false),{tag:"SPAN","class":"bx-calendar-icon"},true,false),"click",BX.delegate(this._onDataToClick,this))},_openCalendar:function(e,t){BX.calendar({node:e,field:t,form:this._settings.getParam("formName"),bTime:false,currentTime:this._settings.getParam("currentTime"),bHideTime:false})},_onIntervalChange:function(e){this.layout()},_onDataFromClick:function(e){var t=BX.findChild(this._container,{tag:"DIV","class":"bx-filter-date-from"},true,false);if(!t){return}this._openCalendar(BX.findChild(t,{
tag:"SPAN","class":"bx-calendar-icon"},true,false),BX.findChild(t,{tag:"INPUT","class":"bx-input-date"},true,false))},_onDataToClick:function(e){var t=BX.findChild(this._container,{tag:"DIV","class":"bx-filter-date-to"},true,false);if(!t){return}this._openCalendar(BX.findChild(t,{tag:"SPAN","class":"bx-calendar-icon"},true,false),BX.findChild(t,{tag:"INPUT","class":"bx-input-date"},true,false))},_displayNode:function(e,t){var i=BX.findChild(this._container,e,true,false);if(i){i.style.display=t?"":"none"}},layout:function(){var e=BX.findChild(this._container,{tag:"SELECT","class":"bx-filter-date-interval-select"},true,false);if(!e){return}var t,i,n,s;t=i=n=s=false;var r=e.value;if(r==="interval"){t=i=n=true}else if(r==="before"){i=true}else if(r==="after"||r==="exact"){t=true}else if(r==="days"){s=true}this._displayNode({tag:"DIV","class":"bx-filter-date-days"},s);this._displayNode({tag:"DIV","class":"bx-filter-date-from"},t);this._displayNode({tag:"DIV","class":"bx-filter-date-to"},i);this._displayNode({tag:"SPAN","class":"bx-filter-calendar-separate"},n)},tryGetParams:function(e){return false},trySetParams:function(e){return false}};BX.InterfaceGridFilterDate.create=function(e){var t=new BX.InterfaceGridFilterDate;t.initialize(e);return t}}if(typeof BX.InterfaceGridFilterUser==="undefined"){BX.InterfaceGridFilterUser=function(){this._settings=null;this._info=null;this._container=null};BX.InterfaceGridFilterUser.prototype={initialize:function(e){this._settings=e?e:BX.CrmParamBag.create(null);this._container=BX(e.getParam("containerId"));this._info=e.getParam("info",null)},layout:function(){},trySetParams:function(e){if(!this._info){return false}var t=this._info["params"]?this._info["params"]:{};var i=t["data"]?t["data"]:{};this._setElementByParam(i["elementId"],i["paramName"],e);var n=t["search"]?t["search"]:{};this._setElementByParam(n["elementId"],n["paramName"],e);return true},tryGetParams:function(e){return false},_setElementByParam:function(e,t,i){var n=BX.type.isNotEmptyString(e)?BX(e):null;if(BX.type.isElementNode(n)){n.value=BX.type.isNotEmptyString(t)&&i[t]?i[t]:""}}};BX.InterfaceGridFilterUser.create=function(e){var t=new BX.InterfaceGridFilterUser;t.initialize(e);return t}}if(typeof BX.InterfaceGridFilterSaveAsDialog==="undefined"){BX.InterfaceGridFilterSaveAsDialog=function(){this._id="";this._settings=null;this._filter=null;this._dlg=null;this._buttonId="";this._nameInput=null};BX.InterfaceGridFilterSaveAsDialog.prototype={initialize:function(e,t){this._id=e;this._settings=t?t:BX.CrmParamBag.create(null);this._filter=t.getParam("filter",null)},getId:function(){return this._id},getButtonId:function(){return this._buttonId},getValues:function(){return{name:this._nameInput?this._nameInput.value:""}},openDialog:function(){if(this._dlg){this._dlg.show();return}this._dlg=new BX.PopupWindow(this.getId()+"_SAVE_AS",null,{autoHide:false,draggable:true,offsetLeft:0,offsetTop:0,bindOptions:{forceBindPosition:false},closeByEsc:true,closeIcon:{top:"10px",right:"15px"},titleBar:{content:BX.create("span",{text:BX.InterfaceGridFilter.getMessage("saveAsDialogTitle")})},events:{onPopupClose:BX.delegate(this._handleDialogClose,this)},content:this._prepareContent(),buttons:this._prepareButtons()});this._dlg.show()},_prepareContent:function(){var e=BX.create("TABLE",{style:{width:"350px",margin:"5px 0 0 0"}});var t=e.insertRow(-1);var i=t.insertCell(-1);i.align="right";i.innerHTML=BX.InterfaceGridFilter.getMessage("saveAsDialogFieldName")+":";i=t.insertCell(-1);this._nameInput=BX.create("INPUT",{style:{width:"200px"},props:{type:"text",maxlength:"255",size:"30"},text:BX.InterfaceGridFilter.getMessage("defaultFilterName")});i.appendChild(this._nameInput);return e},_prepareButtons:function(){return[new BX.PopupWindowButton({text:BX.InterfaceGridFilter.getMessage("buttonSave"),className:"popup-window-button-accept",events:{click:BX.delegate(this._handleSaveButtonClick,this)}}),new BX.PopupWindowButtonLink({text:BX.InterfaceGridFilter.getMessage("buttonCancel"),className:"popup-window-button-link-cancel",events:{click:BX.delegate(this._handleCancelButtonClick,this)}})]},_handleSaveButtonClick:function(e){this._buttonId="save";this._filter.handleSaveAsDialogClose(this);this._dlg.close()},_handleCancelButtonClick:function(e){this._buttonId="cancel";this._filter.handleSaveAsDialogClose(this);this._dlg.close()},_handleDialogClose:function(e){if(this._dlg){this._dlg.destroy()}this._dlg=null}};BX.InterfaceGridFilterSaveAsDialog.create=function(e,t){var i=new BX.InterfaceGridFilterSaveAsDialog;i.initialize(e,t);return i}}if(typeof BX.InterfaceGridFilterCheckListMenu==="undefined"){BX.InterfaceGridFilterCheckListMenu=function(){this._id="";this._settings=null;this._filter=null;this._allowToggle=true;this._items=[];this._menuId="";this._menu=null};BX.InterfaceGridFilterCheckListMenu.prototype={initialize:function(e,t){this._id=e;this._menuId=this._id.toLowerCase();this._settings=t?t:BX.CrmParamBag.create(null);this._filter=t.getParam("filter",null);this._allowToggle=this.getSetting("allowToggle",true);this._closeOnClick=this.getSetting("closeOnClick",false);var i=this.getSetting("items");for(var n=0;n<i.length;n++){var s=i[n];this._items.push(BX.InterfaceGridFilterCheckListMenuItem.create(s["id"],BX.CrmParamBag.create({text:BX.type.isString(s["text"])?s["text"]:"",checked:BX.type.isBoolean(s["checked"])?s["checked"]:false,onchange:BX.type.isFunction(s["onchange"])?s["onchange"]:null,onclick:BX.type.isFunction(s["onclick"])?s["onclick"]:null,allowToggle:BX.type.isBoolean(s["allowToggle"])?s["allowToggle"]:this._allowToggle,closeOnClick:BX.type.isBoolean(s["closeOnClick"])?s["closeOnClick"]:this._closeOnClick,separatorBefore:BX.type.isBoolean(s["separatorBefore"])?s["separatorBefore"]:false,separatorAfter:BX.type.isBoolean(s["separatorAfter"])?s["separatorAfter"]:false,menu:this})))}},getId:function(){return this._id},getSetting:function(e,t){return this._settings.getParam(e,t)},open:function(){var e=[];for(var t=0;t<this._items.length;t++){var i=this._items[t].createPopupMenuItems();for(var n=0;n<i.length;n++){e.push(i[n])}}if(typeof BX.PopupMenu.Data[this._menuId]!=="undefined"){BX.PopupMenu.Data[this._menuId].popupWindow.destroy();delete BX.PopupMenu.Data[this._menuId]}this._menu=BX.PopupMenu.show(this._menuId,this.getSetting("anchor",null),e,{offsetTop:parseInt(this.getSetting("offsetTop",0)),offsetLeft:parseInt(this.getSetting("offsetLeft",0)),angle:this.getSetting("angle",{})})},close:function(){if(typeof BX.PopupMenu.Data[this._menuId]!=="undefined"){BX.PopupMenu.Data[this._menuId].popupWindow.close()}},getContainer:function(){return BX("menu-popup-"+this.getId().toLowerCase())}};BX.InterfaceGridFilterCheckListMenu.create=function(e,t){var i=new BX.InterfaceGridFilterCheckListMenu;i.initialize(e,t);return i}}if(typeof BX.InterfaceGridFilterCheckListMenuItem==="undefined"){BX.InterfaceGridFilterCheckListMenuItem=function(){this._id="";this._settings=null;this._menu=null;this._checked=false;this._allowToggle=true;this._closeOnClick=false};BX.InterfaceGridFilterCheckListMenuItem.prototype={initialize:function(e,t){this._id=e;this._settings=t?t:BX.CrmParamBag.create(null);this._menu=t.getParam("menu",null);this._checked=t.getParam("checked",false);this._allowToggle=this.getSetting("allowToggle",true);this._closeOnClick=this.getSetting("closeOnClick",false)},getSetting:function(e,t){return this._settings.getParam(e,t)},getId:function(){return this._id},isChecked:function(){return this._checked},setChecked:function(e){e=!!e;if(this._checked===e){return}this._checked=e;var t=this.getSetting("onchange",null);if(BX.type.isFunction(t)){try{t({id:this.getId(),checked:e},this)}catch(i){}}},toggle:function(){if(this._allowToggle){this.setChecked(!this.isChecked())}},createPopupMenuItems:function(){var e=[];if(this.getSetting("separatorBefore",false)){e.push({SEPARATOR:true})}e.push({text:this.getSetting("text",this.getId()),className:"tabbed-filter-popup-item"+(this.isChecked()?" menu-popup-item-checked":"")+" tabbed-check-list-menu-item-"+this.getId().toLowerCase(),href:"#",onclick:BX.delegate(this._onClick,this)});if(this.getSetting("separatorAfter",false)){e.push({SEPARATOR:true})}return e},_onClick:function(e){BX.PreventDefault(e);var t=this.getSetting("onclick",null);if(BX.type.isFunction(t)){try{t({id:this.getId(),checked:this.isChecked()},this)}catch(i){}}if(this._closeOnClick){this._menu.close();return}this.toggle();var n=BX.findChild(this._menu.getContainer(),{tag:"A","class":"tabbed-check-list-menu-item-"+this.getId().toLowerCase()},true,false);if(this.isChecked()){BX.addClass(n,"menu-popup-item-checked")}else{BX.removeClass(n,"menu-popup-item-checked")}}};BX.InterfaceGridFilterCheckListMenuItem.create=function(e,t){var i=new BX.InterfaceGridFilterCheckListMenuItem;i.initialize(e,t);return i}}
//# sourceMappingURL=script.map.js