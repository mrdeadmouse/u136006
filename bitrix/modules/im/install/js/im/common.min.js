(function(e){if(e.BX.MessengerCommon)return;var s=e.BX;s.MessengerCommon=function(){this.BXIM={}};s.MessengerCommon.prototype.setBxIm=function(e){this.BXIM=e};s.MessengerCommon.prototype.isMobile=function(){return this.BXIM.mobileVersion};s.MessengerCommon.prototype.MobileActionEqual=function(e){if(!this.isMobile())return true;for(var s=0;s<arguments.length;s++){if(arguments[s]==this.BXIM.mobileAction)return true}return false};s.MessengerCommon.prototype.MobileActionNotEqual=function(e){if(!this.isMobile())return false;for(var s=0;s<arguments.length;s++){if(arguments[s]==this.BXIM.mobileAction)return false}return true};s.MessengerCommon.prototype.isScrollMax=function(e,s){if(!e)return true;s=typeof s=="number"?s:0;return e.scrollHeight-e.offsetHeight-s<=e.scrollTop};s.MessengerCommon.prototype.isScrollMin=function(e){if(!e)return false;return 0==e.scrollTop};s.MessengerCommon.prototype.enableScroll=function(e,s,t){if(!e)return false;t=t!==false;s=parseInt(s);return t&&this.isScrollMax(e,s)};s.MessengerCommon.prototype.preventDefault=function(t){t=t||e.event;if(t.stopPropagation)t.stopPropagation();else t.cancelBubble=true;if(typeof BXIM!="undefined"&&BXIM.messenger&&BXIM.messenger.closeMenuPopup)BXIM.messenger.closeMenuPopup();if(typeof s!="undefined"&&s.calendar&&s.calendar.get().popup)s.calendar.get().popup.close()};s.MessengerCommon.prototype.countObject=function(e){var s=0;for(var t in e){if(e.hasOwnProperty(t)){s++}}return s};s.MessengerCommon.prototype.isElementCoordsBelow=function(e,s,t,r){if(this.isMobile()){return true}if(!s||typeof s.getElementsByClassName=="undefined"){return false}t=t?t:0;var i=this.getElementCoords(e,s);i.bottom=i.top+e.offsetHeight;var n=i.top>=t;var a=i.bottom>t;if(r){return{top:n,bottom:a,coords:i}}else{return n||a}};s.MessengerCommon.prototype.isElementVisibleOnScreen=function(e,s,t){if(this.isMobile()){return BitrixMobile.isElementVisibleOnScreen(e)}if(!s||typeof s.getElementsByClassName=="undefined"){return false}var r=this.getElementCoords(e,s);r.bottom=r.top+e.offsetHeight;var i=s.scrollTop;var n=i+s.clientHeight;var a=r.top>=0&&r.top<n;var o=r.bottom>0&&r.bottom<s.clientHeight;if(t){return{top:a,bottom:o}}else{return a||o}};s.MessengerCommon.prototype.getElementCoords=function(e,s){if(this.isMobile()){return BitrixMobile.getElementCoords(e)}if(!s||typeof s.getElementsByClassName=="undefined"){return false}var t=e.getBoundingClientRect();var r=s.getBoundingClientRect();return{originTop:t.top,originLeft:t.left,top:t.top-r.top,left:t.left-r.left}};s.MessengerCommon.prototype.getDateFormatType=function(e){e=e?e.toString().toUpperCase():"DEFAULT";var t=[];if(e=="MESSAGE_TITLE"){t=[["tommorow","tommorow"],["today","today"],["yesterday","yesterday"],["",s.date.convertBitrixFormat(s.message("IM_M_MESSAGE_TITLE_FORMAT_DATE"))]]}else if(e=="MESSAGE"){t=[["",s.message("IM_M_MESSAGE_FORMAT_TIME")]]}else if(e=="RECENT_TITLE"){t=[["tommorow","today"],["today","today"],["yesterday","yesterday"],["",s.date.convertBitrixFormat(s.message("IM_CL_RESENT_FORMAT_DATE"))]]}else{t=[["tommorow","tommorow, "+s.message("IM_M_MESSAGE_FORMAT_TIME")],["today","today, "+s.message("IM_M_MESSAGE_FORMAT_TIME")],["yesterday","yesterday, "+s.message("IM_M_MESSAGE_FORMAT_TIME")],["",s.date.convertBitrixFormat(s.message("FORMAT_DATETIME"))]]}return t};s.MessengerCommon.prototype.formatDate=function(e,t){if(typeof t=="undefined"){t=this.getDateFormatType("DEFAULT")}return s.date.format(t,parseInt(e)+parseInt(s.message("SERVER_TZ_OFFSET")),this.getNowDate()+parseInt(s.message("SERVER_TZ_OFFSET")),true)};s.MessengerCommon.prototype.getNowDate=function(e){var t=new Date;if(e==true)t=new Date(t.getFullYear(),t.getMonth(),t.getDate(),0,0,0);return Math.round(+t/1e3)+parseInt(s.message("USER_TZ_OFFSET"))};s.MessengerCommon.prototype.getDateDiff=function(e){var t=s.message("USER_TZ_OFFSET");if(t==="")return 0;var r=this.getNowDate()+parseInt(s.message("SERVER_TZ_OFFSET"));var i=parseInt(e)+parseInt(s.message("SERVER_TZ_OFFSET"));return r-i};s.MessengerCommon.prototype.isBlankAvatar=function(e){return e==""||e.indexOf(this.BXIM.pathToBlankImage)>=0};s.MessengerCommon.prototype.hideErrorImage=function(e){var s=e.src;e.parentNode.parentNode.className="";e.parentNode.parentNode.innerHTML='<a href="'+s+'" target="_blank">'+s+"</a>"};s.MessengerCommon.prototype.prepareText=function(e,t,r,i,n){var a=e;t=t==true;r=r==true;i=i==true;n=n?n:false;a=s.util.trim(a);var o="&gt;&gt;";if(r&&a.indexOf(o)>=0){var m=false;var g=a.split("<br />");for(var l=0;l<g.length;l++){if(g[l].substring(0,o.length)==o){g[l]=g[l].replace(o,'<div class="bx-messenger-content-quote"><span class="bx-messenger-content-quote-icon"></span><div class="bx-messenger-content-quote-wrap">');while(++l<g.length&&g[l].substring(0,o.length)==o){g[l]=g[l].replace(o,"")}g[l-1]+="</div></div>";m=true}}a=g.join("<br />")}if(t){a=s.util.htmlspecialchars(a)}if(r){a=a.replace(/------------------------------------------------------<br \/>(.*?)\[(.*?)\]<br \/>(.*?)------------------------------------------------------(<br \/>)?/g,function(e,s,t,r,i,n){return(n>0?"<br>":"")+'<div class="bx-messenger-content-quote"><span class="bx-messenger-content-quote-icon"></span><div class="bx-messenger-content-quote-wrap"><div class="bx-messenger-content-quote-name">'+s+' <span class="bx-messenger-content-quote-time">'+t+"</span></div>"+r+"</div></div><br />"});a=a.replace(/------------------------------------------------------<br \/>(.*?)------------------------------------------------------(<br \/>)?/g,function(e,s,t,r,i){return(i>0?"<br>":"")+'<div class="bx-messenger-content-quote"><span class="bx-messenger-content-quote-icon"></span><div class="bx-messenger-content-quote-wrap">'+s+"</div></div><br />"})}if(t){a=a.replace(/\n/gi,"<br />")}a=a.replace(/\t/gi,"&nbsp;&nbsp;&nbsp;&nbsp;");if(i){a=a.replace(/<a(.*?)>(http[s]{0,1}:\/\/.*?)<\/a>/gi,function(e,t,r,i){if(!r.match(/\.(jpg|jpeg|png|gif)$/i)||r.indexOf("/docs/pub/")>0||r.indexOf("logout=yes")>0){return e}else if(s.MessengerCommon.isMobile()){return(i>0?"<br />":"")+'<span class="bx-messenger-file-image"><span class="bx-messenger-file-image-src"><img src="'+r+'" class="bx-messenger-file-image-text" onclick="BXIM.messenger.openPhotoGallery(\''+r+'\');" onerror="BX.MessengerCommon.hideErrorImage(this)"></span></span><br>'}else{return(i>0?"<br />":"")+'<span class="bx-messenger-file-image"><a'+t+' target="_blank" class="bx-messenger-file-image-src"><img src="'+r+'" class="bx-messenger-file-image-text" onerror="BX.MessengerCommon.hideErrorImage(this)"></a></span><br>'}})}if(n){a=a.replace(new RegExp("("+n.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+")","ig"),'<span class="bx-messenger-highlight">$1</span>')}if(false){a=a.replace(/^(\s*<img\s+src=[^>]+?data-code=[^>]+?width=")(\d+)("[^>]+?height=")(\d+)("[^>]+?class="bx-smile"\s*\/?>\s*)$/,function h(e,s,t,r,i,n){return s+parseInt(t,10)*2+r+parseInt(i,10)*2+n})}if(true){a=a.replace(/\[USER=([0-9]{1,})\](.*?)\[\/USER\]/gi,function(e,s,t){var i="";s=parseInt(s);if(r&&t&&s>0&&typeof BXIM!="undefined")i='<span class="bx-messenger-ajax '+(s==BXIM.userId?"bx-messenger-ajax-self":"")+'" data-entity="user" data-userId="'+s+'">'+t+"</span>";else i=t;return i});a=a.replace(/\[PCH=([0-9]{1,})\](.*?)\[\/PCH\]/gi,function(e,s,t){var i="";s=parseInt(s);if(r&&t&&s>0)i='<span class="bx-messenger-ajax" data-entity="phoneCallHistory" data-historyId="'+s+'">'+t+"</span>";else i=t;return i})}if(a.substr(-6)=="<br />"){a=a.substr(0,a.length-6)}a=a.replace(/<br><br \/>/gi,"<br />");a=a.replace(/<br \/><br>/gi,"<br />");return a};s.MessengerCommon.prototype.prepareTextBack=function(e,t){var r=e;t=t===true;r=s.util.htmlspecialcharsback(r);r=r.replace(/<(\/*)([buis]+)>/gi,"[$1$2]");r=r.replace(/<img.*?data-code="([^"]*)".*?>/gi,"$1");r=r.replace(/<a.*?href="([^"]*)".*?>.*?<\/a>/gi,"$1");if(!t){r=r.replace(/------------------------------------------------------(.*?)------------------------------------------------------/gim,"["+s.message("IM_M_QUOTE_BLOCK")+"]")}r=r.split("&nbsp;&nbsp;&nbsp;&nbsp;").join("	");r=r.split("<br />").join("\n");return r};s.MessengerCommon.prototype.getUserParam=function(e,t){e=typeof e=="undefined"?this.BXIM.userId:e;t=typeof t=="boolean"?t:false;if(e.toString().substr(0,4)=="chat"){var r=e.toString().substr(4);if(t||!(this.BXIM.messenger.chat[r]&&this.BXIM.messenger.chat[r].id)){this.BXIM.messenger.chat[r]={id:r,name:s.message("IM_M_LOAD_USER"),owner:0,workPosition:"",avatar:this.BXIM.pathToBlankImage,style:"chat",fake:true};if(t){this.BXIM.messenger.chat[r].fake=false}}return this.BXIM.messenger.chat[r]}else{if(t||!(this.BXIM.messenger.users[e]&&this.BXIM.messenger.users[e].id)){this.BXIM.messenger.users[e]={id:e,avatar:this.BXIM.pathToBlankImage,name:s.message("IM_M_LOAD_USER"),profile:this.BXIM.path.profileTemplate.replace("#user_id#",e),status:"guest",workPosition:"",extranet:false,fake:true};this.BXIM.messenger.hrphoto[e]="/bitrix/js/im/images/hidef-avatar-v2.png";if(t){this.BXIM.messenger.users[e].fake=false}}return this.BXIM.messenger.users[e]}};s.MessengerCommon.prototype.getUserStatus=function(e,t){e=parseInt(e);e=isNaN(e)?this.BXIM.userId:e;t=t===true;var r="";var i="";if(typeof this.BXIM.messenger.users[e]=="undefined"){r="na";i=s.message("IM_STATUS_NA")}else if(this.BXIM.messenger.users[e].status=="offline"){r="offline";i=s.message("IM_STATUS_OFFLINE")}else if(this.BXIM.messenger.BXIM.userId==e){r=this.BXIM.messenger.users[e].status;i=s.message("IM_STATUS_"+r.toUpperCase())}else if(this.BXIM.messenger.users[e].idle>0){r="idle";i=s.message("IM_STATUS_AWAY_TITLE").replace("#TIME#",this.getUserIdle(e))}else if(this.BXIM.messenger.users[e].birthday&&(this.BXIM.messenger.users[e].status=="online"||this.BXIM.messenger.users[e].status=="offline")){r="birthday";if(this.BXIM.messenger.users[e].status=="offline"){i=s.message("IM_STATUS_OFFLINE")}else{i=s.message("IM_M_BIRTHDAY_MESSAGE_SHORT")}}else{r=this.BXIM.messenger.users[e].status;i=s.message("IM_STATUS_"+r.toUpperCase())}return t?i:r};s.MessengerCommon.prototype.getUserIdle=function(e){e=parseInt(e);e=isNaN(e)?this.BXIM.userId:e;var s="";if(this.BXIM.messenger.users[e].idle>0){var t=parseInt(this.BXIM.messenger.users[e].idle);s=this.formatDate(this.BXIM.messenger.users[e].idle,this.getNowDate()-t>=3600?"Hdiff":"idiff")}return s};s.MessengerCommon.prototype.getUserPosition=function(e){var t="";if(!this.BXIM.messenger.users[e])return"";if(this.BXIM.messenger.users[e].workPosition){t=this.BXIM.messenger.users[e].workPosition}else if(this.BXIM.messenger.users[e].extranet){t=s.message("IM_CL_USER_EXTRANET")}else if(this.BXIM.messenger.BXIM.bitrixIntranet){t=s.message("IM_CL_USER_B24")}else{t=s.message("IM_CL_USER")}return t};s.MessengerCommon.prototype.userListRedraw=function(e){if(this.isMobile()){if(!this.MobileActionEqual("RECENT")){return false}}else{if(this.BXIM.messenger.popupMessenger==null)return false}if(this.BXIM.messenger.recentList&&this.BXIM.messenger.contactListSearchText!=null&&this.BXIM.messenger.contactListSearchText.length==0)this.recentListRedraw(e);else this.contactListRedraw(e)};s.MessengerCommon.prototype.contactListRedraw=function(e){e=e||{};if(this.BXIM.messenger.contactListSearchText!=null&&this.BXIM.messenger.contactListSearchText.length==0)this.BXIM.messenger.recentListReturn=false;if(!this.isMobile()){this.BXIM.messenger.contactList=true;s.addClass(this.BXIM.messenger.contactListTab,"bx-messenger-cl-switcher-tab-active");this.BXIM.messenger.recentList=false;s.removeClass(this.BXIM.messenger.recentListTab,"bx-messenger-cl-switcher-tab-active");if(this.BXIM.messenger.popupPopupMenu!=null)this.BXIM.messenger.popupPopupMenu.close()}if(this.BXIM.messenger.contactListSearchText.length>0){this.contactListPrepareSearch("contactList",this.BXIM.messenger.popupContactListElementsWrap,this.BXIM.messenger.contactListSearchText,e.FORCE?{}:{params:false,timeout:this.isMobile()?500:100})}else{if(this.BXIM.messenger.redrawContactListTimeout["contactList"])clearTimeout(this.BXIM.messenger.redrawContactListTimeout["contactList"]);this.BXIM.messenger.popupContactListElementsWrap.innerHTML="";s.adjust(this.BXIM.messenger.popupContactListElementsWrap,{children:this.contactListPrepare()});if(this.isMobile()){BitrixMobile.LazyLoad.showImages()}}e.SEND=e.SEND==true;if(!this.isMobile()&&e.SEND){s.localStorage.set("mrd",{viewGroup:this.BXIM.settings.viewGroup,viewOffline:this.BXIM.settings.viewOffline},5)}};s.MessengerCommon.prototype.contactListPrepareSearch=function(e,t,r,i){if(i.params!=false){var n={groupOpen:true,viewOffline:false,viewGroup:true,viewChat:false,viewOfflineWithPhones:false,extra:false,searchText:r};for(var a in i){if(a=="timeout"||a=="params")continue;n[a]=i[a]}}var o=i.timeout?i.timeout:0;if(o>0){clearTimeout(this.BXIM.messenger.redrawContactListTimeout[e]);this.BXIM.messenger.redrawContactListTimeout[e]=setTimeout(s.delegate(function(){t.innerHTML="";s.adjust(t,{children:this.contactListPrepare(n)});if(this.isMobile()){BitrixMobile.LazyLoad.showImages()}},this),o)}else{t.innerHTML="";s.adjust(t,{children:this.contactListPrepare(n)});if(this.isMobile()){BitrixMobile.LazyLoad.showImages()}}};s.MessengerCommon.prototype.contactListPrepare=function(e){e=typeof e=="object"?e:{};var t=[];var r={};var i={};var n=[];var a={};var o=typeof e.searchText!="undefined"?e.searchText:this.BXIM.messenger.contactListSearchText;var m=!(o!=null&&o.length==0);var g=typeof e.extra!="undefined"?e.extra:true;var l=typeof e.groupOpen!="undefined"?e.groupOpen:"auto";var h=typeof e.viewGroup!="undefined"?e.viewGroup:m||!this.BXIM.settings?false:this.BXIM.settings.viewGroup;var I=typeof e.viewOffline!="undefined"?e.viewOffline:m||!this.BXIM.settings?true:this.BXIM.settings.viewOffline;var M=typeof e.viewChat!="undefined"?e.viewChat:true;var p=typeof e.viewOfflineWithPhones!="undefined"?e.viewOfflineWithPhones:false;if(this.isMobile()){BitrixMobile.LazyLoad.clearImages()}var d={};if(typeof e.exceptUsers!="undefined"){for(var u=0;u<e.exceptUsers.length;u++)d[e.exceptUsers[u]]=true}if(h){r=this.BXIM.messenger.groups;a=this.BXIM.messenger.userInGroup}else{r=this.BXIM.messenger.woGroups;a=this.BXIM.messenger.woUserInGroup}var f=0;for(var u in r)f++;if(f<=0&&!this.BXIM.messenger.contactListLoad){t.push(s.create("div",{props:{className:"bx-messenger-cl-item-load"},html:s.message("IM_CL_LOAD")}));this.contactListGetFromServer();return t}var c=[];var B=[];if(m){o=o+"";if(!this.isMobile()&&this.BXIM.language=="ru"&&s.correctText){var X=s.correctText(o);if(X!=o){B=X.split(" ")}}c=o.split(" ")}i[0]={id:0,name:s.message("IM_M_CL_UNREAD"),status:"open"};for(var u in this.BXIM.messenger.unreadMessage)n.push(u);a[0]={id:0,users:n};for(var u in r){if(u!="last"&&u!=0)i[u]=r[u]}if(M){var E=[];for(var u in this.BXIM.messenger.chat){if(!m&&this.BXIM.messenger.chat[u].style=="call")continue;E.push(u)}E.sort(function(e,s){u=this.BXIM.messenger.chat[e].name;ii=this.BXIM.messenger.chat[s].name;if(u<ii){return-1}else if(u>ii){return 1}else{return 0}});a["chat"]={id:"chat",users:E,isChat:true}}for(var u in i){var S=i[u];if(typeof S=="undefined"||!S.name||!s.type.isNotEmptyString(S.name))continue;var _=[];var b={};if(a[u]&&!a[u].isChat){for(var T=0;T<a[u].users.length;T++){var C=this.BXIM.messenger.users[a[u].users[T]];if(typeof C=="undefined"||this.BXIM.userId==C.id||typeof C.name=="undefined"||d[C.id]||b[u+"_"+C.id])continue;b[u+"_"+C.id]=true;if(m){var R=C.name.toLowerCase()+(C.workPosition?(" "+C.workPosition).toLowerCase():"");var v=false;for(var x=0;x<c.length;x++)if(R.indexOf(c[x].toLowerCase())<0)v=true;if(v){for(var x=0;x<B.length;x++){if(R.indexOf(B[x].toLowerCase())<0)v=true;else v=false}}if(v)continue}var A="";var y="";if(g&&this.BXIM.messenger.unreadMessage[C.id]&&this.BXIM.messenger.unreadMessage[C.id].length>0){A="bx-messenger-cl-status-new-message";y='<span class="bx-messenger-cl-count-digit">'+(this.BXIM.messenger.unreadMessage[C.id].length<100?this.BXIM.messenger.unreadMessage[C.id].length:"99+")+"</span>"}var L="";if(g&&this.countWriting(C.id))L="bx-messenger-cl-status-writing";var N=this.getUserStatus(C.id);if(p&&C.phoneDevice&&N=="offline"){N="online"}if(!m&&u!="last"&&I==false&&N=="offline"&&A=="")continue;if(this.isMobile()){var D="mobile-cl-avatar-id-"+C.id+"-g-"+u;var w='id="'+D+'" src="'+this.BXIM.pathToBlankImage+'" data-src="'+C.avatar+'"';BitrixMobile.LazyLoad.registerImage(D)}else{var w='_src="'+C.avatar+'" src="'+this.BXIM.pathToBlankImage+'"';if(m||S.status=="open"&&l=="auto"||l==true)w='src="'+C.avatar+'" _src="'+this.BXIM.pathToBlankImage+'"'}_.push(s.create("a",{props:{className:"bx-messenger-cl-item bx-messenger-cl-id-"+C.id+" bx-messenger-cl-status-"+N+" "+A+" "+L},attrs:{href:"#user"+C.id,"data-userId":C.id,"data-name":C.name,"data-status":N,"data-avatar":C.avatar},html:'<span class="bx-messenger-cl-count">'+y+"</span>"+'<span class="bx-messenger-cl-avatar"><img class="bx-messenger-cl-avatar-img'+(this.isBlankAvatar(C.avatar)?" bx-messenger-cl-avatar-img-default":"")+'" '+w+'><span class="bx-messenger-cl-status"></span></span>'+'<span class="bx-messenger-cl-user">'+'<div class="bx-messenger-cl-user-title'+(C.extranet?" bx-messenger-user-extranet":"")+'">'+(C.nameList?C.nameList:C.name)+"</div>"+'<div class="bx-messenger-cl-user-desc">'+this.getUserPosition(C.id)+"</div>"+"</span>"}))}if(_.length>0){t.push(s.create("div",{attrs:{"data-groupId-wrap":S.id},props:{className:"bx-messenger-cl-group"+(m||S.status=="open"&&l=="auto"||l==true?" bx-messenger-cl-group-open":"")},children:[s.create("div",{props:{className:"bx-messenger-cl-group-title"},attrs:{"data-groupId":S.id,title:S.name},html:S.name}),s.create("span",{props:{className:"bx-messenger-cl-group-wrapper"},children:_})]}))}}else if(a[u]&&a[u].isChat){for(var T=0;T<a[u].users.length;T++){var O=this.BXIM.messenger.chat[a[u].users[T]];if(typeof O=="undefined"||typeof O.name=="undefined"||b[u+"_chat"+O.id])continue;b[u+"_chat"+O.id]=true;if(m){var v=false;for(var x=0;x<c.length;x++)if(O.name.toLowerCase().indexOf(c[x].toLowerCase())<0)v=true;if(v){for(var x=0;x<B.length;x++){if(O.name.toLowerCase().indexOf(B[x].toLowerCase())<0)v=true;else v=false}}if(v)continue}var L="";if(g&&this.countWriting("chat"+O.id))L="bx-messenger-cl-status-writing";var A="";var y="";if(g&&this.BXIM.messenger.unreadMessage["chat"+O.id]&&this.BXIM.messenger.unreadMessage["chat"+O.id].length>0){A="bx-messenger-cl-status-new-message";y='<span class="bx-messenger-cl-count-digit">'+(this.BXIM.messenger.unreadMessage["chat"+O.id].length<100?this.BXIM.messenger.unreadMessage["chat"+O.id].length:"99+")+"</span>"}if(this.isMobile()){var D="mobile-cl-avatar-id-chat-"+O.id+"-g-"+u;var w='id="'+D+'" src="'+this.BXIM.pathToBlankImage+'" data-src="'+O.avatar+'"';BitrixMobile.LazyLoad.registerImage(D)}else{var w='_src="'+O.avatar+'" src="'+this.BXIM.pathToBlankImage+'"';if(m||S.status=="open"&&l=="auto"||l==true)w='src="'+O.avatar+'" _src="'+this.BXIM.pathToBlankImage+'"'}_.push(s.create("span",{props:{className:"bx-messenger-cl-item bx-messenger-cl-id-chat"+O.id+" bx-messenger-cl-status-online "+A+" "+L},attrs:{"data-userId":"chat"+O.id,"data-userIsChat":"Y","data-name":O.name,"data-status":"online","data-avatar":O.avatar},html:'<span class="bx-messenger-cl-count">'+y+"</span>"+'<span class="bx-messenger-cl-avatar bx-messenger-cl-avatar-'+O.style+'"><img class="bx-messenger-cl-avatar-img'+(this.isBlankAvatar(O.avatar)?" bx-messenger-cl-avatar-img-default":"")+'" '+w+'><span class="bx-messenger-cl-status"></span></span>'+'<span class="bx-messenger-cl-user">'+'<div class="bx-messenger-cl-user-title">'+O.name+"</div>"+'<div class="bx-messenger-cl-user-desc">'+(O.style=="call"?s.message("IM_CL_PHONE"):s.message("IM_CL_CHAT"))+"</div>"+"</span>"}))}if(_.length>0){t.push(s.create("div",{attrs:{"data-groupId-wrap":S.id},props:{className:"bx-messenger-cl-group"+(m||S.status=="open"&&l=="auto"||l==true?" bx-messenger-cl-group-open":"")},children:[s.create("div",{props:{className:"bx-messenger-cl-group-title"},attrs:{"data-groupId":S.id,title:S.name},html:S.name}),s.create("span",{props:{className:"bx-messenger-cl-group-wrapper"},children:_})]}))}}}if(this.BXIM.bitrixIntranet&&m){var U={};for(var u in this.BXIM.messenger.groups){var G=true;for(var x=0;x<c.length;x++)if(this.BXIM.messenger.groups[u].name&&this.BXIM.messenger.groups[u].name.toLowerCase().indexOf(c[x].toLowerCase())>=0)G=false;if(G){for(var x=0;x<B.length;x++){if(this.BXIM.messenger.groups[u].name&&this.BXIM.messenger.groups[u].name.toLowerCase().indexOf(B[x].toLowerCase())>=0)G=false}}if(!G){U[u]={id:u,name:this.BXIM.messenger.groups[u].name,status:"close"}}}for(var u in U){var S=U[u];if(typeof S=="undefined"||!S.name||!s.type.isNotEmptyString(S.name))continue;var b={};var _=[];if(this.BXIM.messenger.userInGroup[u]&&!this.BXIM.messenger.userInGroup[u].isChat){for(var T=0;T<this.BXIM.messenger.userInGroup[u].users.length;T++){var C=this.BXIM.messenger.users[this.BXIM.messenger.userInGroup[u].users[T]];if(typeof C=="undefined"||this.BXIM.userId==C.id||typeof C.name=="undefined"||d[C.id]||b[u+"_"+C.id])continue;b[u+"_"+C.id]=true;var A="";var y="";if(g&&this.BXIM.messenger.unreadMessage[C.id]&&this.BXIM.messenger.unreadMessage[C.id].length>0){A="bx-messenger-cl-status-new-message";y='<span class="bx-messenger-cl-count-digit">'+(this.BXIM.messenger.unreadMessage[C.id].length<100?this.BXIM.messenger.unreadMessage[C.id].length:"99+")+"</span>"}var L="";if(g&&this.countWriting(C.id))L="bx-messenger-cl-status-writing";var N=this.getUserStatus(C.id);if(p&&C.phoneDevice&&N=="offline"){N="online"}if(u!="last"&&I==false&&N=="offline"&&A=="")continue;if(this.isMobile()){var D="mobile-cl-avatar-id-"+C.id+"-g-"+u;var w='id="'+D+'" src="'+this.BXIM.pathToBlankImage+'" data-src="'+C.avatar+'"';BitrixMobile.LazyLoad.registerImage(D)}else{var w='_src="'+C.avatar+'" src="'+this.BXIM.pathToBlankImage+'"';if(m||S.status=="open"&&l=="auto"||l==true)w='src="'+C.avatar+'" _src="'+this.BXIM.pathToBlankImage+'"'}_.push(s.create("span",{props:{className:"bx-messenger-cl-item bx-messenger-cl-id-"+C.id+" bx-messenger-cl-status-"+N+" "+A+" "+L},attrs:{"data-userId":C.id,"data-name":C.name,"data-status":N,"data-avatar":C.avatar},html:'<span class="bx-messenger-cl-count">'+y+"</span>"+'<span class="bx-messenger-cl-avatar"><img class="bx-messenger-cl-avatar-img'+(this.isBlankAvatar(C.avatar)?" bx-messenger-cl-avatar-img-default":"")+'" '+w+'><span class="bx-messenger-cl-status"></span></span>'+'<span class="bx-messenger-cl-user">'+'<div class="bx-messenger-cl-user-title'+(C.extranet?" bx-messenger-user-extranet":"")+'">'+(C.nameList?C.nameList:C.name)+"</div>"+'<div class="bx-messenger-cl-user-desc">'+this.getUserPosition(C.id)+"</div>"+"</span>"}))}if(_.length>0){t.push(s.create("div",{attrs:{"data-groupId-wrap":S.id},props:{className:"bx-messenger-cl-group"+(l==true?" bx-messenger-cl-group-open":"")},children:[s.create("div",{props:{className:"bx-messenger-cl-group-title"},attrs:{"data-groupId":S.id,title:S.name},html:S.name}),s.create("span",{props:{className:"bx-messenger-cl-group-wrapper"},children:_})]}))}}}}if(t.length<=0){t.push(s.create("div",{props:{className:"bx-messenger-cl-item-empty"},html:s.message("IM_M_CL_EMPTY")}))}return t};s.MessengerCommon.prototype.contactListClickItem=function(e){this.BXIM.messenger.closeMenuPopup();if(this.BXIM.messenger.popupContactListSearchInput.value!=""){this.BXIM.messenger.popupContactListSearchInput.value="";this.BXIM.messenger.contactListSearchText="";s.localStorage.set("mns",this.BXIM.messenger.contactListSearchText,5);if(this.BXIM.messenger.recentListReturn){this.BXIM.messenger.recentList=true;this.BXIM.messenger.contactList=false}this.userListRedraw()}if(this.isMobile()){this.BXIM.messenger.openMessenger(s.proxy_context.getAttribute("data-userId"),s.proxy_context)}else{this.BXIM.messenger.openMessenger(s.proxy_context.getAttribute("data-userId"))}return s.PreventDefault(e)};s.MessengerCommon.prototype.contactListToggleGroup=function(){var e="";var t=s.findNextSibling(s.proxy_context,{className:"bx-messenger-cl-group-wrapper"});if(t.childNodes.length>0){var r=s.findChildrenByClassName(t,"bx-messenger-cl-avatar-img");if(s.hasClass(s.proxy_context.parentNode,"bx-messenger-cl-group-open")){e="close";s.removeClass(s.proxy_context.parentNode,"bx-messenger-cl-group-open");if(!this.isMobile()&&r){for(var i=0;i<r.length;i++){r[i].setAttribute("_src",r[i].src);r[i].src=this.BXIM.pathToBlankImage}}}else{e="open";s.addClass(s.proxy_context.parentNode,"bx-messenger-cl-group-open");if(!this.isMobile()&&r){for(var i=0;i<r.length;i++){r[i].src=r[i].getAttribute("_src");r[i].setAttribute("_src",this.BXIM.pathToBlankImage)}}}}else{if(s.hasClass(s.proxy_context.parentNode,"bx-messenger-cl-group-open")){e="close";s.removeClass(s.proxy_context.parentNode,"bx-messenger-cl-group-open")}else{e="open";s.addClass(s.proxy_context.parentNode,"bx-messenger-cl-group-open")}}var n=s.proxy_context.getAttribute("data-groupId");var a=this.BXIM.messenger.contactListSearchText!=null&&this.BXIM.messenger.contactListSearchText.length>0?false:this.BXIM.messenger.BXIM.settings.viewGroup;if(a)this.BXIM.messenger.groups[n].status=e;else if(this.BXIM.messenger.woGroups[n])this.BXIM.messenger.woGroups[n].status=e;s.userOptions.save("IM","groupStatus",n,e);s.localStorage.set("mgp",{id:n,status:e},5)};s.MessengerCommon.prototype.contactListGetFromServer=function(){if(this.BXIM.messenger.contactListLoad)return false;this.BXIM.messenger.contactListLoad=true;s.ajax({url:this.BXIM.pathToAjax+"?CONTACT_LIST&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_CONTACT_LIST:"Y",IM_AJAX_CALL:"Y",DESKTOP:!this.isMobile()&&this.BXIM.desktop&&this.BXIM.desktop.ready()?"Y":"N",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){if(t&&t.BITRIX_SESSID){s.message({bitrix_sessid:t.BITRIX_SESSID})}if(t.ERROR==""){for(var r in t.USERS)this.BXIM.messenger.users[r]=t.USERS[r];for(var r in t.GROUPS)this.BXIM.messenger.groups[r]=t.GROUPS[r];for(var r in t.CHATS){if(this.BXIM.messenger.chat[r]&&this.BXIM.messenger.chat[r].fake)t.CHATS[r].fake=true;else if(!this.BXIM.messenger.chat[r])t.CHATS[r].fake=true;this.BXIM.messenger.chat[r]=t.CHATS[r]}for(var r in t.USER_IN_GROUP){if(typeof this.BXIM.messenger.userInGroup[r]=="undefined"){this.BXIM.messenger.userInGroup[r]=t.USER_IN_GROUP[r]}else{for(var i=0;i<t.USER_IN_GROUP[r].users.length;i++)this.BXIM.messenger.userInGroup[r].users.push(t.USER_IN_GROUP[r].users[i]);this.BXIM.messenger.userInGroup[r].users=s.util.array_unique(this.BXIM.messenger.userInGroup[r].users)}}for(var r in t.WO_GROUPS)this.BXIM.messenger.woGroups[r]=t.WO_GROUPS[r];for(var r in t.WO_USER_IN_GROUP){if(typeof this.BXIM.messenger.woUserInGroup[r]=="undefined"){this.BXIM.messenger.woUserInGroup[r]=t.WO_USER_IN_GROUP[r]}else{for(var i=0;i<t.WO_USER_IN_GROUP[r].users.length;i++)this.BXIM.messenger.woUserInGroup[r].users.push(t.WO_USER_IN_GROUP[r].users[i]);this.BXIM.messenger.woUserInGroup[r].users=s.util.array_unique(this.BXIM.messenger.woUserInGroup[r].users)}}this.userListRedraw();if(!this.isMobile()){this.BXIM.messenger.dialogStatusRedraw();if(this.BXIM.messenger.popupChatDialogContactListElements!=null){this.contactListPrepareSearch("popupChatDialogContactListElements",this.BXIM.messenger.popupChatDialogContactListElements,this.BXIM.messenger.popupChatDialogContactListSearch.value,{viewOffline:true,viewChat:false})}if(this.BXIM.webrtc.popupTransferDialogContactListElements!=null){this.contactListPrepareSearch("popupTransferDialogContactListElements",this.BXIM.webrtc.popupTransferDialogContactListElements,this.BXIM.webrtc.popupTransferDialogContactListSearch.value,{viewChat:false})}}}else{this.BXIM.messenger.contactListLoad=false;if(t.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate(this.contactListGetFromServer,this),2e3);s.onCustomEvent(e,"onImError",[t.ERROR,t.BITRIX_SESSID])}else if(t.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;if(this.BXIM.desktop&&this.BXIM.desktop.ready()){setTimeout(s.delegate(this.contactListGetFromServer,this),1e4)}s.onCustomEvent(e,"onImError",[t.ERROR])}}},this),onfailure:s.delegate(function(){this.BXIM.messenger.sendAjaxTry=0;this.BXIM.messenger.contactListLoad=false},this)})};s.MessengerCommon.prototype.contactListSearchClear=function(e){this.BXIM.messenger.popupContactListSearchInput.value="";this.BXIM.messenger.contactListSearchText=s.util.trim(this.BXIM.messenger.popupContactListSearchInput.value);s.localStorage.set("mns",this.BXIM.messenger.contactListSearchText,5);if(this.isMobile()){s.removeClass(this.BXIM.messenger.popupContactListSearchInput.parentNode,"bx-messenger-input-wrap-active")}if(this.BXIM.messenger.recentListReturn){this.BXIM.messenger.recentList=true;this.BXIM.messenger.contactList=false}this.userListRedraw();return s.PreventDefault(e)};s.MessengerCommon.prototype.contactListSearch=function(e){if(e.keyCode==16||e.keyCode==18||e.keyCode==20||e.keyCode==244||e.keyCode==91)return false;this.BXIM.messenger.recentList=false;this.BXIM.messenger.contactList=true;if(this.isMobile()){if(!app.enableInVersion(10)){setTimeout(function(){document.body.scrollTop=0},100)}}else{if(e.keyCode==27){if(this.BXIM.messenger.contactListSearchText<=0){this.BXIM.messenger.popupContactListSearchInput.value="";if(!this.isMobile()&&this.BXIM.messenger.popupMessenger&&!this.BXIM.messenger.desktop.ready()&&!this.BXIM.messenger.webrtc.callInit){this.BXIM.messenger.popupMessenger.destroy()}}else{this.BXIM.messenger.popupContactListSearchInput.value="";this.BXIM.messenger.popupMessengerTextarea.focus()}}if(e.keyCode==13){this.BXIM.messenger.popupContactListSearchInput.value="";var t=s.findChildByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-cl-item");if(t){this.BXIM.messenger.BXIM.openMessenger(t.getAttribute("data-userid"))}}}this.BXIM.messenger.contactListSearchText=s.util.trim(this.BXIM.messenger.popupContactListSearchInput.value);if(!this.isMobile()){s.localStorage.set("mns",this.BXIM.messenger.contactListSearchText,5)}if(this.BXIM.messenger.contactListSearchText==""){if(this.BXIM.messenger.recentListReturn){this.BXIM.messenger.recentList=true;this.BXIM.messenger.contactList=false}if(this.isMobile()){s.removeClass(this.BXIM.messenger.popupContactListSearchInput.parentNode,"bx-messenger-input-wrap-active")}}else{if(this.isMobile()){s.addClass(this.BXIM.messenger.popupContactListSearchInput.parentNode,"bx-messenger-input-wrap-active")}if(this.BXIM.messenger.realSearch){clearTimeout(this.BXIM.messenger.contactListSearchTimeout);this.BXIM.messenger.contactListSearchTimeout=setTimeout(s.delegate(function(){if(this.BXIM.messenger.contactListSearchText.length<=3)return false;s.ajax({url:this.BXIM.pathToAjax+"?CONTACT_LIST_SEARCH&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_CONTACT_LIST_SEARCH:"Y",SEARCH:this.BXIM.messenger.contactListSearchText,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(e){if(!this.BXIM.messenger.userInGroup["other"])this.BXIM.messenger.userInGroup["other"]={id:"other",users:[]};if(!this.BXIM.messenger.woUserInGroup["other"])this.BXIM.messenger.woUserInGroup["other"]={id:"other",users:[]};var t=s.clone(this.BXIM.messenger.userInGroup["other"]["users"]);var r=s.clone(this.BXIM.messenger.woUserInGroup["other"]["users"]);for(var i in e.USERS){this.BXIM.messenger.users[i]=e.USERS[i];this.BXIM.messenger.userInGroup["other"]["users"].push(i);this.BXIM.messenger.woUserInGroup["other"]["users"].push(i)}if(this.BXIM.messenger.contactList)this.contactListRedraw({FORCE:true});this.BXIM.messenger.userInGroup["other"]["users"]=t;this.BXIM.messenger.woUserInGroup["other"]["users"]=r},this),onfailure:function(e){}})},this),1e3)}}this.userListRedraw()};s.MessengerCommon.prototype.recentListRedraw=function(e){clearTimeout(this.BXIM.messenger.redrawRecentListTimeout);if(this.MobileActionNotEqual("RECENT"))return false;if(!this.isMobile()){
if(this.BXIM.messenger.popupMessenger==null)return false;this.BXIM.messenger.recentList=true;s.addClass(this.BXIM.messenger.recentListTab,"bx-messenger-cl-switcher-tab-active");this.BXIM.messenger.contactList=false;s.removeClass(this.BXIM.messenger.contactListTab,"bx-messenger-cl-switcher-tab-active")}if(this.BXIM.messenger.contactListSearchText!=null&&this.BXIM.messenger.contactListSearchText.length==0){this.BXIM.messenger.recentListReturn=true}else{this.BXIM.messenger.contactListSearchText="";this.BXIM.messenger.popupContactListSearchInput.value=""}if(this.BXIM.messenger.redrawContactListTimeout["contactList"])clearTimeout(this.BXIM.messenger.redrawContactListTimeout["contactList"]);if(!this.isMobile()&&this.BXIM.messenger.popupPopupMenu!=null)this.BXIM.messenger.popupPopupMenu.close();this.BXIM.messenger.popupContactListElementsWrap.innerHTML="";s.adjust(this.BXIM.messenger.popupContactListElementsWrap,{children:this.recentListPrepare(e)});if(this.isMobile()){BitrixMobile.LazyLoad.showImages()}};s.MessengerCommon.prototype.recentListPrepare=function(e){var t=[];var r={};e=typeof e=="object"?e:{};var i=e.showOnlyChat;if(!this.BXIM.messenger.recentListLoad){t.push(s.create("div",{props:{className:"bx-messenger-cl-item-load"},html:s.message("IM_CL_LOAD")}));this.recentListGetFromServer();return t}if(this.isMobile()){BitrixMobile.LazyLoad.clearImages()}this.BXIM.messenger.recent.sort(function(e,s){var t=parseInt(e.date);var r=parseInt(s.date);if(t>r){return-1}else if(t<r){return 1}else{if(e>s){return-1}else if(e<s){return 1}else{return 0}}});this.BXIM.messenger.recentListIndex=[];for(var n=0;n<this.BXIM.messenger.recent.length;n++){if(typeof this.BXIM.messenger.recent[n].userIsChat=="undefined")this.BXIM.messenger.recent[n].userIsChat=this.BXIM.messenger.recent[n].recipientId.toString().substr(0,4)=="chat";var a=s.clone(this.BXIM.messenger.recent[n]);var o="";if(a.userIsChat){g=this.BXIM.messenger.chat[a.userId.toString().substr(4)];if(typeof g=="undefined"||typeof g.name=="undefined")continue;var m="chat"+g.id}else if(!i){var g=this.BXIM.messenger.users[a.userId];if(typeof g=="undefined"||this.BXIM.userId==g.id||typeof g.name=="undefined")continue;var m=g.id}else{continue}if(parseInt(a.date)>0){a.date=this.formatDate(a.date,this.getDateFormatType("RECENT_TITLE"));if(!r[a.date]){r[a.date]=true;t.push(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title"+(this.BXIM.language=="ru"?" bx-messenger-lowercase":"")},html:a.date})]}))}}else{if(!r["never"]){r["never"]=true;t.push(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title"},html:s.message("IM_RESENT_NEVER")})]}))}}if(this.BXIM.messenger.message[a.id]&&this.BXIM.messenger.message[a.id].text){a.text=this.BXIM.messenger.message[a.id].text}if(!a.text&&a.params&&a.params["FILE_ID"].length>0){a.text="["+s.message("IM_F_FILE")+"]"}var l="";var h="";if(this.BXIM.messenger.unreadMessage[m]&&this.BXIM.messenger.unreadMessage[m].length>0){l="bx-messenger-cl-status-new-message";h='<span class="bx-messenger-cl-count-digit">'+(this.BXIM.messenger.unreadMessage[m].length<100?this.BXIM.messenger.unreadMessage[m].length:"99+")+"</span>"}var I="";var M="";if(this.countWriting(m))I="bx-messenger-cl-status-writing";if(a.senderId==this.BXIM.userId)M='<span class="bx-messenger-cl-user-reply"></span>';if(!g.avatar)g.avatar=this.BXIM.pathToBlankImage;a.text=this.prepareText(a.text);a.text=a.text.replace(/<img.*?data-code="([^"]*)".*?>/gi,"$1");a.text=a.text.replace(/<s>([^"]*)<\/s>/gi,"");a.text=a.text.replace("<br />"," ").replace(/<\/?[^>]+>/gi,"").replace(/------------------------------------------------------(.*?)------------------------------------------------------/gim," ["+s.message("IM_M_QUOTE_BLOCK")+"] ");var p="";var d=g.avatar;var u="";if(this.isMobile()){if(this.BXIM.messenger.currentTab==m){u="bx-messenger-cl-item-active "}var f="mobile-rc-avatar-id-"+g.id;p='id="'+f+'" data-src="'+g.avatar+'"';d=this.BXIM.pathToBlankImage;BitrixMobile.LazyLoad.registerImage(f)}t.push(s.create("span",{props:{className:"bx-messenger-cl-item  bx-messenger-cl-id-"+(a.userIsChat?"chat":"")+g.id+" "+u+(a.userIsChat?"bx-messenger-cl-item-chat "+l+" "+I+" "+o:"bx-messenger-cl-status-"+this.getUserStatus(g.id)+" "+l+" "+I)},attrs:{"data-userId":m,"data-name":g.name,"data-status":this.getUserStatus(g.id),"data-avatar":g.avatar,"data-userIsChat":a.userIsChat},html:'<span class="bx-messenger-cl-count">'+h+"</span>"+'<span class="bx-messenger-cl-avatar '+(a.userIsChat?"bx-messenger-cl-avatar-"+g.style:"")+'"><img class="bx-messenger-cl-avatar-img'+(this.isBlankAvatar(g.avatar)?" bx-messenger-cl-avatar-img-default":"")+'" src="'+d+'" '+p+'><span class="bx-messenger-cl-status"></span></span>'+'<span class="bx-messenger-cl-user">'+'<div class="bx-messenger-cl-user-title'+(g.extranet?" bx-messenger-user-extranet":"")+'">'+(g.nameList?g.nameList:g.name)+"</div>"+'<div class="bx-messenger-cl-user-desc">'+M+""+a.text+"</div>"+"</span>"}));this.BXIM.messenger.recentListIndex.push(m)}if(t.length<=0){t.push(s.create("div",{props:{className:"bx-messenger-cl-item-empty"},html:s.message("IM_M_CL_EMPTY")}))}return t};s.MessengerCommon.prototype.recentListAdd=function(e){if(!e.skipDateCheck){for(var t=0;t<this.BXIM.messenger.recent.length;t++){if(this.BXIM.messenger.recent[t].userId==e.userId&&parseInt(this.BXIM.messenger.recent[t].date)>parseInt(e.date))return false}}var r=[];r.push(e);for(var t=0;t<this.BXIM.messenger.recent.length;t++)if(this.BXIM.messenger.recent[t].userId!=e.userId)r.push(this.BXIM.messenger.recent[t]);this.BXIM.messenger.recent=r;if(this.BXIM.messenger.recentList){if(this.isMobile()){clearTimeout(this.BXIM.messenger.redrawRecentListTimeout);this.BXIM.messenger.redrawRecentListTimeout=setTimeout(s.delegate(function(){this.recentListRedraw()},this),300)}else{this.recentListRedraw()}}};s.MessengerCommon.prototype.recentListHide=function(e,t){var r=[];for(var i=0;i<this.BXIM.messenger.recent.length;i++)if(this.BXIM.messenger.recent[i].userId!=e)r.push(this.BXIM.messenger.recent[i]);this.BXIM.messenger.recent=r;if(this.BXIM.messenger.recentList)this.recentListRedraw();if(!this.isMobile())s.localStorage.set("mrlr",e,5);t=t!=false;if(t){s.ajax({url:this.BXIM.pathToAjax+"?RECENT_HIDE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{IM_RECENT_HIDE:"Y",USER_ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()}});this.readMessage(e,true,true)}};s.MessengerCommon.prototype.recentListGetFromServer=function(){if(this.BXIM.messenger.recentListLoad)return false;this.BXIM.messenger.recentListLoad=true;s.ajax({url:this.BXIM.pathToAjax+"?RECENT_LIST&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_RECENT_LIST:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){if(t&&t.BITRIX_SESSID){s.message({bitrix_sessid:t.BITRIX_SESSID})}if(t.ERROR==""){this.BXIM.messenger.recent=[];for(var r in t.RECENT){t.RECENT[r].date=parseInt(t.RECENT[r].date)-parseInt(s.message("USER_TZ_OFFSET"));this.BXIM.messenger.recent.push(t.RECENT[r])}var i=false;for(var r in this.BXIM.messenger.unreadMessage){for(var n=0;n<this.BXIM.messenger.unreadMessage[r].length;n++){if(!i||i.SEND_DATE<=this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][n]].date){i={ID:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][n]].id,SEND_DATE:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][n]].date,RECIPIENT_ID:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][n]].recipientId,SENDER_ID:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][n]].senderId,USER_ID:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][n]].senderId,SEND_MESSAGE:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][n]].text,PARAMS:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[r][n]].params}}}}if(i){this.recentListAdd({userId:i.RECIPIENT_ID.toString().substr(0,4)=="chat"?i.RECIPIENT_ID:i.USER_ID,id:i.ID,date:i.SEND_DATE,recipientId:i.RECIPIENT_ID,senderId:i.SENDER_ID,text:i.SEND_MESSAGE,params:i.PARAMS},true)}for(var r in t.CHAT){if(this.BXIM.messenger.chat[r]&&this.BXIM.messenger.chat[r].fake)t.CHAT[r].fake=true;else if(!this.BXIM.messenger.chat[r])t.CHAT[r].fake=true;this.BXIM.messenger.chat[r]=t.CHAT[r]}for(var r in t.USERS)this.BXIM.messenger.users[r]=t.USERS[r];if(this.BXIM.messenger.recentList)this.recentListRedraw();this.BXIM.messenger.smile=t.SMILE;this.BXIM.messenger.smileSet=t.SMILE_SET;this.BXIM.settingsNotifyBlocked=t.NOTIFY_BLOCKED;if(!this.isMobile())this.BXIM.messenger.dialogStatusRedraw()}else{this.BXIM.messenger.recentListLoad=false;if(t.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate(this.recentListGetFromServer,this),2e3);s.onCustomEvent(e,"onImError",[t.ERROR,t.BITRIX_SESSID])}else if(t.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;if(this.BXIM.desktop&&this.BXIM.desktop.ready()){setTimeout(s.delegate(this.recentListGetFromServer,this),1e4)}s.onCustomEvent(e,"onImError",[t.ERROR])}}},this),onfailure:s.delegate(function(){this.BXIM.messenger.sendAjaxTry=0;this.BXIM.messenger.recentListLoad=false},this)})};s.MessengerCommon.prototype.drawMessage=function(e,t,r,i){if(this.BXIM.messenger.popupMessenger==null||e!=this.BXIM.messenger.currentTab||typeof t!="object"||e==0||!this.MobileActionEqual("DIALOG"))return false;i=i==true;r=i?false:r;if(t.senderId==this.BXIM.userId&&this.BXIM.messenger.popupMessengerLastMessage<t.id){this.BXIM.messenger.popupMessengerLastMessage=t.id}if(typeof t.params!="object"){t.params={}}this.BXIM.messenger.openChatFlag=this.BXIM.messenger.currentTab.toString().substr(0,4)=="chat"?true:false;var n=t.params&&t.params.IS_EDITED=="Y";var a=t.params&&t.params.IS_DELETED=="Y";var o=t.id.indexOf("temp")==0;var m=o&&t.retry;var g=t.senderId==0;var l=this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)]&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].style=="group";var h=this.BXIM.ppServerStatus;if(this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)]&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].style=="call")h=false;var I=h&&typeof t.params.LIKE=="object"&&t.params.LIKE.length>0?t.params.LIKE.length:"";var M=h&&typeof t.params.LIKE=="object"&&s.util.in_array(this.BXIM.userId,t.params.LIKE);var p=s.MessengerCommon.diskDrawFiles(t.chatId,t.params.FILE_ID);if(p.length>0){p=s.create("div",{props:{className:"bx-messenger-file-box"+(t.text!=""?" bx-messenger-file-box-with-message":"")},children:p})}else{p=null}var d=false;if(!p&&t.text.length<=0){d=true;c=true}if(t.system&&t.system=="Y"){g=true;t.senderId=0}var u=this.BXIM.messenger.users[t.senderId];if(!g&&typeof u=="undefined"){d=true;c=true}if(!this.BXIM.messenger.history[e])this.BXIM.messenger.history[e]=[];if(parseInt(t.id)>0)this.BXIM.messenger.history[e].push(t.id);if(!d){var f=0;var c=false;var B=false;if(this.BXIM.messenger.unreadMessage[e]&&s.util.in_array(t.id,this.BXIM.messenger.unreadMessage[e]))B=true}var X=false;var E=null;if(i){E=this.BXIM.messenger.popupMessengerBodyWrap.firstChild;if(E){if(s.hasClass(E,"bx-messenger-content-empty")||s.hasClass(E,"bx-messenger-content-load")){s.remove(E)}else if(s.hasClass(E,"bx-messenger-content-group")){E=E.nextSibling}}}else{E=this.BXIM.messenger.popupMessengerBodyWrap.lastChild;if(E&&(s.hasClass(E,"bx-messenger-content-empty")||s.hasClass(E,"bx-messenger-content-load"))){s.remove(E)}else if(E&&s.hasClass(E,"bx-messenger-content-item-notify")){if(t.senderId==this.BXIM.messenger.currentTab||!this.countWriting(this.BXIM.messenger.currentTab)){s.remove(E);X=false;E=this.BXIM.messenger.popupMessengerBodyWrap.lastChild}else{X=true;E=this.BXIM.messenger.popupMessengerBodyWrap.lastChild.previousSibling}}}if(!d){var S=this.formatDate(t.date,this.getDateFormatType("MESSAGE_TITLE"));if(!s("bx-im-go-"+S)){var _=[];if(this.BXIM.desktop&&this.BXIM.desktop.run()){_=[s.create("a",{attrs:{name:"bx-im-go-"+t.date},props:{className:"bx-messenger-content-group-link"}}),s.create("a",{attrs:{id:"bx-im-go-"+S,href:"#bx-im-go-"+t.date},props:{className:"bx-messenger-content-group-title"+(this.BXIM.language=="ru"?" bx-messenger-lowercase":"")},html:S})]}else{_=[s.create("a",{attrs:{name:"bx-im-go-"+t.date},props:{className:"bx-messenger-content-group-link"}}),s.create("div",{attrs:{id:"bx-im-go-"+S},props:{className:"bx-messenger-content-group-title"+(this.BXIM.language=="ru"?" bx-messenger-lowercase":"")},html:S})]}var b=s.create("div",{props:{className:"bx-messenger-content-group"+(S==s.message("FD_TODAY")?" bx-messenger-content-group-today":"")},children:_});if(i){this.BXIM.messenger.popupMessengerBodyWrap.insertBefore(b,this.BXIM.messenger.popupMessengerBodyWrap.firstChild);E=b.nextSibling}else{if(X&&E.nextElementSibling){this.BXIM.messenger.popupMessengerBodyWrap.insertBefore(b,E.nextElementSibling);E=b}else{this.BXIM.messenger.popupMessengerBodyWrap.appendChild(b)}}}if(!g&&E){if(t.senderId==E.getAttribute("data-senderId")&&parseInt(t.date)-300<parseInt(E.getAttribute("data-messageDate"))){var T=s.findChildByClassName(E,"bx-messenger-content-item-text-message");var C=[s.create("div",{props:{className:"bx-messenger-hr"}}),s.create("span",{props:{className:"bx-messenger-content-item-text-wrap"+(i?" bx-messenger-content-item-text-wrap-append":"")},children:[s.create("span",{attrs:{title:s.message("IM_M_OPEN_EXTRA_TITLE").replace("#SHORTCUT#",s.browser.IsMac()?"CMD":"CTRL")},props:{className:"bx-messenger-content-item-menu"}}),s.create("span",{props:{className:"bx-messenger-message"+(a?" bx-messenger-message-deleted":" ")+(a||n?" bx-messenger-message-edited":"")},attrs:{id:"im-message-"+t.id},html:s.MessengerCommon.prepareText(t.text,false,true,true,!this.BXIM.messenger.openChatFlag||t.senderId==this.BXIM.userId?false:this.BXIM.messenger.users[this.BXIM.userId].name)}),p]})];if(i){for(var R=0,v=C.length;R<v;R++){T.insertBefore(C[R],T.firstChild)}E.setAttribute("data-blockmessageid",t.id)}else{for(var R=0,v=C.length;R<v;R++){T.appendChild(C[R])}var x=s.findChildByClassName(E,"bx-messenger-content-item-date");x.innerHTML=o?s.message("IM_M_DELIVERED"):" &nbsp; "+this.formatDate(t.date,this.getDateFormatType("MESSAGE"));if(m){this.drawProgessMessage(t.id,{title:s.message("IM_M_RETRY")})}else if(o){this.drawProgessMessage(t.id)}E.setAttribute("data-messageDate",t.date);E.setAttribute("data-messageId",t.id);E.setAttribute("data-senderId",t.senderId)}if(B)s.addClass(E,"bx-messenger-content-item-new");f=t.id;c=true}}}if(!c){if(E)f=E.getAttribute("data-messageId");if(g){var A=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-messageId":""+t.id+""}},false);if(!A){var y=s.create("div",{attrs:{"data-type":"system","data-senderId":t.senderId,"data-messageId":t.id,"data-blockmessageid":t.id},props:{className:"bx-messenger-content-item bx-messenger-content-item-system"},children:[s.create("span",{props:{className:"bx-messenger-content-item-content"},children:[typeof u=="undefined"?[]:s.create("span",{props:{className:"bx-messenger-content-item-avatar"},children:[s.create("span",{props:{className:"bx-messenger-content-item-arrow"}}),s.create("img",{props:{className:"bx-messenger-content-item-avatar-img"+(s.MessengerCommon.isBlankAvatar(u.avatar)?" bx-messenger-content-item-avatar-img-default":"")},attrs:{src:u.avatar}})]}),s.create("span",{props:{className:"bx-messenger-content-item-text-center"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-message"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-wrap"+(i?" bx-messenger-content-item-text-wrap-append":"")},children:[s.create("span",{props:{className:"bx-messenger-message"+(a?" bx-messenger-message-deleted":"")+(a||n?" bx-messenger-message-edited":"")},attrs:{id:"im-message-"+t.id},html:s.MessengerCommon.prepareText(t.text,false,true,true)}),p]})]}),s.create("span",{props:{className:"bx-messenger-content-item-params"},children:[s.create("span",{props:{className:"bx-messenger-content-item-date"},html:" &nbsp; "+this.formatDate(t.date,this.getDateFormatType("MESSAGE"))}),!h?null:s.create("span",{props:{className:"bx-messenger-content-item-like"+(M?" bx-messenger-content-item-liked":"")},children:[s.create("span",{attrs:{title:I>0?s.message("IM_MESSAGE_LIKE_LIST"):""},props:{className:"bx-messenger-content-like-digit"+(I<=0?" bx-messenger-content-like-digit-off":"")},html:I}),s.create("span",{attrs:{"data-messageId":t.id},props:{className:"bx-messenger-content-like-button"},html:s.message(!M?"IM_MESSAGE_LIKE":"IM_MESSAGE_DISLIKE")})]})]}),s.create("span",{props:{className:"bx-messenger-clear"}})]})]})]});if(t.system&&t.system=="Y"&&B)s.addClass(y,"bx-messenger-content-item-new")}}else if(t.senderId==this.BXIM.userId){var y=s.create("div",{attrs:{"data-type":"self","data-senderId":t.senderId,"data-messageDate":t.date,"data-messageId":t.id,"data-blockmessageid":t.id},props:{className:"bx-messenger-content-item"},children:[s.create("span",{props:{className:"bx-messenger-content-item-content"},children:[s.create("span",{props:{className:"bx-messenger-content-item-avatar"},children:[s.create("span",{props:{className:"bx-messenger-content-item-arrow"}}),s.create("img",{props:{className:"bx-messenger-content-item-avatar-img"+(s.MessengerCommon.isBlankAvatar(u.avatar)?" bx-messenger-content-item-avatar-img-default":"")},attrs:{src:u.avatar}})]}),m?s.create("span",{props:{className:"bx-messenger-content-item-status"},children:[s.create("span",{attrs:{title:s.message("IM_M_RETRY"),"data-messageid":t.id,"data-chat":parseInt(t.recipientId)>0?"Y":"N"},props:{className:"bx-messenger-content-item-error"},children:[s.create("span",{props:{className:"bx-messenger-content-item-error-icon"}})]})]}):s.create("span",{props:{className:"bx-messenger-content-item-status"},children:o?[s.create("span",{props:{className:"bx-messenger-content-item-progress"}})]:[]}),s.create("span",{props:{className:"bx-messenger-content-item-text-center"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-message"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-wrap"+(i?" bx-messenger-content-item-text-wrap-append":"")},children:[s.create("span",{attrs:{title:s.message("IM_M_OPEN_EXTRA_TITLE").replace("#SHORTCUT#",s.browser.IsMac()?"CMD":"CTRL")},props:{className:"bx-messenger-content-item-menu"}}),s.create("span",{props:{className:"bx-messenger-message"+(a?" bx-messenger-message-deleted":" ")+(a||n?" bx-messenger-message-edited":"")},attrs:{id:"im-message-"+t.id},html:s.MessengerCommon.prepareText(t.text,false,true,true)}),p]})]}),s.create("span",{props:{className:"bx-messenger-content-item-params"},children:[s.create("span",{props:{className:"bx-messenger-content-item-date"},html:m?s.message("IM_M_NOT_DELIVERED"):o?s.message("IM_M_DELIVERED"):" &nbsp; "+this.formatDate(t.date,this.getDateFormatType("MESSAGE"))}),!h?null:s.create("span",{props:{className:"bx-messenger-content-item-like"+(M?" bx-messenger-content-item-liked":"")},children:[s.create("span",{attrs:{title:I>0?s.message("IM_MESSAGE_LIKE_LIST"):""},props:{className:"bx-messenger-content-like-digit"+(I<=0?" bx-messenger-content-like-digit-off":"")},html:I}),s.create("span",{attrs:{"data-messageId":t.id},props:{className:"bx-messenger-content-like-button"},html:s.message(!M?"IM_MESSAGE_LIKE":"IM_MESSAGE_DISLIKE")})]})]}),s.create("span",{props:{className:"bx-messenger-clear"}})]})]})]})}else{var y=s.create("div",{attrs:{"data-type":"other","data-senderId":t.senderId,"data-messageDate":t.date,"data-messageId":t.id,"data-blockmessageid":t.id},props:{className:"bx-messenger-content-item bx-messenger-content-item-2"+(B?" bx-messenger-content-item-new":"")},children:[s.create("span",{props:{className:"bx-messenger-content-item-content"},children:[s.create("span",{attrs:{title:l?u.name:""},props:{className:"bx-messenger-content-item-avatar bx-messenger-content-item-avatar-button"},children:[s.create("span",{props:{className:"bx-messenger-content-item-arrow"}}),s.create("img",{props:{className:"bx-messenger-content-item-avatar-img"+(s.MessengerCommon.isBlankAvatar(u.avatar)?" bx-messenger-content-item-avatar-img-default":"")},attrs:{src:u.avatar}})]}),s.create("span",{props:{className:"bx-messenger-content-item-status"},children:[]}),s.create("span",{props:{className:"bx-messenger-content-item-text-center"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-message"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-wrap"+(i?" bx-messenger-content-item-text-wrap-append":"")},children:[s.create("span",{attrs:{title:s.message("IM_M_OPEN_EXTRA_TITLE").replace("#SHORTCUT#",s.browser.IsMac()?"CMD":"CTRL")},props:{className:"bx-messenger-content-item-menu"}}),s.create("span",{props:{className:"bx-messenger-message"+(a?" bx-messenger-message-deleted":" ")+(a||n?" bx-messenger-message-edited":"")},attrs:{id:"im-message-"+t.id},html:s.MessengerCommon.prepareText(t.text,false,true,true,!this.BXIM.messenger.openChatFlag||t.senderId==this.BXIM.userId?false:this.BXIM.messenger.users[this.BXIM.userId].name)}),p]})]}),s.create("span",{props:{className:"bx-messenger-content-item-params"},children:[s.create("span",{props:{className:"bx-messenger-content-item-date"},html:o?s.message("IM_M_DELIVERED"):" &nbsp; "+this.formatDate(t.date,this.getDateFormatType("MESSAGE"))}),!h?null:s.create("span",{props:{className:"bx-messenger-content-item-like"+(M?" bx-messenger-content-item-liked":"")},children:[s.create("span",{attrs:{title:I>0?s.message("IM_MESSAGE_LIKE_LIST"):""},props:{className:"bx-messenger-content-like-digit"+(I<=0?" bx-messenger-content-like-digit-off":"")},html:I}),s.create("span",{attrs:{"data-messageId":t.id},props:{className:"bx-messenger-content-like-button"},html:s.message(!M?"IM_MESSAGE_LIKE":"IM_MESSAGE_DISLIKE")})]})]}),s.create("span",{props:{className:"bx-messenger-clear"}})]})]})]})}}else if(d){y=s.create("div",{attrs:{id:"im-message-"+t.id,"data-messageDate":t.date,"data-messageId":t.id,"data-blockmessageid":t.id},props:{className:"bx-messenger-content-item-text-wrap bx-messenger-item-skipped"}})}if(!c||d){if(i)this.BXIM.messenger.popupMessengerBodyWrap.insertBefore(y,E);else if(X&&E.nextElementSibling)this.BXIM.messenger.popupMessengerBodyWrap.insertBefore(y,E.nextElementSibling);else this.BXIM.messenger.popupMessengerBodyWrap.appendChild(y)}if(!d&&s.MessengerCommon.enableScroll(this.BXIM.messenger.popupMessengerBody,this.BXIM.messenger.popupMessengerBody.offsetHeight,r)){if(this.BXIM.animationSupport){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();(this.BXIM.messenger.popupMessengerBodyAnimation=new s.easing({duration:800,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)},transition:s.easing.makeEaseInOut(s.easing.transitions.quart),step:s.delegate(function(e){this.BXIM.messenger.popupMessengerBody.scrollTop=e.scroll},this)})).animate()}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}return f};s.MessengerCommon.prototype.drawProgessMessage=function(e,t){var r=s("im-message-"+e);if(!r)return false;s.addClass(r.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress");r.parentNode.parentNode.parentNode.previousSibling.innerHTML="";if(typeof t=="object"||t===true){if(this.BXIM.messenger.message[e]){this.BXIM.messenger.errorMessage[this.BXIM.messenger.currentTab]=true;s.addClass(r.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-error");t.chat=t.chat?t.chat:parseInt(this.BXIM.messenger.message[e].recipientId)>0?"Y":"N";s.adjust(r.parentNode.parentNode.parentNode.previousSibling,{children:[s.create("span",{attrs:{title:t.title?t.title:"","data-messageid":e,"data-chat":t.chat},props:{className:"bx-messenger-content-item-error"},children:[s.create("span",{props:{className:"bx-messenger-content-item-error-icon"}})]})]})}else{s.removeClass(r.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress");s.removeClass(r.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-error")}}else{s.adjust(r.parentNode.parentNode.parentNode.previousSibling,{children:[s.create("span",{props:{className:"bx-messenger-content-item-progress"}})]})}return true};s.MessengerCommon.prototype.clearProgessMessage=function(e){var t=s("im-message-"+e);if(!t)return false;s.removeClass(t.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress");s.removeClass(t.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-error");t.parentNode.parentNode.parentNode.previousSibling.innerHTML="";return true};s.MessengerCommon.prototype.startWriting=function(e,t){if(t==this.BXIM.userId){this.BXIM.messenger.writingList[e]=true;this.drawWriting(e);clearTimeout(this.BXIM.messenger.writingListTimeout[e]);this.BXIM.messenger.writingListTimeout[e]=setTimeout(s.delegate(function(){this.endWriting(e)},this),29500)}else{if(!this.BXIM.messenger.writingList[t])this.BXIM.messenger.writingList[t]={};if(!this.BXIM.messenger.writingListTimeout[t])this.BXIM.messenger.writingListTimeout[t]={};this.BXIM.messenger.writingList[t][e]=true;this.drawWriting(e,t);clearTimeout(this.BXIM.messenger.writingListTimeout[t][e]);this.BXIM.messenger.writingListTimeout[t][e]=setTimeout(s.delegate(function(){this.endWriting(e,t)},this),29500)}};s.MessengerCommon.prototype.drawWriting=function(e,t){if(e==this.BXIM.userId)return false;if(this.BXIM.messenger.popupMessenger!=null&&this.MobileActionEqual("RECENT","DIALOG")){if(this.BXIM.messenger.writingList[e]||t&&this.countWriting(t)>0){var r=s.findChildrenByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-cl-id-"+(t?t:e));if(r){for(var i=0;i<r.length;i++)s.addClass(r[i],"bx-messenger-cl-status-writing")}if(this.MobileActionEqual("DIALOG")&&(this.BXIM.messenger.currentTab==e||t&&this.BXIM.messenger.currentTab==t)){if(t){var n=[];for(var i in this.BXIM.messenger.writingList[t]){if(this.BXIM.messenger.writingList[t].hasOwnProperty(i)&&this.BXIM.messenger.users[i]){n.push(this.BXIM.messenger.users[i].name)}}this.drawNotifyMessage(t,"writing",s.message("IM_M_WRITING").replace("#USER_NAME#",n.join(", ")))}else{if(!this.isMobile()){this.BXIM.messenger.popupMessengerPanelAvatar.parentNode.className="bx-messenger-panel-avatar bx-messenger-panel-avatar-status-writing"}this.drawNotifyMessage(e,"writing",s.message("IM_M_WRITING").replace("#USER_NAME#",this.BXIM.messenger.users[e].name))}}}else if(!this.BXIM.messenger.writingList[e]||t&&this.countWriting(t)==0){var r=s.findChildrenByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-cl-id-"+(t?t:e));if(r){for(var i=0;i<r.length;i++)s.removeClass(r[i],"bx-messenger-cl-status-writing")}if(this.MobileActionEqual("DIALOG")&&(this.BXIM.messenger.currentTab==e||this.BXIM.messenger.currentTab==t)){if(!t){if(!this.isMobile())this.BXIM.messenger.popupMessengerPanelAvatar.parentNode.className="bx-messenger-panel-avatar bx-messenger-panel-avatar-status-"+this.getUserStatus(e)}var a=this.BXIM.messenger.popupMessengerBodyWrap.lastChild;if(a&&s.hasClass(a,"bx-messenger-content-item-notify")){if(!t&&this.BXIM.messenger.readedList[e]){this.drawReadMessage(e,this.BXIM.messenger.readedList[e].messageId,this.BXIM.messenger.readedList[e].date,false)}else if(s.MessengerCommon.enableScroll(this.BXIM.messenger.popupMessengerBody,this.BXIM.messenger.popupMessengerBody.offsetHeight)){if(this.BXIM.animationSupport){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();(this.BXIM.messenger.popupMessengerBodyAnimation=new s.easing({duration:800,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop-a.offsetHeight},transition:s.easing.makeEaseInOut(s.easing.transitions.quart),step:s.delegate(function(e){this.BXIM.messenger.popupMessengerBody.scrollTop=e.scroll},this),complete:s.delegate(function(){s.remove(a)},this)})).animate()}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollTop-a.offsetHeight;s.remove(a)}}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollTop-a.offsetHeight;s.remove(a)}}}}}};s.MessengerCommon.prototype.endWriting=function(e,s){if(s){if(this.BXIM.messenger.writingListTimeout[s]&&this.BXIM.messenger.writingListTimeout[s][e])clearTimeout(this.BXIM.messenger.writingListTimeout[s][e]);if(this.BXIM.messenger.writingList[s]&&this.BXIM.messenger.writingList[s][e])delete this.BXIM.messenger.writingList[s][e]}else{clearTimeout(this.BXIM.messenger.writingListTimeout[e]);delete this.BXIM.messenger.writingList[e]}this.drawWriting(e,s)};s.MessengerCommon.prototype.sendWriting=function(t){if(!this.BXIM.ppServerStatus)return false;if(!this.BXIM.messenger.writingSendList[t]){clearTimeout(this.BXIM.messenger.writingSendListTimeout[t]);this.BXIM.messenger.writingSendList[t]=true;s.ajax({url:this.BXIM.pathToAjax+"?START_WRITING&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_START_WRITING:"Y",DIALOG_ID:t,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){if(t&&t.BITRIX_SESSID){s.message({bitrix_sessid:t.BITRIX_SESSID})}if(t.ERROR=="AUTHORIZE_ERROR"&&this.BXIM.desktop.ready()&&this.BXIM.messenger.sendAjaxTry<3){this.BXIM.messenger.sendAjaxTry++;s.onCustomEvent(e,"onImError",[t.ERROR])}else if(t.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;s.onCustomEvent(e,"onImError",[t.ERROR,t.BITRIX_SESSID])}else{if(t.ERROR=="AUTHORIZE_ERROR"||t.ERROR=="SESSION_ERROR"){s.onCustomEvent(e,"onImError",[t.ERROR])}}},this)});this.BXIM.messenger.writingSendListTimeout[t]=setTimeout(s.delegate(function(){this.endSendWriting(t)},this),3e4)}};s.MessengerCommon.prototype.endSendWriting=function(e){clearTimeout(this.BXIM.messenger.writingSendListTimeout[e]);this.BXIM.messenger.writingSendList[e]=false};s.MessengerCommon.prototype.countWriting=function(e){var s=0;if(this.BXIM.messenger.writingList[e]){if(typeof this.BXIM.messenger.writingList[e]=="object"){for(var t in this.BXIM.messenger.writingList[e]){if(this.BXIM.messenger.writingList[e].hasOwnProperty(t)){s++}}}else{s=1}}return s};s.MessengerCommon.prototype.leaveFromChat=function(e,t){if(!this.BXIM.messenger.chat[e])return false;t=t!=false;if(!t){delete this.BXIM.messenger.chat[e];delete this.BXIM.messenger.userInChat[e];delete this.BXIM.messenger.unreadMessage[e];if(this.BXIM.messenger.popupMessenger!=null){if(this.BXIM.messenger.currentTab=="chat"+e){this.BXIM.messenger.currentTab=0;this.BXIM.messenger.openChatFlag=false;this.BXIM.messenger.openCallFlag=false;this.BXIM.messenger.extraClose()}s.MessengerCommon.userListRedraw()}}else{s.ajax({url:this.BXIM.pathToAjax+"?CHAT_LEAVE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{IM_CHAT_LEAVE:"Y",CHAT_ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(e){if(e.ERROR==""){this.readMessage("chat"+e.CHAT_ID,true,false);delete this.BXIM.messenger.chat[e.CHAT_ID];delete this.BXIM.messenger.userInChat[e.CHAT_ID];delete this.BXIM.messenger.unreadMessage[e.CHAT_ID];if(this.BXIM.messenger.popupMessenger!=null){
if(this.BXIM.messenger.currentTab=="chat"+e.CHAT_ID){this.BXIM.messenger.currentTab=0;this.BXIM.messenger.openChatFlag=false;this.BXIM.messenger.openCallFlag=false;s.localStorage.set("mct",this.BXIM.messenger.currentTab,15);this.BXIM.messenger.extraClose()}if(this.BXIM.messenger.recentList)s.MessengerCommon.recentListRedraw()}s.localStorage.set("mcl",e.CHAT_ID,5)}},this)})}};s.MessengerCommon.prototype.pullEvent=function(){s.addCustomEvent(this.isMobile()?"onPull-im":"onPullEvent-im",s.delegate(function(e,t){if(this.isMobile()){t=e.params;e=e.command}if(e=="desktopOffline"){this.BXIM.desktopStatus=false}else if(e=="desktopOnline"){this.BXIM.desktopStatus=true}else if(e=="readMessage"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;this.readMessage(t.userId,false,false)}else if(e=="readMessageChat"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;this.readMessage("chat"+t.chatId,false,false)}else if(e=="readMessageApponent"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;t.date=parseInt(t.date)+parseInt(s.message("USER_TZ_OFFSET"));this.drawReadMessage(t.userId,t.lastId,t.date)}else if(e=="startWriting"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;this.startWriting(t.senderId,t.dialogId)}else if(e=="message"||e=="messageChat"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;if(this.BXIM.lastRecordId>=t.MESSAGE.id)return false;var r={};r.MESSAGE={};r.USERS_MESSAGE={};t.MESSAGE.date=parseInt(t.MESSAGE.date)+parseInt(s.message("USER_TZ_OFFSET"));for(var i in t.CHAT){if(this.BXIM.messenger.chat[i]&&this.BXIM.messenger.chat[i].fake)t.CHAT[i].fake=true;else if(!this.BXIM.messenger.chat[i])t.CHAT[i].fake=true;this.BXIM.messenger.chat[i]=t.CHAT[i]}for(var i in t.USER_IN_CHAT){this.BXIM.messenger.userInChat[i]=t.USER_IN_CHAT[i]}for(var i in t.USER_BLOCK_CHAT){this.BXIM.messenger.userChatBlockStatus[i]=t.USER_BLOCK_CHAT[i]}var n={};for(var i in t.USERS){if(this.BXIM.messenger.users[i]&&this.BXIM.messenger.users[i].status!=t.USERS[i].status&&parseInt(t.MESSAGE.date)+180>s.MessengerCommon.getNowDate()){n[i]=this.BXIM.messenger.users[i].status;this.BXIM.messenger.users[i].status=t.USERS[i].status}}if(this.MobileActionEqual("RECENT")){for(var i in n){if(!this.BXIM.messenger.users[i])continue;var a=s.findChildrenByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-cl-id-"+i);if(a!=null){for(var o=0;o<a.length;o++){s.removeClass(a[o],"bx-messenger-cl-status-"+n[i]);s.addClass(a[o],"bx-messenger-cl-status-"+s.MessengerCommon.getUserStatus(i));a[o].setAttribute("data-status",s.MessengerCommon.getUserStatus(i))}}}}a=null;r.USERS=t.USERS;if(this.MobileActionEqual("DIALOG")){for(var i in t.FILES){if(!this.BXIM.disk.files[t.CHAT_ID])this.BXIM.disk.files[t.CHAT_ID]={};if(this.BXIM.disk.files[t.CHAT_ID][i])continue;t.FILES[i].date=parseInt(t.FILES[i].date)+parseInt(s.message("USER_TZ_OFFSET"));this.BXIM.disk.files[t.CHAT_ID][i]=t.FILES[i]}}r.MESSAGE[t.MESSAGE.id]=t.MESSAGE;this.BXIM.lastRecordId=t.MESSAGE.id;if(t.MESSAGE.senderId==this.BXIM.userId){if(this.BXIM.messenger.sendMessageFlag>0||this.BXIM.messenger.message[t.MESSAGE.id])return;this.readMessage(t.MESSAGE.recipientId,false,false);r.USERS_MESSAGE[t.MESSAGE.recipientId]=[t.MESSAGE.id];this.updateStateVar(r);s.MessengerCommon.recentListAdd({userId:t.MESSAGE.recipientId,id:t.MESSAGE.id,date:parseInt(t.MESSAGE.date)+parseInt(s.message("SERVER_TZ_OFFSET")),recipientId:t.MESSAGE.recipientId,senderId:t.MESSAGE.senderId,text:t.MESSAGE.text,params:t.MESSAGE.params},true)}else{r.UNREAD_MESSAGE={};r.UNREAD_MESSAGE[e=="messageChat"?t.MESSAGE.recipientId:t.MESSAGE.senderId]=[t.MESSAGE.id];r.USERS_MESSAGE[e=="messageChat"?t.MESSAGE.recipientId:t.MESSAGE.senderId]=[t.MESSAGE.id];if(e=="message")this.endWriting(t.MESSAGE.senderId);else this.endWriting(t.MESSAGE.senderId,t.MESSAGE.recipientId);this.updateStateVar(r);s.MessengerCommon.recentListAdd({userId:e=="messageChat"?t.MESSAGE.recipientId:t.MESSAGE.senderId,id:t.MESSAGE.id,date:parseInt(t.MESSAGE.date)+parseInt(s.message("SERVER_TZ_OFFSET")),recipientId:t.MESSAGE.recipientId,senderId:t.MESSAGE.senderId,text:t.MESSAGE.text,params:t.MESSAGE.params},true)}s.localStorage.set("mfm",this.BXIM.messenger.flashMessage,80)}else if(e=="messageUpdate"||e=="messageDelete"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;if(this.BXIM.messenger.message[t.id]){if(!this.BXIM.messenger.message[t.id].params)this.BXIM.messenger.message[t.id].params={};var m=0;if(e=="messageDelete"){t.message=s.message("IM_M_DELETED");this.BXIM.messenger.message[t.id].params.IS_DELETED="Y"}else if(e=="messageUpdate"){this.BXIM.messenger.message[t.id].params.IS_EDITED="Y"}this.BXIM.messenger.message[t.id].text=t.text;if(t.type=="private"){m=t.fromUserId==this.BXIM.messenger.BXIM.userId?t.toUserId:t.fromUserId;this.endWriting(m)}else{m="chat"+t.chatId;this.endWriting(t.senderId,m)}if(this.BXIM.messenger.currentTab==m&&s("im-message-"+t.id)){var g=s("im-message-"+t.id);s.addClass(g,e=="messageDelete"?"bx-messenger-message-edited bx-messenger-message-deleted":"bx-messenger-message-edited");g.innerHTML=s.MessengerCommon.prepareText(this.BXIM.messenger.message[t.id].text,false,true,true);s.addClass(g,"bx-messenger-message-edited-anim");if(g.nextSibling&&s.hasClass(g.nextSibling,"bx-messenger-file-box")){s.addClass(g.nextSibling,"bx-messenger-file-box-with-message")}setTimeout(s.delegate(function(){s.removeClass(g,"bx-messenger-message-edited-anim")},this),1e3)}if(this.BXIM.messenger.recentList)s.MessengerCommon.recentListRedraw()}}else if(e=="messageLike"){if(this.MobileActionNotEqual("DIALOG"))return false;var l=s.util.in_array(this.BXIM.userId,t.users);var h=t.users.length>0?t.users.length:"";if(!this.BXIM.messenger.message[t.id]){return false}if(typeof this.BXIM.messenger.message[t.id].params!="object"){this.BXIM.messenger.message[t.id].params={}}this.BXIM.messenger.message[t.id].params.LIKE=t.users;if(s("im-message-"+t.id)){var I=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-blockmessageid":""+t.id+""}},false);if(I){var M=s.findChildByClassName(I,"bx-messenger-content-item-like");if(M){var p=s.findChildByClassName(M,"bx-messenger-content-like-digit",false);var d=s.findChildByClassName(M,"bx-messenger-content-like-button",false);if(l){d.innerHTML=s.message("IM_MESSAGE_DISLIKE");s.addClass(M,"bx-messenger-content-item-liked")}else{d.innerHTML=s.message("IM_MESSAGE_LIKE");s.removeClass(M,"bx-messenger-content-item-liked")}if(h>0){p.setAttribute("title",s.message("IM_MESSAGE_LIKE_LIST"));s.removeClass(p,"bx-messenger-content-like-digit-off")}else{p.setAttribute("title","");s.addClass(p,"bx-messenger-content-like-digit-off")}if(p.innerHTML<h){s.addClass(I.firstChild,"bx-messenger-content-item-plus-like");setTimeout(function(){s.removeClass(I.firstChild,"bx-messenger-content-item-plus-like")},500)}p.innerHTML=h}}}}else if(e=="fileUpload"){if(this.MobileActionNotEqual("DIALOG"))return false;if(this.BXIM.disk.filesProgress[t.fileTmpId])return false;if(this.BXIM.disk.files[t.fileChatId]&&this.BXIM.disk.files[t.fileChatId][t.fileId]){t.fileParams["preview"]=this.BXIM.disk.files[t.fileChatId][t.fileId]["preview"]}if(!this.BXIM.disk.files[t.fileChatId])this.BXIM.disk.files[t.fileChatId]={};this.BXIM.disk.files[t.fileChatId][t.fileId]=t.fileParams;s.MessengerCommon.diskRedrawFile(t.fileChatId,t.fileId);if(s.MessengerCommon.enableScroll(this.BXIM.messenger.popupMessengerBody,this.BXIM.messenger.popupMessengerBody.offsetHeight)){if(this.BXIM.messenger.BXIM.animationSupport){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();(this.BXIM.messenger.popupMessengerBodyAnimation=new s.easing({duration:800,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)},transition:s.easing.makeEaseInOut(s.easing.transitions.quart),step:s.delegate(function(e){this.BXIM.messenger.popupMessengerBody.scrollTop=e.scroll},this)})).animate()}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}}else if(e=="fileUnRegister"){if(this.MobileActionNotEqual("DIALOG"))return false;for(var u in t.files){if(this.BXIM.disk.filesRegister[t.chatId]){delete this.BXIM.disk.filesRegister[t.chatId][t.files[u]]}if(this.BXIM.disk.files[t.chatId]){this.BXIM.disk.files[t.chatId][t.files[u]].status="error";s.MessengerCommon.diskRedrawFile(t.chatId,t.files[u])}delete this.BXIM.disk.filesProgress[u]}this.drawTab(this.BXIM.messenger.getRecipientByChatId(t.chatId))}else if(e=="chatRename"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;if(this.BXIM.messenger.chat[t.chatId]){this.BXIM.messenger.chat[t.chatId].name=t.chatTitle;this.BXIM.messenger.redrawChatHeader()}}else if(e=="chatAvatar"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;this.BXIM.messenger.updateChatAvatar(t.chatId,t.chatAvatar)}else if(e=="chatUserAdd"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;for(var i in t.users)this.BXIM.messenger.users[i]=t.users[i];if(!this.BXIM.messenger.chat[t.chatId]){this.BXIM.messenger.chat[t.chatId]={id:t.chatId,name:t.chatId,owner:t.chatOwner,fake:true}}else{if(this.BXIM.messenger.userInChat[t.chatId]){for(i=0;i<t.newUsers.length;i++)this.BXIM.messenger.userInChat[t.chatId].push(t.newUsers[i])}else this.BXIM.messenger.userInChat[t.chatId]=t.newUsers;this.BXIM.messenger.redrawChatHeader()}}else if(e=="chatUserLeave"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;if(t.userId==this.BXIM.userId){this.readMessage("chat"+t.chatId,true,false);this.leaveFromChat(t.chatId,false);if(t.message.length>0)this.BXIM.openConfirm({title:s.util.htmlspecialchars(t.chatTitle),message:t.message})}else if(this.MobileActionEqual("DIALOG")){if(!this.BXIM.messenger.chat[t.chatId]||!this.BXIM.messenger.userInChat[t.chatId])return false;var f=[];for(var i=0;i<this.BXIM.messenger.userInChat[t.chatId].length;i++)if(this.BXIM.messenger.userInChat[t.chatId][i]!=t.userId)f.push(this.BXIM.messenger.userInChat[t.chatId][i]);this.BXIM.messenger.userInChat[t.chatId]=f;this.BXIM.messenger.redrawChatHeader()}}else if(e=="notify"){if(this.MobileActionNotEqual("NOTIFY"))return false;if(this.BXIM.lastRecordId>=t.id)return false;t.date=parseInt(t.date)+parseInt(s.message("USER_TZ_OFFSET"));var r={};r.UNREAD_NOTIFY={};r.UNREAD_NOTIFY[t.id]=[t.id];this.BXIM.messenger.notify.notify[t.id]=t;this.BXIM.messenger.notify.flashNotify[t.id]=t.silent!="Y";if(t.settingName=="main|rating_vote"&&t.original_tag.substr(0,16)=="RATING|IMMESSAGE"){var c=t.original_tag.substr(17);if(this.BXIM.messenger.message[c]&&this.BXIM.messenger.message[c].recipientId==this.BXIM.messenger.currentTab&&this.BXIM.windowFocus){delete r.UNREAD_NOTIFY[t.id];this.BXIM.notify.flashNotify[t.id]=false;this.BXIM.notify.viewNotify(t.id)}}if(t.silent=="N")this.BXIM.notify.changeUnreadNotify(r.UNREAD_NOTIFY);s.localStorage.set("mfn",this.BXIM.notify.flashNotify,80);this.BXIM.lastRecordId=t.id}else if(e=="readNotify"){if(this.MobileActionNotEqual("NOTIFY"))return false;this.BXIM.notify.initNotifyCount=0;t.lastId=parseInt(t.lastId);for(var i in this.BXIM.notify.unreadNotify){var B=this.BXIM.notify.notify[this.BXIM.notify.unreadNotify[i]];if(B&&B.type!=1&&B.id<=t.lastId){delete this.BXIM.notify.unreadNotify[i]}}this.BXIM.notify.updateNotifyCount(false)}else if(e=="confirmNotify"){if(this.MobileActionNotEqual("NOTIFY"))return false;var X=parseInt(t.id);delete this.BXIM.notify.notify[X];delete this.BXIM.notify.unreadNotify[X];delete this.BXIM.notify.flashNotify[X];this.BXIM.notify.updateNotifyCount(false);if(this.BXIM.messenger.popupMessenger!=null&&this.BXIM.notifyOpen)this.BXIM.notify.openNotify(true)}else if(e=="readNotifyOne"){if(this.MobileActionNotEqual("NOTIFY"))return false;var B=this.BXIM.notify.notify[t.id];if(B&&B.type!=1)delete this.BXIM.notify.unreadNotify[t.id];this.BXIM.notify.updateNotifyCount(false);if(this.BXIM.messenger.popupMessenger!=null&&this.BXIM.notifyOpen)this.BXIM.notify.openNotify(true)}},this));s.addCustomEvent(this.isMobile()?"onPullOnline":"onPullOnlineEvent",s.delegate(function(e,t){if(this.isMobile()){t=e.params;e=e.command}if(e=="user_online"){if(this.BXIM.messenger.users[t.USER_ID]){var r=false;if(typeof this.BXIM.messenger.users[t.USER_ID].idle=="undefined"){this.BXIM.messenger.users[t.USER_ID].idle=0}if(this.BXIM.messenger.users[t.USER_ID].idle!=0){this.BXIM.messenger.users[t.USER_ID].idle=0;r=true}if(typeof t.STATUS!="undefined"){if(this.BXIM.messenger.users[t.USER_ID].status!=t.STATUS){this.BXIM.messenger.users[t.USER_ID].status=t.STATUS;r=true}}if(r){this.BXIM.messenger.dialogStatusRedraw();this.userListRedraw()}}}else if(e=="user_offline"){if(this.BXIM.messenger.users[t.USER_ID]){if(this.BXIM.messenger.users[t.USER_ID].status!="offline"){this.BXIM.messenger.users[t.USER_ID].status="offline";this.BXIM.messenger.users[t.USER_ID].idle=0;this.BXIM.messenger.dialogStatusRedraw();s.MessengerCommon.userListRedraw()}}}else if(e=="user_status"){if(this.BXIM.messenger.users[t.USER_ID]&&t.STATUS){var r=false;if(typeof t.IDLE!="undefined"){if(typeof this.BXIM.messenger.users[t.USER_ID].idle=="undefined"){this.BXIM.messenger.users[t.USER_ID].idle=0}if(this.BXIM.messenger.users[t.USER_ID].idle!=t.IDLE){this.BXIM.messenger.users[t.USER_ID].idle=t.IDLE;r=true}}if(typeof t.STATUS!="undefined"){if(this.BXIM.messenger.users[t.USER_ID].status!=t.STATUS){this.BXIM.messenger.users[t.USER_ID].status=t.STATUS;r=true}}if(r){this.BXIM.messenger.dialogStatusRedraw();s.MessengerCommon.userListRedraw()}}}else if(e=="online_list"){var r=false;for(var i in this.BXIM.messenger.users){if(typeof t.USERS[i]=="undefined"){if(this.BXIM.messenger.users[i].status!="offline"){this.BXIM.messenger.users[i].status="offline";this.BXIM.messenger.users[i].idle=0;r=true}}else{if(typeof t.USERS[i].idle!="undefined"){if(typeof this.BXIM.messenger.users[i].idle=="undefined"){this.BXIM.messenger.users[i].idle=0}if(this.BXIM.messenger.users[i].idle!=t.USERS[i].idle){this.BXIM.messenger.users[i].idle=t.USERS[i].idle;r=true}}if(typeof t.USERS[i].status!="undefined"){if(this.BXIM.messenger.users[i].status!=t.USERS[i].status){this.BXIM.messenger.users[i].status=t.USERS[i].status;r=true}}}}if(r){this.BXIM.messenger.dialogStatusRedraw();s.MessengerCommon.userListRedraw()}}},this))};s.MessengerCommon.prototype.updateStateVar=function(e,t,r){r=r!==false;if(typeof e.CHAT!="undefined"){for(var i in e.CHAT){if(this.BXIM.messenger.chat[i]&&this.BXIM.messenger.chat[i].fake)e.CHAT[i].fake=true;else if(!this.BXIM.messenger.chat[i])e.CHAT[i].fake=true;this.BXIM.messenger.chat[i]=e.CHAT[i]}}if(typeof e.USER_IN_CHAT!="undefined"){for(var i in e.USER_IN_CHAT){this.BXIM.messenger.userInChat[i]=e.USER_IN_CHAT[i]}}if(typeof e.USER_BLOCK_CHAT!="undefined"){for(var i in e.USER_BLOCK_CHAT){this.BXIM.messenger.userChatBlockStatus[i]=e.USER_BLOCK_CHAT[i]}}if(typeof e.USERS!="undefined"){for(var i in e.USERS){this.BXIM.messenger.users[i]=e.USERS[i]}}if(typeof e.USER_IN_GROUP!="undefined"){for(var i in e.USER_IN_GROUP){if(typeof this.BXIM.messenger.userInGroup[i]=="undefined"){this.BXIM.messenger.userInGroup[i]=e.USER_IN_GROUP[i]}else{for(var n=0;n<e.USER_IN_GROUP[i].users.length;n++)this.BXIM.messenger.userInGroup[i].users.push(e.USER_IN_GROUP[i].users[n]);this.BXIM.messenger.userInGroup[i].users=s.util.array_unique(this.BXIM.messenger.userInGroup[i].users)}}}if(typeof e.WO_USER_IN_GROUP!="undefined"){for(var i in e.WO_USER_IN_GROUP){if(typeof this.BXIM.messenger.woUserInGroup[i]=="undefined"){this.BXIM.messenger.woUserInGroup[i]=e.WO_USER_IN_GROUP[i]}else{for(var n=0;n<e.WO_USER_IN_GROUP[i].users.length;n++)this.BXIM.messenger.woUserInGroup[i].users.push(e.WO_USER_IN_GROUP[i].users[n]);this.BXIM.messenger.woUserInGroup[i].users=s.util.array_unique(this.BXIM.messenger.woUserInGroup[i].users)}}}if(typeof e.MESSAGE!="undefined"){for(var i in e.MESSAGE){this.BXIM.messenger.message[i]=e.MESSAGE[i];this.BXIM.lastRecordId=parseInt(i)>this.BXIM.lastRecordId?parseInt(i):this.BXIM.lastRecordId}}this.changeUnreadMessage(e.UNREAD_MESSAGE,t);if(typeof e.USERS_MESSAGE!="undefined"){for(var i in e.USERS_MESSAGE){e.USERS_MESSAGE[i].sort(s.delegate(function(e,s){e=parseInt(e);s=parseInt(s);if(!this.BXIM.messenger.message[e]||!this.BXIM.messenger.message[s]){return 0}var t=parseInt(this.BXIM.messenger.message[e].date);var r=parseInt(this.BXIM.messenger.message[s].date);if(t<r){return-1}else if(t>r){return 1}else{if(e<s){return-1}else if(e>s){return 1}else{return 0}}},this));if(!this.BXIM.messenger.showMessage[i])this.BXIM.messenger.showMessage[i]=e.USERS_MESSAGE[i];for(var n=0;n<e.USERS_MESSAGE[i].length;n++){if(!s.util.in_array(e.USERS_MESSAGE[i][n],this.BXIM.messenger.showMessage[i])){this.BXIM.messenger.showMessage[i].push(e.USERS_MESSAGE[i][n]);if(this.BXIM.messenger.history[i])this.BXIM.messenger.history[i]=s.util.array_merge(this.BXIM.messenger.history[i],e.USERS_MESSAGE[i]);else this.BXIM.messenger.history[i]=e.USERS_MESSAGE[i];if(r&&this.BXIM.messenger.currentTab==i&&this.MobileActionEqual("DIALOG"))this.drawMessage(i,this.BXIM.messenger.message[e.USERS_MESSAGE[i][n]])}}}}};s.MessengerCommon.prototype.changeUnreadMessage=function(e,t){t=t!=false;var r=false;var i=false;var n=true;for(var a in e){var o=false;if(this.BXIM.xmppStatus&&a.toString().substr(0,4)!="chat"){if(!(this.BXIM.messenger.popupMessenger!=null&&this.BXIM.messenger.currentTab==a&&this.BXIM.isFocus())){i=true;if(this.BXIM.messenger.unreadMessage[a])this.BXIM.messenger.unreadMessage[a]=s.util.array_unique(s.util.array_merge(this.BXIM.messenger.unreadMessage[a],e[a]));else this.BXIM.messenger.unreadMessage[a]=e[a]}o=true}if(!o){if(this.BXIM.messenger.popupMessenger!=null&&this.BXIM.messenger.currentTab==a&&this.BXIM.isFocus()){if(typeof this.BXIM.messenger.flashMessage[a]=="undefined")this.BXIM.messenger.flashMessage[a]={};for(var m=0;m<e[a].length;m++){if(this.BXIM.isFocus())this.BXIM.messenger.flashMessage[a][e[a][m]]=false;if(this.BXIM.messenger.message[e[a][m]]&&this.BXIM.messenger.message[e[a][m]].senderId==this.BXIM.messenger.currentTab)r=true}this.readMessage(a,true,true,true)}else if(this.isMobile()&&this.BXIM.messenger.currentTab==a){var g=this.BXIM.messenger.currentTab;this.BXIM.isFocusMobile(s.delegate(function(e){if(e){s.MessengerCommon.readMessage(g,true,true,true)}},this));if(this.BXIM.messenger.unreadMessage[g])this.BXIM.messenger.unreadMessage[g]=s.util.array_unique(s.util.array_merge(this.BXIM.messenger.unreadMessage[g],e[g]));else this.BXIM.messenger.unreadMessage[g]=e[g]}else{i=true;if(this.BXIM.messenger.unreadMessage[a])this.BXIM.messenger.unreadMessage[a]=s.util.array_unique(s.util.array_merge(this.BXIM.messenger.unreadMessage[a],e[a]));else this.BXIM.messenger.unreadMessage[a]=e[a];if(typeof this.BXIM.messenger.flashMessage[a]=="undefined"){this.BXIM.messenger.flashMessage[a]={};for(var m=0;m<e[a].length;m++){var l=this.BXIM.messenger.message[e[a][m]].text.match(new RegExp("("+this.BXIM.messenger.users[this.BXIM.userId].name.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+")","ig"));if(this.BXIM.settings.status!="dnd"||l){this.BXIM.messenger.flashMessage[a][e[a][m]]=t}}}else{for(var m=0;m<e[a].length;m++){var l=this.BXIM.messenger.message[e[a][m]].text.match(new RegExp("("+this.BXIM.messenger.users[this.BXIM.userId].name.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+")","ig"));if(this.BXIM.settings.status!="dnd"||l){if(!t&&!this.BXIM.isFocus()){this.BXIM.messenger.flashMessage[a][e[a][m]]=false}else{if(typeof this.BXIM.messenger.flashMessage[a][e[a][m]]=="undefined")this.BXIM.messenger.flashMessage[a][e[a][m]]=true}}}}}}var h=false;for(var m=0;m<e[a].length;m++){if(!h||h.SEND_DATE<=parseInt(this.BXIM.messenger.message[e[a][m]].date)+parseInt(s.message("SERVER_TZ_OFFSET"))){h={ID:this.BXIM.messenger.message[e[a][m]].id,SEND_DATE:parseInt(this.BXIM.messenger.message[e[a][m]].date)+parseInt(s.message("SERVER_TZ_OFFSET")),RECIPIENT_ID:this.BXIM.messenger.message[e[a][m]].recipientId,SENDER_ID:this.BXIM.messenger.message[e[a][m]].senderId,USER_ID:this.BXIM.messenger.message[e[a][m]].senderId,SEND_MESSAGE:this.BXIM.messenger.message[e[a][m]].text,PARAMS:this.BXIM.messenger.message[e[a][m]].params}}}if(h){s.MessengerCommon.recentListAdd({userId:h.RECIPIENT_ID.toString().substr(0,4)=="chat"?h.RECIPIENT_ID:h.USER_ID,id:h.ID,date:h.SEND_DATE,recipientId:h.RECIPIENT_ID,senderId:h.SENDER_ID,text:h.SEND_MESSAGE,params:h.PARAMS},true)}if(this.MobileActionEqual("DIALOG")&&this.BXIM.messenger.popupMessenger!=null&&this.BXIM.messenger.currentTab==a){n=true}}if(n){this.BXIM.messenger.dialogStatusRedraw(this.isMobile()?{type:1,slidingPanelRedrawDisable:true}:{})}if(this.MobileActionEqual("RECENT")&&this.BXIM.messenger.popupMessenger!=null&&!this.BXIM.messenger.recentList&&i)s.MessengerCommon.userListRedraw();if(!this.isMobile()){this.BXIM.messenger.newMessage(t);this.BXIM.messenger.updateMessageCount(t);if(t&&r&&this.BXIM.settings.status!="dnd"){this.BXIM.playSound("newMessage2")}}};s.MessengerCommon.prototype.readMessage=function(t,r,i,n){if(!t)return false;n=n==true;if(!n&&(!this.BXIM.messenger.unreadMessage[t]||this.BXIM.messenger.unreadMessage[t].length<=0))return false;r=r!=false;i=i!==false;if(this.BXIM.messenger.popupMessenger!=null){var a=s.findChildrenByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-cl-id-"+t);if(a!=null)for(var o=0;o<a.length;o++)a[o].firstChild.innerHTML="";a=s.findChildrenByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-content-item-new",false);if(a!=null)for(var o=0;o<a.length;o++)if(a[o].getAttribute("data-notifyType")!=1)s.removeClass(a[o],"bx-messenger-content-item-new")}var m=0;if(Math&&this.BXIM.messenger.unreadMessage[t])m=Math.max.apply(Math,this.BXIM.messenger.unreadMessage[t]);if(this.BXIM.messenger.unreadMessage[t])delete this.BXIM.messenger.unreadMessage[t];if(this.BXIM.messenger.flashMessage[t])delete this.BXIM.messenger.flashMessage[t];s.localStorage.set("mfm",this.BXIM.messenger.flashMessage,80);if(!this.isMobile()){this.BXIM.messenger.updateMessageCount(r)}if(i){clearTimeout(this.BXIM.messenger.readMessageTimeout[t+"_"+this.BXIM.messenger.currentTab]);this.BXIM.messenger.readMessageTimeout[t+"_"+this.BXIM.messenger.currentTab]=setTimeout(s.delegate(function(){var r={IM_READ_MESSAGE:"Y",USER_ID:t,TAB:this.BXIM.messenger.currentTab,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()};if(parseInt(m)>0)r["LAST_ID"]=m;var i=s.ajax({url:this.BXIM.pathToAjax+"?READ_MESSAGE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,skipAuthCheck:true,data:r,onsuccess:s.delegate(function(r){if(r&&r.BITRIX_SESSID){s.message({bitrix_sessid:r.BITRIX_SESSID})}if(r.ERROR!=""){if(r.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate(function(){this.readMessage(t,false,true)},this),2e3);s.onCustomEvent(e,"onImError",[r.ERROR,r.BITRIX_SESSID])}else if(r.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;if(this.BXIM.desktop&&this.BXIM.desktop.ready()){setTimeout(s.delegate(function(){this.readMessage(t,false,true)},this),1e4)}s.onCustomEvent(e,"onImError",[r.ERROR])}}},this),onfailure:s.delegate(function(){this.BXIM.messenger.sendAjaxTry=0;try{if(typeof i=="object"&&i.status==0)s.onCustomEvent(e,"onImError",["CONNECT_ERROR"])}catch(t){}},this)})},this),200)}if(r){s.localStorage.set("mrm",t,5);s.localStorage.set("mnnb",true,1)}};s.MessengerCommon.prototype.drawReadMessage=function(e,t,r,i){var n=Math.max.apply(Math,this.BXIM.messenger.showMessage[e]);if(n!=t||this.BXIM.messenger.message[n].senderId==e){this.BXIM.messenger.readedList[e]=false;return false}this.BXIM.messenger.readedList[e]={messageId:t,date:r};if(!this.countWriting(e)){i=i!=false;this.drawNotifyMessage(e,"readed",s.message("IM_M_READED").replace("#DATE#",this.formatDate(r)),i)}};s.MessengerCommon.prototype.drawNotifyMessage=function(e,t,r,i){if(this.BXIM.messenger.popupMessenger==null||e!=this.BXIM.messenger.currentTab||typeof r=="undefined"||typeof t=="undefined"||e==0)return false;var n=this.BXIM.messenger.popupMessengerBodyWrap.lastChild;if(s.hasClass(n,"bx-messenger-content-empty"))return false;var a=s.create("div",{attrs:{"data-type":"notify"},props:{className:"bx-messenger-content-item bx-messenger-content-item-notify"},children:[s.create("span",{props:{className:"bx-messenger-content-item-content"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-center"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-message"},html:'<span class="bx-messenger-content-item-notify-icon-'+t+'"></span>'+this.prepareText(r,false,true,true)})]})]})]});if(s.hasClass(n,"bx-messenger-content-item-notify"))s.remove(n);this.BXIM.messenger.popupMessengerBodyWrap.appendChild(a);i=i!=false;if(this.BXIM.messenger.popupMessengerBody&&s.MessengerCommon.enableScroll(this.BXIM.messenger.popupMessengerBody,this.BXIM.messenger.popupMessengerBody.offsetHeight)){if(this.BXIM.animationSupport&&i){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();(this.BXIM.messenger.popupMessengerBodyAnimation=new s.easing({duration:1200,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)},transition:s.easing.makeEaseInOut(s.easing.transitions.quart),step:s.delegate(function(e){this.BXIM.messenger.popupMessengerBody.scrollTop=e.scroll},this)})).animate()}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}};s.MessengerCommon.prototype.loadHistory=function(e,t){t=typeof t=="undefined"?true:t;if(!this.BXIM.messenger.historyEndOfList[e])this.BXIM.messenger.historyEndOfList[e]={};if(!this.BXIM.messenger.historyLoadFlag[e])this.BXIM.messenger.historyLoadFlag[e]={};if(this.BXIM.messenger.historyLoadFlag[e]&&this.BXIM.messenger.historyLoadFlag[e][t]){if(this.isMobile())app.pullDownLoadingStop();return}if(this.isMobile()){t=false}else{if(t){if(this.BXIM.messenger.historySearch!=""||this.BXIM.messenger.historyDateSearch!="")return;if(!(this.BXIM.messenger.popupHistoryItems.scrollTop>this.BXIM.messenger.popupHistoryItems.scrollHeight-this.BXIM.messenger.popupHistoryItems.offsetHeight-100))return}else{if(this.BXIM.messenger.popupMessengerBody.scrollTop>=5)return}}if(!this.BXIM.messenger.historyEndOfList[e]||!this.BXIM.messenger.historyEndOfList[e][t]){var r=[];if(t){r=s.findChildrenByClassName(this.BXIM.messenger.popupHistoryBodyWrap,"bx-messenger-history-item-text")}else{r=s.findChildrenByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-content-item-text-wrap")}if(!this.isMobile()&&r.length<20){return false}if(r.length>0)this.BXIM.messenger.historyOpenPage[e]=Math.floor(r.length/20)+1;else this.BXIM.messenger.historyOpenPage[e]=1;var i=null;if(!this.isMobile()){i=s.create("div",{props:{className:"bx-messenger-content-load-more-history"},children:[s.create("span",{props:{className:"bx-messenger-content-load-img"}}),s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_LOAD_MESSAGE")})]});if(t){this.BXIM.messenger.popupHistoryBodyWrap.appendChild(i)}else{this.BXIM.messenger.popupMessengerBodyWrap.insertBefore(i,this.BXIM.messenger.popupMessengerBodyWrap.firstChild)}}if(!this.BXIM.messenger.historyLoadFlag[e])this.BXIM.messenger.historyLoadFlag[e]={};this.BXIM.messenger.historyLoadFlag[e][t]=true;s.ajax({url:this.BXIM.pathToAjax+"?HISTORY_LOAD_MORE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_HISTORY_LOAD_MORE:"Y",USER_ID:e,PAGE_ID:this.BXIM.messenger.historyOpenPage[e],IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(r){if(i)s.remove(i);if(this.isMobile())app.pullDownLoadingStop();this.BXIM.messenger.historyLoadFlag[e][t]=false;if(r.MESSAGE.length==0){this.BXIM.messenger.historyEndOfList[e][t]=true;return}for(var n in r.FILES){if(!this.BXIM.disk.files[r.CHAT_ID])this.BXIM.disk.files[r.CHAT_ID]={};if(this.BXIM.disk.files[r.CHAT_ID][n])continue;r.FILES[n].date=parseInt(r.FILES[n].date)+parseInt(s.message("USER_TZ_OFFSET"));this.BXIM.disk.files[r.CHAT_ID][n]=r.FILES[n]}var a=0;for(var n in r.MESSAGE){r.MESSAGE[n].date=parseInt(r.MESSAGE[n].date)+parseInt(s.message("USER_TZ_OFFSET"));this.BXIM.messenger.message[n]=r.MESSAGE[n];a++}if(a<20){this.BXIM.messenger.historyEndOfList[e][t]=true}for(var n in r.USERS_MESSAGE){if(t){if(this.BXIM.messenger.history[n])this.BXIM.messenger.history[n]=s.util.array_merge(this.BXIM.messenger.history[n],r.USERS_MESSAGE[n]);else this.BXIM.messenger.history[n]=r.USERS_MESSAGE[n]}else{if(this.BXIM.messenger.showMessage[n])this.BXIM.messenger.showMessage[n]=s.util.array_unique(s.util.array_merge(r.USERS_MESSAGE[n],this.BXIM.messenger.showMessage[n]));else this.BXIM.messenger.showMessage[n]=r.USERS_MESSAGE[n]}}if(t){for(var n=0;n<r.USERS_MESSAGE[e].length;n++){var o=this.BXIM.messenger.message[r.USERS_MESSAGE[e][n]];if(o){if(s("im-message-history-"+o.id))continue;var m=s.MessengerCommon.formatDate(o.date,s.MessengerCommon.getDateFormatType("MESSAGE_TITLE"));if(!s("bx-im-history-"+m)){var g=s.create("div",{props:{className:"bx-messenger-content-group bx-messenger-content-group-history"},children:[s.create("div",{attrs:{id:"bx-im-history-"+m},props:{className:"bx-messenger-content-group-title"+(this.BXIM.language=="ru"?" bx-messenger-lowercase":"")},html:m})]});this.BXIM.messenger.popupHistoryBodyWrap.appendChild(g)}var o=this.BXIM.messenger.drawMessageHistory(o);if(o)this.BXIM.messenger.popupHistoryBodyWrap.appendChild(o)}}}else{var l=this.BXIM.messenger.popupMessengerBodyWrap.firstChild.nextSibling;l=s("im-message-"+l.getAttribute("data-blockmessageid"));for(var n=0;n<r.USERS_MESSAGE[e].length;n++){var o=this.BXIM.messenger.message[r.USERS_MESSAGE[e][n]];if(o){if(s("im-message-"+o.id))continue;s.MessengerCommon.drawMessage(e,o,false,true)}}this.BXIM.messenger.popupMessengerBody.scrollTop=l.offsetTop-this.BXIM.messenger.popupMessengerBody.offsetTop-l.offsetHeight-100}},this),onfailure:s.delegate(function(){if(i)s.remove(i);if(this.isMobile())app.pullDownLoadingStop()},this)})}};s.MessengerCommon.prototype.loadUserData=function(e){s.ajax({url:this.BXIM.pathToAjax+"?USER_DATA_LOAD&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_USER_DATA_LOAD:"Y",USER_ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){if(t.ERROR==""){this.BXIM.messenger.userChat[e]=t.CHAT_ID;s.MessengerCommon.getUserParam(e,true);this.BXIM.messenger.users[e].name=s.message("IM_M_USER_NO_ACCESS");for(var r in t.USERS){this.BXIM.messenger.users[r]=t.USERS[r]}for(var r in t.PHONES){this.BXIM.messenger.phones[r]={};for(var i in t.PHONES[r]){this.BXIM.messenger.phones[r][i]=s.util.htmlspecialcharsback(t.PHONES[r][i])}}for(var r in t.USER_IN_GROUP){if(typeof this.BXIM.messenger.userInGroup[r]=="undefined"){this.BXIM.messenger.userInGroup[r]=t.USER_IN_GROUP[r]}else{for(var i=0;i<t.USER_IN_GROUP[r].users.length;i++)this.BXIM.messenger.userInGroup[r].users.push(t.USER_IN_GROUP[r].users[i]);this.BXIM.messenger.userInGroup[r].users=s.util.array_unique(this.BXIM.messenger.userInGroup[r].users)}}for(var r in t.WO_USER_IN_GROUP){if(typeof this.BXIM.messenger.woUserInGroup[r]=="undefined"){this.BXIM.messenger.woUserInGroup[r]=t.WO_USER_IN_GROUP[r]}else{for(var i=0;i<t.WO_USER_IN_GROUP[r].users.length;i++)this.BXIM.messenger.woUserInGroup[r].users.push(t.WO_USER_IN_GROUP[r].users[i]);this.BXIM.messenger.woUserInGroup[r].users=s.util.array_unique(this.BXIM.messenger.woUserInGroup[r].users);

}}this.BXIM.messenger.dialogStatusRedraw()}else{this.BXIM.messenger.redrawTab[e]=true;if(t.ERROR=="ACCESS_DENIED"){this.BXIM.messenger.currentTab=0;this.BXIM.messenger.openChatFlag=false;this.BXIM.messenger.openCallFlag=false;this.BXIM.messenger.extraClose()}}},this)})};s.MessengerCommon.prototype.loadChatData=function(e){s.ajax({url:this.BXIM.pathToAjax+"?CHAT_DATA_LOAD&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_CHAT_DATA_LOAD:"Y",CHAT_ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(e){if(e.ERROR==""){if(this.BXIM.messenger.chat[e.CHAT_ID].fake){this.BXIM.messenger.chat[e.CHAT_ID].name=s.message("IM_M_USER_NO_ACCESS")}for(var t in e.CHAT){this.BXIM.messenger.chat[t]=e.CHAT[t]}for(var t in e.USER_IN_CHAT){this.BXIM.messenger.userInChat[t]=e.USER_IN_CHAT[t]}for(var t in e.USER_BLOCK_CHAT){this.BXIM.messenger.userChatBlockStatus[t]=e.USER_BLOCK_CHAT[t]}if(this.BXIM.messenger.currentTab=="chat"+e.CHAT_ID){if(this.BXIM.messenger.chat[e.CHAT_ID]&&this.BXIM.messenger.chat[e.CHAT_ID].style=="call"){this.BXIM.messenger.openCallFlag=true}}this.BXIM.messenger.dialogStatusRedraw()}},this)})};s.MessengerCommon.prototype.loadLastMessage=function(t,r){if(this.BXIM.messenger.loadLastMessageTimeout[t])return false;this.BXIM.messenger.historyWindowBlock=true;delete this.BXIM.messenger.redrawTab[t];this.BXIM.messenger.loadLastMessageTimeout[t]=true;s.ajax({url:this.BXIM.pathToAjax+"?LOAD_LAST_MESSAGE&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:90,data:{IM_LOAD_LAST_MESSAGE:"Y",CHAT:r?"Y":"N",USER_ID:t,USER_LOAD:r?this.BXIM.messenger.chat[t.toString().substr(4)]&&this.BXIM.messenger.chat[t.toString().substr(4)].fake?"Y":"N":"Y",TAB:this.BXIM.messenger.currentTab,READ:this.BXIM.messenger.BXIM.isFocus()?"Y":"N",MOBILE:this.isMobile()?"Y":"N",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(i){this.BXIM.messenger.loadLastMessageTimeout[t]=false;if(!i)return false;if(i&&i.BITRIX_SESSID){s.message({bitrix_sessid:i.BITRIX_SESSID})}if(i.ERROR==""){if(!r){this.BXIM.messenger.userChat[t]=i.CHAT_ID;s.MessengerCommon.getUserParam(t,true);this.BXIM.messenger.users[t].name=s.message("IM_M_USER_NO_ACCESS")}for(var n in i.USERS){this.BXIM.messenger.users[n]=i.USERS[n]}for(var n in i.PHONES){this.BXIM.messenger.phones[n]={};for(var a in i.PHONES[n]){this.BXIM.messenger.phones[n][a]=s.util.htmlspecialcharsback(i.PHONES[n][a])}}for(var n in i.USER_IN_GROUP){if(typeof this.BXIM.messenger.userInGroup[n]=="undefined"){this.BXIM.messenger.userInGroup[n]=i.USER_IN_GROUP[n]}else{for(var a=0;a<i.USER_IN_GROUP[n].users.length;a++)this.BXIM.messenger.userInGroup[n].users.push(i.USER_IN_GROUP[n].users[a]);this.BXIM.messenger.userInGroup[n].users=s.util.array_unique(this.BXIM.messenger.userInGroup[n].users)}}for(var n in i.WO_USER_IN_GROUP){if(typeof this.BXIM.messenger.woUserInGroup[n]=="undefined"){this.BXIM.messenger.woUserInGroup[n]=i.WO_USER_IN_GROUP[n]}else{for(var a=0;a<i.WO_USER_IN_GROUP[n].users.length;a++)this.BXIM.messenger.woUserInGroup[n].users.push(i.WO_USER_IN_GROUP[n].users[a]);this.BXIM.messenger.woUserInGroup[n].users=s.util.array_unique(this.BXIM.messenger.woUserInGroup[n].users)}}for(var n in i.READED_LIST){i.READED_LIST[n].date=parseInt(i.READED_LIST[n].date)+parseInt(s.message("USER_TZ_OFFSET"));this.BXIM.messenger.readedList[n]=i.READED_LIST[n]}if(!r&&i.USER_LOAD=="Y")s.MessengerCommon.userListRedraw();for(var n in i.FILES){if(!this.BXIM.messenger.disk.files[i.CHAT_ID])this.BXIM.messenger.disk.files[i.CHAT_ID]={};i.FILES[n].date=parseInt(i.FILES[n].date)+parseInt(s.message("USER_TZ_OFFSET"));this.BXIM.messenger.disk.files[i.CHAT_ID][n]=i.FILES[n]}this.BXIM.messenger.sendAjaxTry=0;var o=0;for(var n in i.MESSAGE){o++;i.MESSAGE[n].date=parseInt(i.MESSAGE[n].date)+parseInt(s.message("USER_TZ_OFFSET"));this.BXIM.messenger.message[n]=i.MESSAGE[n];this.BXIM.lastRecordId=parseInt(n)>this.BXIM.lastRecordId?parseInt(n):this.BXIM.lastRecordId}if(o<=0)delete this.BXIM.messenger.redrawTab[i.USER_ID];for(var n in i.USERS_MESSAGE){if(this.BXIM.messenger.showMessage[n])this.BXIM.messenger.showMessage[n]=s.util.array_unique(s.util.array_merge(i.USERS_MESSAGE[n],this.BXIM.messenger.showMessage[n]));else this.BXIM.messenger.showMessage[n]=i.USERS_MESSAGE[n]}if(r&&this.BXIM.messenger.chat[i.USER_ID.substr(4)].fake){this.BXIM.messenger.chat[i.USER_ID.toString().substr(4)].name=s.message("IM_M_USER_NO_ACCESS")}for(var n in i.CHAT){this.BXIM.messenger.chat[n]=i.CHAT[n]}for(var n in i.USER_IN_CHAT){this.BXIM.messenger.userInChat[n]=i.USER_IN_CHAT[n]}for(var n in i.USER_BLOCK_CHAT){this.BXIM.messenger.userChatBlockStatus[n]=i.USER_BLOCK_CHAT[n]}if(this.BXIM.messenger.currentTab==i.USER_ID){if(this.BXIM.messenger.currentTab.toString().substr(0,4)=="chat"&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)]&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].style=="call"){this.BXIM.messenger.openCallFlag=true}}s.MessengerCommon.drawTab(i.USER_ID,this.BXIM.messenger.currentTab==i.USER_ID);if(this.BXIM.messenger.currentTab==i.USER_ID&&this.BXIM.messenger.readedList[i.USER_ID])s.MessengerCommon.drawReadMessage(i.USER_ID,this.BXIM.messenger.readedList[i.USER_ID].messageId,this.BXIM.messenger.readedList[i.USER_ID].date,false);this.BXIM.messenger.historyWindowBlock=false;if(this.BXIM.isFocus()){s.MessengerCommon.readMessage(i.USER_ID,true,false)}}else{this.BXIM.messenger.redrawTab[t]=true;if(i.ERROR=="ACCESS_DENIED"){this.BXIM.messenger.currentTab=0;this.BXIM.messenger.openChatFlag=false;this.BXIM.messenger.openCallFlag=false;this.BXIM.messenger.extraClose()}else if(i.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate(function(){this.loadLastMessage(t,r)},this),2e3);s.onCustomEvent(e,"onImError",[i.ERROR,i.BITRIX_SESSID])}else if(i.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;if(this.BXIM.desktop&&this.BXIM.desktop.ready()){setTimeout(s.delegate(function(){this.loadLastMessage(t,r)},this),1e4)}s.onCustomEvent(e,"onImError",[i.ERROR])}}},this),onfailure:s.delegate(function(){this.BXIM.messenger.loadLastMessageTimeout[t]=false;this.BXIM.messenger.historyWindowBlock=false;this.BXIM.messenger.sendAjaxTry=0;this.BXIM.messenger.redrawTab[t]=true},this)})};s.MessengerCommon.prototype.openDialog=function(e,t,r){var i=s.MessengerCommon.getUserParam(e);if(i.id<=0)return false;this.BXIM.messenger.currentTab=e;if(e.toString().substr(0,4)=="chat"){this.BXIM.messenger.openChatFlag=true;if(this.BXIM.messenger.chat[e.toString().substr(4)]&&this.BXIM.messenger.chat[e.toString().substr(4)].style=="call")this.BXIM.messenger.openCallFlag=true}s.localStorage.set("mct",this.BXIM.messenger.currentTab,15);this.BXIM.messenger.dialogStatusRedraw();if(!this.isMobile()){this.BXIM.messenger.popupMessengerPanel.className=this.BXIM.messenger.openChatFlag?"bx-messenger-panel bx-messenger-hide":"bx-messenger-panel";if(this.BXIM.messenger.openChatFlag){this.BXIM.messenger.popupMessengerPanel2.className=this.BXIM.messenger.openCallFlag?"bx-messenger-panel bx-messenger-hide":"bx-messenger-panel";this.BXIM.messenger.popupMessengerPanel3.className=this.BXIM.messenger.openCallFlag?"bx-messenger-panel":"bx-messenger-panel bx-messenger-hide"}else{this.BXIM.messenger.popupMessengerPanel2.className="bx-messenger-panel bx-messenger-hide";this.BXIM.messenger.popupMessengerPanel3.className="bx-messenger-panel bx-messenger-hide"}}t=t==true;r=r!=false;var n=[];if(typeof this.BXIM.messenger.showMessage[e]!="undefined"&&this.BXIM.messenger.showMessage[e].length>0){if(!i.fake&&this.BXIM.messenger.showMessage[e].length>=15){this.BXIM.messenger.redrawTab[e]=false}else{this.drawTab(e,true);this.BXIM.messenger.redrawTab[e]=true}}else if(this.BXIM.messenger.popupMessengerConnectionStatusState!="online"){n=[s.create("div",{props:{className:"bx-messenger-content-empty"},children:[s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_LOAD_ERROR")})]})];this.BXIM.messenger.redrawTab[e]=true}else if(typeof this.BXIM.messenger.showMessage[e]=="undefined"){n=[s.create("div",{props:{className:"bx-messenger-content-load"},children:[s.create("span",{props:{className:"bx-messenger-content-load-img"}}),s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_LOAD_MESSAGE")})]})];this.BXIM.messenger.redrawTab[e]=true}else if(this.BXIM.messenger.redrawTab[e]&&this.BXIM.messenger.showMessage[e].length==0){n=[s.create("div",{props:{className:"bx-messenger-content-load"},children:[s.create("span",{props:{className:"bx-messenger-content-load-img"}}),s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_LOAD_MESSAGE")})]})];this.BXIM.messenger.showMessage[e]=[]}else{n=[s.create("div",{props:{className:"bx-messenger-content-empty"},children:[s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message(this.BXIM.settings.loadLastMessage?"IM_M_NO_MESSAGE_2":"IM_M_NO_MESSAGE")})]})]}if(n.length>0){this.BXIM.messenger.popupMessengerBodyWrap.innerHTML="";s.adjust(this.BXIM.messenger.popupMessengerBodyWrap,{children:n})}if(t)this.BXIM.messenger.extraClose();if(this.isMobile()){BXMobileApp.UI.Page.TextPanel.setText(this.BXIM.messenger.textareaHistory[e]?this.BXIM.messenger.textareaHistory[e]:"")}else{this.BXIM.messenger.popupMessengerTextarea.value=this.BXIM.messenger.textareaHistory[e]?this.BXIM.messenger.textareaHistory[e]:""}if(this.BXIM.messenger.redrawTab[e]){if(this.BXIM.settings.loadLastMessage){this.loadLastMessage(e,this.BXIM.messenger.openChatFlag)}else{if(this.BXIM.messenger.openChatFlag)s.MessengerCommon.loadChatData(e.toString().substr(4));else s.MessengerCommon.loadUserData(e);delete this.BXIM.messenger.redrawTab[e];this.drawTab(e,true)}}else{this.drawTab(e,true)}if(!this.BXIM.messenger.redrawTab[e]){if(this.isMobile()){this.BXIM.isFocusMobile(s.delegate(function(t){if(t){s.MessengerCommon.readMessage(e)}},this))}else if(this.BXIM.isFocus()){this.readMessage(e)}}if(!this.isMobile())this.BXIM.messenger.resizeMainWindow();if(s.MessengerCommon.countWriting(e)){if(this.BXIM.messenger.openChatFlag)s.MessengerCommon.drawWriting(0,e);else s.MessengerCommon.drawWriting(e)}else if(this.BXIM.messenger.readedList[e]){this.drawReadMessage(e,this.BXIM.messenger.readedList[e].messageId,this.BXIM.messenger.readedList[e].date,false)}if(!this.isMobile()&&r)this.BXIM.webrtc.callOverlayToggleSize(true);s.onCustomEvent("onImDialogOpen",[{id:e}]);if(this.isMobile()){app.onCustomEvent("onImDialogOpen",{id:e})}};s.MessengerCommon.prototype.drawTab=function(e,t){if(this.BXIM.messenger.popupMessenger==null||e!=this.BXIM.messenger.currentTab)return false;this.BXIM.messenger.dialogStatusRedraw();this.BXIM.messenger.popupMessengerBodyWrap.innerHTML="";if(!this.BXIM.messenger.showMessage[e]||this.BXIM.messenger.showMessage[e].length<=0){this.BXIM.messenger.popupMessengerBodyWrap.appendChild(s.create("div",{props:{className:"bx-messenger-content-empty"},children:[s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message(this.BXIM.settings.loadLastMessage?"IM_M_NO_MESSAGE_2":"IM_M_NO_MESSAGE")})]}))}if(this.BXIM.messenger.showMessage[e])this.BXIM.messenger.showMessage[e].sort(s.delegate(function(e,s){if(!this.BXIM.messenger.message[e]||!this.BXIM.messenger.message[s]){return 0}var t=parseInt(this.BXIM.messenger.message[e].date);var r=parseInt(this.BXIM.messenger.message[s].date);if(t<r){return-1}else if(t>r){return 1}else{if(e<s){return-1}else if(e>s){return 1}else{return 0}}},this));else this.BXIM.messenger.showMessage[e]=[];for(var r=0;r<this.BXIM.messenger.showMessage[e].length;r++)s.MessengerCommon.drawMessage(e,this.BXIM.messenger.message[this.BXIM.messenger.showMessage[e][r]],false);t=t!=false;if(t){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();if(this.BXIM.messenger.unreadMessage[e]&&this.BXIM.messenger.unreadMessage[e].length>0){var i=s("im-message-"+this.BXIM.messenger.unreadMessage[e][0]);if(i)this.BXIM.messenger.popupMessengerBody.scrollTop=i.offsetTop-60-this.BXIM.messenger.popupMessengerBodyWrap.offsetTop;else this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}delete this.BXIM.messenger.redrawTab[e]};s.MessengerCommon.prototype.sendMessageAjax=function(t,r,i,n){if(this.BXIM.messenger.popupMessengerConnectionStatusState!="online")return false;s.MessengerCommon.drawProgessMessage("temp"+t);if(this.BXIM.messenger.sendMessageFlag<0)this.BXIM.messenger.sendMessageFlag=0;clearTimeout(this.BXIM.messenger.sendMessageTmpTimeout["temp"+t]);if(this.BXIM.messenger.sendMessageTmp[t])return false;this.BXIM.messenger.sendMessageTmp[t]=true;n=n==true;this.BXIM.messenger.sendMessageFlag++;s.MessengerCommon.recentListAdd({id:"temp"+t,date:s.MessengerCommon.getNowDate()+parseInt(s.message("SERVER_TZ_OFFSET")),skipDateCheck:true,recipientId:r,senderId:this.BXIM.userId,text:s.MessengerCommon.prepareText(i,true),userId:r,params:{}},true);var a=s.ajax({url:this.BXIM.pathToAjax+"?MESSAGE_SEND&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:60,data:{IM_SEND_MESSAGE:"Y",CHAT:n?"Y":"N",ID:"temp"+t,RECIPIENT_ID:r,MESSAGE:i,TAB:this.BXIM.messenger.currentTab,USER_TZ_OFFSET:s.message("USER_TZ_OFFSET"),IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(a){this.BXIM.messenger.sendMessageFlag--;if(a&&a.BITRIX_SESSID){s.message({bitrix_sessid:a.BITRIX_SESSID})}if(a.ERROR==""){this.BXIM.messenger.sendAjaxTry=0;this.BXIM.messenger.message[a.TMP_ID].text=a.SEND_MESSAGE;this.BXIM.messenger.message[a.TMP_ID].date=parseInt(a.SEND_DATE);this.BXIM.messenger.message[a.TMP_ID].id=a.ID;this.BXIM.messenger.message[a.ID]=this.BXIM.messenger.message[a.TMP_ID];if(this.BXIM.messenger.popupMessengerLastMessage==a.TMP_ID)this.BXIM.messenger.popupMessengerLastMessage=a.ID;delete this.BXIM.messenger.message[a.TMP_ID];var o=this.BXIM.messenger.message[a.ID];var m=s.util.array_search(""+a.TMP_ID+"",this.BXIM.messenger.showMessage[a.RECIPIENT_ID]);if(this.BXIM.messenger.showMessage[a.RECIPIENT_ID][m])this.BXIM.messenger.showMessage[a.RECIPIENT_ID][m]=""+a.ID+"";for(var g=0;g<this.BXIM.messenger.recent.length;g++){if(this.BXIM.messenger.recent[g].id==a.TMP_ID){this.BXIM.messenger.recent[g].id=""+a.ID+"";break}}if(a.RECIPIENT_ID==this.BXIM.messenger.currentTab){var l=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-messageid":""+a.TMP_ID+""}},true);if(l){l.setAttribute("data-messageid",""+a.ID+"");if(l.getAttribute("data-blockmessageid")==""+a.TMP_ID+""){l.setAttribute("data-blockmessageid",""+a.ID+"")}else{var h=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-blockmessageid":""+a.TMP_ID+""}},true);if(h){h.setAttribute("data-blockmessageid",""+a.ID+"")}}}var I=s("im-message-"+a.TMP_ID);if(I){I.id="im-message-"+a.ID;I.innerHTML=s.MessengerCommon.prepareText(a.SEND_MESSAGE,false,true,true)}var M=this.BXIM.messenger.users[o.senderId];var p=s.findChildByClassName(l,"bx-messenger-content-item-date");if(p)p.innerHTML=" &nbsp; "+s.MessengerCommon.formatDate(o.date,s.MessengerCommon.getDateFormatType("MESSAGE"));s.MessengerCommon.clearProgessMessage(a.ID)}if(this.BXIM.messenger.history[a.RECIPIENT_ID])this.BXIM.messenger.history[a.RECIPIENT_ID].push(o.id);else this.BXIM.messenger.history[a.RECIPIENT_ID]=[o.id];this.BXIM.messenger.updateStateVeryFastCount=2;this.BXIM.messenger.updateStateFastCount=5;this.BXIM.messenger.setUpdateStateStep();if(s.PULL){s.PULL.setUpdateStateStepCount(2,5)}s.MessengerCommon.updateStateVar(a,true,true);s.localStorage.set("msm",{id:a.ID,recipientId:a.RECIPIENT_ID,date:a.SEND_DATE,text:a.SEND_MESSAGE,senderId:this.BXIM.userId,MESSAGE:a.MESSAGE,USERS_MESSAGE:a.USERS_MESSAGE,USERS:a.USERS,USER_IN_GROUP:a.USER_IN_GROUP,WO_USER_IN_GROUP:a.WO_USER_IN_GROUP},5);if(this.BXIM.animationSupport){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();(this.BXIM.messenger.popupMessengerBodyAnimation=new s.easing({duration:800,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)},transition:s.easing.makeEaseInOut(s.easing.transitions.quart),step:s.delegate(function(e){this.BXIM.messenger.popupMessengerBody.scrollTop=e.scroll},this)})).animate()}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}if(!this.MobileActionEqual("RECENT")&&this.BXIM.messenger.recentList)s.MessengerCommon.recentListRedraw()}else{if(a.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate(function(){this.BXIM.messenger.sendMessageTmp[t]=false;this.sendMessageAjax(t,r,i,n)},this),2e3);s.onCustomEvent(e,"onImError",[a.ERROR,a.BITRIX_SESSID])}else if(a.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;if(this.BXIM.desktop&&this.BXIM.desktop.ready()){setTimeout(s.delegate(function(){this.BXIM.messenger.sendMessageTmp[t]=false;this.sendMessageAjax(t,r,i,n)},this),1e4)}s.onCustomEvent(e,"onImError",[a.ERROR])}else{this.BXIM.messenger.sendMessageTmp[t]=false;var l=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-messageid":"temp"+t}},true);var p=s.findChildByClassName(l,"bx-messenger-content-item-date");if(p){if(a.ERROR=="SESSION_ERROR"||a.ERROR=="AUTHORIZE_ERROR"||a.ERROR=="UNKNOWN_ERROR"||a.ERROR=="IM_MODULE_NOT_INSTALLED")p.innerHTML=s.message("IM_M_NOT_DELIVERED");else p.innerHTML=a.ERROR}s.onCustomEvent(e,"onImError",["SEND_ERROR",a.ERROR,a.TMP_ID,a.SEND_DATE,a.SEND_MESSAGE,a.RECIPIENT_ID]);s.MessengerCommon.drawProgessMessage("temp"+t,{title:s.message("IM_M_RETRY"),chat:n?"Y":"N"});if(this.BXIM.messenger.message["temp"+t])this.BXIM.messenger.message["temp"+t].retry=true}}},this),onfailure:s.delegate(function(){this.BXIM.messenger.sendMessageFlag--;this.BXIM.messenger.sendMessageTmp[t]=false;var r=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-messageid":"temp"+t}},true);var i=s.findChildByClassName(r,"bx-messenger-content-item-date");if(i)i.innerHTML=s.message("IM_M_NOT_DELIVERED");s.MessengerCommon.drawProgessMessage("temp"+t,{title:s.message("IM_M_RETRY"),chat:n?"Y":"N"});this.BXIM.messenger.sendAjaxTry=0;try{if(typeof a=="object"&&a.status==0)s.onCustomEvent(e,"onImError",["CONNECT_ERROR"])}catch(o){}if(this.BXIM.messenger.message["temp"+t])this.BXIM.messenger.message["temp"+t].retry=true},this)})};s.MessengerCommon.prototype.sendMessageRetry=function(){var e=this.BXIM.messenger.currentTab;var t=[];for(var r=0;r<this.BXIM.messenger.showMessage[e].length;r++){var i=this.BXIM.messenger.message[this.BXIM.messenger.showMessage[e][r]];if(!i||i.id.indexOf("temp")!=0)continue;i.text=s.MessengerCommon.prepareTextBack(i.text);t.push(i)}if(t.length<=0)return false;t.sort(function(e,s){e=e.id.substr(4);s=s.id.substr(4);if(e<s){return-1}else if(e>s){return 1}else{return 0}});for(var r=0;r<t.length;r++){var n=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-messageid":""+t[r].id+""}},true);var a=s.findChildByClassName(n,"bx-messenger-content-item-date");if(a)a.innerHTML=s.message("IM_M_DELIVERED");this.sendMessageRetryTimeout(t[r],100*r)}};s.MessengerCommon.prototype.sendMessageRetryTimeout=function(e,t){clearTimeout(this.BXIM.messenger.sendMessageTmpTimeout[e.id]);this.BXIM.messenger.sendMessageTmpTimeout[e.id]=setTimeout(s.delegate(function(){s.MessengerCommon.sendMessageAjax(e.id.substr(4),e.recipientId,e.text,e.recipientId.toString().substr(0,4)=="chat")},this),t)};s.MessengerCommon.prototype.messageLike=function(e,t){if(e.toString().substr(0,4)=="temp"||!this.BXIM.messenger.message[e]||this.BXIM.messenger.popupMessengerLikeBlock[e])return false;t=typeof t=="undefined"?false:t;if(!this.BXIM.messenger.message[e].params){this.BXIM.messenger.message[e].params={}}if(!this.BXIM.messenger.message[e].params.LIKE){this.BXIM.messenger.message[e].params.LIKE=[]}var r=s.util.in_array(this.BXIM.userId,this.BXIM.messenger.message[e].params.LIKE);if(!t){var i=r?"minus":"plus";if(i=="plus"){this.BXIM.messenger.message[e].params.LIKE.push(this.BXIM.userId);r=true}else{var n=[];for(var a=0;a<this.BXIM.messenger.message[e].params.LIKE.length;a++){if(this.BXIM.messenger.message[e].params.LIKE[a]!=this.BXIM.userId){n.push(this.BXIM.messenger.message[e].params.LIKE[a])}}this.BXIM.messenger.message[e].params.LIKE=n;r=false}}var o=this.BXIM.messenger.message[e].params.LIKE.length>0?this.BXIM.messenger.message[e].params.LIKE.length:"";if(s("im-message-"+e)){var m=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-blockmessageid":""+e+""}},false);var g=s.findChildByClassName(m,"bx-messenger-content-item-like");var l=s.findChildByClassName(m,"bx-messenger-content-like-digit",false);var h=s.findChildByClassName(m,"bx-messenger-content-like-button",false);if(r){h.innerHTML=s.message("IM_MESSAGE_DISLIKE");s.addClass(g,"bx-messenger-content-item-liked")}else{h.innerHTML=s.message("IM_MESSAGE_LIKE");s.removeClass(g,"bx-messenger-content-item-liked")}if(o>0){l.setAttribute("title",s.message("IM_MESSAGE_LIKE_LIST"));s.removeClass(l,"bx-messenger-content-like-digit-off")}else{l.setAttribute("title","");s.addClass(l,"bx-messenger-content-like-digit-off")}l.innerHTML=o}if(!t){clearTimeout(this.BXIM.messenger.popupMessengerLikeBlockTimeout[e]);this.BXIM.messenger.popupMessengerLikeBlockTimeout[e]=setTimeout(s.delegate(function(){this.BXIM.messenger.popupMessengerLikeBlock[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?MESSAGE_LIKE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_LIKE_MESSAGE:"Y",ID:e,ACTION:i,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){if(t.ERROR==""){this.BXIM.messenger.message[e].params.LIKE=t.LIKE}this.BXIM.messenger.popupMessengerLikeBlock[e]=false;s.MessengerCommon.messageLike(e,true)},this),onfailure:s.delegate(function(s){this.BXIM.messenger.popupMessengerLikeBlock[e]=false},this)})},this),1e3)}return true};s.MessengerCommon.prototype.messageIsLike=function(e){return typeof this.BXIM.messenger.message[e].params.LIKE=="object"&&s.util.in_array(this.BXIM.userId,this.BXIM.messenger.message[e].params.LIKE)};s.MessengerCommon.prototype.checkEditMessage=function(e){var t=false;if(this.BXIM.ppServerStatus&&parseInt(e)!=0&&e.toString().substr(0,4)!="temp"&&this.BXIM.messenger.message[e]&&this.BXIM.messenger.message[e].senderId==this.BXIM.userId&&parseInt(this.BXIM.messenger.message[e].date)+259200>(new Date).getTime()/1e3&&(!this.BXIM.messenger.message[e].params||this.BXIM.messenger.message[e].params.IS_DELETED!="Y")&&s("im-message-"+e)&&s.util.in_array(e,this.BXIM.messenger.showMessage[this.BXIM.messenger.currentTab])){t=true}return t};s.MessengerCommon.prototype.deleteMessageAjax=function(e){this.BXIM.messenger.editMessageCancel();if(!s.MessengerCommon.checkEditMessage(e))return false;s.MessengerCommon.drawProgessMessage(e);s.ajax({url:this.BXIM.pathToAjax+"?MESSAGE_DELETE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_DELETE_MESSAGE:"Y",ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(t){if(t.ERROR)return false;s.MessengerCommon.clearProgessMessage(e)},this),onfailure:s.delegate(function(){s.MessengerCommon.clearProgessMessage(e)},this)});return true};s.MessengerCommon.prototype.diskDrawFiles=function(e,t,r){if(!this.BXIM.disk.enable)return[];if(typeof this.BXIM.disk.files[e]=="undefined")return[];var i=[];if(typeof t!="object"){if(typeof this.BXIM.disk.files[e][t]=="undefined")return[];i.push(t)}else{i=t}r=r||{};var n=this.isMobile()?"mobile":this.BXIM.desktop.ready()?"desktop":"default";var a=true;var o=[];for(var m=0;m<i.length;m++){var g=this.BXIM.disk.files[e][i[m]];if(!g)continue;if(r.status){if(typeof r.status!="object"){r.status=[r.status]}if(!s.util.in_array(g.status,r.status)){continue}}var l=null;if(g.type=="image"&&(g.preview||g.urlPreview[n])){var h=null;if(this.isMobile()&&g.preview&&typeof g.preview!="string"){if(g.urlPreview[n]){var h=s.create("div",{attrs:{src:g.urlPreview[n]},props:{className:"bx-messenger-file-image-text bx-messenger-hide"}})}}if(g.preview&&typeof g.preview!="string"){var I=g.preview;if(g.urlPreview[n]){g.preview=""}}else{var I=s.create("img",{attrs:{src:g.urlPreview[n]?g.urlPreview[n]:g.preview},props:{className:"bx-messenger-file-image-text"}})}if(a&&g.urlShow[n]){if(this.isMobile()&&g.urlPreview[n]){l=s.create("div",{props:{className:"bx-messenger-file-preview"},children:[s.create("span",{props:{className:"bx-messenger-file-image"},children:[s.create("span",{events:{click:s.delegate(function(){this.BXIM.messenger.openPhotoGallery(g.urlPreview[n])},this)},props:{className:"bx-messenger-file-image-src"},children:[h,I]})]}),s.create("br")]})}else{l=s.create("div",{props:{className:"bx-messenger-file-preview"},children:[s.create("span",{props:{className:"bx-messenger-file-image"},children:[s.create("a",{attrs:{href:g.urlShow[n],target:"_blank"},props:{className:"bx-messenger-file-image-src"},children:[I]})]}),s.create("br")]})}}else{l=s.create("div",{props:{className:"bx-messenger-file-preview"},children:[s.create("span",{props:{className:"bx-messenger-file-image"},children:[s.create("span",{props:{className:"bx-messenger-file-image-src"},children:[I]})]}),s.create("br")]})}}var M=g.name;if(this.isMobile()){if(M.length>20){M=M.substr(0,8)+"..."+M.substr(M.length-13,M.length)}}else{if(M.length>40){M=M.substr(0,20)+"..."+M.substr(M.length-23,M.length)}}var p=s.create("span",{attrs:{title:g.name},props:{className:"bx-messenger-file-title"},children:[s.create("span",{props:{className:"bx-messenger-file-title-name"},html:M})]});if(a&&(g.urlShow[n]||g.urlDownload[n])){if(this.isMobile())p=s.create("span",{props:{className:"bx-messenger-file-title-href"},events:{click:function(){s.localStorage.set("impmh",true,1);app.openDocument({url:g.urlDownload["mobile"],filename:M})}},children:[p]});else p=s.create("a",{props:{className:"bx-messenger-file-title-href"},attrs:{href:g.urlShow?g.urlShow[n]:g.urlDownload[n],target:"_blank"},children:[p]})}p=s.create("div",{props:{className:"bx-messenger-file-attrs"},children:[p,s.create("span",{props:{className:"bx-messenger-file-size"},html:s.UploaderUtils.getFormattedSize(g.size)})]});var d=null;if(g.status=="done"){if(!this.isMobile()){d=s.create("div",{props:{className:"bx-messenger-file-download"},children:[!g.urlDownload||!a?null:s.create("a",{attrs:{href:g.urlDownload[n],target:"_blank"},props:{className:"bx-messenger-file-download-link bx-messenger-file-download-pc"},html:s.message("IM_F_DOWNLOAD")}),!g.urlDownload||!this.BXIM.disk.enable?null:s.create("span",{props:{className:"bx-messenger-file-download-link bx-messenger-file-download-disk"},html:s.message("IM_F_DOWNLOAD_DISK"),events:{click:s.delegate(function(){var e=s.proxy_context.parentNode.parentNode.getAttribute("data-chatId");var t=s.proxy_context.parentNode.parentNode.getAttribute("data-fileId");var r=s.proxy_context.parentNode.parentNode.getAttribute("data-boxId");this.BXIM.disk.saveToDisk(e,t,{boxId:r})},this)}})]})}else{d=s.create("div",{props:{className:"bx-messenger-file-download"},children:[]})}}else if(g.status=="upload"){var u={};var f="";var c=null;var B="";var X="";if(g.authorId==this.BXIM.userId&&g.progress>=0){X=s.message("IM_F_UPLOAD_2").replace("#PERCENT#",g.progress);u={width:g.progress+"%"};c=s.create("span",{attrs:{title:s.message("IM_F_CANCEL")},props:{className:"bx-messenger-file-delete"}})}else{X=s.message("IM_F_UPLOAD");B=" bx-messenger-file-progress-infinite"}d=s.create("div",{props:{className:"bx-messenger-progress-box"},children:[s.create("span",{attrs:{title:X},props:{className:"bx-messenger-file-progress"},children:[s.create("span",{props:{className:"bx-messenger-file-progress-line"+B},style:u})]}),c]})}else if(g.status=="error"){d=s.create("span",{props:{className:"bx-messenger-file-status-error"},html:g.errorText?g.errorText:s.message("IM_F_ERROR")})}if(!d)return false;if(i.length==1&&r.showInner=="Y"){o=[l,p,d]}else{var E=r.boxId?r.boxId:"im-file";o.push(s.create("div",{attrs:{id:E+"-"+g.id,"data-chatId":g.chatId,"data-fileId":g.id,"data-boxId":E},props:{className:"bx-messenger-file"},children:[l,p,d]}))}}return o};s.MessengerCommon.prototype.diskRedrawFile=function(e,t,r){r=r||{};var i=r.boxId?r.boxId:"im-file";var n=s(i+"-"+t);if(n){var a=this.diskDrawFiles(e,t,{showInner:"Y",boxId:i});if(a){n.innerHTML="";s.adjust(n,{children:a})}}};s.MessengerCommon.prototype.diskChatDialogFileInited=function(e,t,r){var i=r.form.CHAT_ID.value;if(!this.BXIM.disk.files[i])this.BXIM.disk.files[i]={};this.BXIM.disk.files[i][e]={id:e,tempId:e,chatId:i,date:s.MessengerCommon.getNowDate(),type:t.isImage?"image":"file",preview:t.isImage?t.canvas:"",name:t.name,size:t.file.size,status:"upload",progress:-1,authorId:this.BXIM.userId,authorName:this.BXIM.messenger.users[this.BXIM.userId].name,urlPreview:"",urlShow:"",urlDownload:""};if(!this.BXIM.disk.filesRegister[i])this.BXIM.disk.filesRegister[i]={};this.BXIM.disk.filesRegister[i][e]={id:e,type:this.BXIM.disk.files[i][e].type,mimeType:t.file.type,name:this.BXIM.disk.files[i][e].name,size:this.BXIM.disk.files[i][e].size};this.diskChatDialogFileRegister(i)};s.MessengerCommon.prototype.diskChatDialogFileRegister=function(t){clearTimeout(this.BXIM.disk.timeout[t]);this.BXIM.disk.timeout[t]=setTimeout(s.delegate(function(){var r=0;if(this.BXIM.messenger.chat[t]&&this.BXIM.messenger.chat[t].style!="private"){r="chat"+t}else{for(var i in this.BXIM.messenger.userChat){if(this.BXIM.messenger.userChat[i]==t){r=i;break}}}if(!r)return false;var n=[];for(var a in this.BXIM.disk.filesRegister[t]){n.push(a)}var o="tempFile"+this.BXIM.disk.fileTmpId;this.BXIM.messenger.message[o]={id:o,chatId:t,senderId:this.BXIM.userId,recipientId:r,date:s.MessengerCommon.getNowDate(),text:"",params:{FILE_ID:n}};if(!this.BXIM.messenger.showMessage[r])this.BXIM.messenger.showMessage[r]=[];this.BXIM.messenger.showMessage[r].push(o);s.MessengerCommon.drawMessage(r,this.BXIM.messenger.message[o]);s.MessengerCommon.drawProgessMessage(o);this.BXIM.messenger.sendMessageFlag++;this.BXIM.messenger.popupMessengerFileFormInput.setAttribute("disabled",true);this.BXIM.disk.OldBeforeUnload=e.onbeforeunload;e.onbeforeunload=function(){if(typeof s.PULL!="undefined"&&typeof s.PULL.tryConnectDelay=="function"){s.PULL.tryConnectDelay()}return s.message("IM_F_EFP")};s.ajax({url:this.BXIM.pathToFileAjax+"?FILE_REGISTER&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_FILE_REGISTER:"Y",CHAT_ID:t,RECIPIENT_ID:r,MESSAGE_TMP_ID:o,FILES:JSON.stringify(this.BXIM.disk.filesRegister[t]),IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate(function(i){if(i.ERROR!=""){this.BXIM.messenger.sendMessageFlag--;delete this.BXIM.messenger.message[o];s.MessengerCommon.drawTab(r);e.onbeforeunload=this.BXIM.disk.OldBeforeUnload;this.BXIM.disk.filesRegister[t]={};if(this.BXIM.disk.formAgents["imDialog"]["clear"])this.BXIM.disk.formAgents["imDialog"].clear();return false}this.BXIM.messenger.sendMessageFlag--;var n=[];var a={};for(var m in i.FILE_ID){var g=i.FILE_ID[m];delete this.BXIM.disk.filesRegister[i.CHAT_ID][g.TMP_ID];if(parseInt(g.FILE_ID)>0){a[g.TMP_ID]=g.FILE_ID;this.BXIM.disk.filesProgress[g.TMP_ID]=g.FILE_ID;this.BXIM.disk.filesMessage[g.TMP_ID]=i.MESSAGE_ID;this.BXIM.disk.files[i.CHAT_ID][g.FILE_ID]={};for(var l in this.BXIM.disk.files[i.CHAT_ID][g.TMP_ID])this.BXIM.disk.files[i.CHAT_ID][g.FILE_ID][l]=this.BXIM.disk.files[i.CHAT_ID][g.TMP_ID][l];

this.BXIM.disk.files[i.CHAT_ID][g.FILE_ID]["id"]=g.FILE_ID;delete this.BXIM.disk.files[i.CHAT_ID][g.TMP_ID];this.BXIM.disk.files[i.CHAT_ID][g.FILE_ID]["name"]=g.FILE_NAME;if(s("im-file-"+g.TMP_ID)){s("im-file-"+g.TMP_ID).setAttribute("data-fileId",g.FILE_ID);s("im-file-"+g.TMP_ID).id="im-file-"+g.FILE_ID;s.MessengerCommon.diskRedrawFile(i.CHAT_ID,g.FILE_ID)}n.push(g.FILE_ID)}else{this.BXIM.disk.files[i.CHAT_ID][g.TMP_ID]["status"]="error";s.MessengerCommon.diskRedrawFile(i.CHAT_ID,g.TMP_ID)}}this.BXIM.messenger.message[i.MESSAGE_ID]=s.clone(this.BXIM.messenger.message[i.MESSAGE_TMP_ID]);this.BXIM.messenger.message[i.MESSAGE_ID]["id"]=i.MESSAGE_ID;this.BXIM.messenger.message[i.MESSAGE_ID]["params"]["FILE_ID"]=n;if(this.BXIM.messenger.popupMessengerLastMessage==i.MESSAGE_TMP_ID)this.BXIM.messenger.popupMessengerLastMessage=i.MESSAGE_ID;delete this.BXIM.messenger.message[i.MESSAGE_TMP_ID];var h=s.util.array_search(""+i.MESSAGE_TMP_ID+"",this.BXIM.messenger.showMessage[i.RECIPIENT_ID]);if(this.BXIM.messenger.showMessage[i.RECIPIENT_ID][h])this.BXIM.messenger.showMessage[i.RECIPIENT_ID][h]=""+i.MESSAGE_ID+"";if(s("im-message-"+i.MESSAGE_TMP_ID)){s("im-message-"+i.MESSAGE_TMP_ID).id="im-message-"+i.MESSAGE_ID;var I=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-messageid":""+i.MESSAGE_TMP_ID}},true);if(I){I.setAttribute("data-messageid",""+i.MESSAGE_ID+"");if(I.getAttribute("data-blockmessageid")==""+i.MESSAGE_TMP_ID)I.setAttribute("data-blockmessageid",""+i.MESSAGE_ID+"")}else{var M=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-blockmessageid":""+i.MESSAGE_TMP_ID}},true);if(M){M.setAttribute("data-blockmessageid",""+i.MESSAGE_ID+"")}}var p=s.findChildByClassName(I,"bx-messenger-content-item-date");if(p)p.innerHTML=" &nbsp; "+s.MessengerCommon.formatDate(this.BXIM.messenger.message[i.MESSAGE_ID].date,s.MessengerCommon.getDateFormatType("MESSAGE"))}s.MessengerCommon.clearProgessMessage(i.MESSAGE_ID);if(this.BXIM.messenger.history[i.RECIPIENT_ID])this.BXIM.messenger.history[i.RECIPIENT_ID].push(i.MESSAGE_ID);else this.BXIM.messenger.history[i.RECIPIENT_ID]=[i.MESSAGE_ID];this.BXIM.messenger.popupMessengerFileFormRegChatId.value=i.CHAT_ID;this.BXIM.messenger.popupMessengerFileFormRegMessageId.value=i.MESSAGE_ID;this.BXIM.messenger.popupMessengerFileFormRegParams.value=JSON.stringify(a);this.BXIM.disk.formAgents["imDialog"].submit();this.BXIM.messenger.popupMessengerFileFormInput.removeAttribute("disabled")},this),onfailure:s.delegate(function(){this.BXIM.messenger.sendMessageFlag--;delete this.BXIM.messenger.message[o];this.BXIM.disk.filesRegister[t]={};s.MessengerCommon.drawTab(r);e.onbeforeunload=this.BXIM.disk.OldBeforeUnload;if(this.BXIM.disk.formAgents["imDialog"]["clear"])this.BXIM.disk.formAgents["imDialog"].clear()},this)});this.BXIM.disk.fileTmpId++},this),500)};s.MessengerCommon.prototype.diskChatDialogFileStart=function(e,t,r,i){var n=this.BXIM.disk.filesProgress[e.id];formFields=r.streams.packages.getItem(i).data;if(!this.BXIM.disk.files[formFields.REG_CHAT_ID][n])return false;this.BXIM.disk.files[formFields.REG_CHAT_ID][n].progress=parseInt(t);s.MessengerCommon.diskRedrawFile(formFields.REG_CHAT_ID,n)};s.MessengerCommon.prototype.diskChatDialogFileProgress=function(e,t,r,i){var n=this.BXIM.disk.filesProgress[e.id];formFields=r.streams.packages.getItem(i).data;if(!this.BXIM.disk.files[formFields.REG_CHAT_ID][n])return false;this.BXIM.disk.files[formFields.REG_CHAT_ID][n].progress=parseInt(t);s.MessengerCommon.diskRedrawFile(formFields.REG_CHAT_ID,n)};s.MessengerCommon.prototype.diskChatDialogFileDone=function(t,r,i,n){if(!this.BXIM.disk.files[r.file.fileChatId][r.file.fileId])return false;if(this.BXIM.disk.files[r.file.fileChatId]&&this.BXIM.disk.files[r.file.fileChatId][r.file.fileId]){r.file.fileParams["preview"]=this.BXIM.disk.files[r.file.fileChatId][r.file.fileId]["preview"]}if(!this.BXIM.disk.files[r.file.fileChatId])this.BXIM.disk.files[r.file.fileChatId]={};this.BXIM.disk.files[r.file.fileChatId][r.file.fileId]=r.file.fileParams;s.MessengerCommon.diskRedrawFile(r.file.fileChatId,r.file.fileId);delete this.BXIM.disk.filesMessage[r.file.fileTmpId];e.onbeforeunload=this.BXIM.disk.OldBeforeUnload};s.MessengerCommon.prototype.diskChatDialogFileError=function(t,r,i,n){var a=this.BXIM.disk.filesProgress[t.id];formFields=i.streams.packages.getItem(n).data;if(!this.BXIM.disk.files[formFields.REG_CHAT_ID][a])return false;t.deleteFile();this.BXIM.disk.files[formFields.REG_CHAT_ID][a].status="error";this.BXIM.disk.files[formFields.REG_CHAT_ID][a].errorText=r.error;s.MessengerCommon.diskRedrawFile(formFields.REG_CHAT_ID,a);e.onbeforeunload=this.BXIM.disk.OldBeforeUnload};s.MessengerCommon.prototype.diskChatDialogUploadError=function(t,r,i){var n=JSON.parse(t.post.REG_PARAMS);var a={};for(var o in n){if(this.BXIM.disk.filesMessage[o]){delete this.BXIM.disk.filesMessage[o]}if(this.BXIM.disk.filesRegister[t.post.REG_CHAT_ID]){delete this.BXIM.disk.filesRegister[t.post.REG_CHAT_ID][o];delete this.BXIM.disk.filesRegister[t.post.REG_CHAT_ID][n[o]]}if(this.BXIM.disk.files[t.post.REG_CHAT_ID]){if(this.BXIM.disk.files[t.post.REG_CHAT_ID][n[o]]){this.BXIM.disk.files[t.post.REG_CHAT_ID][n[o]].status="error";s.MessengerCommon.diskRedrawFile(t.post.REG_CHAT_ID,n[o])}if(this.BXIM.disk.files[t.post.REG_CHAT_ID][o]){this.BXIM.disk.files[t.post.REG_CHAT_ID][o].status="error";s.MessengerCommon.diskRedrawFile(t.post.REG_CHAT_ID,o)}}delete this.BXIM.disk.filesProgress[o]}s.ajax({url:this.BXIM.pathToFileAjax+"?FILE_UNREGISTER&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_FILE_UNREGISTER:"Y",CHAT_ID:t.post.REG_CHAT_ID,FILES:t.post.REG_PARAMS,MESSAGES:JSON.stringify(a),IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()}});e.onbeforeunload=this.BXIM.disk.OldBeforeUnload;s.MessengerCommon.drawTab(this.BXIM.messenger.getRecipientByChatId(t.post.REG_CHAT_ID))};s.MessengerCommon=new s.MessengerCommon})(window);
//# sourceMappingURL=common.map.js