if(typeof BX.CrmLeadEditor==="undefined"){BX.CrmLeadEditor=function(){this._id="";this._settings={};this._prefix="";this._statusId=this._statusName=this._sourceId=this._sourceName=this._currencyId=this._currencyName=null;this._assignedById=this._assignedByName=null;this._addPhoneBtn=this._addEmailBtn=null;this._statusProgressBar=null;this._dispatcher=null;this._isDirty=false;this._contextMenuId="";this._productRowList=null;this._productRowListChangeHandler=BX.delegate(this._onProductRowListChange,this);this._leadStatusChangeCompleteHandler=BX.delegate(this._onExternalLeadStatusChange,this);this._currencyChangeCompleteHandler=BX.delegate(this._onExternalCurrencyChange,this);this._statusChangeCompleteHandler=BX.delegate(this._onExternalStatusChange,this);this._isInStatusChangeMode=false;this._isInLeadStatusChangeMode=false;this._isInCurrencyChangeMode=false;this._syncData={}};BX.CrmLeadEditor.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._prefix=this.getSetting("prefix");this._dispatcher=this.getSetting("dispatcher",null);this._currencyId=this.resolveElement("currency_id");if(this._currencyId){BX.bind(BX.findParent(this._currencyId,{className:"crm_block_container"}),"click",BX.delegate(this._onCurrencySelect,this))}this._currencyName=this.resolveElement("currency_name");this._assignedById=this.resolveElement("assigned_by_id");if(this._assignedById){BX.bind(BX.findParent(this._assignedById,{className:"crm_block_container"}),"click",BX.delegate(this._onResponsibleSelect,this))}this._assignedByName=this.resolveElement("assigned_by_name");this._addPhoneBtn=this.resolveElement("phone_add_btn");if(this._addPhoneBtn){BX.bind(this._addPhoneBtn,"click",BX.delegate(this._onPhoneAdd,this))}this._addEmailBtn=this.resolveElement("email_add_btn");if(this._addEmailBtn){BX.bind(this._addEmailBtn,"click",BX.delegate(this._onEmailAdd,this))}this._sourceId=this.resolveElement("source_id");if(this._sourceId){BX.bind(BX.findParent(this._sourceId,{className:"crm_block_container"}),"click",BX.delegate(this._onSourceSelect,this))}this._sourceName=this.resolveElement("source_name");this._statusId=this.resolveElement("status_id");this._statusName=this.resolveElement("status_name");var i=this.resolveElement("status_container");if(i){BX.bind(BX.findParent(i,{className:"crm_meeting_info"}),"click",BX.delegate(this._onStatusClick,this));var n=this.getEntityId();this._statusProgressBar=BX.CrmProgressBar.create("LEAD_"+n,{entityType:"LEAD",entityId:n,currentStepId:this.getFieldValue("STATUS_ID"),container:i,isEditable:true});BX.addCustomEvent(this._statusProgressBar,"onStepChange",BX.delegate(this._onInternalLeadStatusChange,this));BX.addCustomEvent(this._statusProgressBar,"onStepSelectPageRequest",BX.delegate(this._onLeadStatusPageRequest,this))}BX.addCustomEvent(window,"onCrmEntityUpdate",BX.delegate(this._onExternalUpdate,this));BX.addCustomEvent(window,"onCrmEntityDelete",BX.delegate(this._onExternalDelete,this));BX.addCustomEvent(window,"onOpenPageBefore",BX.delegate(this._onBeforePageOpen,this));BX.addCustomEvent(window,"onOpenPageAfter",BX.delegate(this._onAfterPageOpen,this))},getId:function(){return this._id},getSettings:function(){return this._settings},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},setSetting:function(t,e){this._settings[t]=e},getEntityId:function(){return parseInt(this.getSetting("entityId",0))},prepareElementId:function(t){t=t.toLowerCase();return this._prefix!==""?this._prefix+"_"+t:t},resolveElement:function(t){return BX(this.prepareElementId(t))},getFieldValue:function(t){var e=this.resolveElement(t);return e?e.value:""},createSaveHandler:function(){return BX.delegate(this._onSave,this)},getMessage:function(t){var e=BX.CrmLeadEditor.messages;return BX.type.isNotEmptyString(e[t])?e[t]:""},getContextId:function(){return this.getSetting("contextId","")},getCurrencyId:function(){return this.getFieldValue("CURRENCY_ID")},setProductRowList:function(t,e){if(this._productRowList===t){return}e=!!e;if(this._productRowList){BX.removeCustomEvent(this._productRowList,"onCrmProductRowListChange",this._productRowListChangeHandler)}this._productRowList=t;if(this._productRowList){BX.addCustomEvent(this._productRowList,"onCrmProductRowListChange",this._productRowListChangeHandler)}var i=this.resolveElement("opportunity");if(i){if(!this._productRowList){i.disabled=false}else{var n=this._productRowList.getItemCount()>0;i.disabled=n;if(!e){i.value=n?this._productRowList.getSumTotal():0}}}},_onPhoneAdd:function(t){this._createMultiField("PHONE",BX.findPreviousSibling(this._addPhoneBtn,{tagName:"DIV",className:"clb"}));return BX.PreventDefault(t)},_onEmailAdd:function(t){this._createMultiField("EMAIL",BX.findPreviousSibling(this._addEmailBtn,{tagName:"DIV",className:"clb"}));return BX.PreventDefault(t)},_onCurrencySelect:function(t){var e=this.getSetting("currencySelectorUrl","");if(e!==""){BX.CrmMobileContext.getCurrent().open({url:e,data:{contextId:this.getContextId()}});this._enableCurrencyChangeMode(true)}},_onSourceSelect:function(t){var e=this.getSetting("sourceSelectorUrl","");if(e!==""){BX.CrmMobileContext.getCurrent().open({url:e});this._enableStatusChangeMode(true)}},_onResponsibleSelect:function(){BX.CrmMobileContext.getCurrent().openUserSelector({callback:BX.delegate(this._onResponsibleChange,this),multiple:false,okButtonTitle:this.getMessage("userSelectorOkButton"),cancelButtonTitle:this.getMessage("userSelectorCancelButton")})},_onResponsibleChange:function(t){var e=0;var i="";if(t&&t["a_users"]){var n=t["a_users"];for(var s in n){if(!n.hasOwnProperty(s)){continue}var a=n[s];e=parseInt(a["ID"]);i=a["NAME"];break}}if(this._assignedById){this._assignedById.value=e}if(this._assignedByName){this._assignedByName.innerHTML=BX.util.htmlspecialchars(i)}},_createMultiField:function(t,e){var i=0;var n="";var s=t+"_";do{i++;n="n"+i.toString()}while(BX.type.isDomNode(this.resolveElement(s+n+"_VALUE")));var a=this.getSetting("multiFields",{});if(typeof a[t]==="undefined"){a[t]={}}a[t][n]={};var r=BX.create("INPUT",{props:{id:this.prepareElementId(s+n+"_VALUE"),type:"text",className:"crm_input_text fll"},style:{width:"70%"}});e.parentNode.insertBefore(r,e);var o=BX.create("SELECT",{props:{id:this.prepareElementId(s+n+"_VALUE_TYPE"),className:"crm_input_select flr"}});var d=this.getSetting("multiFieldInfos",{});var l=typeof d[t]!=="undefined"?d[t]:{};for(var u in l){if(!l.hasOwnProperty(u)){continue}var h=l[u];var c=BX.create("OPTION",{value:u,text:h});if(!BX.browser.isIE){o.add(c,null)}else{try{o.add(c,o.options[null])}catch(_){o.add(c,null)}}}e.parentNode.insertBefore(o,e)},_saveMultiFields:function(t,e){var i=this.getSetting("multiFields",{});if(typeof i[t]==="undefined"){return}if(typeof e["FM"]==="undefined"){e["FM"]={}}if(typeof e["FM"][t]==="undefined"){e["FM"][t]={}}var n=i[t];for(var s in n){if(!n.hasOwnProperty(s)){continue}var a=t+"_"+s;var r=this.getFieldValue(a+"_value");if(r===""){continue}e["FM"][t][s]={VALUE:r,VALUE_TYPE:this.getFieldValue(a+"_value_type")}}},_onSave:function(){if(!this._dispatcher){return}var t=this.getEntityId();var e={ID:this.getEntityId(),TITLE:this.getFieldValue("TITLE"),NAME:this.getFieldValue("NAME"),SECOND_NAME:this.getFieldValue("SECOND_NAME"),LAST_NAME:this.getFieldValue("LAST_NAME"),COMPANY_TITLE:this.getFieldValue("COMPANY_TITLE"),CURRENCY_ID:this.getFieldValue("CURRENCY_ID"),OPPORTUNITY:this.getFieldValue("OPPORTUNITY"),STATUS_ID:this.getFieldValue("STATUS_ID"),ADDRESS:this.getFieldValue("ADDRESS"),ADDRESS_2:this.getFieldValue("ADDRESS_2"),ADDRESS_CITY:this.getFieldValue("ADDRESS_CITY"),ADDRESS_REGION:this.getFieldValue("ADDRESS_REGION"),ADDRESS_PROVINCE:this.getFieldValue("ADDRESS_PROVINCE"),ADDRESS_POSTAL_CODE:this.getFieldValue("ADDRESS_POSTAL_CODE"),ADDRESS_COUNTRY:this.getFieldValue("ADDRESS_COUNTRY"),COMMENTS:this.getFieldValue("COMMENTS"),SOURCE_ID:this.getFieldValue("SOURCE_ID"),ASSIGNED_BY_ID:this.getFieldValue("ASSIGNED_BY_ID")};e["PROCESS_PRODUCT_ROWS"]="Y";e["PRODUCT_ROWS"]=this._productRowList?this._productRowList.prepareForSave():[];this._saveMultiFields("PHONE",e);this._saveMultiFields("EMAIL",e);if(t<=0){this._dispatcher.createEntity(e,BX.CrmMobileContext.getCurrent().createCloseHandler(),{contextId:this.getContextId(),title:this.getSetting("title","")})}else{this._dispatcher.updateEntity(e,BX.CrmMobileContext.getCurrent().createCloseHandler(),{contextId:this.getContextId(),title:this.getSetting("title","")})}},_enableCurrencyChangeMode:function(t){t=!!t;if(this._isInCurrencyChangeMode===t){return}this._isInCurrencyChangeMode=t;if(t){BX.addCustomEvent(window,"onCrmCurrencySelect",this._currencyChangeCompleteHandler)}else{BX.removeCustomEvent(window,"onCrmCurrencySelect",this._currencyChangeCompleteHandler)}},_enableLeadStatusChangeMode:function(t){t=!!t;if(this._isInLeadStatusChangeMode===t){return}this._isInLeadStatusChangeMode=t;if(t){BX.addCustomEvent(window,"onCrmProgressStepSelect",this._leadStatusChangeCompleteHandler)}else{BX.removeCustomEvent(window,"onCrmProgressStepSelect",this._leadStatusChangeCompleteHandler)}},_enableStatusChangeMode:function(t){t=!!t;if(this._isInStatusChangeMode===t){return}this._isInStatusChangeMode=t;if(t){BX.addCustomEvent(window,"onCrmStatusSelect",this._statusChangeCompleteHandler)}else{BX.removeCustomEvent(window,"onCrmStatusSelect",this._statusChangeCompleteHandler)}},_onStatusClick:function(t){this._onLeadStatusPageRequest();BX.eventCancelBubble(t)},_onLeadStatusPageRequest:function(){var t=this.getSetting("leadStatusSelectorUrl","");if(t!==""){BX.CrmMobileContext.getCurrent().open({url:t,data:{contextId:this.getContextId(),currentStepId:this.getFieldValue("STATUS_ID"),disabledStepIds:["CONVERTED"]}});this._enableLeadStatusChangeMode(true)}},_onInternalLeadStatusChange:function(t){var e=BX.type.isNotEmptyString(t["stepId"])?t["stepId"]:"";var i=BX.type.isNotEmptyString(t["stepName"])?t["stepName"]:"";if(this._statusId){this._statusId.value=e}if(this._statusName){this._statusName.innerHTML=BX.util.htmlspecialchars(i!==""?i:e)}},_onExternalUpdate:function(t){var e=typeof t["typeName"]!=="undefined"?t["typeName"]:"";var i=typeof t["id"]!=="undefined"?parseInt(t["id"]):0;var n=typeof t["senderId"]!=="undefined"?t["senderId"]:"";if(e===BX.CrmLeadModel.typeName&&i===this.getEntityId()&&n!==this._dispatcher.getId()){this._isDirty=true}},_onExternalDelete:function(t){var e=typeof t["typeName"]!=="undefined"?t["typeName"]:"";var i=typeof t["id"]!=="undefined"?parseInt(t["id"]):0;if(e===BX.CrmLeadModel.typeName&&i===this.getEntityId()){BX.CrmMobileContext.getCurrent().close()}},_onExternalLeadStatusChange:function(t){var e=BX.type.isNotEmptyString(t["contextId"])?t["contextId"]:"";if(e!==this.getContextId()){return}this._syncData["STATUS"]={id:BX.type.isNotEmptyString(t["statusId"])?t["statusId"]:"",name:BX.type.isNotEmptyString(t["name"])?t["name"]:""};this._enableLeadStatusChangeMode(false)},_onExternalCurrencyChange:function(t){var e=typeof t["contextId"]?t["contextId"]:"";if(e!==this.getSetting("contextId","")){return}var i=typeof t["id"]?t["id"]:"";var n=typeof t["name"]?t["name"]:"";this._syncData["CURRENCY"]={id:i,name:n};this._enableCurrencyChangeMode(false)},_onExternalStatusChange:function(t){var e=typeof t["contextId"]?t["contextId"]:"";if(e!==this.getSetting("contextId","")){return}var i=typeof t["statusId"]?t["statusId"]:"";var n=typeof t["name"]?t["name"]:"";this._syncData["SOURCE"]={id:i,name:n};this._enableStatusChangeMode(false)},_synchronize:function(){if(!this._syncData){return}if(typeof this._syncData["STATUS"]!=="undefined"){var t=this._syncData["STATUS"];var e=BX.type.isNotEmptyString(t["id"])?t["id"]:"";if(this._statusId){this._statusId.value=e}var i=BX.type.isNotEmptyString(t["name"])?t["name"]:"";if(this._statusName){this._statusName.innerHTML=BX.util.htmlspecialchars(i)}if(this._statusProgressBar){this._statusProgressBar.setCurrentStepId(e,false)}delete this._syncData["STATUS"]}else if(typeof this._syncData["CURRENCY"]!=="undefined"){t=this._syncData["CURRENCY"];e=BX.type.isNotEmptyString(t["id"])?t["id"]:"";var n="";if(this._currencyId){n=this._currencyId.value;this._currencyId.value=e}i=BX.type.isNotEmptyString(t["name"])?t["name"]:"";if(this._currencyName){this._currencyName.innerHTML=BX.util.htmlspecialchars(i!==""?i:e)}if(this._productRowList){this._productRowList.setCurrencyId(e,BX.delegate(this._synchronizeOpportunity,this))}else{this._convertOpportunity(n,e)}delete this._syncData["CURRENCY"]}else if(typeof this._syncData["SOURCE"]!=="undefined"){var t=this._syncData["SOURCE"];var e=BX.type.isNotEmptyString(t["id"])?t["id"]:"";if(this._sourceId){this._sourceId.value=e}var i=BX.type.isNotEmptyString(t["name"])?t["name"]:"";if(this._sourceName){this._sourceName.innerHTML=BX.util.htmlspecialchars(i!==""?i:e)}delete this._syncData["SOURCE"]}},_convertOpportunity:function(t,e){var i=parseFloat(this.getFieldValue("OPPORTUNITY"));if(i==0){return}var n=this;BX.ajax({url:this.getSetting("serviceUrl",""),method:"POST",dataType:"json",data:{ACTION:"CONVERT_MONEY",SRC_CURRENCY_ID:t,DST_CURRENCY_ID:e,SUM:i},onsuccess:function(t){var e=n.resolveElement("opportunity");if(e){e.value=typeof t["SUM"]!=="undefined"?t["SUM"]:0}if(n._currencyId){n._currencyId.value=typeof t["CURRENCY_ID"]!=="undefined"?t["CURRENCY_ID"]:""}if(n._currencyName){n._currencyName.innerHTML=BX.util.htmlspecialchars(typeof t["CURRENCY_NAME"]!=="undefined"?t["CURRENCY_NAME"]:"")}},onfailure:function(t){}})},_synchronizeOpportunity:function(){var t=this.resolveElement("opportunity");if(!t){return}var e=this._productRowList;if(!e){t.disabled=false}else{var i=e.getItemCount()>0;t.disabled=i;t.value=i?e.getSumTotal():0}},_onBeforePageOpen:function(){if(this._isDirty){this._isDirty=false;BX.CrmMobileContext.getCurrent().reload()}},_onAfterPageOpen:function(){if(this._productRowList&&this._productRowList.isInEditMode()){this._productRowList.cancelEditMode()}this._synchronize()},_onProductRowListChange:function(t){this._synchronizeOpportunity()}};if(typeof BX.CrmLeadEditor.messages==="undefined"){BX.CrmLeadEditor.messages={}}BX.CrmLeadEditor.items={};BX.CrmLeadEditor.create=function(t,e){var i=new BX.CrmLeadEditor;i.initialize(t,e);this.items[t]=i;return i}}
//# sourceMappingURL=script.map.js