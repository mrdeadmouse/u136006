(function(e){if(e.LHEPostForm)return;var t={controller:{},handler:{}};BX.addCustomEvent(e,"BFileDLoadFormControllerWasBound",function(e){t.controller[e.id]=true});BX.addCustomEvent(e,"WDLoadFormControllerInit",function(e){t.controller[e.CID]=e});BX.addCustomEvent(e,"WDLoadFormControllerWasBound",function(e){t.controller[e.CID]=true});BX.addCustomEvent(e,"DiskDLoadFormControllerInit",function(e){t.controller[e.CID]=e});BX.addCustomEvent(e,"DiskLoadFormControllerWasBound",function(e){t.controller[e.CID]=true});BX.addCustomEvent(e,"OnEditorInitedBefore",function(i){if(t.handler[i.id]){i.__lhe_flags=["OnEditorInitedBefore"];if(t.handler[i.id]["params"]&&t.handler[i.id]["params"]["LHEJsObjName"])e[t.handler[i.id].params["LHEJsObjName"]]=i;t.handler[i.id].OnEditorInitedBefore(i)}});var i=function(e){if(t.handler[e.id]&&t.handler[e.id].editorIsLoaded!=true){t.handler[e.id].editorIsLoaded=true;t.handler[e.id].exec();BX.onCustomEvent(t.handler[e.id],"OnEditorIsLoaded",[t.handler[e.id],e])}};BX.addCustomEvent(e,"OnCreateIframeAfter",i);BX.addCustomEvent(e,"OnEditorInitedAfter",function(e,n){if(t.handler[e.id]){e.__lhe_flags.push("OnEditorInitedAfter");t.handler[e.id].OnEditorInitedAfter(e);if(t.handler[e.id].editorIsLoaded!=true&&n&&e.sandbox&&e.sandbox.inited)i.apply(e,[e])}});BX.util.object_search=function(e,t){for(var i in t){if(t.hasOwnProperty(i)){if(t[i]==e)return true;else if(typeof t[i]=="object"){var n=BX.util.object_search_key(e,t[i]);if(n!==false)return n}}}return false};var n=function(e,t,i){i=i&&i.length>0?i:[];if(typeof t=="object"&&t.length>0){var n;while((n=t.pop())&&n&&t.length>0){i.push(n)}t=n}i.push(t);this.exist=true;this.bxTag=e;this.tag=t;this.tags=i;this.regexp=new RegExp("\\[("+i.join("|")+")=((?:\\s|\\S)*?)(?:\\s*?WIDTH=(\\d+)\\s*?HEIGHT=(\\d+))?\\]","ig");this.code="["+t+"=#ID##ADDITIONAL#]";this.wysiwyg='<span style="color: #2067B0; border-bottom: 1px dashed #2067B0; margin:0 2px;" id="#ID#"#ADDITIONAL#>#NAME#</span>'},o=function(e,i,n){this.CID=this.id=i;this.parser=e.parser["disk_file"]||null;this.params=n;this.node=BX("diskuf-selectdialog-"+i);this.handler=t.controller[i];this.manager=e;this.eventNode=this.manager.eventNode;this.parserName="disk_file";this.prefixNode="disk-edit-attach";this.prefixHTMLNode="disk-attach-";this.props={valueEditClassName:"wd-inline-file",securityCID:"disk-upload-cid"};this.storage="disk";this.fileToAttach={};this.xmlToAttach={};this.events={onInit:"DiskDLoadFormControllerInit",onShow:"DiskLoadFormController",onBound:"DiskLoadFormControllerWasBound"}};o.prototype={parser:false,eventNode:null,values:{},initialized:false,functionsToExec:[],exec:function(e,t){if(typeof e=="function")this.functionsToExec.push([e,t]);if(this.handler&&this.handler!==true){var i;while((i=this.functionsToExec.shift())&&i)i[0].apply(this,i[1])}},init:function(){if(this.initialized!==true){this.values={};this.functionsToExec=[];this.initialized=true;this.bindMainEvents(this.manager);if(this.parser!==null){this.bindEvents(this.manager);return this.initValues()}}return false},initValues:function(){var e=BX.findChildren(this.node,{className:this.props.valueEditClassName},true);if(e&&e.length>0){this.exec(this.runCheckText);return true}return false},bindMainEvents:function(i){var n=null;BX.addCustomEvent(i.eventNode,"onReinitializeBefore",BX.proxy(this.clean,this));BX.addCustomEvent(i.eventNode,"onShowControllers",BX.proxy(function(e){n=e;BX.onCustomEvent(i.eventNode,this.events.onShow,[e])},this));if(!t.controller[this.id]){var o=BX.delegate(function(t){if(t["UID"]==this.id||t["id"]==this.id){if(n==="show"||n==="hide"){BX.onCustomEvent(i.eventNode,this.events.onShow,[n]);n=null}BX.removeCustomEvent(e,this.events.onBound,o)}},this);BX.addCustomEvent(e,this.events.onBound,o)}},bindEvents:function(e){this._catchHandler=BX.delegate(function(t){BX.removeCustomEvent(this.eventNode,this.events.onInit,this._catchHandler);this.handler=t;var i=BX.findChild(BX(e.formID),{attr:{id:this.props.securityCID}},true,false);if(i)i.value=this.handler.CID;this.exec();var n=BX.delegate(function(){BX.onCustomEvent(e.eventNode,"onUploadsHasBeenChanged",arguments)},this);BX.addCustomEvent(this.handler.agent,"onFileIsInited",n);BX.addCustomEvent(this.handler.agent,"ChangeFileInput",n);BX.onCustomEvent(e.eventNode,"onControllerInitialized",[this.id,t])},this);if(this.handler!="object")BX.addCustomEvent(e.eventNode,this.events.onInit,this._catchHandler);else this._catchHandler(this.handler);BX.addCustomEvent(e.eventNode,"OnFileUploadSuccess",BX.delegate(function(e,t){if(this.id==t.CID||this.id==t.id){this.addFile(e,{usePostfix:true})}},this));BX.addCustomEvent(e.eventNode,"OnFileUploadRemove",BX.delegate(function(e,t){if(this.id==t.CID||this.id==t.id){this.deleteFile(e,{usePostfix:true})}},this));BX.addCustomEvent(this,"onFileIsInText",BX.proxy(function(e,t){this.adjustFile(this.checkFile(e),t)},this))},addFile:function(e,t){var i=this.checkFile(e.element_id,e,t);if(i){setTimeout(BX.proxy(function(){this.bindFile(i);this.adjustFile(i,false)},this),100);BX.onCustomEvent(this.eventNode,"onFileIsAdded",[i,this])}return true},checkFile:function(e,t){e=""+(typeof e=="object"?e.id:e);if(typeof t=="object"&&t!==null&&e&&t.element_name&&BX(t.place)){var i={id:e,name:t.element_name,url:t.element_url,type:"isnotimage/xyz",isImage:false,place:BX(t.place,true),xmlID:BX(t.place,true).getAttribute("bx-attach-xml-id"),fileID:BX(t.place,true).getAttribute("bx-attach-file-id")},n;if(/(\.png|\.jpg|\.jpeg|\.gif|\.bmp)$/i.test(t.element_name)&&(n=BX.findChild(i.place,{className:"files-preview",tagName:"IMG"},true,false))&&n){i.type="image/xyz";i.lowsrc=n.src;i.element_url=i.src=n.src.replace(/\Wwidth=(\d+)/,"").replace(/\Wheight=(\d+)/,"");i.isImage=true;i.width=parseInt(n.getAttribute("data-bx-full-width"));i.height=parseInt(n.getAttribute("data-bx-full-height"))}if(i.xmlID)this.xmlToAttach[i.xmlID+""]=e;if(i.fileID)this.fileToAttach[i.fileID+""]=e;this.values[e]=i}return this.values[e]||false},bindFile:function(e){var t=e.place;if(typeof e=="object"&&t&&!t.hasAttribute("bx-file-is-bound")){var i=BX.findChild(t,{className:"f-wrap"},true,false),n=BX.findChild(t,{className:"files-preview"},true,false);if(i){BX.bind(i,"click",BX.delegate(function(){this.insertFile(e.id)},this));i.style.cursor="pointer";i.title=BX.message("MPF_FILE")}if(n){BX.bind(n,"click",BX.delegate(function(){this.insertFile(e.id)},this))}}},adjustFile:function(e,t){var i=e.place;if(t===true||t===false){if(!e.info)e.info=BX.findChild(e.place,{className:"files-info"},true,false);i=e.info;if(BX.type.isDomNode(i)){var n="check-in-text-"+e.id,o=BX(n),s=t===false?{attrs:{"bx-file-is-in-text":"N"},props:{className:"insert-btn"},html:'<span class="insert-btn-text">'+BX.message("MPF_FILE_INSERT_IN_TEXT")+"</span>"}:{attrs:{"bx-file-is-in-text":"Y"},props:{className:"insert-text"},html:'<span class="insert-btn-text">'+BX.message("MPF_FILE_IN_TEXT")+"</span>"};if(!o){s.attrs.id=n;s.events={click:BX.proxy(function(){this.insertFile(e.id)},this)};i.appendChild(BX.create("SPAN",s))}else{BX.adjust(o,s)}}}},insertFile:function(e){BX.onCustomEvent(this.eventNode,"onFileIsInserted",[this.checkFile(e),this])},deleteFile:function(e,t){e=this.checkFile(e,t);if(e){BX.onCustomEvent(this.eventNode,"onFileIsDeleted",[e,this]);this.values[e.id].place=null;delete this.values[e.id].place;this.values[e.id]=null;delete this.values[e.id];e=null;return true}return false},reinitValues:function(e,t){var i,n,o={};while((i=t.pop())&&i){n=BX(this.prefixHTMLNode+i);n=n?n.tagName=="A"?n:BX.findChild(n,{tagName:"IMG"},true):null;if(n){o["E"+i]={type:"file",id:i,name:n.getAttribute("data-bx-title"),size:n.getAttribute("data-bx-size"),sizeInt:n.getAttribute("data-bx-size"),storage:"disk",previewUrl:n.tagName=="A"?"":n.getAttribute("data-bx-src"),fileId:n.getAttribute("bx-attach-file-id")};if(n.hasAttribute("bx-attach-xml-id"))o["E"+i]["xmlId"]=n.getAttribute("bx-attach-xml-id")}}this.handler.selectFile({},{},o);this.runCheckText()},runCheckText:function(){if(!this._checkText)this._checkText=BX.delegate(this.checkText,this);this.manager.exec(this._checkText)},checkText:function(){var e,t=this.manager.getContent(),i=[],n,o;if(t!=""){e=t;for(o in this.xmlToAttach){if(this.xmlToAttach.hasOwnProperty(o)){t=t.replace(new RegExp("\\&\\#91\\;DOCUMENT ID=("+o+")([WIDTHHEIGHT=0-9 ]*)\\&\\#93\\;","gim"),"["+this.parser["tag"]+"="+this.xmlToAttach[o]+"$2]").replace(new RegExp("\\[DOCUMENT ID=("+o+")([WIDTHHEIGHT=0-9 ]*)\\]","gim"),"["+this.parser["tag"]+"="+this.xmlToAttach[o]+"$2]")}}for(o in this.fileToAttach){if(this.fileToAttach.hasOwnProperty(o)){t=t.replace(new RegExp("\\&\\#91\\;"+this.parser["tag"]+"=("+o+")([WIDTHHEIGHT=0-9 ]*)\\&\\#93\\;","gim"),"["+this.parser["tag"]+"="+this.fileToAttach[o]+"$2]").replace(new RegExp("\\["+this.parser["tag"]+"=("+o+")([WIDTHHEIGHT=0-9 ]*)\\]","gim"),"["+this.parser["tag"]+"="+this.fileToAttach[o]+"$2]")}}n=new RegExp("(?:\\&\\#91\\;)("+this.parser["tags"].join("|")+")=([a-z=0-9 ]+)(?:\\&\\#93\\;)","gim");if(n.test(t)){for(o in this.values){if(this.values.hasOwnProperty(o)){i.push(o)}}if(i.length>0){n=new RegExp("(?:\\&\\#91\\;|\\[)("+this.parser["tags"].join("|")+")=("+i.join("|")+")([WIDTHHEIGHT=0-9 ]*)(?:\\&\\#93\\;|\\])","gim");if(n.test(t))t=t.replace(n,BX.delegate(function(e,t,i,n){return"["+t+"="+i+n+"]"},this))}}if(e!=t)BX.onCustomEvent(this.eventNode,"onFileIsDetected",[t,this])}return t},clean:function(){if(this.handler&&this.handler.values){var e,t,i,n=BX(this.manager.formID);while((e=this.handler.values.pop())&&e){BX.remove(e)}if(this.handler.params&&this.handler.params.controlName){t=BX.findChildren(n,{tagName:"INPUT",attribute:{name:this.handler.params.controlName}},true)}if(t){for(i=0;i<t.length;i++){BX.remove(t[i])}}}},reinit:function(e,t){var i=[],n,o;for(n in t){if(t.hasOwnProperty(n)){if(t[n]["USER_TYPE_ID"]==this.parserName&&t[n]["VALUE"]){for(o in t[n]["VALUE"]){if(t[n]["VALUE"].hasOwnProperty(o)){i.push(t[n]["VALUE"][o])}}}}}if(i.length>0){this.exec(this.reinitValues,[e,i]);return true}return false}};var s=function(e,t,i){s.superclass.constructor.apply(this,arguments);this.parser=e.parser["webdav_element"]||null;this.node=BX("wduf-selectdialog-"+t);this.manager=e;this.parserName="webdav_element";this.prefixNode="wd-doc";this.prefixHTMLNode="wdif-doc-";this.storage="webdav";this.events={onInit:"WDLoadFormControllerInit",onShow:"WDLoadFormController",onBound:"WDLoadFormControllerWasBound"}};BX.extend(s,o);s.prototype.reinitValues=function(e,t){var i,n,o={};this.waitAnswerFromServer=[];while((i=t.pop())&&i){n=BX(this.prefixHTMLNode+i);n=n?n.tagName=="A"?n:BX.findChild(n,{tagName:"IMG"},true):null;if(n){o["E"+i]={type:"file",id:i,name:n.getAttribute("alt"),storage:"webdav",size:n.getAttribute("data-bx-size"),sizeInt:1,ext:"",link:n.getAttribute("data-bx-document")};if(n.hasAttribute("bx-attach-xml-id"))o["E"+i]["xmlId"]=n.getAttribute("bx-attach-xml-id");this.waitAnswerFromServer.push(i)}}if(this.waitAnswerFromServer.length>0){if(!this._defferCheckText)this._defferCheckText=BX.delegate(this.defferCheckText,this);BX.addCustomEvent(this.eventNode,"OnFileUploadSuccess",this._defferCheckText);this.handler.WDFD_SelectFile({},{},o)}};s.prototype.defferCheckText=function(e){var t=BX.util.array_search(e.element_id,this.waitAnswerFromServer);if(t>=0){this.runCheckText();this.waitAnswerFromServer=BX.util.deleteFromArray(this.waitAnswerFromServer,t)}if(this.waitAnswerFromServer.length<=0)BX.removeCustomEvent(this.eventNode,"OnFileUploadSuccess",this._defferCheckText)};var a=function(e,t,i){a.superclass.constructor.apply(this,arguments);this.parser=e.parser["file"]?e.parser["file"]:e.parser["postimage"]["exist"]?e.parser["postimage"]:null;this.postfix=i["postfix"]||"";this.node=BX("file-selectdialog-"+t);this.parserName="file";this.prefixNode="wd-doc";this.prefixHTMLNode="file-doc-";this.props={valueEditClassName:"file-inline-file",securityCID:"upload-cid"};this.storage="bfile";this.events={onInit:"BFileDLoadFormControllerInit",onShow:"BFileDLoadFormController",onBound:"BFileDLoadFormControllerWasBound"}};BX.extend(a,o);a.prototype.initValues=function(e){var t;if(e!==true){t=BX.findChildren(this.node,{className:this.props.valueEditClassName},true);if(t&&t.length>1){this.exec(this.initValues,[true]);return true}return false}t=this.handler.agent.values||[];var i,n,o,s,a={},r="/bitrix/components/bitrix/main.file.input/file.php?mfi_mode=down&cid="+this.handler.CID+"&sessid="+BX.bitrix_sessid();for(var l=0;l<t.length;l++){s=parseInt(t[l].getAttribute("id").replace(this.prefixNode,""));if(a["id"+s])continue;a["id"+s]="Y";if(s>0){n=BX.findChild(t[l],{className:"f-wrap"},true,false);if(!n)continue;o={element_id:s,element_name:n.innerHTML,parser:this.parser.bxTag,storage:"bfile",element_url:r+"&fileID="+s};i=this.addFile(o,{usePostfix:true,hasPreview:false})}}this.runCheckText();return true};a.prototype.checkFile=function(e,t,i){e=""+(typeof e=="object"?e.id:e);e=e+(i&&i["usePostfix"]===true?this.postfix:"");if(typeof t=="object"&&t!==null&&e&&t.element_name&&BX(this.prefixNode+t.element_id,true)){var n={id:e,name:t.element_name,url:t.element_url,type:"isnotimage/xyz",isImage:false,place:BX(this.prefixNode+t.element_id,true)},o;if((t["element_type"]&&t["element_type"].indexOf("image/")===0||/(\.png|\.jpg|\.jpeg|\.gif|\.bmp)$/i.test(t.element_name))&&((o=BX.findChild(n.place,{tagName:"IMG"},true,false))&&o||i&&i["hasPreview"]===false)){n.type="image/xyz";n.src=t["element_thumbnail"]||t["element_url"];n.isImage=true;n.hasPreview=false;n.lowsrc="";n.width="";n.height="";if(BX(o)){n.hasPreview=true;n.lowsrc=t["element_thumbnail"]||o["src"];n.width=parseInt(o.getAttribute("data-bx-full-width"));n.height=parseInt(o.getAttribute("data-bx-full-height"))}}else if(this.parser.bxTag=="postimage"){return false}this.values[e]=n}return this.values[e]||false};a.prototype.bindFile=function(e){var t=e&&e["place"]?e["place"]:null;if(typeof e=="object"&&t&&!t.hasAttribute("bx-file-is-bound")){if(e.isImage&&e.hasPreview){var i=BX.findChild(t,{className:"feed-add-img-title"},true,false),n=BX.findChild(t,{className:"feed-add-img-wrap"},true,false);if(n){BX.bind(n,"click",BX.proxy(function(){this.insertFile(e)},this));n.style.cursor="pointer";n.title=BX.message("MPF_IMAGE")}if(i){BX.bind(i,"click",BX.delegate(function(){this.insertFile(e)},this));i.style.cursor="pointer";i.title=BX.message("MPF_IMAGE")}}else a.superclass.bindFile.apply(this,arguments)}};a.prototype.clean=function(){a.superclass.clean.apply(this,arguments);if(this["handler"]&&this.handler["agent"]&&this.handler.agent["inputName"]){var e,t,i,n=BX(this.manager.formID);t=BX.findChildren(n,{tagName:"INPUT",attribute:{name:this.handler.agent.inputName+"[]"}},true);if(t){for(i=0;i<t.length;i++){BX.remove(t[i])}}}};e.LHEPostForm=function(e,i){this.params=i;this.formID=e;this.oEditorId=i["LHEJsObjId"];this.__divId=i["LHEJsObjName"]||i["LHEJsObjId"];t.handler[this.oEditorId]=this;this.oEditor=LHEPostForm.getEditor(this.oEditorId);this.eventNode=BX("div"+this.__divId);BX.addCustomEvent(this.eventNode,"OnShowLHE",BX.delegate(this.OnShowLHE,this));BX.addCustomEvent(this.eventNode,"OnButtonClick",BX.delegate(this.OnButtonClick,this));BX.addCustomEvent(this.eventNode,"OnAfterShowLHE",function(e,t){if(t.oEditor&&t.oEditor["AllowBeforeUnloadHandler"])t.oEditor.AllowBeforeUnloadHandler();if(t.monitoringWakeUp===true)t.monitoringStart()});BX.addCustomEvent(this.eventNode,"OnAfterHideLHE",function(e,t){t.monitoringWakeUp=t.monitoringStop();if(t.oEditor&&t.oEditor["DenyBeforeUnloadHandler"])t.oEditor.DenyBeforeUnloadHandler()});this.initParsers(i);this.initFiles(e,i);BX.ready(BX.delegate(function(){if(BX("lhe_button_submit_"+e,true)){BX.bind(BX("lhe_button_submit_"+e,true),"mousedown",function(){BX.addClass(this,"feed-add-button-press")});BX.bind(BX("lhe_button_submit_"+e,true),"mouseup",function(){BX.removeClass(this,"feed-add-button-press")});BX.bind(BX("lhe_button_submit_"+e,true),"click",BX.proxy(function(e){BX.onCustomEvent(this.eventNode,"OnButtonClick",["submit"]);return BX.PreventDefault(e)},this))}if(BX("lhe_button_cancel_"+e,true)){BX.bind(BX("lhe_button_cancel_"+e,true),"mousedown",function(){BX.addClass(this,"feed-add-button-press")});BX.bind(BX("lhe_button_cancel_"+e,true),"mouseup",function(){BX.removeClass(this,"feed-add-button-press")});BX.bind(BX("lhe_button_cancel_"+e,true),"click",BX.proxy(function(e){BX.onCustomEvent(this.eventNode,"OnButtonClick",["cancel"]);return BX.PreventDefault(e)},this))}},this));this.inited=true;BX.addCustomEvent(BX(this.formID),"onAutoSavePrepare",function(e){e.FORM.setAttribute("bx-lhe-autosave-prepared","Y")});BX.onCustomEvent(this,"onInitialized",[this,e,i,this.parsers]);BX.onCustomEvent(this.eventNode,"onInitialized",[this,e,i,this.parsers]);if(this.oEditor&&this.oEditor.inited&&!this.oEditor["__lhe_flags"]){BX.onCustomEvent(this.oEditor,"OnEditorInitedBefore",[this.oEditor]);BX.onCustomEvent(this.oEditor,"OnEditorInitedAfter",[this.oEditor,true])}};e.LHEPostForm.prototype={editorIsLoaded:false,arFiles:{},parser:{},controllers:{},exec:function(e,t){this.functionsToExec=this.functionsToExec||[];if(typeof e=="function")this.functionsToExec.push([e,t]);if(this.editorIsLoaded==true){var i;while((i=this.functionsToExec.shift())&&i)i[0].apply(this,i[1])}},initParsers:function(e){this.parser={postimage:{exist:false,bxTag:"postimage",tag:"IMG ID",tags:["IMG ID"],regexp:/\[(IMG ID)=((?:\s|\S)*?)(?:\s*?WIDTH=(\d+)\s*?HEIGHT=(\d+))?\]/gi,code:"[IMG ID=#ID##ADDITIONAL#]",wysiwyg:'<img id="#ID#" src="'+'#SRC#" lowsrc="'+'#LOWSRC#" title=""#ADDITIONAL# />'}};var t=e["parsers"]?e["parsers"]:{};for(var i in t){if(t.hasOwnProperty(i)&&/[a-z]/gi.test(i+"")){this.parser[i]=new n(i,t[i])}}if(BX.util.object_search("UploadImage",t)){this.parser["postimage"]["exist"]=true}if(typeof e["arSize"]=="object"){var o="";if(e["arSize"]["width"])o+="max-width:"+e["arSize"]["width"]+"px;";if(e["arSize"]["height"])o+="max-height:"+e["arSize"]["height"]+"px;";if(o!=="")this.parser["postimage"]["wysiwyg"]=this.parser["postimage"]["wysiwyg"].replace("#ADDITIONAL#",'style="'+o+'" #ADDITIONAL#')}},initFiles:function(t,i){this.arFiles={};this.controllers={common:{postfix:"",storage:"bfile",parser:"postimage",node:e,obj:null,init:false}};if(!i["CID"]||typeof i["CID"]!=="object")return;BX.addCustomEvent(this.eventNode,"onFileIsAdded",BX.delegate(this.OnFileUploadSuccess,this));BX.addCustomEvent(this.eventNode,"onFileIsDeleted",BX.delegate(this.OnFileUploadRemove,this));BX.addCustomEvent(this.eventNode,"onFileIsDetected",BX.delegate(this.setContent,this));BX.addCustomEvent(this.eventNode,"onFileIsInserted",BX.delegate(this.insertFile,this));var n,r,l;for(r in i["CID"]){if(i["CID"].hasOwnProperty(r)){n=i["CID"][r]["parser"];if(n=="disk_file")this.controllers[r]=new o(this,r,i["CID"][r]);else if(n=="webdav_element")this.controllers[r]=new s(this,r,i["CID"][r]);else if(n=="file")this.controllers[r]=new a(this,r,i["CID"][r]);if(this.controllers[r]&&this.controllers[r].init()&&!l)l=true}}BX.ready(BX.delegate(function(){BX.bind(BX("bx-b-uploadfile-"+t),"click",BX.proxy(this.controllerInit,this));if(l)this.controllerInit("show")},this))},controllerInit:function(e){this.controllerInitStatus=e=="show"||e=="hide"?e:this.controllerInitStatus=="show"?"hide":"show";BX.onCustomEvent(this.eventNode,"onShowControllers",[this.controllerInitStatus])},getContent:function(){return this.oEditor?this.oEditor.GetContent():""},setContent:function(e){if(this.oEditor)this.oEditor.SetContent(e)},OnFileUploadSuccess:function(e,t,i){if(this.controllers[t.id]){var n=t.parser.bxTag+e.id;this.arFiles[n]=this.arFiles[n]||[];this.arFiles[n].push(t.id);if(i===true&&e.isImage&&this.insertImageAfterUpload){if(!this._insertFile)this._insertFile=BX.delegate(this.insertFile,this);this.exec(this._insertFile,arguments)}}},OnFileUploadRemove:function(e,t){if(this.controllers[t.id]){var i=t.parser.bxTag+e.id;if(this.arFiles[i]){var n=BX.util.array_search(t.id,this.arFiles[i]);this.arFiles[i]=BX.util.deleteFromArray(this.arFiles[i],n);if(!this.arFiles[i]||this.arFiles[i].length<=0){this.arFiles[i]=null;delete this.arFiles[i];if(!this._deleteFile)this._deleteFile=BX.delegate(this.deleteFile,this);this.exec(this._deleteFile,arguments)}}}},showPanelEditor:function(e,t){if(e==undefined)e=!this.oEditor.toolbar.IsShown();this.params.showPanelEditor=e;var i=BX("lhe_button_editor_"+this.formID),n=BX("panel-close"+this.__divId);if(n){this.oEditor.dom.cont.appendChild(n)}if(e){this.oEditor.dom.toolbarCont.style.opacity="inherit";this.oEditor.toolbar.Show();if(i)BX.addClass(i,"feed-add-post-form-btn-active");if(n)n.style.display=""}else{this.oEditor.toolbar.Hide();if(i)BX.removeClass(i,"feed-add-post-form-btn-active");if(n)n.style.display="none"}if(t!==false)BX.userOptions.save("main.post.form","postEdit","showBBCode",e?"Y":"N")},monitoring:{interval:null,text:"",savedText:"",files:[],savedFiles:[]},monitoringStart:function(){if(this.monitoring.interval===null){if(!this._monitoringStart){this._monitoringStart=BX.delegate(this.checkFilesInText,this);BX.addCustomEvent(this.oEditor,"OnContentChanged",BX.proxy(function(e){this.monitoring.text=e},this))}this.monitoring.interval=setInterval(this._monitoringStart,1e3)}},monitoringStop:function(){var e=this.monitoring.interval!==null;if(this.monitoring.interval!==null)clearInterval(this.monitoring.interval);this.monitoring.interval=null;return e},monitoringSetStatus:function(e,t,i){if(this.arFiles[e+t]){var n;for(var o=0;o<this.arFiles[e+t].length;o++){this.monitoring.files.push(e+t);n=this.arFiles[e+t][o];BX.onCustomEvent(this.controllers[n],"onFileIsInText",[t,i])}}},checkFilesInText:function(){if(this.monitoring.text!==this.monitoring.savedText){this.monitoring.savedText=this.monitoring.text;this.monitoring.files=[];var e=this.monitoring.savedText,t,i=function(e,t){return function(i,n,o){e.monitoring.files.push([t,o].join("/"))}};for(t in this.parser){if(this.parser.hasOwnProperty(t)){if(!this.parser[t]["checkFilesInText"]){this.parser[t]["checkFilesInText"]=i(this,t)}e.replace(this.parser[t]["regexp"],this.parser[t]["checkFilesInText"])}}if(this.monitoring.savedFiles.join(",")!=this.monitoring.files.join(",")){var n=this.monitoring.files.join("|")+"|",o;for(t=0;t<this.monitoring.savedFiles.length;t++){o=this.monitoring.savedFiles[t];if(n.indexOf(o+"|")>=0)n=n.replace(o+"|","");else{o=o.split("/");this.monitoringSetStatus(o[0],o[1],false)}}n=n.substring(0,n.length-1).split("|");for(t=0;t<n.length;t++){o=o=n[t].split("/");this.monitoringSetStatus(o[0],o[1],true)}}this.monitoring.savedFiles=this.monitoring.files;if(this.monitoring.savedFiles.length<=0)this.monitoringStop()}},checkFile:function(e,t){var i=false;if(typeof e=="string"){var n=typeof t=="string"?t:t.parser;if(!!this.arFiles[n+e]){var o=this.arFiles[n+e][0];t=this.controllers[o];i={file:t.values[e],controller:t}}}else if(this.controllers[t.id]){i={file:e,controller:t}}return i},insertFile:function(e,t){var i=this.oEditor;if(i&&e){var n=e["id"],o="",s=t.parser,a=i.GetViewMode(),r=this.parser[s.bxTag][a];if(e["isImage"]){r=a=="wysiwyg"?this.parser["postimage"][a]:r;if(e.width>0&&e.height>0&&i.sEditorMode=="html"){o=' style="width:'+e.width+"px;height:"+e.height+'px;" onload="this.style=\' \'"'}}if(a=="wysiwyg"){i.InsertHtml(r.replace("#ID#",i.SetBxTag(false,{tag:s.bxTag,params:{value:n}})).replace("#SRC#",e.src).replace("#URL#",e.url).replace("#LOWSRC#",e.lowsrc||"").replace("#NAME#",e.name).replace("#ADDITIONAL#",o)+"<span>&nbsp;</span>");setTimeout(BX.delegate(i.AutoResizeSceleton,i),500);setTimeout(BX.delegate(i.AutoResizeSceleton,i),1e3)}else if(a=="code"&&i.bbCode){i.textareaView.Focus();i.textareaView.WrapWith(false,false,r.replace("#ID#",n).replace("#ADDITIONAL#",""))}this.monitoringSetStatus(s.bxTag,e.id,true);this.monitoringStart()}},deleteFile:function(e,t){var i=this.oEditor,n=t.parser,o=e.id,s=i.GetContent();if(n&&s.indexOf("="+o)>=0){if(i.GetViewMode()=="wysiwyg"){var a=i.GetIframeDoc(),r,l;for(r in i["bxTags"]){if(i["bxTags"].hasOwnProperty(r)){if(typeof i.bxTags[r]=="object"&&i.bxTags[r]["params"]&&i.bxTags[r]["params"]["value"]==e.id){l=a.getElementById(r);if(l)l.parentNode.removeChild(l)}}}i.SaveContent()}else{s=s.replace(n.regexp,function(t,i,n){return n==e.id?"":t});i.SetContent(s);i.Focus()}this.monitoringSetStatus(n.bxTag,e.id,false)}},reinit:function(e,t){BX.onCustomEvent(this.eventNode,"onReinitializeBefore",[this,e,t]);this.arFiles={};delete this.monitoringWakeUp;this.monitoringStop();this.oEditor.CheckAndReInit(e||"");BX.onCustomEvent(this.eventNode,"onReinitialize",[this,e,t]);var i,n=false;for(i in this.controllers){if(this.controllers.hasOwnProperty(i)){if(this.controllers[i]["init"]&&this.controllers[i].reinit(e,t))n=true}}this.controllerInit(n?"show":"hide");if(this.params["~height"]){this.oEditor.SetConfigHeight(this.params["~height"]);this.oEditor.ResizeSceleton()}},Parse:function(e,t,i){var n=this.parser[e],o=this;if(n){t=t.replace(n.regexp,function(t,s,a,r,l){var d=o.checkFile(a,e);if(d&&(d=d.file)&&d){var h="",f=d.isImage?o.parser.postimage.wysiwyg:n.wysiwyg;o.monitoringStart();if(d.isImage){r=parseInt(r);l=parseInt(l);h=r&&l?' width="'+r+'" height="'+l+'"':"";if(h===""&&d["width"]>0&&d["height"]>0){h=' style="width:'+d["width"]+"px;height:"+d["height"]+'px;" onload="this.style=\' \'"'}}return f.replace("#ID#",i.SetBxTag(false,{tag:e,params:{value:a}})).replace("#NAME#",d.name).replace("#SRC#",d.src).replace("#LOWSRC#",d.lowsrc).replace("#ADDITIONAL#",h).replace("#WIDTH#",parseInt(r)).replace("#HEIGHT#",parseInt(l))}return t})}return t},Unparse:function(e,t){var i="",n=e.tag;if(this.parser[n]){var o=parseInt(t.node.hasAttribute("width")?t.node.getAttribute("width"):0),s=parseInt(t.node.hasAttribute("height")?t.node.getAttribute("height"):0),a="";if(o>0&&s>0){a=" WIDTH="+o+" HEIGHT="+s}i=this.parser[n]["code"].replace("#ID#",e.params.value).replace("#ADDITIONAL#",a).replace("#WIDTH#",o).replace("#HEIGHT#",s)}return i},OnShowLHE:function(e,t,i){var n=this.__divId;e=e===false?false:e==="hide"?"hide":e==="justShow"?"justShow":true;this.oEditor=this.oEditor||LHEPostForm.getEditor(this.oEditorId);if(!this.oEditor)return;this.oEditor.Init();var o=BX("micro"+n),s=this.eventNode;if(o){o.style.display=e===true||e==="justShow"?"none":"block"}if(e=="hide"){BX.onCustomEvent(this.eventNode,"OnBeforeHideLHE",[e,this]);if(this.eventNode.style.display=="none"){BX.onCustomEvent(this.eventNode,"OnAfterHideLHE",[e,this])}else{new BX["easing"]({duration:200,start:{opacity:100,height:this.eventNode.scrollHeight},finish:{opacity:0,height:20},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:function(e){s.style.height=e.height+"px";s.style.opacity=e.opacity/100},complete:BX.proxy(function(){this.eventNode.style.cssText="";this.eventNode.style.display="none";BX.onCustomEvent(s,"OnAfterHideLHE",[e,this])},this)}).animate()}}else if(e){BX.onCustomEvent(this.eventNode,"OnBeforeShowLHE",[e,this]);if(e=="justShow"){this.eventNode.style.display="block";BX.onCustomEvent(this.eventNode,"OnAfterShowLHE",[e,this]);if(i!==false)this.oEditor.Focus()}else if(this.eventNode.style.display=="block"){BX.onCustomEvent(this.eventNode,"OnAfterShowLHE",[e,this]);if(i!==false)this.oEditor.Focus()}else{BX.adjust(this.eventNode,{style:{display:"block",overflow:"hidden",height:"20px",opacity:.1}});new BX["easing"]({duration:200,start:{opacity:10,height:20},finish:{opacity:100,height:s.scrollHeight},transition:BX["easing"].makeEaseOut(BX.easing.transitions.quad),step:function(e){s.style.height=e.height+"px";s.style.opacity=e.opacity/100},complete:BX.proxy(function(){BX.onCustomEvent(s,"OnAfterShowLHE",[e,this]);this.oEditor.Focus();this.eventNode.style.cssText=""},this)}).animate()}}else{BX.onCustomEvent(this.eventNode,"OnBeforeHideLHE",[e,this]);this.eventNode.style.display="none";BX.onCustomEvent(this.eventNode,"OnAfterHideLHE",[e,this])}},OnButtonClick:function(e){if(e!="cancel"){BX.onCustomEvent(this.eventNode,"OnClickSubmit",[this])}else{BX.onCustomEvent(this.eventNode,"OnClickCancel",[this]);BX.onCustomEvent(this.eventNode,"OnShowLHE",["hide"])}},OnEditorInitedBefore:function(t){var i=this;this.oEditor=t;t.formID=this.formID;if(this.params)this.params["~height"]=t.config["height"];if(this.params&&this.params["ctrlEnterHandler"]){BX.addCustomEvent(t,"OnCtrlEnter",function(){t.SaveContent();if(typeof e[i.params["ctrlEnterHandler"]]=="function")e[i.params["ctrlEnterHandler"]]();else BX.submit(BX(i.formID))})}var n=this.params.parsers?this.params.parsers:[];if(BX.util.object_search("Spoiler",n)){t.AddButton({id:"spoiler",name:BX.message("spoilerText"),iconClassName:"spoiler",disabledForTextarea:false,src:BX.message("MPF_TEMPLATE_FOLDER")+"/images/lhespoiler.png",toolbarSort:205,handler:function(){var e=this,t=false;if(!e.editor.bbCode||!e.editor.synchro.IsFocusedOnTextarea()){t=e.editor.action.actions.formatBlock.exec("formatBlock","blockquote","bx-spoiler",false,{bxTagParams:{tag:"spoiler"}})}else{t=e.editor.action.actions.formatBbCode.exec("quote",{tag:"SPOILER"})}return t}});t.AddParser({name:"spoiler",obj:{Parse:function(e,t,i){if(/\[(cut|spoiler)(([^\]])*)\]/gi.test(t)){t=t.replace(/[\001-\006]/gi,"").replace(/\[cut(((?:=)[^\]]*)|)\]/gi,"$1").replace(/\[\/cut]/gi,"").replace(/\[spoiler([^\]]*)\]/gi,"$1").replace(/\[\/spoiler]/gi,"");var n=/(?:\001([^\001]*)\001)([^\001-\004]+)\002/gi,o=/(?:\003([^\003]*)\003)([^\001-\004]+)\004/gi,s=function(e,t){e=e.replace(/^(="|='|=)/gi,"").replace(/("|')?$/gi,"");return'<blockquote class="bx-spoiler" id="'+i.SetBxTag(false,{tag:"spoiler"})+'" title="'+e+'">'+t+"</blockquote>"},a=function(e,t,i){return s(t,i)};while(t.match(n)||t.match(o)){t=t.replace(n,a).replace(o,a)}}t=t.replace(/\001([^\001]*)\001/gi,"[cut$1]").replace(/\003([^\003]*)\003/gi,"[spoiler$1]").replace(/\002/gi,"[/cut]").replace(/\004/gi,"[/spoiler]");return t},UnParse:function(e,i){if(e.tag=="spoiler"){var n="",o;for(o=0;o<i.node.childNodes.length;o++){n+=t.bbParser.GetNodeHtml(i.node.childNodes[o])}n=BX.util.trim(n);if(n!="")return"[SPOILER"+(i.node.hasAttribute("title")?"="+i.node.getAttribute("title"):"")+"]"+n+"[/SPOILER]"}return""}}})}if(BX.util.object_search("MentionUser",n)){t.AddParser({name:"postuser",obj:{Parse:function(e,i){i=i.replace(/\[USER\s*=\s*(\d+)\]((?:\s|\S)*?)\[\/USER\]/gi,function(e,i,n){n=BX.util.trim(n);if(n=="")return"";return'<span id="'+t.SetBxTag(false,{tag:"postuser",params:{value:parseInt(i)}})+'" class="bxhtmled-metion">'+n+"</span>"});return i},UnParse:function(e,i){if(e.tag=="postuser"){var n="",o;for(o=0;o<i.node.childNodes.length;o++){n+=t.bbParser.GetNodeHtml(i.node.childNodes[o])}n=BX.util.trim(n);if(n!="")return"[USER="+e.params.value+"]"+n+"[/USER]"}return""}}})}var o=function(e,n){return i.Parse(e,n,t)},s=function(e,t){return i.Unparse(e,t)};for(var a in this.parser){if(this.parser.hasOwnProperty(a)){t.AddParser({name:a,obj:{Parse:o,UnParse:s}})}}},OnEditorInitedAfter:function(t){BX.addCustomEvent(t,"OnIframeDrop",BX.proxy(function(){BX.onCustomEvent(this.eventNode,"OnIframeDrop",arguments)},this));BX.addCustomEvent(t,"OnIframeDragOver",BX.proxy(function(){BX.onCustomEvent(this.eventNode,"OnIframeDragOver",arguments)},this));BX.addCustomEvent(t,"OnIframeDragLeave",BX.proxy(function(){BX.onCustomEvent(this.eventNode,"OnIframeDragLeave",arguments)},this));t.contextMenu.items["postimage"]=t.contextMenu.items["postdocument"]=t.contextMenu.items["postfile"]=[{TEXT:BX.message("BXEdDelFromText"),bbMode:true,ACTION:function(){var e=t.contextMenu.GetTargetItem("postimage");if(!e)e=t.contextMenu.GetTargetItem("postdocument");if(!e)e=t.contextMenu.GetTargetItem("postfile");if(e&&e.element){t.selection.RemoveNode(e.element)}t.contextMenu.Hide()}}];if(!this.params["lazyLoad"]){BX.onCustomEvent(this.eventNode,"OnShowLHE",["justShow",t,false])}if(t.toolbar.controls&&t.toolbar.controls.FontSelector){t.toolbar.controls.FontSelector.SetWidth(45)}BX.addCustomEvent(BX(this.formID),"onAutoSavePrepare",function(e){var i=e;setTimeout(function(){
BX.addCustomEvent(t,"OnContentChanged",BX.proxy(function(e){this["mpfTextContent"]=e;this.Init()},i))},1500)});BX.addCustomEvent(BX(this.formID),"onAutoSave",BX.proxy(function(e,t){if(BX.type.isNotEmptyString(e["mpfTextContent"]))t["text"+this.formID]=e["mpfTextContent"]},this));BX.addCustomEvent(BX(this.formID),"onAutoSaveRestore",BX.proxy(function(e,i){if(i["text"+this.formID]&&/[^\s]+/gi.test(i["text"+this.formID])){t.CheckAndReInit(i["text"+this.formID])}},this));if(BX(this.formID)&&BX(this.formID).hasAttribute("bx-lhe-autosave-prepared")&&BX(this.formID).BXAUTOSAVE){BX(this.formID).removeAttribute("bx-lhe-autosave-prepared");setTimeout(BX.proxy(function(){BX(this.formID).BXAUTOSAVE.Prepare()},this),100)}var i=this.formID,n=this.params;this.showPanelEditor(n.showPanelEditor,false);if(!t.mainPostFormCustomized){t.mainPostFormCustomized=true;BX.addCustomEvent(t,"OnIframeKeydown",function(n){if(e.onKeyDownHandler){e.onKeyDownHandler(n,t,i)}});BX.addCustomEvent(t,"OnIframeKeyup",function(n){if(e.onKeyUpHandler){e.onKeyUpHandler(n,t,i)}});if(e["BXfpdStopMent"+i]){BX.addCustomEvent(t,"OnIframeClick",function(){e["BXfpdStopMent"+i]()})}if(t&&t.textareaView.GetCursorPosition){BX.addCustomEvent(t,"OnTextareaKeyup",function(n){if(e.onTextareaKeyUpHandler){e.onTextareaKeyUpHandler(n,t,i)}});BX.addCustomEvent(t,"OnTextareaKeydown",function(n){if(e.onTextareaKeyDownHandler){e.onTextareaKeyDownHandler(n,t,i)}})}}}};e.LHEPostForm.getEditor=function(t){return e["BXHtmlEditor"]?e["BXHtmlEditor"].Get(typeof t=="object"?t.id:t):null};e.LHEPostForm.getHandler=function(e){return t.handler[typeof e=="object"?e.id:e]};e.LHEPostForm.unsetHandler=function(e){var i=typeof e=="object"?e.id:e;if(!t.handler[i])return;if(t.handler[i].oEditor)t.handler[i].oEditor.Destroy();t.handler[i]=null};e.LHEPostForm.reinitData=function(e,t,i){var n=LHEPostForm.getHandler(e);if(n)n.exec(n.reinit,[t,i]);return false};e.LHEPostForm.reinitDataBefore=function(e){var t=LHEPostForm.getHandler(e);if(t&&t["eventNode"])BX.onCustomEvent(t.eventNode,"onReinitializeBefore",[t])};e.BXPostFormTags=function(e,t){this.popup=null;this.formID=e;this.buttonID=t;this.sharpButton=null;this.addNewLink=null;this.tagsArea=null;this.hiddenField=null;this.popupContent=null;BX.ready(BX.proxy(this.init,this))};e.BXPostFormTags.prototype.init=function(){this.sharpButton=BX(this.buttonID);this.addNewLink=BX("post-tags-add-new-"+this.formID);this.tagsArea=BX("post-tags-block-"+this.formID);this.tagsContainer=BX("post-tags-container-"+this.formID);this.hiddenField=BX("post-tags-hidden-"+this.formID);this.popupContent=BX("post-tags-popup-content-"+this.formID);this.popupInput=BX.findChild(this.popupContent,{tag:"input"});var e=BX.findChildren(this.tagsContainer,{className:"feed-add-post-del-but"},true);for(var t=0,i=e.length;t<i;t++){BX.bind(e[t],"click",BX.proxy(this.onTagDelete,{obj:this,tagBox:e[t].parentNode,tagValue:e[t].parentNode.getAttribute("data-tag")}))}BX.bind(this.sharpButton,"click",BX.proxy(this.onButtonClick,this));BX.bind(this.addNewLink,"click",BX.proxy(this.onAddNewClick,this))};e.BXPostFormTags.prototype.onTagDelete=function(){BX.remove(this.tagBox);this.obj.hiddenField.value=this.obj.hiddenField.value.replace(this.tagValue+",","").replace("  "," ")};e.BXPostFormTags.prototype.show=function(){if(this.popup===null){this.popup=new BX.PopupWindow("bx-post-tag-popup",this.addNewLink,{content:this.popupContent,lightShadow:false,offsetTop:8,offsetLeft:10,autoHide:true,angle:true,closeByEsc:true,zIndex:-910,buttons:[new BX.PopupWindowButton({text:BX.message("TAG_ADD"),events:{click:BX.proxy(this.onTagAdd,this)}})]});BX.bind(this.popupInput,"keydown",BX.proxy(this.onKeyPress,this));BX.bind(this.popupInput,"keyup",BX.proxy(this.onKeyPress,this))}this.popup.show();BX.focus(this.popupInput)};e.BXPostFormTags.prototype.addTag=function(e){var t=BX.type.isNotEmptyString(e)?e.split(","):this.popupInput.value.split(",");var i=[];for(var n=0;n<t.length;n++){var o=BX.util.trim(t[n]);if(o.length>0){var s=this.hiddenField.value.split(",");if(!BX.util.in_array(o,s)){var a;var r=BX.create("span",{children:[a=BX.create("span",{attrs:{"class":"feed-add-post-del-but"}})],attrs:{"class":"feed-add-post-tags"}});r.insertBefore(document.createTextNode(o),a);this.tagsContainer.insertBefore(r,this.addNewLink);BX.bind(a,"click",BX.proxy(this.onTagDelete,{obj:this,tagBox:r,tagValue:o}));this.hiddenField.value+=o+",";i.push(o)}}}return i};e.BXPostFormTags.prototype.onTagAdd=function(e){this.addTag();this.popupInput.value="";this.popup.close()};e.BXPostFormTags.prototype.onAddNewClick=function(t){t=t||e.event;this.show();BX.PreventDefault(t)};e.BXPostFormTags.prototype.onButtonClick=function(t){t=t||e.event;BX.show(this.tagsArea);this.show();BX.PreventDefault(t)};e.BXPostFormTags.prototype.onKeyPress=function(t){t=t||e.event;var i=t.keyCode?t.keyCode:t.which?t.which:null;if(i==13){setTimeout(BX.proxy(this.onTagAdd,this),0)}};var r=null;e.MPFbuttonShowWait=function(e){if(e&&!BX.type.isElementNode(e))e=null;e=e||this;e=e?e.tagName=="A"?e:e.parentNode:e;if(e){BX.addClass(e,"feed-add-button-load");r=e;BX.defer(function(){e.disabled=true})()}};e.MPFbuttonCloseWait=function(e){if(e&&!BX.type.isElementNode(e))e=null;e=e||r||this;if(e){e.disabled=false;BX.removeClass(e,"feed-add-button-load");r=null}};e.__mpf_wd_getinfofromnode=function(e,t){var i=BX.findChild(BX((e["prefixNode"]||"wd-doc")+e.element_id),{className:"files-preview",tagName:"IMG"},true,false);if(i){e.lowsrc=i.src;e.element_url=i.src.replace(/\Wwidth\=(\d+)/,"").replace(/\Wheight\=(\d+)/,"");e.width=parseInt(i.getAttribute("data-bx-full-width"));e.height=parseInt(i.getAttribute("data-bx-full-height"))}else if(t.urlGet){e.element_url=t.urlGet.replace("#element_id#",e.element_id).replace("#ELEMENT_ID#",e.element_id).replace("#element_name#",e.element_name).replace("#ELEMENT_NAME#",e.element_name)}};var l={listen:false,plus:false,text:""};e.BXfpdSelectCallback=function(t,i,n,o){if(!BX.findChild(BX("feed-add-post-destination-item"),{attr:{"data-id":t.id}},false,false)){var s=i;var a="S";if(i=="groups"){s="all-users"}else if(BX.util.in_array(i,["contacts","companies","leads","deals"])){s="crm"}if(i=="sonetgroups"){a="SG"}else if(i=="groups"){a="UA"}else if(i=="users"){a="U"}else if(i=="department"){a="DR"}else if(i=="contacts"){a="CRMCONTACT"}else if(i=="companies"){a="CRMCOMPANY"}else if(i=="leads"){a="CRMLEAD"}else if(i=="deals"){a="CRMDEAL"}var r=o?" feed-add-post-destination-undelete":"";r+=i=="sonetgroups"&&typeof e["arExtranetGroupID"]!="undefined"&&BX.util.in_array(t.entityId,e["arExtranetGroupID"])?" feed-add-post-destination-extranet":"";var l=BX.create("span",{attrs:{"data-id":t.id},props:{className:"feed-add-post-destination feed-add-post-destination-"+s+r},children:[BX.create("input",{attrs:{type:"hidden",name:"SPERM["+a+"][]",value:t.id}}),BX.create("span",{props:{className:"feed-add-post-destination-text"},html:t.name})]});if(!o){l.appendChild(BX.create("span",{props:{className:"feed-add-post-del-but"},events:{click:function(n){BX.SocNetLogDestination.deleteItem(t.id,i,e.BXSocNetLogDestinationFormName);BX.PreventDefault(n)},mouseover:function(){BX.addClass(this.parentNode,"feed-add-post-destination-hover")},mouseout:function(){BX.removeClass(this.parentNode,"feed-add-post-destination-hover")}}}))}BX("feed-add-post-destination-item").appendChild(l)}BX("feed-add-post-destination-input").value="";BX.SocNetLogDestination.BXfpSetLinkName({formName:e.BXSocNetLogDestinationFormName,tagInputName:"bx-destination-tag",tagLink1:BX.message("BX_FPD_LINK_1"),tagLink2:BX.message("BX_FPD_LINK_2")})};e.onKeyDownHandler=function(t,i,n){var o=t.keyCode;if(!e["BXfpdStopMent"+n])return true;if(o==107||(t.shiftKey||t.modifiers>3)&&BX.util.in_array(o,[187,50,107,43,61])){setTimeout(function(){var t=i.selection.GetRange(),o=i.GetIframeDoc(),s=t?t.endContainer.textContent:"",a=s?s.slice(t.endOffset-1,t.endOffset):"",r=s?s.slice(t.endOffset-2,t.endOffset-1):"";if((a=="@"||a=="+")&&(!r||BX.util.in_array(r,["+","@",",","("])||r.length==1&&BX.util.trim(r)==="")){l.listen=true;l.text="";l.leaveContent=true;t.setStart(t.endContainer,t.endOffset-1);t.setEnd(t.endContainer,t.endOffset);i.selection.SetSelection(t);var d=BX.create("SPAN",{props:{id:"bx-mention-node"}},o);i.selection.Surround(d,t);t.setStart(d,1);t.setEnd(d,1);i.selection.SetSelection(t);if(!BX.SocNetLogDestination.isOpenDialog()){BX.SocNetLogDestination.openDialog(e["BXSocNetLogDestinationFormNameMent"+n],{bindNode:getMentionNodePosition(d,i)})}}},10)}if(l.listen){if(o==i.KEY_CODES["enter"]){BX.SocNetLogDestination.selectCurrentSearchItem(e["BXSocNetLogDestinationFormNameMent"+n]);i.iframeKeyDownPreventDefault=true;BX.PreventDefault(t)}else if(o==i.KEY_CODES["left"]){BX.SocNetLogDestination.moveCurrentSearchItem(e["BXSocNetLogDestinationFormNameMent"+n],"left");i.iframeKeyDownPreventDefault=true;BX.PreventDefault(t)}else if(o==i.KEY_CODES["right"]){BX.SocNetLogDestination.moveCurrentSearchItem(e["BXSocNetLogDestinationFormNameMent"+n],"right");i.iframeKeyDownPreventDefault=true;BX.PreventDefault(t)}else if(o==i.KEY_CODES["up"]){BX.SocNetLogDestination.moveCurrentSearchItem(e["BXSocNetLogDestinationFormNameMent"+n],"up");i.iframeKeyDownPreventDefault=true;BX.PreventDefault(t)}else if(o==i.KEY_CODES["down"]){BX.SocNetLogDestination.moveCurrentSearchItem(e["BXSocNetLogDestinationFormNameMent"+n],"down");i.iframeKeyDownPreventDefault=true;BX.PreventDefault(t)}}if(!l.listen&&o===i.KEY_CODES["enter"]){var s=i.selection.GetRange();if(s.collapsed){var a=s.endContainer,r=i.GetIframeDoc();if(a){if(a.className!=="bxhtmled-metion"){a=BX.findParent(a,function(e){return e.className=="bxhtmled-metion"},r.body)}if(a&&a.className=="bxhtmled-metion"){i.selection.SetAfter(a)}}}}};e.onKeyUpHandler=function(t,i,n){var o=t.keyCode,s,a;if(!e["BXfpdStopMent"+n])return true;if(l.listen===true){if(o==i.KEY_CODES["escape"]){e["BXfpdStopMent"+n]()}else if(o!==i.KEY_CODES["enter"]&&o!==i.KEY_CODES["left"]&&o!==i.KEY_CODES["right"]&&o!==i.KEY_CODES["up"]&&o!==i.KEY_CODES["down"]){s=i.GetIframeDoc();var r=s.getElementById("bx-mention-node");if(r){var d=BX.util.trim(i.util.GetTextContent(r)),h=d;d=d.replace(/^[\+@]*/,"");BX.SocNetLogDestination.search(d,true,e["BXSocNetLogDestinationFormNameMent"+n],BX.message("MPF_NAME_TEMPLATE"),{bindNode:getMentionNodePosition(r,i)});if(l.leaveContent&&l._lastText&&h===""){e["BXfpdStopMent"+n]()}else if(l.leaveContent&&l.lastText&&h!==""&&d===""){e["BXfpdStopMent"+n]();BX.SocNetLogDestination.openDialog(e["BXSocNetLogDestinationFormNameMent"+n],{bindNode:getMentionNodePosition(r,i)})}l.lastText=d;l._lastText=h}else{e["BXfpdStopMent"+n]()}}}else{if(!t.shiftKey&&(o===i.KEY_CODES["space"]||o===i.KEY_CODES["escape"]||o===188||o===190)){a=i.selection.GetRange();if(a.collapsed){var f=a.endContainer;s=i.GetIframeDoc();if(f){if(f.className!=="bxhtmled-metion"){f=BX.findParent(f,function(e){return e.className=="bxhtmled-metion"},s.body)}if(f&&f.className=="bxhtmled-metion"){d=i.util.GetTextContent(f);var u=d.match(/[\s\.\,]$/);if(u||o===i.KEY_CODES["escape"]){f.innerHTML=d.replace(/[\s\.\,]$/,"");var c=BX.create("SPAN",{html:u||i.INVISIBLE_SPACE},s);i.util.InsertAfter(c,f);i.selection.SetAfter(c)}}}}}}};e.onTextareaKeyDownHandler=function(t,i,n){var o=t.keyCode;if(l.listen&&o==i.KEY_CODES["enter"]){BX.SocNetLogDestination.selectFirstSearchItem(e["BXSocNetLogDestinationFormNameMent"+n]);i.textareaKeyDownPreventDefault=true;BX.PreventDefault(t)}};e.onTextareaKeyUpHandler=function(t,i,n){var o,s,a=t.keyCode;if(l.listen===true){if(a==27){e["BXfpdStopMent"+n]()}else if(a!==13){s=i.textareaView.GetValue(false);o=i.textareaView.GetCursorPosition();if(s.indexOf("+")!==-1||s.indexOf("@")!==-1){var r=s.substr(0,o),d=Math.max(r.lastIndexOf("+"),r.lastIndexOf("@"));if(d>=0){var h=r.substr(d),f=h;h=h.replace(/^[\+@]*/,"");if(!BX.SocNetLogDestination.isOpenDialog()){BX.SocNetLogDestination.openDialog(e["BXSocNetLogDestinationFormNameMent"+n])}BX.SocNetLogDestination.search(h,true,e["BXSocNetLogDestinationFormNameMent"+n],BX.message("MPF_NAME_TEMPLATE"));if(l.leaveContent&&l._lastText&&f===""){e["BXfpdStopMent"+n]()}else if(l.leaveContent&&l.lastText&&f!==""&&h===""){e["BXfpdStopMent"+n]();BX.SocNetLogDestination.openDialog(e["BXSocNetLogDestinationFormNameMent"+n])}l.lastText=h;l._lastText=f}}}}else{if(a==16){var u=this;this.shiftPressed=true;if(this.shiftTimeout)this.shiftTimeout=clearTimeout(this.shiftTimeout);this.shiftTimeout=setTimeout(function(){u.shiftPressed=false},100)}if(a==107||(t.shiftKey||t.modifiers>3||this.shiftPressed)&&BX.util.in_array(a,[187,50,107,43,61])){o=i.textareaView.element.selectionStart;if(o>0){s=i.textareaView.element.value;var c=s.substr(o-1,1);if(c&&(c==="+"||c==="@")){l.listen=true;l.text="";l.textarea=true;if(!BX.SocNetLogDestination.isOpenDialog()){BX.SocNetLogDestination.openDialog(e["BXSocNetLogDestinationFormNameMent"+n])}}}}}};e.getMentionNodePosition=function(e,t){var i=BX.pos(e),n=BX.pos(t.dom.areaCont),o=BX.GetWindowScrollPos(t.GetIframeDoc()),s=n.top+i.bottom-o.scrollTop+2,a=n.left+i.right-o.scrollLeft;return{top:s,left:a}};e.BxInsertMention=function(t){var i=t.item,n=t.type,o=t.formID,s=t.editorId,a=t.bNeedComa,r=LHEPostForm.getEditor(s);if(n=="users"&&i&&i.entityId>0&&r){if(r.GetViewMode()=="wysiwyg"){var d=r.GetIframeDoc(),h=r.selection.GetRange(),f=d.getElementById("bx-mention-node"),u=BX.create("SPAN",{props:{className:"bxhtmled-metion"},text:BX.util.htmlspecialcharsback(i.name)},d),c=BX.create("SPAN",{html:a?",&nbsp;":"&nbsp;"},d);r.SetBxTag(u,{tag:"postuser",params:{value:i.entityId}});if(f){r.util.ReplaceNode(f,u)}else{r.selection.InsertNode(u,h)}if(u&&u.parentNode){var p=BX.findParent(u,{className:"bxhtmled-metion"},d.body);if(p){r.util.InsertAfter(u,p)}}if(u&&u.parentNode){r.util.InsertAfter(c,u);r.selection.SetAfter(c)}}else if(r.GetViewMode()=="code"&&r.bbCode){r.textareaView.Focus();var m=r.textareaView.GetValue(false),g=r.textareaView.GetCursorPosition(),B=m.substr(0,g),X=Math.max(B.lastIndexOf("+"),B.lastIndexOf("@"));if(X>=0&&g>X){r.textareaView.SetValue(m.substr(0,X)+m.substr(g));r.textareaView.element.setSelectionRange(X,X)}r.textareaView.WrapWith(false,false,"[USER="+i.entityId+"]"+i.name+"[/USER]"+(a?", ":" "))}delete BX.SocNetLogDestination.obItemsSelected[e["BXSocNetLogDestinationFormNameMent"+o]][i.id];e["BXfpdStopMent"+o]();l["text"]="";if(r.GetViewMode()=="wysiwyg"){r.Focus();r.selection.SetAfter(c)}}};e.buildDepartmentRelation=function(e){var t={};for(var i in e){var n=e[i]["parent"];if(!t[n])t[n]=[];t[n][t[n].length]=i}function o(e,t){var i={};if(t[e]){for(var n in t[e]){var s=t[e][n];var a=[];if(t[s]&&t[s].length>0)a=o(s,t);i[s]={id:s,type:"category",items:a}}}return i}return o("DR0",t)};e.MPFMentionInit=function(t,i){if(!i["items"]["departmentRelation"])i["items"]["departmentRelation"]=e.buildDepartmentRelation(i["items"]["department"]);e["departmentRelation"]=i["items"]["departmentRelation"];if(i["initDestination"]===true){e.BXSocNetLogDestinationFormName="destination"+(""+(new Date).getTime()).substr(6);e.BXSocNetLogDestinationDisableBackspace=null;BX.SocNetLogDestination.init({name:e.BXSocNetLogDestinationFormName,searchInput:BX("feed-add-post-destination-input"),extranetUser:i["extranetUser"],bindMainPopup:{node:BX("feed-add-post-destination-container"),offsetTop:"5px",offsetLeft:"15px"},bindSearchPopup:{node:BX("feed-add-post-destination-container"),offsetTop:"5px",offsetLeft:"15px"},callback:{select:e["BXfpdSelectCallback"],unSelect:BX.delegate(BX.SocNetLogDestination.BXfpUnSelectCallback,{formName:e.BXSocNetLogDestinationFormName,inputContainerName:"feed-add-post-destination-item",inputName:"feed-add-post-destination-input",tagInputName:"bx-destination-tag",tagLink1:BX.message("BX_FPD_LINK_1"),tagLink2:BX.message("BX_FPD_LINK_2")}),openDialog:BX.delegate(BX.SocNetLogDestination.BXfpOpenDialogCallback,{inputBoxName:"feed-add-post-destination-input-box",inputName:"feed-add-post-destination-input",tagInputName:"bx-destination-tag"}),closeDialog:BX.delegate(BX.SocNetLogDestination.BXfpCloseDialogCallback,{inputBoxName:"feed-add-post-destination-input-box",inputName:"feed-add-post-destination-input",tagInputName:"bx-destination-tag"}),openSearch:BX.delegate(BX.SocNetLogDestination.BXfpOpenDialogCallback,{inputBoxName:"feed-add-post-destination-input-box",inputName:"feed-add-post-destination-input",tagInputName:"bx-destination-tag"}),closeSearch:BX.delegate(BX.SocNetLogDestination.BXfpCloseSearchCallback,{inputBoxName:"feed-add-post-destination-input-box",inputName:"feed-add-post-destination-input",tagInputName:"bx-destination-tag"})},items:i["items"],itemsLast:i["itemsLast"],itemsSelected:i["itemsSelected"],isCrmFeed:i["isCrmFeed"],useClientDatabase:!!i["useClientDatabase"]});BX.bind(BX("feed-add-post-destination-input"),"keyup",BX.delegate(BX.SocNetLogDestination.BXfpSearch,{formName:e.BXSocNetLogDestinationFormName,inputName:"feed-add-post-destination-input",tagInputName:"bx-destination-tag"}));BX.bind(BX("feed-add-post-destination-input"),"keydown",BX.delegate(BX.SocNetLogDestination.BXfpSearchBefore,{formName:e.BXSocNetLogDestinationFormName,inputName:"feed-add-post-destination-input"}));BX.bind(BX("bx-destination-tag"),"click",function(t){BX.SocNetLogDestination.openDialog(e.BXSocNetLogDestinationFormName);BX.PreventDefault(t)});BX.bind(BX("feed-add-post-destination-container"),"click",function(t){BX.SocNetLogDestination.openDialog(e.BXSocNetLogDestinationFormName);BX.PreventDefault(t)});if(i["itemsHidden"]){for(var n in i["itemsHidden"]){e.BXfpdSelectCallback({id:"SG"+i["itemsHidden"][n]["ID"],name:i["itemsHidden"][n]["NAME"]},"sonetgroups","",true)}}BX.SocNetLogDestination.BXfpSetLinkName({formName:e.BXSocNetLogDestinationFormName,tagInputName:"bx-destination-tag",tagLink1:BX.message("BX_FPD_LINK_1"),tagLink2:BX.message("BX_FPD_LINK_2")})}e["BXfpdSelectCallbackMent"+t]=function(n,o,s){e.BxInsertMention({item:n,type:o,formID:t,editorId:i["editorId"]})};e["BXfpdStopMent"+t]=function(){BX.SocNetLogDestination.closeDialog();BX.SocNetLogDestination.closeSearch();clearTimeout(BX.SocNetLogDestination.searchTimeout);BX.SocNetLogDestination.searchOnSuccessHandle=false};e["BXfpdOnDialogOpen"+t]=function(){l.listen=true};e["BXfpdOnDialogClose"+t]=function(){l.listen=false;setTimeout(function(){if(!l.listen){var e=LHEPostForm.getEditor(i.editorId);if(e){var t=e.GetIframeDoc(),n=t.getElementById("bx-mention-node");if(n){e.selection.SetAfter(n);if(l.leaveContent){e.util.ReplaceWithOwnChildren(n)}else{BX.remove(n)}}e.Focus()}}},100)};e["BXSocNetLogDestinationFormNameMent"+t]="mention"+(""+(new Date).getTime()).substr(5);e["BXSocNetLogDestinationDisableBackspace"]=null;var o=BX("bx-b-mention-"+t);BX.SocNetLogDestination.init({name:e["BXSocNetLogDestinationFormNameMent"+t],searchInput:o,extranetUser:i["extranetUser"],bindMainPopup:{node:o,offsetTop:"1px",offsetLeft:"12px"},bindSearchPopup:{node:o,offsetTop:"1px",offsetLeft:"12px"},callback:{select:e["BXfpdSelectCallbackMent"+t],openDialog:e["BXfpdOnDialogOpen"+t],closeDialog:e["BXfpdOnDialogClose"+t],openSearch:e["BXfpdOnDialogOpen"+t],closeSearch:e["BXfpdOnDialogClose"+t]},items:{users:i["items"]["users"],groups:{},sonetgroups:{},department:i["items"]["department"],departmentRelation:i["items"]["departmentRelation"]},itemsLast:{users:e["lastUsers"],sonetgroups:{},department:{},groups:{}},itemsSelected:i["itemsSelected"],departmentSelectDisable:true,obWindowClass:"bx-lm-mention",obWindowCloseIcon:false});BX.ready(function(){var n=BX("bx-b-mention-"+t);if(BX.browser.IsIE()&&!BX.browser.IsIE9()){n.style.width="1px";n.style.marginRight="0"}BX.bind(n,"mousedown",function(o){if(l.listen!==true){var s=LHEPostForm.getEditor(i.editorId),a=s.GetIframeDoc();if(s.GetViewMode()=="wysiwyg"&&a){l.listen=true;l.text="";l.leaveContent=false;var r=s.selection.GetRange(),d=a.getElementById("bx-mention-node");if(d){BX.remove(d)}s.InsertHtml('<span id="bx-mention-node">'+s.INVISIBLE_SPACE+"</span>",r);setTimeout(function(){if(!BX.SocNetLogDestination.isOpenDialog()){BX.SocNetLogDestination.openDialog(e["BXSocNetLogDestinationFormNameMent"+t],{bindNode:n})}var i=a.getElementById("bx-mention-node");if(i){r.setStart(i,0);if(i.firstChild&&i.firstChild.nodeType==3&&i.firstChild.nodeValue.length>0){r.setEnd(i,1)}else{r.setEnd(i,0)}s.selection.SetSelection(r)}s.Focus()},100)}else if(s.GetViewMode()=="code"){l.listen=true;l.text="";l.leaveContent=false;setTimeout(function(){if(!BX.SocNetLogDestination.isOpenDialog()){BX.SocNetLogDestination.openDialog(e["BXSocNetLogDestinationFormNameMent"+t],{bindNode:n})}},100)}BX.onCustomEvent(n,"mentionClick")}})})}})(window);
//# sourceMappingURL=script.map.js