function __MBTasksCPTListInit(){MBTasks.CPT.List.onPullHandler=function(s){var a=!!(s&&s.module_id&&s.module_id==="tasks"&&s.command&&(s.command==="task_add"||s.command==="task_update"||s.command==="task_remove")&&s.params&&s.params.TASK_ID&&s.params.event_GUID);if(!a)return;if(MBTasks.CPT.List.UUIDs_processed.indexOf(s.params.event_GUID)!=-1)return;var t=(new Date).valueOf()*.001;var e=false;var i=100;var r=500;MBTasks.CPT.List.ProcessChangedData(s.command,s.params.TASK_ID)};MBTasks.CPT.List.ProcessChangedDataCallback=function(s,a){var t="t"+a;var e="task-list-block-"+a;if(!s.baseData)return;if(!s.filter_check_result)return;var i=0;if(s.baseData.group_id>0)i=parseInt(s.baseData.group_id);if(s.filter_check_result!="match filter"){MBTasks.CPT.List.RemoveTaskFromList(s.task_id)}else if(MBTasks.CPT.List.groupSelected!==false&&MBTasks.CPT.List.groupSelected!=i){MBTasks.CPT.List.RemoveTaskFromList(s.task_id)}else{var r=s.baseData;var n=false;try{if(!MBTasks.CPT.List.tasksBaseDataCache.hasOwnProperty(t)){MBTasks.CPT.List.tasksBaseDataCache[t]={params_emitter:"tasks_list",matrix:"view",gear:MBTasks.gear,task_id:parseInt(s.task_id)};n=false}else n=true;for(var o in r)MBTasks.CPT.List.tasksBaseDataCache[t][o]=r[o]}catch(l){}if(n)MBTasks.CPT.List.ReRenderTaskItem(s.task_id);else{var k=MBTasks.CPT.List.RenderNewTaskItem(s.task_id);MBTasks.CPT.List.InsertAsFirstChild(BX("tasks-all-items-tasks"),k);var c=0;for(var T in MBTasks.CPT.List.tasksBaseDataCache){c++;break}if(c>0)BX("tasks-list-no-task-notificator").style.display="none"}}};MBTasks.CPT.List.ProcessChangedData=function(s,a){if(MBTasks.CPT.List.tasksListGroupsShowed)return;if(s==="task_remove"){MBTasks.CPT.List.RemoveTaskFromList(a)}else if(s==="task_update"||s==="task_add"){MBTasks.CPT.List.loadBaseTaskData(a,function(s){return function(a){MBTasks.CPT.List.ProcessChangedDataCallback(a,s)}}(a))}};MBTasks.CPT.List.InsertAsFirstChild=function(s,a){if(s.firstChild)s.insertBefore(a,s.firstChild);else s.appendChild(a)};MBTasks.CPT.List.RenderNewTaskItem=function(s){var a="t"+s;if(!MBTasks.CPT.List.tasksBaseDataCache.hasOwnProperty(a))return;var t=MBTasks.CPT.List.tasksBaseDataCache[a];var e="task-item-"+s;var i="";if(t.priority==0)i="task-list-priority-low";else if(t.priority==2)i="task-list-priority-high";var r="";if(t.status_id==-1)r="task-list-status-overdue";else if(t.status_id==4||t.status_id==7){r="task-list-status-waiting"}else if(t.status_id==1||t.status_id==-2){r="task-list-status-new"}if(MBTasks.gear=="2"||MBTasks.gear=="D"||MBTasks.gear=="OD"){var n=function(s){return function(){try{app.openNewPage(MBTasks.CPT.List.snmrouterPath,s)}catch(a){}return false}}(t)}else{var n=function(s){return function(){try{app.openNewPage(MBTasks.CPT.List.taskViewHrefTemplate.replace("#TASK_ID#",s))}catch(a){}return false}}(s)}var o=BX.create("DIV",{props:{id:"task-list-block-"+s,className:"task-list-block "+i},events:{click:n},children:[BX.create("DIV",{props:{id:e+"-title",className:"task-list-block-title"},html:BX.util.htmlspecialchars(t.title)}),BX.create("DIV",{props:{className:"task-list-block-names"},children:[BX.create("A",{props:{id:e+"-originator",className:"task-list-block-names-link"},html:BX.util.htmlspecialchars(t.originator_formatted_name)}),BX.create("SPAN",{props:{className:"task-list-separate"}}),BX.create("A",{props:{id:e+"-responsible",className:"task-list-block-names-link"},html:BX.util.htmlspecialchars(t.responsible_formatted_name)})]}),BX.create("DIV",{props:{id:e+"-deadline",className:"task-list-deadline"},html:BX.util.htmlspecialchars(t.deadline_formatted)}),BX.create("DIV",{props:{className:"task-list-priority"}}),BX.create("DIV",{props:{id:"task-list-block-status-"+s,className:"task-list-status "+r}}),BX.create("DIV",{props:{className:"task-list-arrow"}})]});return o};MBTasks.CPT.List.RemoveTaskFromList=function(s){var a="t"+s;var t="task-list-block-"+s;if(!MBTasks.CPT.List.tasksBaseDataCache.hasOwnProperty(a))return;delete MBTasks.CPT.List.tasksBaseDataCache[a];if(BX(t)){try{var e=parseInt(BX(t).offsetHeight)-parseInt(window.getComputedStyle(BX(t),null).getPropertyValue("padding-top"))-parseInt(window.getComputedStyle(BX(t),null).getPropertyValue("padding-bottom"));MBTasks.CPT.List.sexyRemove(t,1,.33,e,e/3,10)}catch(i){}}};MBTasks.CPT.List.loadBaseTaskData=function(s,a){var t=MBTasks.siteDir+"mobile/?mobile_action=task_router";var e={sessid:MBTasks.sessid,site:MBTasks.site,lang:MBTasks.lang,subject:"BASE",task_id:s,user_id:MBTasks.userId,action:"get_task_data",CHECK_FILTER_ID:MBTasks.CPT.List.FILTER_ID,DATE_TIME_FORMAT:MBTasks.DATE_TIME_FORMAT,PATH_TEMPLATE_TO_USER_PROFILE:"",PATH_TO_FORUM_SMILE:"",AVA_WIDTH:0,AVA_HEIGHT:0};function i(){a(false)}function r(s,a){if(s&&(s=='{"status":"failed"}'||s.status=="failed")){app.BasicAuth({success:function(s,a){return function(e){MBTasks.sessid=e.sessid_md5;BX.ajax({timeout:30,method:"POST",dataType:"json",url:t,data:s,onsuccess:function(s){try{r(s,a)}catch(t){}},onfailure:function(){try{i(a)}catch(s){}}})}}(e,a),failure:function(s){return function(){try{i(s)}catch(a){}}}(a)})}else if(s&&s.task_id)a(s);else a(false)}BX.ajax({timeout:30,method:"POST",dataType:"json",data:e,url:t,onsuccess:function(s,a){return function(s){try{r(s,a)}catch(t){}}}(e,a),onfailure:function(s,a){return function(){try{i(a)}catch(s){}}}(e,a)})};MBTasks.CPT.List.sexyRemove=function(s,a,t,e,i,r){if(a<=0){BX.remove(BX(s));var n=0;for(var o in MBTasks.CPT.List.tasksBaseDataCache){n++;break}if(n==0)BX("tasks-list-no-task-notificator").style.display="block"}else{BX(s).style.opacity=a.toString();if(e>=0){BX(s).style.height=e+"px"}window.setTimeout(function(s,a,t,e,i,r){return function(){MBTasks.CPT.List.sexyRemove(s,a,t,e,i,r)}}(s,a-t,t,parseInt(e-i),i,r),r)}};MBTasks.CPT.List.onTasksFilterChangeHandler=function(s){if(!(s.module_id&&s.module_id==="tasks"&&s.emitter&&s.emitter==="tasks filter"&&s.user_id==MBTasks.userId))return;var a=document.location.href;var t=a.split("?");if(t.length>=2){var e=encodeURIComponent("SWITCH_TO_FILTER_PRESET_ID")+"=";var i=t[1].split(/[&;]/g);for(var r=i.length;r-->0;)if(i[r].lastIndexOf(e,0)!==-1)i.splice(r,1);a=t[0]+"?"+i.join("&")}a+=(a.split("?")[1]?"&":"?")+"SWITCH_TO_FILTER_PRESET_ID="+s.filter_preset_id;app.reload({url:a})};MBTasks.CPT.List.UpdateTaskListDelayed=function(s,a){if(Math.abs(a-MBTasks.lastTimeUIApplicationDidBecomeActiveNotification)<=1)MBTasks.CPT.List.RefreshPage()};MBTasks.CPT.List.RefreshPage=function(s){app.reload()};MBTasks.CPT.List.ReRenderTaskItem=function(s){if(!MBTasks.CPT.List.tasksBaseDataCache.hasOwnProperty("t"+s))return;var a=MBTasks.CPT.List.tasksBaseDataCache["t"+s];var t="task-item-"+s;BX(t+"-title").innerHTML=BX.util.htmlspecialchars(a.title);BX(t+"-originator").innerHTML=BX.util.htmlspecialchars(a.originator_formatted_name);BX(t+"-responsible").innerHTML=BX.util.htmlspecialchars(a.responsible_formatted_name);if(a.deadline_formatted.length>0)BX(t+"-deadline").innerHTML=BX.util.htmlspecialchars(a.deadline_formatted);else BX(t+"-deadline").innerHTML=" ";var e="";if(a.priority==0)e="task-list-priority-low";if(a.priority==2)e="task-list-priority-high";BX("task-list-block-"+s).className="task-list-block "+e;var i="";switch(parseInt(a.status_id)){case-1:i="task-list-status-overdue";break;case 4:case 7:i="task-list-status-waiting";break;case-1:case 1:i="task-list-status-new";break;default:break}BX("task-list-block-status-"+s).className="task-list-status "+i};MBTasks.CPT.List.AcquireLockOpenNewPage=function(){if(MBTasks.CPT.List.lockOpenNewPage<0)MBTasks.CPT.List.lockOpenNewPage=0;if(MBTasks.CPT.List.lockOpenNewPage>0)return"busy";var s=++MBTasks.CPT.List.lockOpenNewPage;if(s===1)return"lock_acquired";else if(s>1){--MBTasks.CPT.List.lockOpenNewPage;return"try_again"}};MBTasks.CPT.List.ReleaseLockOpenNewPage=function(){window.setTimeout(function(){try{app.checkOpenStatus({callback:function(s){if(s&&s.status!=="visible"){--MBTasks.CPT.List.lockOpenNewPage}else{MBTasks.CPT.List.ReleaseLockOpenNewPage()}}})}catch(s){}},100)};BX.addCustomEvent("onTaskActionBeforePerfome",function(s){MBTasks.CPT.List.UUIDs_processed.push(s.UUID)});BX.addCustomEvent("onTaskActionPerfomed",function(s){if(!(s.module_id&&s.module_id==="tasks"&&s.action))return;var a=s.data;var t="t"+a.task_id;var e="task-list-block-"+a.task_id;if(s.action==="remove"){if(s.rc!=="executed")return;MBTasks.CPT.List.RemoveTaskFromList(a.task_id)}else if(s.action==="edit"){if(MBTasks.CPT.List.tasksBaseDataCache.hasOwnProperty(t)){for(var i in a.baseData){if(a.baseData.hasOwnProperty(i))MBTasks.CPT.List.tasksBaseDataCache[t][i]=a.baseData[i]}MBTasks.CPT.List.ReRenderTaskItem(a.task_id)}window.setTimeout(function(s){return function(){MBTasks.CPT.List.ProcessChangedData("task_update",s)}}(a.task_id),1500)}else{if(MBTasks.CPT.List.tasksBaseDataCache.hasOwnProperty(t)){if(a.baseData){MBTasks.CPT.List.tasksBaseDataCache[t].status_id=a.baseData.status_id;MBTasks.CPT.List.tasksBaseDataCache[t].status_formatted_name=a.baseData.status_formatted_name;if(BX(e)){var r="";if(MBTasks.CPT.List.tasksBaseDataCache[t].status_id==-1)r="task-list-status-overdue";else if(MBTasks.CPT.List.tasksBaseDataCache[t].status_id==4||MBTasks.CPT.List.tasksBaseDataCache[t].status_id==7){r="task-list-status-waiting"}else if(MBTasks.CPT.List.tasksBaseDataCache[t].status_id==-2||MBTasks.CPT.List.tasksBaseDataCache[t].status_id==1){r="task-list-status-new"}try{BX("task-list-block-status-"+a.task_id).className="task-list-status "+r}catch(n){}}}}window.setTimeout(function(s){return function(){MBTasks.CPT.List.ProcessChangedData("task_update",s)}}(a.task_id),1500)}});app.menuCreate({items:[{name:BX.message("MB_TASKS_TASKS_LIST_MENU_GOTO_FILTER"),url:BX.message("PATH_TO_TASKS_FILTER"),arrowFlag:true,icon:"settings"},{name:BX.message("MB_TASKS_TASKS_LIST_MENU_CREATE_NEW_TASK"),icon:"add",arrowFlag:false,action:function(){var s=0;if(MBTasks.CPT.List.groupSelected>0)s=parseInt(MBTasks.CPT.List.groupSelected);app.showModalDialog({url:BX.message("PATH_TO_TASKS_CREATE")+"&dialogKey="+"&offerGroupId="+s+"&t="+(new Date).getTime()})}}]});app.addButtons({menuButton:{type:"context-menu",style:"custom",callback:function(){app.menuShow()}}});BX.addCustomEvent("onTasksFilterChange",MBTasks.CPT.List.onTasksFilterChangeHandler);BX.addCustomEvent("onTaskEditPerfomed",function(s){if(s.rc<1)return;var a=s.rc;MBTasks.CPT.List.ProcessChangedData("task_update",a)});BX.addCustomEvent("UIApplicationDidBecomeActiveNotification",function(s){MBTasks.lastTimeUIApplicationDidBecomeActiveNotification=(new Date).valueOf()*.001});app.onCustomEvent("onPullExtendWatch",{id:"TASKS_GENERAL_"+MBTasks.userId});BX.addCustomEvent("onPull",MBTasks.CPT.List.onPullHandler)}
//# sourceMappingURL=script.map.js