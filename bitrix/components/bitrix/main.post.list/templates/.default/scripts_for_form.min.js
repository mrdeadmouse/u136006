(function(e){e["UC"]=!!e["UC"]?e["UC"]:{};if(!!e["FCForm"])return;e.FCForm=function(t){this.url="";this.lhe="";this.entitiesId={};this.form=BX(t["formId"]);this.handler=LHEPostForm.getHandler(t["editorId"]);this.editorName=t["editorName"];this.editorId=t["editorId"];this.windowEvents={OnUCUnlinkForm:BX.delegate(function(t){if(!!t&&!!this.entitiesId[t]){var i={},s=true;for(var n in this.entitiesId){if(this.entitiesId.hasOwnProperty(n)&&n!=t){s=false;i[n]=this.entitiesId[n]}}this.entitiesId=i;if(s&&!!this.windowEvents){for(n in this.windowEvents){if(this.windowEvents.hasOwnProperty(n)&&n)BX.removeCustomEvent(e,n,this.windowEvents[n])}this.windowEventsSet=false}}},this),OnUCUserQuote:BX.delegate(function(e,t,i,s,n){if(this.entitiesId[e]){if(!this._checkTextSafety([e,0],s))return;this.show([e,0]);if(n!==true){this.handler.exec(this.windowEvents.OnUCUserQuote,[e,t,i,s,true]);return}else if(!this.handler.oEditor.toolbar.controls.Quote){BX.DoNothing()}else if(!t&&!i){this.handler.oEditor.action.Exec("quote")}else{i=BX.util.htmlspecialchars(i);if(this.handler.oEditor.GetViewMode()=="wysiwyg"){i=i.replace(/\n/g,"<br/>");if(t){if(t.id>0){t='<span id="'+this.handler.oEditor.SetBxTag(false,{tag:"postuser",params:{value:t.id}})+'" class="bxhtmled-metion">'+t.name.replace(/</gi,"&lt;").replace(/>/gi,"&gt;")+"</span>"}else{t="<span>"+t.name.replace(/</gi,"&lt;").replace(/>/gi,"&gt;")+"</span>"}t=t!==""?t+BX.message("MPL_HAVE_WRITTEN")+"<br/>":"";i=t+i}}else if(this.handler.oEditor.bbCode){if(t){if(t.id>0){t="[USER="+t.id+"]"+t.name+"[/USER]"}else{t=t.name}t=t!==""?t+BX.message("MPL_HAVE_WRITTEN")+"\n":"";i=t+i}}this.handler.oEditor.action.actions.quote.setExternalSelection(i);this.handler.oEditor.action.Exec("quote")}}},this),OnUCUserReply:BX.delegate(function(t,i,s,n){if(!this._checkTextSafety([t,0],n))return;if(this.entitiesId[t]){this.show([t,0]);if(i>0){this.handler.exec(e.BxInsertMention,[{item:{entityId:i,name:s},type:"users",formID:this.form.id,editorId:this.editorId,bNeedComa:true,insertHtml:true}])}}},this),OnUCAfterRecordEdit:BX.delegate(function(e,t,i,s){if(!!this.entitiesId[e]){if(s==="EDIT"){this.show([e,t],i["messageBBCode"],i["messageFields"]);this.editing=true}else{this.hide(true);if(!!i["errorMessage"]){this.id=[e,t];this.showError(i["errorMessage"])}else if(!!i["okMessage"]){this.id=[e,t];this.showNote(i["okMessage"]);this.id=null}}}},this),OnUCUsersAreWriting:BX.delegate(function(e,t,i,s,n){if(!!this.entitiesId[e]){this.showAnswering([e,0],t,i,s,n)}},this),OnUCRecordHaveDrawn:BX.delegate(function(e,t){if(!!this.entitiesId[e]){var i=parseInt(!!t&&!!t["messageFields"]&&!!t["messageFields"]["AUTHOR"]&&!!t["messageFields"]["AUTHOR"]["ID"]?t["messageFields"]["AUTHOR"]["ID"]:0);if(i>0)this.hideAnswering([e,0],i)}},this)};this.linkEntity(t["entitiesId"]);BX.remove(BX("micro"+t["editorName"]));BX.remove(BX("micro"+t["editorId"]));this.eventNode=this.handler.eventNode;if(this.eventNode){BX.addCustomEvent(this.eventNode,"OnBeforeHideLHE",BX.delegate(function(){if(!!this.id&&!!BX("uc-writing-"+this.form.id+"-"+this.id[0]))BX.hide(BX("uc-writing-"+this.form.id+"-"+this.id[0]))},this));BX.addCustomEvent(this.eventNode,"OnAfterHideLHE",BX.delegate(function(){var t=this._getPlacehoder();if(t){BX.hide(t)}t=this._getSwitcher();if(t){BX.show(t);BX.focus(t.firstChild)}this.__content_length=0;if(!!this.id){BX.onCustomEvent(this.eventNode,"OnUCFormAfterHide",[this]);this.showAnswering(this.id)}clearTimeout(this._checkWriteTimeout);this._checkWriteTimeout=0;this.clear();BX.onCustomEvent(e,"OnUCFeedChanged",[this.id])},this));BX.addCustomEvent(this.eventNode,"OnBeforeShowLHE",BX.delegate(function(){var e=this._getPlacehoder();if(e){BX.show(e)}e=this._getSwitcher();if(e){BX.hide(e)}if(!!this.id&&!!BX("uc-writing-"+this.form.id+"-"+this.id[0]))BX.hide(BX("uc-writing-"+this.form.id+"-"+this.id[0]))},this));BX.addCustomEvent(this.eventNode,"OnAfterShowLHE",BX.delegate(function(t,i){this._checkWrite(t,i);if(!!this.id)this.showAnswering(this.id);BX.onCustomEvent(e,"OnUCFeedChanged",[this.id])},this));BX.addCustomEvent(this.eventNode,"OnClickSubmit",BX.delegate(this.submit,this));BX.addCustomEvent(this.eventNode,"OnClickCancel",BX.delegate(this.cancel,this));BX.onCustomEvent(this.eventNode,"OnUCFormInit",[this])}this.id=null};e.FCForm.prototype={linkEntity:function(t){if(!!t){for(var i in t){if(t.hasOwnProperty(i)){BX.onCustomEvent(e,"OnUCUnlinkForm",[i]);this.entitiesId[i]=t[i]}}}if(!this.windowEventsSet&&!!this.entitiesId){BX.addCustomEvent(e,"OnUCUnlinkForm",this.windowEvents.OnUCUnlinkForm);BX.addCustomEvent(e,"OnUCUserReply",this.windowEvents.OnUCUserReply);BX.addCustomEvent(e,"OnUCUserQuote",this.windowEvents.OnUCUserQuote);BX.addCustomEvent(e,"OnUCAfterRecordEdit",this.windowEvents.OnUCAfterRecordEdit);BX.addCustomEvent(e,"OnUCUsersAreWriting",this.windowEvents.OnUCUsersAreWriting);BX.addCustomEvent(e,"OnUCRecordHaveDrawn",this.windowEvents.OnUCRecordHaveDrawn);this.windowEventsSet=true}},_checkTextSafety:function(e,t){if(t===true){t=e;if(this.id&&this.id.join("-")!=e.join("-")&&this.handler.editorIsLoaded&&this.handler.oEditor.IsContentChanged())return confirm(BX.message("MPL_SAFE_EDIT"));return true}return t===false},_checkWrite:function(t,i){if(this.handler.editorIsLoaded&&this._checkWriteTimeout!==false){this.__content_length=this.__content_length>0?this.__content_length:0;var s=this.handler.oEditor.GetContent(),n=BX.delegate(function(){this._checkWrite(t,i)},this),o=2e3;if(s.length>=4&&this.__content_length!=s.length&&!!this.id){BX.onCustomEvent(e,"OnUCUserIsWriting",[this.id[0],this.id[1]]);o=3e4}this._checkWriteTimeout=setTimeout(n,o);this.__content_length=s.length}},_getPlacehoder:function(e){e=!!e?e:this.id;return!!e?BX("record-"+e.join("-")+"-placeholder"):null},_getSwitcher:function(e){e=!!e?e:this.id;return!!e?BX("record-"+e[0]+"-switcher"):null},hide:function(e){if(this.eventNode.style.display!="none"){BX.onCustomEvent(this.eventNode,"OnShowLHE",[e===true?false:"hide"])}},clear:function(){this.editing=false;var e=this._getPlacehoder();if(!!e)BX.hide(e);var t=BX.findChildren(e,{tagName:"DIV",className:"feed-add-error"},true);if(!!t){e=t.pop();do{BX.remove(e)}while((e=t.pop())&&e)}BX.onCustomEvent(this.eventNode,"OnUCFormClear",[this]);var i=BX.findChild(this.form,{className:"wduf-placeholder-tbody"},true,false);if(i!==null&&typeof i!="undefined")BX.cleanNode(i,false);i=BX.findChild(this.form,{className:"wduf-selectdialog"},true,false);if(i!==null&&typeof i!="undefined")BX.hide(i);i=BX.findChild(this.form,{className:"file-placeholder-tbody"},true,false);if(i!==null&&typeof i!="undefined")BX.cleanNode(i,false);this.id=null},show:function(e,t,i){if(this.id&&!!e&&this.id.join("-")==e.join("-"))return true;else this.hide(true);this.id=e;var s=this._getPlacehoder();s.appendChild(this.form);BX.onCustomEvent(this.eventNode,"OnUCFormBeforeShow",[this,t,i]);BX.onCustomEvent(this.eventNode,"OnShowLHE",["show"]);BX.onCustomEvent(this.eventNode,"OnUCFormAfterShow",[this,t,i]);return true},submit:function(){if(this.busy===true)return"busy";var t=this.handler.editorIsLoaded?this.handler.oEditor.GetContent():"";if(!t){this.showError(BX.message("JERROR_NO_MESSAGE"));return false}this.showWait();this.busy=true;var i={};e.convertFormToArray(this.form,i);i["REVIEW_TEXT"]=t;i["NOREDIRECT"]="Y";i["MODE"]="RECORD";i["AJAX_POST"]="Y";i["id"]=this.id;if(this.editing===true){i["REVIEW_ACTION"]="EDIT";i["FILTER"]={ID:this.id[1]}}BX.onCustomEvent(this.eventNode,"OnUCFormSubmit",[this,i]);BX.onCustomEvent(e,"OnUCFormSubmit",[this.id[0],this.id[1],this,i]);BX.ajax({method:"POST",url:this.form.action,data:i,dataType:"json",onsuccess:BX.proxy(function(t){this.closeWait();var i=t,s=this.id[0];BX.onCustomEvent(this.eventNode,"OnUCFormResponse",[this,t]);if(!!this.OnUCFormResponseData)t=this.OnUCFormResponseData;if(!!t){if(!!t["errorMessage"]){this.showError(t["errorMessage"])}else{BX.onCustomEvent(e,"OnUCAfterRecordAdd",[this.id[0],t,i]);this.hide(true)}}this.busy=false;BX.onCustomEvent(e,"OnUCFormResponse",[s,t["messageId"],this,t])},this),onfailure:BX.delegate(function(){this.closeWait();this.busy=false;BX.onCustomEvent(e,"OnUCFormResponse",[this.id[0],this.id[1],this,[]])},this)})},cancel:function(){},showError:function(e){if(!e)return;var t=this._getPlacehoder(),i=BX.findChildren(t,{tagName:"DIV",className:"feed-add-error"},true);if(!!i){var s=i.pop();do{BX.remove(s);BX.remove(s)}while((s=i.pop())&&!!s)}t.insertBefore(BX.create("div",{attrs:{"class":"feed-add-error"},html:'<span class="feed-add-info-text"><span class="feed-add-info-icon"></span>'+"<b>"+BX.message("FC_ERROR")+"</b><br />"+e+"</span>"}),t.firstChild);BX.show(t)},showNote:function(e){if(!e)return;var t=this._getPlacehoder(),i=BX.findChildren(t,{tagName:"DIV",className:"feed-add-successfully"},true),s=null;if(!!i){while((s=i.pop())&&!!s){BX.remove(s)}}t.insertBefore(BX.create("div",{attrs:{"class":"feed-add-successfully"},html:'<span class="feed-add-info-text"><span class="feed-add-info-icon"></span>'+e+"</span>"}),t.firstChild);BX.show(t)},showWait:function(){var e=BX("lhe_button_submit_"+this.form.id);if(!!e){BX.addClass(e,"feed-add-button-load");BX.addClass(e,"feed-add-button-press");BX.defer(function(){e.disabled=true})()}},closeWait:function(){var e=BX("lhe_button_submit_"+this.form.id);if(!!e){e.disabled=false;BX.removeClass(e,"feed-add-button-press");BX.removeClass(e,"feed-add-button-load")}},objAnswering:null,showAnswering:function(e,t,i,s,n){if(!(t>0))return false;var o="uc-writing-"+this.form.id+"-"+e[0],r=BX(o+"-area"),a=this._getSwitcher(e),d=BX.localStorage.get("ucAnsweringStorage");d=!!d?d:{};if(!r&&a){r=BX.create("DIV",{attrs:{id:o+"-area",className:"feed-com-writers"},html:'<div id="'+o+'-users" class="feed-com-writers-wrap"></div><div class="feed-com-writers-pen"></div>'});a.appendChild(r)}if(!!r){if(t>0){if(!n){d["userId"+t]={id:e[0],userId:t,name:i,avatar:s,time:new Date};BX.localStorage.set("ucAnsweringStorage",d,3e3)}if(!BX(o+"-user-"+t)){BX.adjust(BX(o+"-users"),{children:[BX.create("DIV",{attrs:{className:"feed-com-avatar",id:o+"-user-"+t,title:i},children:[BX.create("IMG",{attrs:{src:s&&s.length>0?s:"/bitrix/images/1.gif"}})]})]})}}if(BX(o+"-users").childNodes.length>0){if(BX(r.parentNode).style.display=="none"){var h=BX("lhe_buttons_"+this.form.id);if(!h||h.style.display=="none")h=this.form;h.appendChild(r)}else if(r.parentNode!=a)a.appendChild(r);if(this.objAnswering&&this.objAnswering.name!="show")this.objAnswering.stop();if(!this.objAnswering||this.objAnswering.name!="show"){r.style.display="inline-block";this.objAnswering=new BX["easing"]({duration:500,start:{opacity:0},finish:{opacity:100},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:function(e){r.style.opacity=e.opacity/100}});this.objAnswering.name="show";this.objAnswering.animate()}var l=setTimeout(BX.delegate(function(){this.hideAnswering(e,t)},this),!!n?n:40500);if(BX(o+"-user-"+t)){clearTimeout(BX(o+"-user-"+t).getAttribute("bx-check-timeout"));BX(o+"-user-"+t).setAttribute("bx-check-timeout",l+"")}}}},hideAnswering:function(e,t){var i="uc-writing-"+this.form.id+"-"+e[0],s=BX(i+"-area"),n=BX(i+"-user-"+t,false);if(n&&s){if(BX(i+"-users").childNodes.length>1){new BX["easing"]({duration:500,start:{opacity:100},finish:{opacity:0},transition:BX["easing"].makeEaseOut(BX["easing"].transitions.quart),step:function(e){n.style.opacity=e.opacity/100},complete:function(){if(!!n&&!!n.parentNode)n.parentNode.removeChild(n)}}).animate()}else{if(this.objAnswering&&this.objAnswering.name!="hide")this.objAnswering.stop();if(!this.objAnswering||this.objAnswering.name!="hide"){this.objAnswering=new BX["easing"]({duration:500,start:{opacity:100},finish:{opacity:0},transition:BX["easing"].makeEaseOut(BX.easing.transitions.quart),step:function(e){s.style.opacity=e.opacity/100},complete:function(){s.style.display="none";if(!!n&&!!n.parentNode)n.parentNode.removeChild(n)}});this.objAnswering.name="hide";this.objAnswering.animate()}}}}};e.convertFormToArray=function(e,t){t=!!t?t:[];if(!!e){var i,s=[],n=e.elements.length;for(i=0;i<n;i++){var o=e.elements[i];if(o.disabled)continue;switch(o.type.toLowerCase()){case"text":case"textarea":case"password":case"hidden":case"select-one":s.push({name:o.name,value:o.value});break;case"radio":case"checkbox":if(o.checked)s.push({name:o.name,value:o.value});break;case"select-multiple":for(var r=0;r<o.options.length;r++){if(o.options[r].selected)s.push({name:o.name,value:o.options[r].value})}break;default:break}}var a=t;i=0;while(i<s.length){var d=s[i].name.indexOf("[");if(d==-1){a[s[i].name]=s[i].value;a=t;i++}else{var h=s[i].name.substring(0,d);var l=s[i].name.substring(d+1);if(!a[h])a[h]=[];var f=l.indexOf("]");if(f==-1){a=t;i++}else if(f===0){a=a[h];s[i].name=""+a.length}else{a=a[h];s[i].name=l.substring(0,f)+l.substring(f+1)}}}}return t};e.FCForm.onUCUsersAreWriting=function(){BX.ready(function(){var t=null,i=null,s=BX.localStorage.get("ucAnsweringStorage");if(!!s){for(var n in s){if(s.hasOwnProperty(n)){t=s[n];if(!!t&&t.userId>0){i=new Date-t.time;if(i<3e4){BX.onCustomEvent(e,"OnUCUsersAreWriting",[t.id,t.userId,t.name,t.avatar,i])}}}}}})};e["fRefreshCaptcha"]=function(e){var t=null,i=BX.findChild(e,{attr:{name:"captcha_code"}},true),s=BX.findChild(e,{attr:{name:"captcha_word"}},true),n=BX.findChild(e,{className:"comments-reply-field-captcha-image"},true);if(n)t=BX.findChild(n,{tag:"img"});if(i&&s&&t){s.value="";BX.ajax.getCaptcha(function(e){i.value=e["captcha_sid"];t.src="/bitrix/tools/captcha.php?captcha_code="+e["captcha_sid"]})}}})(window);
//# sourceMappingURL=scripts_for_form.map.js